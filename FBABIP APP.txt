<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FBA/BIP App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .transition-all { transition: all 0.3s ease-in-out; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background: white; padding: 2rem; border-radius: 0.5rem; width: 90%; max-width: 600px; }
        .chat-bubble { max-width: 75%; padding: 0.75rem 1rem; border-radius: 1rem; margin-bottom: 0.5rem; word-wrap: break-word; }
        .chat-bubble-user { background-color: #3b82f6; color: white; border-bottom-right-radius: 0.25rem; align-self: flex-end; }
        .chat-bubble-model { background-color: #e5e7eb; color: #1f2937; border-bottom-left-radius: 0.25rem; align-self: flex-start; }
        .typing-indicator { display: flex; align-items: center; padding: 0.75rem 1rem; }
        .typing-indicator span { height: 8px; width: 8px; margin: 0 2px; background-color: #9ca3af; border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .analysis-content h4 { font-weight: 700; font-size: 1.125rem; margin-bottom: 0.5rem; color: #111827; }
        .analysis-content ul, .analysis-content ol { list-style-position: inside; padding-left: 0.5rem; margin-bottom: 1rem; }
        .analysis-content h5 { font-weight: 600; font-size: 1rem; margin-top: 0.75rem; color: #374151; }
        .analysis-content p { margin-bottom: 1rem; }
        #visual-hypothesis-container svg { width: 100%; height: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem; }
        html { scroll-behavior: smooth; }
        
        /* Button Loading State */
        .btn-loading { position: relative; color: transparent !important; pointer-events: none; }
        .btn-loading::after { content: ""; position: absolute; width: 1.25rem; height: 1.25rem; top: 50%; left: 50%; margin-top: -0.625rem; margin-left: -0.625rem; border: 2px solid #ffffff; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Collapsible Styles */
        .section-header { cursor: pointer; user-select: none; }
        .section-header svg.chevron { transition: transform 0.3s; }
        .section-collapsed .section-content { display: none; }
        .section-collapsed .section-header svg.chevron { transform: rotate(-90deg); }
        
        /* Side Nav Active State */
        .nav-link.active { background-color: #eff6ff; color: #1d4ed8; border-left: 4px solid #2563eb; padding-left: 12px; }
        .nav-link { border-left: 4px solid transparent; transition: all 0.2s; }

        /* Pigeon Guide Styles */
        #pigeon-guide-btn { position: fixed; bottom: 20px; right: 20px; width: 80px; height: 80px; z-index: 60; cursor: grab; transition: transform 0.3s ease; animation: float 6s ease-in-out infinite; touch-action: none; }
        #pigeon-guide-btn:active { cursor: grabbing; }
        #pigeon-guide-btn:hover { transform: scale(1.1) translateY(-5px); }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        
        #guide-chat-popover { position: fixed; bottom: 110px; right: 20px; width: 350px; height: 500px; background: white; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.15); z-index: 59; display: flex; flex-direction: column; overflow: hidden; border: 1px solid #e5e7eb; transform-origin: bottom right; transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        #guide-chat-popover.hidden-popover { transform: scale(0); opacity: 0; pointer-events: none; }
        .guide-header { background: #0f766e; color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .guide-messages { flex-grow: 1; overflow-y: auto; padding: 1rem; background-color: #f0fdfa; display: flex; flex-direction: column; gap: 0.5rem; }
        .guide-input-area { padding: 0.75rem; background: white; border-top: 1px solid #e5e7eb; display: flex; gap: 0.5rem; }
        
        /* Guide Specific Bubbles */
        .guide-bubble-ai { background-color: white; border: 1px solid #ccfbf1; color: #134e4a; border-bottom-left-radius: 0.25rem; align-self: flex-start; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .guide-bubble-user { background-color: #0f766e; color: white; border-bottom-right-radius: 0.25rem; align-self: flex-end; }

        /* Presentation Mode Styles (Option 2) */
        body.presentation-mode #app-navbar, 
        body.presentation-mode aside, 
        body.presentation-mode .no-print, 
        body.presentation-mode #chat-input-container,
        body.presentation-mode #pigeon-guide-btn,
        body.presentation-mode .section-header svg.chevron { 
            display: none !important; 
        }
        body.presentation-mode #view-container { 
            padding-top: 1rem !important; 
            background-color: #f8fafc;
        }
        body.presentation-mode .max-w-7xl { 
            max-w-100% !important; 
            padding: 0 2rem !important; 
        }
        body.presentation-mode .step-section { 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important; 
            border: 1px solid #e2e8f0; 
            margin-bottom: 2rem; 
        }
        /* Ensure charts text is readable when projected */
        body.presentation-mode text { font-size: 14px !important; }

        /* Print Styles */
        @media print {
            #app-navbar, aside, .no-print, button, .modal-overlay, #chat-input-container, #pigeon-guide-btn, #guide-chat-popover { display: none !important; }
            body, #app, #view-container { background: white !important; min-height: auto !important; height: auto !important; }
            .section-collapsed .section-content { display: block !important; } /* Force expand */
            .section-header svg.chevron { display: none; }
            .bg-white, .shadow-lg { box-shadow: none !important; border: none !important; }
            .max-w-7xl, .max-w-4xl { max-width: 100% !important; padding: 0 !important; margin: 0 !important; }
            #case-detail-screen-template > div { display: block !important; }
            .flex-col { display: block !important; } /* Un-flex columns for print flow */
            .border { border: 1px solid #ddd; }
            /* Hide chat windows in print unless they have meaningful content, but usually we want summaries */
            #interview-container, #prevent-chat-container, #teach-chat-container, #respond-chat-container { display: none; }
            /* Ensure text areas expand */
            textarea { border: none; resize: none; overflow: visible; height: auto; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- App Container -->
    <div id="app" class="min-h-screen flex flex-col">
        <!-- Loading Screen -->
        <div id="loading-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-100">
             <div class="text-center">
                 <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                 <p id="loading-text" class="mt-4 text-lg font-medium text-gray-600" data-i18n="app.loading">Initializing Secure Session...</p>
             </div>
        </div>

        <!-- Navigation Bar -->
        <nav id="app-navbar" class="hidden bg-white shadow-md z-10 relative no-print">
             <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                 <div class="flex items-center justify-between h-16">
                     <div class="flex items-center"><span class="font-bold text-xl text-blue-600" data-i18n="nav.title">FBA App</span></div>
                     <div class="flex items-center space-x-4">
                        <select id="language-switcher" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2">
                            <option value="en">English</option>
                            <option value="es">Espa√±ol</option>
                            <option value="add_new_lang">üåê Add Language...</option>
                        </select>
                        <span id="user-id-display" class="text-xs text-gray-500"></span>
                        <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-md text-sm font-medium" data-i18n="nav.logout">Logout</button>
                     </div>
                 </div>
             </div>
        </nav>

        <!-- Main View Container -->
        <main id="view-container" class="flex-grow py-10 w-full"></main>
        
        <!-- Live Observation Overlay (NEW) -->
        <div id="live-obs-overlay" class="hidden fixed inset-0 bg-gray-900 z-[70] flex flex-col p-6 transition-all duration-300">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-white flex items-center">
                        <span class="animate-pulse mr-2 text-red-500">‚óè</span> Live Observation
                    </h2>
                    <p id="live-student-name" class="text-gray-400 text-sm">Student Name</p>
                </div>
                <button id="exit-live-mode" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-bold border border-gray-600 shadow-lg">Exit Focus Mode</button>
            </div>

            <div class="flex-grow grid grid-cols-1 lg:grid-cols-4 gap-6 h-full overflow-hidden">
                <!-- Left Col: Timer & Stats -->
                <div class="bg-gray-800 rounded-2xl p-6 flex flex-col items-center justify-center border border-gray-700 shadow-xl relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-purple-500"></div>
                    <div class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-4">Session Duration</div>
                    <div id="live-timer-display" class="text-6xl lg:text-7xl font-mono text-white font-bold mb-8 tracking-tighter">00:00</div>
                    <div class="flex space-x-2 w-full justify-center">
                        <button id="live-timer-toggle" class="bg-green-600 hover:bg-green-500 text-white px-4 py-3 rounded-xl text-lg font-bold transition-all transform active:scale-95 flex-grow shadow-lg border-b-4 border-green-800">START</button>
                        <button id="live-timer-reset" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-3 rounded-xl text-lg font-bold border border-gray-600 transition-all active:scale-95 shadow-lg">‚Ü∫</button>
                    </div>
                    <div class="mt-8 grid grid-cols-2 gap-4 w-full">
                        <div class="bg-gray-700/50 p-3 rounded-lg text-center">
                            <div id="live-session-count" class="text-2xl font-bold text-blue-400">0</div>
                            <div class="text-[10px] text-gray-400 uppercase">Events</div>
                        </div>
                        <div class="bg-gray-700/50 p-3 rounded-lg text-center">
                            <div id="live-last-log" class="text-sm font-bold text-gray-300 mt-1">--:--</div>
                            <div class="text-[10px] text-gray-400 uppercase">Last Log</div>
                        </div>
                    </div>
                </div>

                <!-- Center Col: Buttons Grid -->
                <div class="lg:col-span-2 bg-gray-800 rounded-2xl p-6 border border-gray-700 shadow-xl relative flex flex-col">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-yellow-500 to-red-500"></div>
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest">Quick Log Behaviors</h3>
                        <button id="live-edit-btn" class="text-xs text-gray-500 hover:text-white underline decoration-dotted transition-colors">Edit Buttons</button>
                    </div>
                    <div id="live-buttons-container" class="grid grid-cols-2 sm:grid-cols-3 gap-4 flex-grow overflow-y-auto content-start">
                        <!-- Buttons injected via JS -->
                    </div>
                </div>

                <!-- Right Col: Live Feed & Notes (NEW) -->
                <div class="bg-gray-800 rounded-2xl p-4 border border-gray-700 shadow-xl relative flex flex-col">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-green-400 to-blue-500"></div>
                    <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-4">Session Feed & Notes</h3>
                    
                    <div id="live-stream-feed" class="flex-grow overflow-y-auto mb-4 space-y-2 pr-2 bg-gray-900/30 rounded p-2">
                        <!-- Feed Items Injected Here -->
                        <div class="text-xs text-gray-600 text-center italic mt-10">Stream started...</div>
                    </div>

                    <div class="mt-auto">
                        <button id="live-mic-btn" class="w-full bg-gray-700 hover:bg-gray-600 text-white rounded-lg p-3 flex items-center justify-center transition-colors border border-gray-600 group">
                            <span id="live-mic-icon" class="text-2xl mr-2 group-hover:scale-110 transition-transform">üéôÔ∏è</span>
                            <span id="live-mic-text" class="font-bold text-sm">Dictate Note</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- PIGEON GUIDE UI (Global) -->
        <div id="pigeon-guide-btn" class="hidden no-print" title="Click for Help">
            <svg viewBox="0 0 220 200" class="w-full h-full drop-shadow-lg">
                <g transform="translate(10, 10)">
                    <!-- Tail Feathers -->
                    <path d="M150 120 L190 145 L170 155 Z" fill="#475569" />
                    
                    <!-- Legs -->
                    <path d="M110 145 L110 165 L100 175 M110 165 L120 175" stroke="#ef4444" stroke-width="4" fill="none" stroke-linecap="round"/>
                    <path d="M130 145 L130 165 L120 175 M130 165 L140 175" stroke="#ef4444" stroke-width="4" fill="none" stroke-linecap="round"/>

                    <!-- Main Body (Elongated) -->
                    <path d="M70 50 
                             Q 90 30 120 50 
                             Q 170 70 170 110 
                             Q 160 150 100 140 
                             Q 60 130 60 90 
                             Q 60 70 70 50" 
                          fill="#94a3b8" />
                          
                    <!-- Wing (Darker Grey - Elongated) -->
                    <path d="M80 80 Q 120 70 150 90 Q 140 120 90 110 Z" fill="#64748b" />

                    <!-- Neck Iridescence (Purple/Green sheen) -->
                    <path d="M60 65 Q 70 75 80 65" stroke="#a855f7" stroke-width="5" fill="none" opacity="0.6" style="mix-blend-mode: overlay;" />
                    <path d="M60 72 Q 70 82 80 72" stroke="#10b981" stroke-width="5" fill="none" opacity="0.6" style="mix-blend-mode: overlay;" />

                    <!-- Head -->
                    <circle cx="70" cy="50" r="28" fill="#94a3b8" />
                    
                    <!-- Eye (Orange ring, black pupil) -->
                    <circle cx="60" cy="45" r="6" fill="#f59e0b" />
                    <circle cx="60" cy="45" r="2.5" fill="black" />
                    
                    <!-- Beak (Dark grey) -->
                    <path d="M42 48 L25 52 L42 55 Z" fill="#334155" />
                    <!-- Cere (White part above beak) -->
                    <path d="M42 48 Q 39 45 45 42" fill="#e2e8f0" /> 
                </g>
            </svg>
            <div class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full shadow-sm animate-pulse">Help?</div>
        </div>

        <!-- Global Timer Widget -->
        <div id="global-timer-widget" class="fixed bottom-5 left-5 bg-white border border-gray-300 shadow-xl rounded-full p-2 flex items-center space-x-2 z-50 hidden no-print transition-all hover:scale-105">
            <div id="global-timer-display" class="font-mono font-bold text-gray-800 px-2">00:00</div>
            <button id="global-timer-toggle" class="bg-green-600 text-white rounded-full p-2 hover:bg-green-700 focus:outline-none">
                <svg id="play-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <svg id="stop-icon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path></svg>
            </button>
        </div>

        <div id="guide-chat-popover" class="hidden-popover no-print">
            <div class="guide-header">
                <div class="flex items-center">
                    <span class="font-bold mr-2">Percy the Guide</span>
                </div>
                <button id="close-guide-btn" class="text-white hover:text-gray-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="guide-messages" class="guide-messages">
                <!-- Messages go here -->
            </div>
            <div class="guide-input-area">
                <input type="text" id="guide-input" class="flex-grow p-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="Ask Percy...">
                <button id="guide-send-btn" class="bg-teal-600 text-white p-2 rounded-md hover:bg-teal-700">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                </button>
            </div>
        </div>

        <!-- Templates (Hidden) -->
        <div id="login-screen-template" class="hidden">
            <div class="min-h-screen bg-gray-50 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
                <div class="max-w-md w-full space-y-8 p-10 bg-white rounded-xl shadow-lg">
                    <div>
                        <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900" data-i18n="auth.title">FBA/BIP App</h2>
                        <p class="mt-2 text-center text-sm text-gray-600" data-i18n="auth.subtitle">Functional Behavior Assessment & Intervention Tool</p>
                    </div>
                    <div class="text-center">
                        <p class="text-sm text-gray-500 mb-4" data-i18n="auth.guest_access">Demonstration Access</p>
                        <button id="anonymous-login-btn" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" data-i18n="auth.login_btn">Get Started</button>
                        <p id="login-error" class="mt-2 text-xs text-red-600"></p>
                    </div>
                    <!-- Privacy Warning -->
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mt-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-xs text-yellow-700" data-i18n="auth.privacy_warning"><strong>Privacy Notice:</strong> Do not enter real names. Use codenames or IDs.</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 text-xs text-gray-500 border-t pt-4">
                        <p class="font-semibold text-center text-gray-600 mb-2" data-i18n="auth.about_title">About FBA/BIP</p>
                        <p class="text-justify" data-i18n="auth.about_text">This tool guides practitioners through the Functional Behavioral Assessment (FBA) process and the development of Behavior Intervention Plans (BIP) using evidence-based practices and data-driven decision making.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboard-screen-template" class="hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <!-- NEW: Report Settings Section -->
                <div class="bg-white p-4 rounded-lg shadow mb-6 mt-6 no-print">
                    <details>
                        <summary class="cursor-pointer font-bold text-gray-700 flex items-center select-none">
                            <svg class="w-5 h-5 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            <span>‚öôÔ∏è School / Report Settings</span>
                        </summary>
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">School Name</label>
                                <input type="text" id="setting-school-name" placeholder="e.g. Springfield Elementary" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">District / Organization</label>
                                <input type="text" id="setting-district" placeholder="e.g. Springfield School District" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <!-- NEW: School Logo Upload -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700">School Logo</label>
                                <div class="flex items-center space-x-4 mt-1">
                                    <div id="logo-preview" class="w-12 h-12 bg-gray-100 border rounded flex items-center justify-center text-xs text-gray-400 overflow-hidden">No Logo</div>
                                    <input type="file" id="school-logo-upload" accept="image/*" class="text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                    <button id="clear-logo-btn" class="text-xs text-red-500 hover:text-red-700 underline hidden">Remove</button>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Max size: 500KB. Saved locally.</p>
                            </div>
                            <div class="md:col-span-2 text-right">
                                <button id="save-settings-btn" class="bg-blue-600 text-white px-4 py-2 rounded shadow-sm hover:bg-blue-700 text-sm font-bold transition-colors">Save Settings</button>
                            </div>
                        </div>
                    </details>
                </div>

                <div class="flex justify-between items-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-900" data-i18n="dashboard.title">Case Dashboard</h1>
                    <div class="flex space-x-3">
                        <input type="file" id="import-case-input" class="hidden" accept=".json">
                        <button id="import-case-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                            <span data-i18n="dashboard.import_btn">Import JSON</span>
                        </button>
                        <button id="add-case-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md" data-i18n="dashboard.new_case_btn">+ New Case</button>
                    </div>
                </div>
                <div id="cases-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <div id="no-cases-message" class="hidden text-center py-12 bg-white rounded-lg shadow">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9-1V7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2z" /></svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900" data-i18n="dashboard.no_cases_title">No cases</h3>
                    <p class="mt-1 text-sm text-gray-500" data-i18n="dashboard.no_cases_text">Get started by creating a new case or importing one.</p>
                </div>
            </div>
        </div>

        <div id="case-detail-screen-template" class="hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <!-- Header Actions -->
                <div class="flex justify-between items-center mb-6 no-print">
                    <button id="back-to-dashboard-btn" class="inline-flex items-center text-sm font-medium text-blue-600 hover:text-blue-800" data-i18n="case_detail.back_btn">&larr; Back to Dashboard</button>
                    <div class="flex space-x-2">
                        <!-- NEW: Home Note Button (Option 2) -->
                        <button id="home-note-btn" class="bg-pink-600 hover:bg-pink-700 text-white text-sm font-semibold py-2 px-4 rounded border border-pink-800 flex items-center shadow-sm transition-transform active:scale-95">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                            Home Note
                        </button>
                        <!-- NEW: Presentation Mode Button (Option 2) -->
                        <button id="present-mode-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold py-2 px-4 rounded border border-indigo-800 flex items-center shadow-sm transition-transform active:scale-95">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path></svg>
                            Present
                        </button>
                        <button onclick="window.print()" class="bg-gray-100 hover:bg-gray-200 text-gray-800 text-sm font-semibold py-2 px-4 rounded border border-gray-300 flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                            Print
                        </button>
                        <button id="export-case-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-800 text-sm font-semibold py-2 px-4 rounded border border-gray-300 flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            <span data-i18n="case_detail.export_btn">Export JSON</span>
                        </button>
                    </div>
                </div>

                <div class="flex flex-col lg:flex-row gap-8">
                    <!-- Side Navigation (Desktop) -->
                    <aside class="hidden lg:block w-64 flex-shrink-0 no-print">
                        <div class="sticky top-6 bg-white rounded-lg shadow overflow-hidden">
                            <nav class="flex flex-col" id="side-nav">
                                <a href="#step-1-section" class="nav-link px-4 py-3 text-sm font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-700 border-b border-gray-100" data-i18n="steps.step1_short">1. Interview</a>
                                <a href="#step-2-section" class="nav-link px-4 py-3 text-sm font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-700 border-b border-gray-100" data-i18n="steps.step2_short">2. ABC Data</a>
                                <a href="#step-3-section" class="nav-link px-4 py-3 text-sm font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-700 border-b border-gray-100" data-i18n="steps.step3_short">3. Records</a>
                                <a href="#step-4-section" class="nav-link px-4 py-3 text-sm font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-700 border-b border-gray-100" data-i18n="steps.step4_short">4. Visual</a>
                                <a href="#step-5-section" class="nav-link px-4 py-3 text-sm font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-700 border-b border-gray-100" data-i18n="steps.step5_short">5. Decision</a>
                                <a href="#step-6-section" class="nav-link px-4 py-3 text-sm font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-700" data-i18n="steps.step6_short">6. BIP</a>
                            </nav>
                        </div>
                    </aside>

                    <!-- Main Content Column -->
                    <div class="flex-grow space-y-8 min-w-0">
                        <!-- Progress Tracker (Option 2 Implementation) -->
                        <div class="mb-8 no-print">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Case Progress</span>
                                <span id="progress-percentage" class="text-xs font-bold text-blue-600">0%</span>
                            </div>
                            <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-gray-200">
                                <div id="progress-bar-fill" style="width:0%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-500 transition-all duration-500"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-400" id="progress-steps-indicator">
                                <span id="prog-step-1" class="transition-colors">Interview</span>
                                <span id="prog-step-2" class="transition-colors">ABC Data</span>
                                <span id="prog-step-3" class="transition-colors">Records</span>
                                <span id="prog-step-4" class="transition-colors">Visual</span>
                                <span id="prog-step-5" class="transition-colors">Decision</span>
                                <span id="prog-step-6" class="transition-colors">BIP</span>
                            </div>
                        </div>

                        <!-- Student Header -->
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <h1 id="case-detail-student-name" class="text-3xl font-bold text-gray-900"></h1>
                            <p id="case-detail-student-dob" class="text-md text-gray-600 mt-1"></p>
                        </div>
                        
                        <!-- Step 1: Problem ID -->
                        <div id="step-1-section" class="step-section bg-white rounded-lg shadow-lg">
                            <div class="section-header p-6 flex justify-between items-center border-b">
                                <h2 class="text-2xl font-bold text-gray-800" data-i18n="case_detail.step1_title">Step 1: Problem Identification Interview</h2>
                                <svg class="chevron w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div class="section-content p-6 pt-2">
                                <p class="text-sm text-gray-600 mb-6" data-i18n="case_detail.step1_desc">Use this AI-guided interview to collect initial information from a parent or teacher.</p>
                                <div id="interview-container" class="border rounded-lg p-4 bg-gray-50 no-print">
                                    <div id="chat-window" class="h-96 overflow-y-auto mb-4 flex flex-col space-y-2 p-2"></div>
                                    <div id="chat-input-container" class="flex items-center">
                                        <input type="text" id="chat-input" class="flex-grow p-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type your response...">
                                        <button id="send-btn" class="bg-blue-600 text-white p-3 rounded-r-lg hover:bg-blue-700 disabled:bg-blue-300" data-i18n="case_detail.send_btn">Send</button>
                                    </div>
                                </div>
                                 <div id="interview-summary-container" class="hidden mt-6">
                                     <h3 class="text-xl font-semibold text-gray-800" data-i18n="case_detail.interview_summary_title">Interview Summary</h3>
                                     <div id="summary-content" class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg"></div>
                                 </div>
                            </div>
                        </div>

                        <!-- Step 2: Problem Analysis -->
                        <div id="step-2-section" class="step-section bg-white rounded-lg shadow-lg">
                             <div class="section-header p-6 flex justify-between items-center border-b">
                                 <h2 class="text-2xl font-bold text-gray-800" data-i18n="case_detail.step2_title">Step 2: Problem Analysis (ABC Data)</h2>
                                 <svg class="chevron w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                             </div>
                             <div class="section-content p-6 pt-2">
                                 <!-- NEW: Environmental Audit Section -->
                                 <div id="env-audit-container" class="mb-6 bg-white p-4 rounded-lg border border-gray-200 shadow-sm mt-4 no-print">
                                     <div class="flex justify-between items-center cursor-pointer select-none" onclick="this.nextElementSibling.classList.toggle('hidden'); this.querySelector('.chevron-audit').classList.toggle('rotate-180')">
                                         <h5 class="font-bold text-gray-700 flex items-center">
                                             <span class="bg-teal-100 text-teal-800 p-1 rounded mr-2 text-xs">üè´</span> 
                                             Classroom Environment Audit
                                         </h5>
                                         <div class="flex items-center space-x-2">
                                             <span id="env-score-badge" class="hidden text-xs font-bold px-2 py-1 rounded bg-gray-100 text-gray-600">Score: --%</span>
                                             <svg class="chevron-audit w-5 h-5 text-gray-400 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                         </div>
                                     </div>
                                     <div class="hidden mt-4 pt-4 border-t border-gray-100">
                                         <p class="text-xs text-gray-500 mb-3">Rate the environment before analyzing student behavior. Low scores suggest structural changes are needed first.</p>
                                         <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                                             <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer"><input type="checkbox" class="env-chk mr-2 rounded text-teal-600 focus:ring-teal-500"> Visual Schedule is current & visible</label>
                                             <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer"><input type="checkbox" class="env-chk mr-2 rounded text-teal-600 focus:ring-teal-500"> Physical boundaries are clear</label>
                                             <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer"><input type="checkbox" class="env-chk mr-2 rounded text-teal-600 focus:ring-teal-500"> Noise levels are managed</label>
                                             <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer"><input type="checkbox" class="env-chk mr-2 rounded text-teal-600 focus:ring-teal-500"> Materials are organized & accessible</label>
                                             <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer"><input type="checkbox" class="env-chk mr-2 rounded text-teal-600 focus:ring-teal-500"> Seating arrangement limits distraction</label>
                                             <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer"><input type="checkbox" class="env-chk mr-2 rounded text-teal-600 focus:ring-teal-500"> Expectations posted positively</label>
                                             <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer"><input type="checkbox" class="env-chk mr-2 rounded text-teal-600 focus:ring-teal-500"> Transition cues provided</label>
                                             <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer"><input type="checkbox" class="env-chk mr-2 rounded text-teal-600 focus:ring-teal-500"> Staff proximity/supervision adequate</label>
                                         </div>
                                         
                                         <div class="mt-4 pt-4 border-t border-gray-100 flex justify-between items-center">
                                             <button id="calc-env-score" class="bg-teal-600 hover:bg-teal-700 text-white text-xs font-bold px-4 py-2 rounded shadow-sm transition-colors">Calculate Score</button>
                                             <div class="text-right">
                                                 <span id="env-score-display" class="font-bold text-2xl text-gray-300">--%</span>
                                             </div>
                                         </div>
                                         <p id="env-recommendation" class="text-xs font-medium text-gray-500 mt-2 text-right min-h-[1.5em]"></p>
                                     </div>
                                 </div>

                                 <!-- NEW: Routine Hotspot Matrix (Option 2) -->
                                 <div id="routine-matrix-container"></div>

                                 <div class="flex justify-end space-x-2 mb-4 no-print">
                                     <!-- NEW: Crisis Mode Button -->
                                     <button id="crisis-mode-btn" class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center mr-2 animate-pulse border border-red-900">
                                         <span class="mr-2 text-lg">üö®</span> Crisis Mode
                                     </button>
                                     <!-- NEW Live Mode Button -->
                                     <button id="live-mode-btn" class="bg-gradient-to-r from-rose-600 to-red-600 hover:from-rose-700 hover:to-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center mr-auto">
                                         <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                                         Live Mode
                                     </button>
                                     <button id="open-interval-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center mr-2">
                                         <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                         Interval Recording
                                     </button>
                                     <button id="analyze-data-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md disabled:bg-purple-300 disabled:cursor-not-allowed" data-i18n="case_detail.analyze_btn">Analyze Data with AI</button>
                                     <button id="print-data-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center">
                                         <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                                         Log PDF
                                     </button>
                                     <button id="export-csv-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center">
                                         <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                         CSV
                                     </button>
                                     <!-- NEW: Paper Log Scan Button -->
                                     <input type="file" id="paper-log-upload" accept="image/*" class="hidden">
                                     <button id="scan-paper-log-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center">
                                         <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                         Scan Log
                                     </button>
                                     <button id="add-abc-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md" data-i18n="case_detail.add_abc_btn">+ Add Observation</button>
                                 </div>
                                 
                                 <!-- NEW: Quick-Click Frequency Counter -->
                                 <div id="quick-click-container" class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg hidden no-print">
                                     <div class="flex justify-between items-center mb-3">
                                         <h5 class="font-bold text-yellow-800">‚ö° Rapid Frequency Tracker</h5>
                                         <span class="text-xs text-yellow-600">Tap to log occurrence immediately</span>
                                     </div>
                                     <div id="quick-click-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
                                 </div>

                                 <!-- NEW: Automated Insights Grid -->
                                 <div id="automated-insights-grid" class="hidden grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                     <!-- Content injected via JS -->
                                 </div>

                                 <!-- ABC Stats Panel -->
                                 <div id="abc-stats-panel" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                                     <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                                         <h5 class="text-xs font-bold text-blue-600 uppercase tracking-wide">Total Observations</h5>
                                         <p id="stat-total-obs" class="text-2xl font-bold text-gray-900">0</p>
                                     </div>
                                     <div class="bg-purple-50 p-4 rounded-lg border border-purple-100">
                                         <h5 class="text-xs font-bold text-purple-600 uppercase tracking-wide">Common Antecedent</h5>
                                         <p id="stat-common-ant" class="text-sm font-semibold text-gray-900 mt-1">-</p>
                                     </div>
                                     <div class="bg-red-50 p-4 rounded-lg border border-red-100">
                                         <h5 class="text-xs font-bold text-red-600 uppercase tracking-wide">Common Behavior</h5>
                                         <p id="stat-common-beh" class="text-sm font-semibold text-gray-900 mt-1">-</p>
                                     </div>
                                     <!-- NEW: Data Health Card -->
                                     <div id="stat-health-card" class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                         <h5 id="stat-health-title" class="text-xs font-bold text-gray-500 uppercase tracking-wide">Data Health</h5>
                                         <div class="flex items-end mt-1">
                                             <p id="stat-health-score" class="text-2xl font-bold text-gray-900">0%</p>
                                             <span class="text-xs text-gray-500 ml-2 mb-1">Quality Score</span>
                                         </div>
                                     </div>
                                     <!-- NEW: Function Chart Container -->
                                     <div id="function-chart-container" class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex flex-col items-center justify-center relative overflow-hidden">
                                         <h5 class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2 w-full text-left">Hypothesized Functions</h5>
                                         <div class="text-xs text-gray-400 italic">No data yet</div>
                                     </div>
                                 </div>

                                 <!-- Pattern Correlation Card (Option 1 Implementation) -->
                                 <div id="pattern-highlight-card" class="hidden mb-6 bg-gradient-to-r from-indigo-50 to-blue-50 border-l-4 border-indigo-500 p-4 rounded shadow-sm">
                                     <h5 class="text-sm font-bold text-indigo-900 uppercase tracking-wide mb-1">üîç Top Pattern Detected</h5>
                                     <p id="pattern-text" class="text-indigo-800 text-sm"></p>
                                 </div>

                                 <!-- NEW: Smart Schedule Calculator (Option 1 Implementation) -->
                                 <div id="smart-schedule-container" class="hidden mb-6"></div>

                                 <!-- NEW: Graph Annotation Tools (Option 2) -->
                                 <div id="annotation-tools" class="hidden flex flex-col sm:flex-row gap-2 mb-2 p-2 bg-gray-50 rounded border border-gray-200 text-sm no-print items-center">
                                     <div class="flex items-center">
                                         <span class="text-xs font-bold text-gray-500 uppercase mr-2">üìå Context Markers:</span>
                                     </div>
                                     <input type="date" id="anno-date" class="border rounded p-1 text-xs text-gray-700">
                                     <input type="text" id="anno-text" placeholder="Event (e.g., Fire Drill, Sub Teacher)" class="border rounded p-1 flex-grow text-xs text-gray-700">
                                     <button id="add-anno-btn" class="bg-gray-600 text-white px-3 py-1 rounded hover:bg-gray-700 text-xs font-bold shadow-sm whitespace-nowrap transition-colors">
                                         + Add Marker
                                     </button>
                                 </div>

                                 <!-- Temporal Chart Container -->
                                 <div id="abc-chart-container" class="mb-4 no-print"></div>

                                 <!-- Categorical Charts Container -->
                                 <div id="categorical-charts-container" class="mb-6 no-print"></div>

                                 <p class="text-sm text-gray-600 mb-6" data-i18n="case_detail.step2_desc">Record ABC observations. Once you have at least 3 entries, use the AI to analyze patterns and generate a hypothesis.</p>
                                 
                                 <!-- Smart Filters -->
                                 <div class="flex flex-col sm:flex-row gap-4 mb-4 bg-gray-50 p-3 rounded-lg border border-gray-200 no-print">
                                     <div class="flex-grow">
                                         <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Search Data</label>
                                         <input type="text" id="abc-filter-search" class="w-full p-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="Search antecedent, behavior...">
                                     </div>
                                     <div class="min-w-[200px]">
                                         <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Filter by Behavior</label>
                                         <select id="abc-filter-behavior" class="w-full p-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                             <option value="all">All Behaviors</option>
                                         </select>
                                     </div>
                                 </div>

                                 <div class="overflow-x-auto">
                                     <table class="min-w-full divide-y divide-gray-200">
                                         <thead class="bg-gray-50">
                                             <tr>
                                                 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="case_detail.table_date">Date & Time</th>
                                                 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="case_detail.table_ant">Antecedent</th>
                                                 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="case_detail.table_beh">Behavior</th>
                                                 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="case_detail.table_cons">Consequence</th>
                                                 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider no-print" data-i18n="case_detail.table_actions">Actions</th>
                                             </tr>
                                         </thead>
                                         <tbody id="abc-data-body" class="bg-white divide-y divide-gray-200"></tbody>
                                     </table>
                                     <div id="no-abc-data-message" class="hidden text-center py-8 text-gray-500"><p data-i18n="case_detail.no_data">No ABC data has been recorded for this case yet.</p></div>
                                 </div>
                                 <div id="analysis-container" class="mt-8"></div>
                                 
                                 <!-- NEW: Auto-Generated Narrative Section -->
                                 <div class="mt-4 border-t pt-4 no-print">
                                     <h5 class="font-bold text-gray-700 mb-2">Auto-Generated Narrative</h5>
                                     <button id="generate-narrative-btn" class="text-xs bg-indigo-50 text-indigo-700 px-3 py-1 rounded border border-indigo-200 hover:bg-indigo-100 font-medium shadow-sm transition-colors">Generate Narrative Paragraph</button>
                                     <div id="narrative-output" class="mt-2 p-3 bg-white border rounded text-sm text-gray-600 italic hidden shadow-inner leading-relaxed select-all"></div>
                                 </div>

                                 <!-- NEW: Function Sorter Matrix (Option 1) -->
                                 <div id="function-matrix-container" class="mt-8 p-4 bg-gray-100 rounded-lg border border-gray-300 hidden no-print">
                                     <div class="flex justify-between items-center mb-4">
                                         <h4 class="font-bold text-gray-700">üß© Function Sorter</h4>
                                         <span class="text-xs text-gray-500">Drag behaviors to likely functions</span>
                                     </div>
                                     <div class="flex flex-wrap gap-2 mb-4 min-h-[40px] p-2 bg-white rounded border border-gray-200" id="draggable-behaviors">
                                         <!-- Behaviors injected here as draggable chips -->
                                     </div>
                                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 h-auto sm:h-64">
                                         <div class="matrix-box bg-blue-50 border-2 border-dashed border-blue-200 p-2 rounded flex flex-col items-center transition-colors min-h-[100px]" data-func="Escape">
                                             <h5 class="text-blue-800 font-bold text-xs uppercase mb-2">Escape / Avoid</h5>
                                             <div class="dropped-container w-full flex flex-wrap gap-1 justify-center"></div>
                                         </div>
                                         <div class="matrix-box bg-green-50 border-2 border-dashed border-green-200 p-2 rounded flex flex-col items-center transition-colors min-h-[100px]" data-func="Attention">
                                             <h5 class="text-green-800 font-bold text-xs uppercase mb-2">Attention</h5>
                                             <div class="dropped-container w-full flex flex-wrap gap-1 justify-center"></div>
                                         </div>
                                         <div class="matrix-box bg-yellow-50 border-2 border-dashed border-yellow-200 p-2 rounded flex flex-col items-center transition-colors min-h-[100px]" data-func="Tangible">
                                             <h5 class="text-yellow-800 font-bold text-xs uppercase mb-2">Tangible / Activity</h5>
                                             <div class="dropped-container w-full flex flex-wrap gap-1 justify-center"></div>
                                         </div>
                                         <div class="matrix-box bg-purple-50 border-2 border-dashed border-purple-200 p-2 rounded flex flex-col items-center transition-colors min-h-[100px]" data-func="Sensory">
                                             <h5 class="text-purple-800 font-bold text-xs uppercase mb-2">Sensory / Automatic</h5>
                                             <div class="dropped-container w-full flex flex-wrap gap-1 justify-center"></div>
                                         </div>
                                     </div>
                                 </div>
                             </div>
                        </div>

                        <!-- Step 3: Record Review -->
                        <div id="step-3-section" class="step-section bg-white rounded-lg shadow-lg">
                            <div class="section-header p-6 flex justify-between items-center border-b">
                                <h2 class="text-2xl font-bold text-gray-800" data-i18n="case_detail.step3_title">Step 3: Record Review</h2>
                                <svg class="chevron w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div class="section-content p-6 pt-2">
                                <div class="flex justify-end mb-4 no-print">
                                    <button id="analyze-records-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md disabled:bg-indigo-300 disabled:cursor-not-allowed" data-i18n="case_detail.analyze_records_btn">Analyze Records with AI</button>
                                </div>
                                <p class="text-sm text-gray-600 mb-4" data-i18n="case_detail.step3_desc">Paste relevant text from student records (e.g., IEPs, psychological evaluations, past FBA reports) below. The AI will summarize key points.</p>
                                <textarea id="record-review-text" rows="10" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Paste record text here..."></textarea>
                                <div id="record-analysis-container" class="mt-6"></div>
                            </div>
                        </div>

                        <!-- Step 4: Visual Hypothesis -->
                        <div id="step-4-section" class="step-section bg-white rounded-lg shadow-lg">
                            <div class="section-header p-6 flex justify-between items-center border-b">
                                <h2 class="text-2xl font-bold text-gray-800" data-i18n="case_detail.step4_title">Step 4: Visual Hypothesis Diagram</h2>
                                <svg class="chevron w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div class="section-content p-6 pt-2">
                                <div class="flex items-center justify-end space-x-2 mb-4 no-print">
                                     <button id="download-svg-btn" class="hidden bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md" data-i18n="case_detail.download_svg">Download SVG</button>
                                    <button id="generate-visual-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow-md disabled:bg-teal-300 disabled:cursor-not-allowed" data-i18n="case_detail.generate_visual_btn">Generate Visual</button>
                                </div>
                                <p class="text-sm text-gray-600 mb-4" data-i18n="case_detail.step4_desc">After completing Steps 1-3, generate a visual summary of the behavioral hypothesis.</p>
                                <div id="visual-hypothesis-container" class="mt-6 p-4 bg-gray-50 rounded-lg min-h-[300px] flex items-center justify-center">
                                     <p id="visual-placeholder" class="text-gray-500" data-i18n="case_detail.visual_placeholder">The visual diagram will appear here once generated.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 5: Critical Decision Point -->
                        <div id="step-5-section" class="step-section bg-white rounded-lg shadow-lg">
                            <div class="section-header p-6 flex justify-between items-center border-b">
                                <h2 class="text-2xl font-bold text-gray-800" data-i18n="case_detail.step5_title">Step 5: The Critical Decision Point (AI-Assisted)</h2>
                                <svg class="chevron w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div class="section-content p-6 pt-2">
                                <p class="text-sm text-gray-600 mb-4" data-i18n="case_detail.step5_desc">This AI-driven checkpoint helps determine the next step by assessing confidence in the hypothesis and potential risks.</p>
                            
                                <!-- NEW: Data Triangulation Section -->
                                <div id="triangulation-wrapper" class="mb-6 bg-indigo-50 p-4 rounded-lg border border-indigo-200 no-print">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <h4 class="font-bold text-indigo-900 text-sm flex items-center">
                                                <span class="text-lg mr-2">üìê</span> Data Triangulation Check
                                            </h4>
                                            <p class="text-xs text-indigo-700">Validate hypothesis by cross-referencing Interview, Records, and Observation data.</p>
                                        </div>
                                        <button id="run-triangulation-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md text-xs transition-colors">
                                            Check Validity
                                        </button>
                                    </div>
                                    <div id="triangulation-container" class="hidden mt-4 animate-fade-in-down"></div>
                                </div>

                                <div id="step-5-initial" class="no-print">
                                    <button id="begin-assessment-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg shadow-md disabled:bg-orange-300 disabled:cursor-not-allowed" data-i18n="case_detail.begin_assessment_btn">
                                        Begin Confidence & Risk Assessment
                                    </button>
                                    <p id="begin-assessment-prompt" class="text-xs text-gray-500 mt-2" data-i18n="case_detail.assessment_prompt_wait">Complete Steps 1-4 to enable this assessment.</p>
                                </div>
                            
                                <div id="assessment-questions-container" class="hidden mt-6 space-y-6 no-print">
                                    <div class="rounded-md bg-gray-50 p-4 border border-gray-200">
                                        <label for="severity-text" class="block text-md font-medium text-gray-800" data-i18n="case_detail.q_severity">1. Severity</label>
                                        <p class="text-sm text-gray-600 mt-1 mb-3" data-i18n="case_detail.q_severity_desc">Describe the severity of the behavior. Does it pose risk of harm?</p>
                                        <textarea id="severity-text" rows="4" class="w-full p-2 border border-gray-300 rounded-md"></textarea>
                                    </div>
                                    <div class="rounded-md bg-gray-50 p-4 border border-gray-200">
                                        <label for="persistence-text" class="block text-md font-medium text-gray-800" data-i18n="case_detail.q_persistence">2. Persistence & History</label>
                                        <p class="text-sm text-gray-600 mt-1 mb-3" data-i18n="case_detail.q_persistence_desc">Describe how long the behavior has been a concern.</p>
                                         <textarea id="persistence-text" rows="4" class="w-full p-2 border border-gray-300 rounded-md"></textarea>
                                    </div>
                                    <div class="rounded-md bg-gray-50 p-4 border border-gray-200">
                                        <label for="complexity-text" class="block text-md font-medium text-gray-800" data-i18n="case_detail.q_complexity">3. Complexity & Confidence</label>
                                        <p class="text-sm text-gray-600 mt-1 mb-3" data-i18n="case_detail.q_complexity_desc">Describe your confidence in the data.</p>
                                        <textarea id="complexity-text" rows="4" class="w-full p-2 border border-gray-300 rounded-md"></textarea>
                                    </div>
                                    <button id="get-recommendation-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md" data-i18n="case_detail.get_rec_btn">Get AI Recommendation</button>
                                </div>
                            
                                <div id="assessment-result-container" class="mt-6"></div>

                                <!-- NEW: Impact Calculator Section -->
                                <div class="mt-8 border-t pt-6 no-print">
                                    <h4 class="font-bold text-gray-800 text-lg mb-2">üìâ Impact Analysis Calculator</h4>
                                    <p class="text-sm text-gray-600 mb-4">Calculate lost instructional time to support resource requests (e.g., 1:1 aid).</p>
                                    <button id="open-impact-calc-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded shadow-sm flex items-center border border-gray-300 transition-colors">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                                        Calculate Impact
                                    </button>
                                    <div id="impact-results-container" class="hidden mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 animate-fade-in-down"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 6: BIP Development -->
                        <div id="step-6-section" class="step-section hidden bg-white rounded-lg shadow-lg">
                            <div class="section-header p-6 flex justify-between items-center border-b">
                                <h2 class="text-2xl font-bold text-gray-800" data-i18n="case_detail.step6_title">Step 6: Behavior Intervention Plan (BIP) Development</h2>
                                <svg class="chevron w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>

                            <div class="section-content p-6 pt-2">
                                <div id="bip-foundation-section">
                                    <h3 class="text-xl font-semibold text-gray-800 mb-4" data-i18n="case_detail.foundational_info">Foundational Information</h3>
                                    <div class="space-y-4">
                                        <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
                                            <label class="block text-sm font-medium text-gray-700" data-i18n="case_detail.hypothesis_label">Hypothesis Statement (from FBA)</label>
                                            <div id="bip-hypothesis" class="mt-1 p-3 bg-white rounded-md text-sm text-gray-800 analysis-content"></div>
                                        </div>
                                        <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
                                            <label for="bip-definition" class="block text-sm font-medium text-gray-700" data-i18n="case_detail.def_label">Operational Definition of Target Behavior</label>
                                            <p class="text-xs text-gray-500 mb-2" data-i18n="case_detail.def_desc">Ensure this is observable and measurable. Refine the definition from Step 1 as needed.</p>
                                            <textarea id="bip-definition" rows="4" class="w-full p-2 border border-gray-300 rounded-md"></textarea>
                                        </div>
                                    </div>
                                    <div class="mt-6 text-right no-print">
                                        <button id="bip-save-foundation-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md" data-i18n="case_detail.save_foundation_btn">Save & Begin BIP</button>
                                    </div>
                                </div>

                                <!-- NEW: Reinforcer Preference Assessment Section -->
                                <div id="preference-assessment-section" class="mt-8 border-t pt-6 hidden no-print">
                                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Reinforcer Inventory</h3>
                                    <div class="bg-pink-50 p-4 rounded-lg border border-pink-200">
                                        <label class="block text-sm font-medium text-pink-900 mb-2">What motivates this student?</label>
                                        <p class="text-xs text-pink-700 mb-3">Identify potential reinforcers to use in the "Respond" strategies.</p>
                                        <div class="flex gap-2 mb-4 flex-wrap sm:flex-nowrap">
                                            <input type="text" id="student-interests" class="flex-grow p-2 border rounded text-sm" placeholder="e.g., Minecraft, drawing, sensory toys, helper tasks...">
                                            <button id="generate-rewards-btn" class="bg-pink-600 text-white px-4 py-2 rounded text-sm hover:bg-pink-700 font-bold shadow-sm whitespace-nowrap">Generate Ideas</button>
                                            <button id="launch-pref-assess-btn" class="bg-purple-600 text-white px-4 py-2 rounded text-sm hover:bg-purple-700 font-bold shadow-sm whitespace-nowrap flex items-center">
                                                <span class="mr-1">üèÜ</span> Run Assessment
                                            </button>
                                        </div>
                                        <div id="reward-ideas-container" class="flex flex-wrap gap-2 mb-4"></div>
                                        <label class="block text-xs font-bold text-pink-900 uppercase mb-1">Confirmed Reinforcers</label>
                                        <textarea id="confirmed-reinforcers" class="w-full p-2 border border-pink-300 rounded text-sm focus:ring-pink-500 focus:border-pink-500" rows="3" placeholder="Selected confirmed reinforcers will appear here..."></textarea>
                                        <div class="mt-2 text-right">
                                             <button id="save-reinforcers-btn" class="bg-pink-600 text-white px-4 py-2 rounded text-sm hover:bg-pink-700 font-bold shadow-sm">Save Reinforcers</button>
                                        </div>
                                    </div>
                                </div>

                                <div id="bip-conversational-builder" class="hidden mt-8 border-t pt-6">
                                    <div id="bip-prevent-section" class="bip-category-section">
                                        <h3 class="text-xl font-semibold text-gray-800 mb-4" data-i18n="case_detail.strategies_prevent">A. Prevent Strategies</h3>
                                        <div id="prevent-chat-container" class="bip-chat-container relative border rounded-lg p-4 bg-gray-50 no-print flex flex-col">
                                            <button class="focus-toggle-btn absolute top-2 right-2 text-gray-400 hover:text-blue-600 p-1 bg-white rounded-full shadow-sm border border-gray-200 z-10 transition-colors" data-target="prevent-chat-container" title="Focus Mode">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>
                                            </button>
                                            <div id="prevent-chat-window" class="chat-window h-96 overflow-y-auto mb-4 flex flex-col space-y-2 p-2 bg-white rounded border border-gray-200"></div>
                                            <div class="flex items-center">
                                                <input type="text" id="prevent-chat-input" class="bip-chat-input flex-grow p-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type your response...">
                                                <button id="prevent-send-btn" class="bip-send-btn bg-blue-600 text-white p-3 rounded-r-lg hover:bg-blue-700 disabled:bg-blue-300" data-i18n="case_detail.send_btn">Send</button>
                                            </div>
                                        </div>
                                        <div id="prevent-content-display" class="bip-content-display hidden analysis-content mt-4 p-6 bg-green-50 border border-green-200 rounded-lg"></div>
                                    </div>

                                    <div id="bip-teach-section" class="hidden bip-category-section mt-8 border-t pt-6">
                                         <h3 class="text-xl font-semibold text-gray-800 mb-4" data-i18n="case_detail.strategies_teach">B. Teach Strategies</h3>
                                        
                                        <!-- NEW: Skill Mapper Container -->
                                        <div id="skill-mapper-container"></div>

                                        <!-- NEW: Task Analysis Container (Option 1) -->
                                        <div id="task-analysis-container"></div>

                                        <div id="teach-chat-container" class="bip-chat-container relative border rounded-lg p-4 bg-gray-50 no-print flex flex-col">
                                            <button class="focus-toggle-btn absolute top-2 right-2 text-gray-400 hover:text-yellow-600 p-1 bg-white rounded-full shadow-sm border border-gray-200 z-10 transition-colors" data-target="teach-chat-container" title="Focus Mode">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>
                                            </button>
                                            <div id="teach-chat-window" class="chat-window h-96 overflow-y-auto mb-4 flex flex-col space-y-2 p-2 bg-white rounded border border-gray-200"></div>
                                            <div class="flex items-center">
                                                <input type="text" id="teach-chat-input" class="bip-chat-input flex-grow p-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder="Type your response...">
                                                <button id="teach-send-btn" class="bip-send-btn bg-yellow-600 text-white p-3 rounded-r-lg hover:bg-yellow-700 disabled:bg-yellow-300" data-i18n="case_detail.send_btn">Send</button>
                                            </div>
                                        </div>
                                        <div id="teach-content-display" class="bip-content-display hidden analysis-content mt-4 p-6 bg-yellow-50 border border-yellow-200 rounded-lg"></div>
                                    </div>
                                    
                                    <div id="bip-respond-section" class="hidden bip-category-section mt-8 border-t pt-6">
                                         <div class="flex justify-between items-center mb-4">
                                             <h3 class="text-xl font-semibold text-gray-800" data-i18n="case_detail.strategies_respond">C. Respond Strategies</h3>
                                             <div class="flex space-x-2 no-print">
                                                 <button id="open-token-board-btn" class="bg-yellow-100 hover:bg-yellow-200 text-yellow-800 border border-yellow-300 font-bold py-2 px-4 rounded-full shadow-sm flex items-center transition-transform active:scale-95">
                                                     <span class="text-xl mr-2">‚≠ê</span> Digital Token Board
                                                 </button>
                                                 <button id="open-choice-board-btn" class="bg-green-100 hover:bg-green-200 text-green-800 border border-green-300 font-bold py-2 px-4 rounded-full shadow-sm flex items-center transition-transform active:scale-95">
                                                     <span class="text-xl mr-2">üéÅ</span> Choice Board
                                                 </button>
                                                 <!-- NEW: Behavior Contract Button -->
                                                 <button id="open-contract-btn" class="bg-indigo-100 hover:bg-indigo-200 text-indigo-800 border border-indigo-300 font-bold py-2 px-4 rounded-full shadow-sm flex items-center transition-transform active:scale-95">
                                                     <span class="text-xl mr-2">üìú</span> Behavior Contract
                                                 </button>
                                             </div>
                                         </div>
                                        <div id="respond-chat-container" class="bip-chat-container relative border rounded-lg p-4 bg-gray-50 no-print flex flex-col">
                                            <button class="focus-toggle-btn absolute top-2 right-2 text-gray-400 hover:text-red-600 p-1 bg-white rounded-full shadow-sm border border-gray-200 z-10 transition-colors" data-target="respond-chat-container" title="Focus Mode">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>
                                            </button>
                                            <div id="respond-chat-window" class="chat-window h-96 overflow-y-auto mb-4 flex flex-col space-y-2 p-2 bg-white rounded border border-gray-200"></div>
                                            <div class="flex items-center">
                                                <input type="text" id="respond-chat-input" class="bip-chat-input flex-grow p-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Type your response...">
                                                <button id="respond-send-btn" class="bip-send-btn bg-red-600 text-white p-3 rounded-r-lg hover:bg-red-700 disabled:bg-red-300" data-i18n="case_detail.send_btn">Send</button>
                                            </div>
                                        </div>
                                        <div id="respond-content-display" class="bip-content-display hidden analysis-content mt-4 p-6 bg-red-50 border border-red-200 rounded-lg"></div>

                                        <!-- NEW: Restorative Debrief Assistant -->
                                        <div class="mt-4 bg-indigo-50 p-4 rounded-lg border border-indigo-200 no-print">
                                            <div class="flex justify-between items-center mb-2">
                                                <h5 class="font-bold text-indigo-900">ü§ù Restorative Debrief Script</h5>
                                                <span class="text-xs text-indigo-700">Guide for post-incident reflection</span>
                                            </div>
                                            <p class="text-xs text-indigo-800 mb-3">Generate a script to help the student understand impact and repair harm once calm.</p>
                                            <div class="flex gap-2">
                                                <select id="debrief-age-group" class="p-2 border rounded text-sm bg-white">
                                                    <option value="young">Early Childhood (3-6)</option>
                                                    <option value="elementary">Elementary (7-11)</option>
                                                    <option value="teen">Secondary (12+)</option>
                                                </select>
                                                <button id="generate-debrief-btn" class="bg-indigo-600 text-white px-3 py-1 rounded text-sm hover:bg-indigo-700 font-bold shadow-sm whitespace-nowrap">
                                                    Generate Script
                                                </button>
                                            </div>
                                            <div id="debrief-output" class="hidden mt-3 p-3 bg-white border border-indigo-100 rounded text-sm italic text-gray-700 leading-relaxed whitespace-pre-wrap"></div>
                                        </div>
                                    </div>

                                    <!-- NEW: Crisis Intervention Plan Section -->
                                    <div id="bip-crisis-section" class="mt-8 border-t pt-6 bg-red-50 p-4 rounded-lg border border-red-200">
                                        <div class="flex items-center mb-4">
                                            <span class="text-2xl mr-2">üö®</span>
                                            <h3 class="text-xl font-bold text-red-900">Crisis Intervention Plan</h3>
                                        </div>
                                        <p class="text-sm text-red-800 mb-3">Specific protocols for when behavior poses immediate danger to self or others.</p>
                                        
                                        <label class="block text-xs font-bold text-red-900 uppercase mb-1">Emergency Steps (Before/During/After)</label>
                                        <textarea id="bip-crisis-text" rows="5" class="w-full p-2 border border-red-300 rounded-md focus:ring-red-500 focus:border-red-500" placeholder="1. Ensure safety of other students...&#10;2. Call support team..."></textarea>
                                        
                                        <div class="mt-4 text-right no-print flex justify-end space-x-2">
                                            <button id="visualize-crisis-btn" class="bg-white hover:bg-red-50 text-red-700 border border-red-300 font-bold py-2 px-4 rounded-lg shadow-sm flex items-center transition-colors">
                                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path></svg>
                                                Visualize Flowchart
                                            </button>
                                            <button id="save-crisis-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">Save Crisis Plan</button>
                                        </div>
                                        <div id="crisis-visual-container" class="mt-6 bg-white rounded-lg p-4 border border-red-100 shadow-inner hidden text-center overflow-x-auto"></div>
                                    </div>

                                    <!-- NEW: Acting-Out Cycle Visualizer (Option 1) -->
                                    <div id="acting-out-cycle-section" class="mt-8 border-t pt-6 bg-white rounded-lg p-6 shadow-sm border border-gray-200">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="text-xl font-bold text-gray-800 flex items-center">
                                                <span class="text-2xl mr-2">üìâ</span> The Acting-Out Cycle
                                            </h3>
                                            <span class="text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded border border-indigo-200">Colvin & Sugai Model</span>
                                        </div>
                                        <p class="text-sm text-gray-600 mb-6">Map strategies to the specific phase of escalation. Click a phase on the curve to edit.</p>
                                        
                                        <!-- SVG Curve Container -->
                                        <div id="cycle-svg-container" class="w-full h-64 border-b border-gray-200 relative mb-6 select-none bg-gray-50 rounded-lg overflow-hidden">
                                            <!-- SVG injected via JS -->
                                        </div>

                                        <!-- Edit Area -->
                                        <div id="cycle-edit-area" class="hidden bg-indigo-50 p-4 rounded-lg border border-indigo-200 animate-fade-in-down">
                                            <div class="flex justify-between items-center mb-4">
                                                <h4 id="cycle-phase-title" class="font-bold text-lg text-indigo-900">Phase: Agitation</h4>
                                                <button onclick="document.getElementById('cycle-edit-area').classList.add('hidden')" class="text-indigo-400 hover:text-indigo-600">‚úï</button>
                                            </div>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div>
                                                    <label class="block text-xs font-bold text-indigo-800 uppercase mb-1">Student Looks Like:</label>
                                                    <textarea id="cycle-student-behavior" class="w-full p-2 border border-indigo-300 rounded text-sm focus:ring-indigo-500 focus:border-indigo-500" rows="3" placeholder="e.g., Tapping pencil, rapid speech..."></textarea>
                                                </div>
                                                <div>
                                                    <label class="block text-xs font-bold text-indigo-800 uppercase mb-1">Staff Should Do:</label>
                                                    <textarea id="cycle-staff-response" class="w-full p-2 border border-indigo-300 rounded text-sm focus:ring-indigo-500 focus:border-indigo-500" rows="3" placeholder="e.g., Validate feelings, offer choice..."></textarea>
                                                </div>
                                            </div>
                                            <div class="mt-4 flex justify-end gap-2">
                                                <button id="cycle-ai-suggest-btn" class="text-xs bg-white text-indigo-600 border border-indigo-200 px-3 py-2 rounded hover:bg-indigo-50 font-bold shadow-sm flex items-center">
                                                    <span class="mr-1">‚ú®</span> AI Suggest
                                                </button>
                                                <button id="cycle-save-btn" class="text-xs bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 font-bold shadow-md">Save Phase</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="bip-goal-section" class="hidden mt-8 border-t pt-6">
                                    <h3 class="text-xl font-semibold text-gray-800 mb-4" data-i18n="case_detail.goal_monitoring_title">Goal Formation & Progress Monitoring</h3>
                                    <div id="bip-goal-inputs" class="no-print">
                                        <p class="text-sm text-gray-600 mb-4" data-i18n="case_detail.goal_inputs_desc">Define a clear, measurable goal and outline your initial ideas.</p>
                                        <div class="space-y-4 bg-gray-50 p-4 rounded-lg border">
                                            <!-- NEW: Intervention Start Date Input -->
                                            <div class="border-b border-gray-200 pb-4 mb-2">
                                                <label for="bip-start-date" class="block text-sm font-medium text-blue-800">üìâ Intervention Start Date (Phase Change)</label>
                                                <p class="text-xs text-gray-500 mb-2">Select the date when this plan was implemented. The charts will draw a phase line to show effectiveness.</p>
                                                <input type="date" id="bip-start-date" class="w-full md:w-1/3 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
                                            </div>

                                            <!-- REPLACED: SMART Goal Builder Wizard -->
                                            <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                                                <div class="flex justify-between items-center mb-3">
                                                    <label class="block text-sm font-bold text-gray-700 uppercase tracking-wide">üèÜ SMART Goal Builder</label>
                                                    <span class="text-[10px] text-gray-400 bg-gray-100 px-2 py-1 rounded hidden sm:inline-block">Specific ‚Ä¢ Measurable ‚Ä¢ Achievable ‚Ä¢ Relevant ‚Ä¢ Time-bound</span>
                                                </div>
                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                                    <div>
                                                        <label class="block text-xs font-semibold text-gray-500 mb-1">Condition (When?)</label>
                                                        <input type="text" id="goal-condition" placeholder="e.g., Given a difficult math task..." class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 goal-builder-input">
                                                    </div>
                                                    <div>
                                                        <label class="block text-xs font-semibold text-gray-500 mb-1">Student (Who?)</label>
                                                        <input type="text" id="goal-student" placeholder="e.g., Sam..." class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 goal-builder-input">
                                                    </div>
                                                    <div>
                                                        <label class="block text-xs font-semibold text-gray-500 mb-1">Replacement Behavior (What?)</label>
                                                        <input type="text" id="goal-behavior" placeholder="e.g., will ask for a break..." class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 goal-builder-input">
                                                    </div>
                                                    <div>
                                                        <label class="block text-xs font-semibold text-gray-500 mb-1">Criteria (How much?)</label>
                                                        <input type="text" id="goal-criteria" placeholder="e.g., in 4 out of 5 opportunities." class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 goal-builder-input">
                                                    </div>
                                                    <!-- NEW: IEP Fields (Option 3) -->
                                                    <div>
                                                        <label class="block text-xs font-semibold text-gray-500 mb-1">Current Baseline Data</label>
                                                        <input type="text" id="goal-baseline" placeholder="e.g., Currently occurs 5 times per day..." class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 goal-builder-input">
                                                    </div>
                                                    <div>
                                                        <label class="block text-xs font-semibold text-gray-500 mb-1">Method of Evaluation</label>
                                                        <select id="goal-method" class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 goal-builder-input bg-white">
                                                            <option value="data collection">Data Collection</option>
                                                            <option value="observation">Teacher Observation</option>
                                                            <option value="work samples">Work Samples</option>
                                                            <option value="rubric">Rubric</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="p-3 bg-blue-50 border border-blue-100 rounded-lg transition-all duration-300">
                                                    <span class="text-xs text-blue-500 uppercase font-bold tracking-wide block mb-1">Goal Preview:</span>
                                                    <p id="goal-preview" class="text-sm font-medium text-blue-900 italic min-h-[1.25rem]">Complete the fields above...</p>
                                                </div>
                                                <!-- Hidden input for compatibility with existing save logic -->
                                                <textarea id="bip-goal-text" class="hidden"></textarea>
                                            </div>

                                            <div>
                                                <label for="bip-monitoring-text" class="block text-sm font-medium text-gray-700" data-i18n="case_detail.monitor_label">Monitoring Plan Ideas</label>
                                                <p class="text-xs text-gray-500 mb-1" data-i18n="case_detail.monitor_help">How often will you collect data? (e.g., "Daily for 2 weeks.")</p>
                                                <textarea id="bip-monitoring-text" rows="3" class="w-full p-2 border border-gray-300 rounded-md"></textarea>
                                            </div>
                                            <div class="flex justify-end gap-2 mt-2">
                                                <button id="gas-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center transition-colors">
                                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                                    Create GAS Rubric
                                                </button>
                                                <button id="generate-monitoring-plan-btn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg shadow-md" data-i18n="case_detail.generate_plan_btn">Generate Plan with AI</button>
                                            </div>
                                            <div id="gas-container" class="hidden mt-6 animate-fade-in-down"></div>
                                        </div>
                                    </div>
                                    <div id="monitoring-plan-display" class="hidden analysis-content mt-4 p-6 bg-cyan-50 border border-cyan-200 rounded-lg"></div>
                                </div>

                                <!-- NEW: BIP Quality Audit Section -->
                                <div id="bip-audit-section" class="hidden mt-8 border-t pt-6 no-print">
                                     <h3 class="text-xl font-semibold text-gray-800 mb-4">Quality Audit</h3>
                                     <p class="text-sm text-gray-600 mb-4">Get an AI supervisor to review the plan for best practices before finalizing.</p>
                                     <button id="audit-bip-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">Run Quality Audit</button>
                                     <div id="bip-audit-result" class="hidden analysis-content mt-4 p-6 bg-purple-50 border border-purple-200 rounded-lg"></div>
                                </div>

                                <!-- NEW: Teacher Fidelity Checklist Section (Option 2) -->
                                <div id="fidelity-section" class="hidden mt-8 border-t pt-6 no-print">
                                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Implementation Fidelity</h3>
                                    <p class="text-sm text-gray-600 mb-4">Generate a daily checklist for teachers to track implementation consistency.</p>
                                    <button id="generate-fidelity-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                                        Generate Daily Checklist
                                    </button>
                                    <div id="fidelity-preview" class="mt-4 hidden p-4 bg-white border border-gray-200 rounded-lg shadow-sm overflow-x-auto"></div>
                                </div>

                                <!-- NEW: Feasibility Check Section (Option 1) -->
                                <div id="feasibility-check-section" class="hidden mt-8 border-t pt-6 bg-gray-50 p-4 rounded-lg border border-gray-200 no-print">
                                    <div class="flex justify-between items-center cursor-pointer select-none" onclick="this.nextElementSibling.classList.toggle('hidden'); this.querySelector('.chevron-feasibility').classList.toggle('rotate-180')">
                                        <h3 class="text-xl font-semibold text-gray-800">‚öñÔ∏è Intervention Feasibility Check</h3>
                                        <div class="flex items-center space-x-2">
                                            <span class="text-xs text-blue-600 font-bold">Check Contextual Fit</span>
                                            <svg class="chevron-feasibility w-5 h-5 text-gray-400 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                        </div>
                                    </div>
                                    <div class="hidden mt-4 space-y-4">
                                        <p class="text-sm text-gray-600">Rate the following to ensure the plan works in the real classroom:</p>
                                        
                                        <div class="grid grid-cols-1 gap-3 text-sm">
                                            <div class="flex justify-between items-center bg-white p-2 rounded border">
                                                <span>1. Are there enough staff to run this plan?</span>
                                                <select class="feasibility-score p-1 border rounded bg-white"><option value="1">No</option><option value="2">Barely</option><option value="3" selected>Yes</option></select>
                                            </div>
                                            <div class="flex justify-between items-center bg-white p-2 rounded border">
                                                <span>2. Does the teacher have the skills needed?</span>
                                                <select class="feasibility-score p-1 border rounded bg-white"><option value="1">Training Needed</option><option value="2">Some</option><option value="3" selected>Yes</option></select>
                                            </div>
                                            <div class="flex justify-between items-center bg-white p-2 rounded border">
                                                <span>3. Is the plan too disruptive to other students?</span>
                                                <select class="feasibility-score p-1 border rounded bg-white"><option value="1">Very Disruptive</option><option value="2">Somewhat</option><option value="3" selected>Not Disruptive</option></select>
                                            </div>
                                            <div class="flex justify-between items-center bg-white p-2 rounded border">
                                                <span>4. Are materials (tokens/timers) easily accessible?</span>
                                                <select class="feasibility-score p-1 border rounded bg-white"><option value="1">No</option><option value="2">Maybe</option><option value="3" selected>Yes</option></select>
                                            </div>
                                            <div class="flex justify-between items-center bg-white p-2 rounded border">
                                                <span>5. Is the administrative support sufficient?</span>
                                                <select class="feasibility-score p-1 border rounded bg-white"><option value="1">No</option><option value="2">Some</option><option value="3" selected>Yes</option></select>
                                            </div>
                                        </div>

                                        <button id="calc-feasibility-btn" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold shadow hover:bg-blue-700 w-full sm:w-auto">Calculate Fit Score</button>
                                        <div id="feasibility-result" class="hidden p-3 rounded border text-sm mt-2 font-medium"></div>
                                    </div>
                                </div>

                                <!-- NEW: Data Sheet Generator Section -->
                                <div id="datasheet-section" class="hidden mt-8 border-t pt-6 no-print">
                                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Data Collection Sheets</h3>
                                    <p class="text-sm text-gray-600 mb-4">Generate printable data sheets for classroom staff.</p>
                                    <div class="flex flex-wrap gap-2">
                                        <button class="gen-sheet-btn bg-white hover:bg-indigo-50 text-indigo-700 font-bold py-2 px-4 rounded border border-indigo-200 shadow-sm flex items-center transition-colors" data-type="frequency">
                                            <span class="mr-2">üìä</span> Frequency Count
                                        </button>
                                        <button class="gen-sheet-btn bg-white hover:bg-indigo-50 text-indigo-700 font-bold py-2 px-4 rounded border border-indigo-200 shadow-sm flex items-center transition-colors" data-type="duration">
                                            <span class="mr-2">‚è±Ô∏è</span> Duration Log
                                        </button>
                                        <button class="gen-sheet-btn bg-white hover:bg-indigo-50 text-indigo-700 font-bold py-2 px-4 rounded border border-indigo-200 shadow-sm flex items-center transition-colors" data-type="abc">
                                            <span class="mr-2">üìù</span> ABC Checklist
                                        </button>
                                    </div>
                                </div>

                                <div id="report-download-container" class="hidden mt-8 text-center border-t pt-6 no-print">
                                    <h3 class="text-xl font-semibold text-gray-800 mb-4" data-i18n="case_detail.bip_complete_title">BIP Complete</h3>
                                    <p class="text-sm text-gray-600 mb-4" data-i18n="case_detail.bip_complete_desc">All sections of the BIP have been generated.</p>
                                    
                                    <!-- NEW: Role-Based Snapshot Section (Option 2) -->
                                    <div class="mb-6 bg-blue-50 p-4 rounded-lg border border-blue-200 text-left shadow-sm">
                                        <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                                            <div>
                                                <h5 class="font-bold text-blue-900 flex items-center text-sm">
                                                    <span class="text-xl mr-2">üë•</span> Role-Based Snapshots
                                                </h5>
                                                <p class="text-xs text-blue-700 mt-1">Generate a concise 1-page guide tailored for specific staff.</p>
                                            </div>
                                            <div class="flex gap-2 w-full sm:w-auto">
                                                <select id="snapshot-role" class="p-2 border border-blue-300 rounded text-sm flex-grow bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                                                    <option value="Substitute Teacher">Substitute Teacher</option>
                                                    <option value="Bus Driver">Bus Driver</option>
                                                    <option value="Cafeteria Monitor">Cafeteria Monitor</option>
                                                    <option value="Art/PE Teacher">Specials (Art/PE) Teacher</option>
                                                    <option value="Paraprofessional">Paraprofessional</option>
                                                </select>
                                                <button id="generate-snapshot-btn" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold shadow hover:bg-blue-700 whitespace-nowrap transition-transform active:scale-95 flex items-center">
                                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                                                    PDF
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- NEW: Report Sections Selector -->
                                    <div class="mb-6 bg-gray-50 p-4 rounded border border-gray-200 inline-block text-left">
                                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Report Sections to Include:</label>
                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 text-sm">
                                            <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-1 rounded">
                                                <input type="checkbox" id="chk-fba" checked class="rounded text-blue-600 focus:ring-blue-500 h-4 w-4"> 
                                                <span class="text-gray-700">I. FBA (Interview, Records, ABC)</span>
                                            </label>
                                            <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-1 rounded">
                                                <input type="checkbox" id="chk-visual" checked class="rounded text-blue-600 focus:ring-blue-500 h-4 w-4"> 
                                                <span class="text-gray-700">II. Visual Hypothesis</span>
                                            </label>
                                            <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-1 rounded">
                                                <input type="checkbox" id="chk-decision" checked class="rounded text-blue-600 focus:ring-blue-500 h-4 w-4"> 
                                                <span class="text-gray-700">III. Critical Decision</span>
                                            </label>
                                            <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-1 rounded">
                                                <input type="checkbox" id="chk-bip" checked class="rounded text-blue-600 focus:ring-blue-500 h-4 w-4"> 
                                    <div class="flex justify-center space-x-4 flex-wrap gap-y-2">
                                        <button id="preview-report-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md flex items-center">
                                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                            Preview
                                        </button>
                                        <button id="download-report-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md" data-i18n="case_detail.download_report_btn">Download PDF Report</button>
                                        <button id="download-word-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md flex items-center">
                                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"/></svg>
                                            Download Word Doc
                                        </button>
                                        <!-- NEW: Pocket BIP Button -->
                                        <button id="download-pocket-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-lg shadow-md flex items-center" title="Download 4x6 Index Card PDF">
                                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0c0 .854.69 1.516 1.636 1.912"></path></svg>
                                            Pocket BIP
                                        </button>
                                        <!-- NEW: Traffic Light Button -->
                                        <button id="download-traffic-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-lg shadow-md flex items-center" title="Download Traffic Light Visual Plan">
                                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><circle cx="12" cy="8" r="1.5" fill="currentColor"/><circle cx="12" cy="12" r="1.5" fill="currentColor"/><circle cx="12" cy="16" r="1.5" fill="currentColor"/></svg>
                                            Traffic Light
                                        </button>
                                        <!-- NEW: Launch Wizard Button -->
                                        <button id="create-rollout-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow-md flex items-center" title="Create a phased implementation schedule">
                                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                            Launch Plan
                                        </button>
                                        <!-- NEW: Roleplay Simulator Button (Option 3) -->
                                        <button id="start-sim-btn" class="bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 px-6 rounded-lg shadow-md flex items-center" title="Practice with AI Student">
                                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                            Roleplay Sim
                                        </button>
                                        <!-- NEW: Staff Fluency Game Button (Option 3) -->
                                        <button id="launch-fluency-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-lg shadow-md flex items-center" title="Rapid-fire training game">
                                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                            Fluency Game
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Global Quick Log FAB -->
                <button id="global-quick-log-btn" class="fixed bottom-32 right-8 bg-blue-600 text-white rounded-full p-4 shadow-lg z-40 hover:bg-blue-700 transition-transform hover:scale-110 no-print flex items-center justify-center" title="Quick Log Observation">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="report-preview-modal" class="hidden modal-overlay">
        <div class="modal-content shadow-xl max-w-4xl h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-800">Report Preview</h3>
                <button id="close-preview-btn" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="report-preview-content" class="flex-grow overflow-y-auto p-8 bg-gray-50 border rounded shadow-inner"></div>
            <div class="mt-4 flex justify-end space-x-2">
                <button id="preview-close-bottom-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded">Close</button>
                <button id="preview-download-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded shadow-md">Download PDF</button>
            </div>
        </div>
    </div>

        <!-- Restoring Missing New Case Modal -->
        <div id="new-case-modal" class="hidden modal-overlay">
        <div class="modal-content shadow-xl">
            <h3 class="text-2xl font-bold mb-6" data-i18n="modals.new_case_title">Create a New Case</h3>
            <form id="new-case-form">
                <div class="mb-4">
                    <label for="student-name" class="block text-sm font-medium text-gray-700" data-i18n="modals.student_name">Codename / Identifier</label>
                    <input type="text" id="student-name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                    <p class="text-xs text-gray-500 mt-1" data-i18n="modals.privacy_hint">For privacy, please use a codename or ID (e.g., 'Student A'), not real names.</p>
                </div>
                <div class="mb-6">
                    <label for="student-grade" class="block text-sm font-medium text-gray-700" data-i18n="modals.grade">Grade Level</label>
                    <input type="text" id="student-grade" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required placeholder="e.g. 5th, K, 10">
                </div>
                <p id="modal-error" class="mb-4 text-xs text-red-600"></p>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-modal-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg" data-i18n="modals.cancel">Cancel</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg" data-i18n="modals.create">Create Case</button>
                </div>
            </form>
        </div>
    </div>

    <div id="abc-modal" class="hidden modal-overlay">
        <div class="modal-content shadow-xl">
            <h3 id="abc-modal-title" class="text-2xl font-bold mb-6" data-i18n="modals.abc_title_add">Add ABC Observation</h3>
            <form id="abc-form">
                <!-- AI Magic Fill Section -->
                <div class="mb-6 bg-blue-50 p-3 rounded-lg border border-blue-100">
                    <label class="block text-sm font-bold text-blue-800 mb-1">‚ú® AI Magic Fill</label>
                    <p class="text-xs text-blue-600 mb-2">Type a sentence like "Sam threw a pencil at 10:30am because he was frustrated with writing."</p>
                    <div class="flex gap-2">
                        <input type="text" id="magic-fill-input" class="flex-grow p-2 border border-blue-200 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Describe the incident naturally...">
                        <button type="button" id="magic-fill-btn" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 font-medium transition-colors">Fill</button>
                    </div>
                </div>

                <!-- Quick Scenarios Section -->
                <div class="mb-4 border-b pb-4">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">‚ö° Quick Scenarios</label>
                    <div class="flex flex-wrap gap-2">
                        <button type="button" class="scenario-btn text-xs bg-purple-100 hover:bg-purple-200 text-purple-800 border border-purple-200 rounded px-3 py-2 transition-colors" 
                                data-ant="Teacher presented academic demand" 
                                data-beh="Verbal refusal, put head down" 
                                data-cons="Teacher removed demand, sent to break">
                            üìö Escape Task
                        </button>
                        <button type="button" class="scenario-btn text-xs bg-red-100 hover:bg-red-200 text-red-800 border border-red-200 rounded px-3 py-2 transition-colors" 
                                data-ant="Peer took preferred toy" 
                                data-beh="Hit peer, grabbed toy back" 
                                data-cons="Toy returned to peer, reprimand given">
                            üß∏ Peer Conflict
                        </button>
                        <button type="button" class="scenario-btn text-xs bg-yellow-100 hover:bg-yellow-200 text-yellow-800 border border-yellow-200 rounded px-3 py-2 transition-colors" 
                                data-ant="Transition to non-preferred activity" 
                                data-beh="Elopement from room" 
                                data-cons="Staff followed, encouraged return">
                            üèÉ Elopement
                        </button>
                    </div>
                </div>

                <!-- NEW: Dynamic History Chips Container -->
                <div id="history-chips-container" class="mb-4 border-b pb-4 hidden"></div>

                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                    <div><label for="observation-date" class="block text-sm font-medium text-gray-700" data-i18n="modals.date">Date of Observation</label><input type="date" id="observation-date" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required></div>
                    <div><label for="observation-time" class="block text-sm font-medium text-gray-700" data-i18n="modals.time">Time (Optional)</label><input type="time" id="observation-time" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div>
                    <!-- Stopwatch UI -->
                    <div class="col-span-2 md:col-span-1 bg-gray-50 p-2 rounded border border-gray-200 text-center">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">‚è± Stopwatch</label>
                        <div id="stopwatch-display" class="text-xl font-mono font-bold text-gray-800 mb-2">00:00</div>
                        <div class="flex justify-center space-x-2">
                            <button type="button" id="start-timer-btn" class="bg-green-500 text-white text-xs px-2 py-1 rounded hover:bg-green-600">Start</button>
                            <button type="button" id="stop-timer-btn" class="bg-red-500 text-white text-xs px-2 py-1 rounded hover:bg-red-600" disabled>Stop</button>
                            <button type="button" id="reset-timer-btn" class="text-gray-500 text-xs px-2 py-1 hover:text-gray-700">Reset</button>
                        </div>
                    </div>
                    <!-- Duration (Pushed to next line on mobile, wraps on desktop if needed) -->
                    <div class="col-span-2 md:col-span-1">
                        <label for="duration" class="block text-sm font-medium text-gray-700">Duration (mins)</label>
                        <input type="number" id="duration" min="0" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="e.g. 15">
                    </div>
                </div>
                
                <!-- Intensity Slider -->
                <div class="mb-4 bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <label for="intensity-range" class="block text-sm font-medium text-gray-700 flex justify-between items-center mb-2">
                        <span>Intensity / Severity</span>
                        <span id="intensity-display" class="font-bold text-yellow-600 bg-yellow-100 px-2 py-0.5 rounded text-xs border border-yellow-200">5</span>
                    </label>
                    <input type="range" id="intensity-range" min="1" max="10" value="5" step="1" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    <div class="flex justify-between text-xs text-gray-500 mt-1 font-medium">
                        <span>1 (Mild)</span>
                        <span>5 (Disruptive)</span>
                        <span>10 (Dangerous)</span>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="setting-context" class="block text-sm font-medium text-gray-700">Setting / Activity</label>
                    <select id="setting-context" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="">Select Setting...</option>
                        <option value="Whole Group Instruction">Whole Group Instruction</option>
                        <option value="Independent Work">Independent Work</option>
                        <option value="Small Group">Small Group</option>
                        <option value="Unstructured/Recess">Unstructured / Recess</option>
                        <option value="Transition">Transition</option>
                        <option value="Cafeteria">Cafeteria</option>
                        <option value="Specials">Specials (Art/PE/Music)</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <!-- Setting Events Section -->
                <div class="mb-4 bg-orange-50 p-3 rounded-lg border border-orange-100">
                    <div class="flex items-center mb-2">
                        <label class="block text-xs font-bold text-orange-800 uppercase mr-2">üê¢ Setting Events (Slow Triggers)</label>
                        <span data-glossary-key="setting_event"></span>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <label class="flex items-center space-x-2"><input type="checkbox" name="setting_event" value="Fatigue/No Sleep" class="rounded text-orange-600 focus:ring-orange-500"> <span>Fatigue / No Sleep</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" name="setting_event" value="Hunger/Thirst" class="rounded text-orange-600 focus:ring-orange-500"> <span>Hunger / Thirst</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" name="setting_event" value="Change in Routine" class="rounded text-orange-600 focus:ring-orange-500"> <span>Change in Routine</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" name="setting_event" value="Missed Medication" class="rounded text-orange-600 focus:ring-orange-500"> <span>Missed Meds</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" name="setting_event" value="Conflict at Home" class="rounded text-orange-600 focus:ring-orange-500"> <span>Home Conflict</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" name="setting_event" value="Illness" class="rounded text-orange-600 focus:ring-orange-500"> <span>Illness</span></label>
                    </div>
                </div>

                <div class="mb-4">
                    <div class="flex justify-between items-center mb-1">
                        <div class="flex items-center">
                            <label for="antecedent" class="block text-sm font-medium text-gray-700 mr-1" data-i18n="modals.ant_label">Antecedent</label>
                            <span data-glossary-key="antecedent"></span>
                        </div>
                        <button type="button" class="mic-btn text-gray-400 hover:text-red-500 transition-colors p-1" title="Dictate" data-target="antecedent">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mb-1" data-i18n="modals.ant_help">What happened immediately before the behavior?</p>
                    <!-- Quick Entry Chips: Antecedent -->
                    <div class="flex flex-wrap gap-2 mb-2">
                        <button type="button" class="preset-chip text-xs bg-gray-50 hover:bg-blue-100 text-gray-600 border border-gray-200 rounded px-2 py-1 transition-colors" data-target="antecedent" data-value="Teacher demand">Teacher demand</button>
                        <button type="button" class="preset-chip text-xs bg-gray-50 hover:bg-blue-100 text-gray-600 border border-gray-200 rounded px-2 py-1 transition-colors" data-target="antecedent" data-value="Transition">Transition</button>
                        <button type="button" class="preset-chip text-xs bg-gray-50 hover:bg-blue-100 text-gray-600 border border-gray-200 rounded px-2 py-1 transition-colors" data-target="antecedent" data-value="Peer conflict">Peer conflict</button>
                        <button type="button" class="preset-chip text-xs bg-gray-50 hover:bg-blue-100 text-gray-600 border border-gray-200 rounded px-2 py-1 transition-colors" data-target="antecedent" data-value="Denied item">Denied item</button>
                    </div>
                    <input type="text" id="antecedent" list="ant-options" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Type or select from history..." required autocomplete="off">
                    <datalist id="ant-options"></datalist>
                </div>

                <div class="mb-4">
                    <div class="flex justify-between items-center mb-1">
                        <div class="flex items-center">
                            <label for="behavior" class="block text-sm font-medium text-gray-700 mr-1" data-i18n="modals.beh_label">Behavior</label>
                            <span data-glossary-key="behavior"></span>
                        </div>
                        <button type="button" class="mic-btn text-gray-400 hover:text-red-500 transition-colors p-1" title="Dictate" data-target="behavior">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mb-1" data-i18n="modals.beh_help">Describe the behavior exactly as it occurred.</p>
                    <!-- Quick Entry Chips: Behavior -->
                    <div class="flex flex-wrap gap-2 mb-2">
                        <button type="button" class="preset-chip text-xs bg-gray-50 hover:bg-blue-100 text-gray-600 border border-gray-200 rounded px-2 py-1 transition-colors" data-target="behavior" data-value="Yelling">Yelling</button>
                        <button type="button" class="preset-chip text-xs bg-gray-50 hover:bg-blue-100 text-gray-600 border border-gray-200 rounded px-2 py-1 transition-colors" data-target="behavior" data-value="Hitting">Hitting</button>
                        <button type="button" class="preset-chip text-xs bg-gray-50 hover:bg-blue-100 text-gray-600 border border-gray-200 rounded px-2 py-1 transition-colors" data-target="behavior" data-value="Work refusal">Refusal</button>
                        <button type="button" class="preset-chip text-xs bg-gray-50 hover:bg-blue-100 text-gray-600 border border-gray-200 rounded px-2 py-1 transition-colors" data-target="behavior" data-value="Elopement">Elopement</button>
                    </div>
                    <input type="text" id="behavior" list="beh-options" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Type or select from history..." required autocomplete="off">
                    <datalist id="beh-options"></datalist>
                </div>

                <div class="mb-6">
                    <div class="flex justify-between items-center mb-1">
                        <div class="flex items-center">
                            <label for="consequence" class="block text-sm font-medium text-gray-700 mr-1" data-i18n="modals.cons_label">Consequence</label>
                            <span data-glossary-key="consequence"></span>
                        </div>
                        <button type="button" class="mic-btn text-gray-400 hover:text-red-500 transition-colors p-1" title="Dictate" data-target="consequence">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mb-1" data-i18n="modals.cons_help">What happened immediately after the behavior?</p>
                    <!-- Quick Entry Chips: Consequence -->
                    <div class="flex flex-wrap gap-2 mb-2">
                        <button type="button" class="preset-chip text-xs bg-gray-50 hover:bg-blue-100 text-gray-600 border border-gray-200 rounded px-2 py-1 transition-colors" data-target="consequence" data-value="Verbal reprimand">Reprimand</button>
                        <button type="button" class="preset-chip text-xs bg-gray-50 hover:bg-blue-100 text-gray-600 border border-gray-200 rounded px-2 py-1 transition-colors" data-target="consequence" data-value="Ignored">Ignored</button>
                        <button type="button" class="preset-chip text-xs bg-gray-50 hover:bg-blue-100 text-gray-600 border border-gray-200 rounded px-2 py-1 transition-colors" data-target="consequence" data-value="Sent to office">Office</button>
                        <button type="button" class="preset-chip text-xs bg-gray-50 hover:bg-blue-100 text-gray-600 border border-gray-200 rounded px-2 py-1 transition-colors" data-target="consequence" data-value="Loss of privilege">Loss of privilege</button>
                    </div>
                    <input type="text" id="consequence" list="cons-options" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Type or select from history..." required autocomplete="off">
                    <datalist id="cons-options"></datalist>
                </div>
                
                <!-- NEW: Perceived Function Section -->
                <div class="mb-6">
                    <div class="flex items-center mb-2">
                        <label class="block text-sm font-medium text-gray-700 mr-2">Perceived Function (Optional)</label>
                        <span data-glossary-key="function"></span>
                    </div>
                    <div class="flex flex-wrap gap-2" id="function-selector">
                        <button type="button" class="func-chip text-xs bg-gray-50 hover:bg-gray-100 text-gray-600 border border-gray-200 rounded px-3 py-2 transition-colors" data-value="Escape">Escape</button>
                        <button type="button" class="func-chip text-xs bg-gray-50 hover:bg-gray-100 text-gray-600 border border-gray-200 rounded px-3 py-2 transition-colors" data-value="Attention">Attention</button>
                        <button type="button" class="func-chip text-xs bg-gray-50 hover:bg-gray-100 text-gray-600 border border-gray-200 rounded px-3 py-2 transition-colors" data-value="Access to Tangible">Access to Tangible</button>
                        <button type="button" class="func-chip text-xs bg-gray-50 hover:bg-gray-100 text-gray-600 border border-gray-200 rounded px-3 py-2 transition-colors" data-value="Sensory/Automatic">Sensory/Automatic</button>
                    </div>
                    <input type="hidden" id="perceived-function">
                </div>

                <p id="abc-modal-error" class="mb-4 text-xs text-red-600"></p>
                <div class="flex justify-end space-x-4"><button type="button" id="cancel-abc-modal-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg" data-i18n="modals.cancel">Cancel</button><button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg" data-i18n="modals.save_obs">Save Observation</button></div>
            </form>
        </div>
    </div>
    
    <!-- ... existing modals ... -->
    <div id="delete-confirm-modal" class="hidden modal-overlay"><div class="modal-content shadow-xl max-w-sm"><h3 id="delete-modal-title" class="text-lg font-bold mb-4" data-i18n="modals.delete_title">Confirm Deletion</h3><p id="delete-modal-msg" class="text-sm text-gray-600 mb-6" data-i18n="modals.delete_msg">Are you sure you want to delete this observation? This action cannot be undone.</p><div class="flex justify-end space-x-4"><button type="button" id="cancel-delete-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg" data-i18n="modals.cancel">Cancel</button><button type="button" id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg" data-i18n="modals.delete_btn">Delete</button></div></div></div><div id="language-modal" class="hidden modal-overlay"><div class="modal-content shadow-xl max-w-sm"><h3 class="text-lg font-bold mb-4">Add New Language</h3><p class="text-sm text-gray-600 mb-4">Enter the name of the language you want to translate the app into (e.g., "French", "Japanese", "Swahili").</p><input type="text" id="new-language-input" class="w-full p-2 border border-gray-300 rounded-md mb-4" placeholder="Language Name"><div class="flex justify-end space-x-4"><button type="button" id="cancel-lang-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button><button type="button" id="confirm-lang-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Translate</button></div></div></div><div id="notification" class="hidden fixed bottom-5 right-5 bg-green-500 text-white py-3 px-5 rounded-lg shadow-xl transition-all opacity-0"><p id="notification-message"></p></div>

    <!-- Strategy Bank Modal -->
    <div id="strategy-bank-modal" class="hidden modal-overlay">
        <div class="modal-content shadow-xl max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Strategy Bank: <span id="sb-modal-category" class="capitalize"></span></h3>
                <button type="button" id="close-sb-modal" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="sb-list" class="space-y-3 max-h-[60vh] overflow-y-auto p-1">
                <!-- Items injected here -->
            </div>
            <div class="mt-6 flex justify-end">
                <button type="button" id="close-sb-btn-bottom" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Close</button>
            </div>
        </div>
    </div>

    <!-- Drill-Down Modal (New) -->
    <div id="drill-down-modal" class="hidden modal-overlay">
        <!-- ... existing drill down modal content ... -->
    </div>

    <!-- NEW: Roleplay Simulator Modal (Option 3) -->
    <div id="roleplay-modal" class="hidden modal-overlay bg-gray-900 bg-opacity-95 z-[90]">
        <div class="modal-content shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col bg-gray-50 rounded-xl overflow-hidden border border-gray-700 p-0">
            <!-- Header -->
            <div class="bg-indigo-900 text-white p-4 flex justify-between items-center shrink-0">
                <div class="flex items-center space-x-3">
                    <span class="text-3xl">üé≠</span>
                    <div>
                        <h3 class="text-xl font-bold">Staff Roleplay Simulator</h3>
                        <p class="text-xs text-indigo-200">Practice your BIP strategies in a safe environment</p>
                    </div>
                </div>
                <button id="close-roleplay-btn" class="text-indigo-300 hover:text-white transition-colors">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <!-- Chat Area -->
            <div id="roleplay-chat-window" class="flex-grow overflow-y-auto p-6 space-y-4 bg-gray-100">
                <!-- Messages injected here -->
            </div>

            <!-- Input Area -->
            <div class="p-4 bg-white border-t border-gray-200 shrink-0">
                <div class="flex space-x-2">
                    <input type="text" id="roleplay-input" class="flex-grow p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none text-lg" placeholder="What do you say/do? (e.g., 'I point to the visual schedule...')">
                    <button id="roleplay-send-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 rounded-lg font-bold text-lg shadow-md transition-transform active:scale-95">Action!</button>
                </div>
                <div class="mt-2 text-center flex justify-center space-x-4">
                    <button id="roleplay-hint-btn" class="text-xs text-indigo-500 hover:text-indigo-700 underline">Need a hint? (Check BIP)</button>
                    <button id="roleplay-restart-btn" class="text-xs text-gray-400 hover:text-gray-600 underline">Restart Scenario</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Token Board Modal (New Option 1) -->
    <div id="token-board-modal" class="hidden modal-overlay bg-gray-900 bg-opacity-90 z-[80]">
        <!-- ... existing token board modal content ... -->
        <div class="w-full max-w-5xl h-[90vh] bg-blue-50 rounded-3xl shadow-2xl border-8 border-blue-200 p-8 flex flex-col relative overflow-hidden">
            <!-- Close Button -->
            <button id="close-token-board" class="absolute top-6 right-6 text-blue-300 hover:text-blue-500 z-50">
                <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>

            <!-- Header -->
            <div class="text-center mb-4 md:mb-8 z-10">
                <h2 class="text-3xl md:text-5xl font-black text-blue-900 uppercase tracking-wider mb-2" style="font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif;">I am working for...</h2>
            </div>
            
            <!-- Reward Setup -->
            <div class="flex justify-center mb-auto z-10">
                <div class="bg-white p-6 rounded-3xl border-4 border-dashed border-blue-300 w-64 h-64 md:w-72 md:h-72 flex flex-col items-center justify-center relative shadow-inner group transition-all hover:border-blue-400">
                    <input type="text" id="token-reward-input" class="text-3xl text-center font-bold text-blue-600 w-full outline-none bg-transparent placeholder-blue-200" placeholder="Type Reward...">
                    <div class="text-6xl mt-4 opacity-50">üéÅ</div>
                    <p class="text-xs text-blue-300 mt-2">Click to edit</p>
                </div>
            </div>

            <!-- Token Slots -->
            <div id="token-slots-container" class="flex justify-center gap-4 md:gap-8 flex-wrap mb-8 md:mb-12 z-10 px-4 min-h-[100px]">
                <!-- Slots injected via JS -->
            </div>

            <!-- Controls -->
            <div class="flex justify-center gap-8 z-10">
                <button id="remove-token-btn" class="bg-red-100 text-red-500 hover:bg-red-200 px-6 py-4 rounded-full text-xl font-bold transition-transform active:scale-95 shadow-md border-b-4 border-red-200 flex items-center">
                    <span class="mr-2">‚ùå</span> Oops
                </button>
                <button id="add-token-btn" class="bg-green-500 text-white hover:bg-green-400 px-10 py-6 rounded-full text-3xl font-black transition-transform active:scale-95 shadow-xl border-b-8 border-green-700 animate-pulse flex items-center">
                    <span class="mr-3">‚≠ê</span> Good Job!
                </button>
            </div>
            
            <!-- Settings (Token Count) -->
            <div class="absolute bottom-6 left-6 z-10">
                <label class="text-blue-800 font-bold text-sm mr-2">Tokens:</label>
                <select id="token-count-select" class="bg-white border border-blue-200 rounded p-1 text-sm font-bold text-blue-600">
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5" selected>5</option>
                    <option value="10">10</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Choice Board Modal (NEW) -->
    <div id="choice-board-modal" class="hidden modal-overlay bg-gray-900 bg-opacity-95 z-[80]">
        <div class="modal-content shadow-2xl w-full max-w-5xl h-[90vh] bg-blue-50 rounded-3xl p-8 flex flex-col relative overflow-hidden">
            <button id="close-choice-board" class="absolute top-6 right-6 text-gray-400 hover:text-gray-600 z-50">
                <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-3xl md:text-4xl font-bold text-center text-blue-900 mb-6 font-sans">I am working for...</h2>
            
            <!-- Setup View -->
            <div id="cb-setup" class="space-y-6 flex flex-col justify-center flex-grow">
                <p class="text-center text-blue-700 text-lg">Enter choices for the student to select from.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-3xl mx-auto w-full">
                    <input class="cb-input p-4 md:p-6 border-4 border-blue-200 rounded-2xl text-center text-xl md:text-2xl font-bold text-blue-800 focus:border-blue-500 outline-none shadow-sm placeholder-blue-200 bg-white" placeholder="Option 1 (e.g. iPad)">
                    <input class="cb-input p-4 md:p-6 border-4 border-blue-200 rounded-2xl text-center text-xl md:text-2xl font-bold text-blue-800 focus:border-blue-500 outline-none shadow-sm placeholder-blue-200 bg-white" placeholder="Option 2 (e.g. Break)">
                    <input class="cb-input p-4 md:p-6 border-4 border-blue-200 rounded-2xl text-center text-xl md:text-2xl font-bold text-blue-800 focus:border-blue-500 outline-none shadow-sm placeholder-blue-200 bg-white" placeholder="Option 3">
                    <input class="cb-input p-4 md:p-6 border-4 border-blue-200 rounded-2xl text-center text-xl md:text-2xl font-bold text-blue-800 focus:border-blue-500 outline-none shadow-sm placeholder-blue-200 bg-white" placeholder="Option 4">
                </div>
                <div class="text-center mt-8">
                    <button id="cb-launch-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-12 rounded-full text-2xl shadow-xl transform transition hover:scale-105 active:scale-95">Present Choices</button>
                </div>
            </div>

            <!-- Student View (Hidden initially) -->
            <div id="cb-present" class="hidden flex-grow grid gap-8 p-4"></div>
            
            <button id="cb-reset-btn" class="hidden absolute bottom-6 left-6 text-gray-400 hover:text-gray-600 underline font-bold z-50">Back to Setup</button>
        </div>
    </div>

    <!-- NEW: Behavior Contract Modal -->
    <div id="contract-modal" class="hidden modal-overlay bg-gray-900 bg-opacity-90 z-[80]">
        <div class="modal-content shadow-2xl w-full max-w-5xl h-[90vh] bg-white rounded-xl p-0 flex flex-col overflow-hidden">
            <!-- Header -->
            <div class="bg-indigo-900 text-white p-4 flex justify-between items-center shrink-0">
                <h3 class="text-xl font-bold">üìú Behavior Contract Builder</h3>
                <button id="close-contract-btn" class="text-indigo-200 hover:text-white">‚úï</button>
            </div>
            
            <div class="flex-grow flex flex-col md:flex-row overflow-hidden">
                <!-- Left: Inputs -->
                <div class="w-full md:w-1/3 p-6 bg-gray-50 border-r border-gray-200 overflow-y-auto">
                    <h4 class="font-bold text-gray-700 mb-4">Contract Details</h4>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Student Agrees To:</label>
                            <textarea id="contract-student-task" class="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-indigo-500 outline-none" rows="2" placeholder="e.g. Raise hand before speaking"></textarea>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Teacher Agrees To:</label>
                            <textarea id="contract-teacher-task" class="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-indigo-500 outline-none" rows="2" placeholder="e.g. Provide a warning before transitions"></textarea>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">If Successful, Student Earns:</label>
                            <input id="contract-reward" class="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="e.g. 10 minutes of iPad time">
                        </div>
                        
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Student Signature</label>
                            <div class="border border-gray-300 bg-white rounded h-32 relative shadow-inner">
                                <canvas id="signature-pad" class="w-full h-full cursor-crosshair touch-none"></canvas>
                                <button id="clear-sig-btn" class="absolute top-1 right-1 text-[10px] text-red-500 hover:text-red-700 bg-white px-2 py-0.5 rounded border border-gray-200 shadow-sm">Clear</button>
                            </div>
                            <p class="text-[10px] text-gray-400 mt-1">Sign inside the box above</p>
                        </div>
                    </div>
                    
                    <button id="generate-contract-btn" class="w-full mt-6 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded shadow-md transition-colors">
                        Generate Contract
                    </button>
                </div>
                
                <!-- Right: Preview -->
                <div class="w-full md:w-2/3 p-8 bg-gray-200 overflow-y-auto flex items-start justify-center">
                    <div id="contract-preview-container" class="bg-white shadow-xl min-h-[600px] w-full max-w-[600px] p-0 transform transition-all origin-top">
                        <div class="h-full flex flex-col items-center justify-center text-gray-400 text-sm italic p-10 h-[600px]">
                            <svg class="w-16 h-16 mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            Fill details on the left and click "Generate" to preview.
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-4 bg-white border-t flex justify-end space-x-2 shrink-0">
                <button id="download-contract-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded shadow-md hidden flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Download PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Preference Assessment Modal (NEW) -->
    <div id="pref-assess-modal" class="hidden modal-overlay bg-gray-900 bg-opacity-95 z-[80]">
        <div class="modal-content shadow-2xl w-full max-w-2xl bg-white rounded-xl overflow-hidden p-0 flex flex-col h-[80vh]">
            <div class="bg-pink-600 text-white p-4 flex justify-between items-center shrink-0">
                <h3 class="text-xl font-bold">üèÜ Preference Assessment</h3>
                <button id="close-pref-btn" class="text-pink-200 hover:text-white">‚úï</button>
            </div>
            
            <!-- Setup View -->
            <div id="pref-setup-view" class="p-6 flex-grow overflow-y-auto">
                <p class="text-sm text-gray-600 mb-4">Enter 3-6 items to test. We will generate pairs to find the strongest reinforcer.</p>
                <div id="pref-inputs" class="space-y-2 mb-4">
                    <input class="pref-item-input w-full p-2 border rounded" placeholder="Item 1 (e.g., iPad)">
                    <input class="pref-item-input w-full p-2 border rounded" placeholder="Item 2 (e.g., Skittles)">
                    <input class="pref-item-input w-full p-2 border rounded" placeholder="Item 3 (e.g., Break)">
                </div>
                <button id="add-pref-input-btn" class="text-xs text-blue-600 underline mb-4">+ Add Item</button>
                <button id="start-pref-btn" class="w-full bg-pink-600 text-white font-bold py-3 rounded-lg shadow-md hover:bg-pink-700">Start Assessment</button>
            </div>

            <!-- Testing View -->
            <div id="pref-test-view" class="hidden p-6 flex-grow flex flex-col justify-center items-center bg-gray-50">
                <h4 class="text-lg font-bold text-gray-500 mb-6">Trial <span id="pref-trial-num">1</span> of <span id="pref-total-trials">0</span></h4>
                <p class="text-sm text-gray-400 mb-4">Ask student: "Pick one." Click their choice.</p>
                <div class="grid grid-cols-2 gap-8 w-full max-w-lg">
                    <button id="pref-choice-a" class="h-40 bg-white border-4 border-blue-200 hover:border-blue-500 rounded-xl text-xl font-bold text-blue-800 shadow-sm transition-all transform active:scale-95 flex items-center justify-center p-4 text-center break-words"></button>
                    <button id="pref-choice-b" class="h-40 bg-white border-4 border-green-200 hover:border-green-500 rounded-xl text-xl font-bold text-green-800 shadow-sm transition-all transform active:scale-95 flex items-center justify-center p-4 text-center break-words"></button>
                </div>
            </div>

            <!-- Results View -->
            <div id="pref-results-view" class="hidden p-6 flex-grow overflow-y-auto">
                <h4 class="text-lg font-bold text-gray-800 mb-4">Hierarchy of Preference</h4>
                <div id="pref-results-chart" class="space-y-3"></div>
                <button id="save-pref-results-btn" class="mt-6 w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700">Save to BIP</button>
            </div>
        </div>
    </div>

    <!-- Interval Recording Modal (NEW) -->
    <div id="interval-modal" class="hidden modal-overlay bg-gray-900 bg-opacity-95 z-[80]">
        <div class="modal-content shadow-2xl w-full max-w-2xl bg-white rounded-xl overflow-hidden p-0 flex flex-col h-[80vh]">
            <!-- Header -->
            <div class="bg-teal-700 text-white p-4 flex justify-between items-center shrink-0">
                <h3 class="text-xl font-bold flex items-center"><span class="mr-2">‚è±Ô∏è</span> Interval Recording</h3>
                <button id="close-interval-btn" class="text-teal-200 hover:text-white">‚úï</button>
            </div>
            
            <!-- Setup View -->
            <div id="int-setup-view" class="p-8 flex flex-col justify-center h-full">
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Recording Type</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button class="int-type-btn p-3 border rounded-lg text-sm font-bold text-center hover:bg-teal-50 focus:ring-2 focus:ring-teal-500 bg-teal-100 border-teal-500 text-teal-800 transition-all" data-val="Partial">Partial<br><span class="text-[10px] font-normal text-gray-500">Anytime during</span></button>
                            <button class="int-type-btn p-3 border rounded-lg text-sm font-bold text-center hover:bg-teal-50 focus:ring-2 focus:ring-teal-500 transition-all text-gray-600" data-val="Whole">Whole<br><span class="text-[10px] font-normal text-gray-500">Entire duration</span></button>
                            <button class="int-type-btn p-3 border rounded-lg text-sm font-bold text-center hover:bg-teal-50 focus:ring-2 focus:ring-teal-500 transition-all text-gray-600" data-val="Momentary">Momentary<br><span class="text-[10px] font-normal text-gray-500">At end beep</span></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">Total Duration (min)</label>
                            <input type="number" id="int-total-mins" value="10" min="1" max="60" class="w-full p-2 border rounded font-mono text-center focus:ring-teal-500 focus:border-teal-500">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">Interval Length (sec)</label>
                            <select id="int-interval-secs" class="w-full p-2 border rounded font-mono text-center bg-white focus:ring-teal-500 focus:border-teal-500">
                                <option value="10">10s</option>
                                <option value="15" selected>15s</option>
                                <option value="20">20s</option>
                                <option value="30">30s</option>
                                <option value="60">60s</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Target Behavior</label>
                        <input type="text" id="int-behavior-name" class="w-full p-2 border rounded focus:ring-teal-500 focus:border-teal-500" placeholder="e.g. Off-Task, Stereotypy">
                    </div>
                    <button id="start-interval-session-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 rounded-lg shadow-lg text-lg transition-transform active:scale-95 flex justify-center items-center">
                        <span class="mr-2">‚ñ∂</span> Start Session
                    </button>
                </div>
            </div>

            <!-- Active View -->
            <div id="int-active-view" class="hidden flex flex-col h-full bg-gray-50">
                <!-- Top Bar -->
                <div class="bg-white p-4 shadow-sm flex justify-between items-center shrink-0 border-b">
                    <div class="text-sm">
                        <span class="font-bold text-gray-500 uppercase text-xs tracking-wider">Interval</span> 
                        <span id="int-current-num" class="font-mono font-bold text-xl ml-1 text-gray-800">1</span>
                        <span class="text-gray-400 text-xs font-mono"> / <span id="int-total-count">40</span></span>
                    </div>
                    <div id="int-timer-display" class="font-mono text-3xl font-bold text-teal-600">00:15</div>
                </div>
                
                <!-- Main Interaction Area -->
                <div class="flex-grow flex flex-col items-center justify-center p-4">
                    <div class="w-full max-w-md mb-8">
                        <div class="flex justify-between text-xs text-gray-400 font-bold mb-1 uppercase">
                            <span>Progress</span>
                            <span id="int-type-display">Partial</span>
                        </div>
                        <div id="int-progress-container" class="w-full h-3 bg-gray-200 rounded-full overflow-hidden">
                            <div id="int-progress-bar" class="h-full bg-teal-500 transition-all duration-100 ease-linear" style="width: 100%"></div>
                        </div>
                    </div>
                    
                    <button id="int-record-btn" class="w-64 h-64 rounded-full border-8 border-gray-200 bg-white flex flex-col items-center justify-center shadow-lg transition-all duration-200 active:scale-95 mb-8 hover:border-teal-200 group">
                        <div id="int-record-icon" class="text-6xl mb-2 transition-transform group-hover:scale-110">üëÅÔ∏è</div>
                        <span id="int-record-label" class="text-xl font-bold text-gray-600 uppercase tracking-widest">Observe</span>
                        <span id="int-status-text" class="text-xs text-gray-400 font-medium mt-1">Tap if behavior occurs</span>
                    </button>
                    
                    <div class="w-full max-w-md">
                        <p class="text-[10px] text-gray-400 font-bold mb-2 uppercase tracking-widest text-center">Session Grid</p>
                        <div id="int-grid" class="flex flex-wrap justify-center gap-1 max-h-32 overflow-y-auto p-2 border rounded bg-white shadow-inner">
                            <!-- Grid items injected here -->
                        </div>
                    </div>
                </div>

                <!-- Bottom Controls -->
                <div class="p-4 bg-white border-t flex justify-between items-center shrink-0">
                    <button id="int-end-btn" class="text-red-500 font-bold text-xs uppercase tracking-wide hover:text-red-700 hover:underline">‚ñ† End Early</button>
                    <div class="text-sm font-bold text-gray-700 bg-gray-100 px-3 py-1 rounded-full">Score: <span id="int-live-score" class="text-teal-700">0%</span></div>
                </div>
            </div>

            <!-- Summary View -->
            <div id="int-summary-view" class="hidden flex flex-col items-center justify-center h-full p-8 bg-teal-50">
                <div class="bg-white p-8 rounded-2xl shadow-xl text-center max-w-sm w-full">
                    <h4 class="text-xl font-bold text-gray-800 mb-2">Session Complete</h4>
                    <div class="text-6xl font-black text-teal-600 mb-4" id="int-final-score">45%</div>
                    <p class="text-sm text-gray-600 mb-6 leading-relaxed" id="int-summary-detail"></p>
                    <div class="space-y-3">
                        <button id="int-save-btn" class="w-full bg-teal-600 text-white font-bold py-3 rounded-lg shadow hover:bg-teal-700 transition-colors flex justify-center items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                            Save to Log
                        </button>
                        <button id="int-discard-btn" class="w-full text-gray-400 font-bold text-sm hover:text-red-500">Discard Data</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK & App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, setPersistence, inMemoryPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, addDoc, serverTimestamp, updateDoc, getDocs, deleteDoc, getDoc, setDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        /* =========================================
           SECTION 1: CONFIGURATION & CONSTANTS
           ========================================= */
        const APP_CONFIG = {
            appId: typeof __app_id !== 'undefined' ? __app_id : 'baps-app-dev',
            // Check if config exists and is not an empty string
            firebaseConfig: (typeof __firebase_config !== 'undefined' && __firebase_config) ? JSON.parse(__firebase_config) : null,
            initialAuthToken: typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null,
        };

        const GLOSSARY = {
            antecedent: {
                title: "Antecedent (Trigger)",
                text: "What happened *immediately* before the behavior? (e.g., 'Asked to do math', 'Loud noise', 'Peer took toy')."
            },
            behavior: {
                title: "Behavior (Action)",
                text: "What did the student do? Be specific and observable. (e.g., 'Hit peer', 'Yelled no', 'Ran out of room')."
            },
            consequence: {
                title: "Consequence (Outcome)",
                text: "What happened *immediately* after? What did the student get or avoid? (e.g., 'Sent to office', 'Got iPad', 'Peers laughed')."
            },
            setting_event: {
                title: "Setting Event",
                text: "Underlying factors (slow triggers) that make a behavior more likely today (e.g., hunger, fatigue, missing meds, conflict at home)."
            },
            function: {
                title: "Function (The 'Why')",
                text: "The reason the behavior continues. Usually to **Get** something (attention, item) or **Escape** something (work, sensory)."
            }
        };

        const STRATEGY_BANK = {
            prevent: [
                { title: "Visual Schedule", desc: "Use pictures or text to show the sequence of activities to reduce anxiety.", functions: ["Escape", "Sensory"] },
                { title: "Priming", desc: "Provide warnings before transitions (e.g., '2 minutes left').", functions: ["Escape", "Tangible"] },
                { title: "Choice Making", desc: "Offer choices between two acceptable tasks or materials.", functions: ["Escape", "Attention"] },
                { title: "Environmental Arrangement", desc: "Reduce distractions or reorganize seating to minimize triggers.", functions: ["Sensory", "Attention"] },
                { title: "Non-Contingent Reinforcement", desc: "Provide attention/access on a fixed schedule regardless of behavior.", functions: ["Attention", "Tangible"] }
            ],
            teach: [
                { title: "Functional Communication (FCT)", desc: "Teach the student to ask for a break/help using words/cards.", functions: ["Escape", "Attention", "Tangible"] },
                { title: "Coping Strategies", desc: "Teach deep breathing, counting, or squeezing a stress ball.", functions: ["Sensory", "Escape"] },
                { title: "Social Skills", desc: "Role-play appropriate interactions or use social stories.", functions: ["Attention", "Tangible"] },
                { title: "Replacement Behavior", desc: "Teach an alternative behavior that serves the same function (e.g., raising hand).", functions: ["Escape", "Attention", "Tangible", "Sensory"] }
            ],
            respond: [
                { title: "Planned Ignoring", desc: "Withhold attention for minor attention-seeking behaviors.", functions: ["Attention"] },
                { title: "Differential Reinforcement", desc: "Heavily praise the absence of behavior or use of replacement behavior.", functions: ["Attention", "Escape"] },
                { title: "Token Economy", desc: "Use a token system to reward appropriate behavior immediately.", functions: ["Tangible", "Attention"] },
                { title: "Response Cost", desc: "Remove a token/privilege for specific problem behaviors.", functions: ["Tangible"] }
            ]
        };

        const I18N_RESOURCES = {
            en: {
                app: { title: "FBA/BIP App", loading: "Initializing Secure Session..." },
                auth: { 
                    title: "FBA/BIP App", 
                    subtitle: "Functional Behavior Assessment & Intervention Tool", 
                    guest_access: "Demonstration Access", 
                    login_btn: "Get Started", 
                    login_error: "Sign in failed. Please refresh and try again.", 
                    about_title: "About FBA/BIP", 
                    about_text: "This tool guides practitioners through the Functional Behavioral Assessment (FBA) process and the development of Behavior Intervention Plans (BIP) using evidence-based practices and data-driven decision making.",
                    privacy_warning: "<strong>Privacy Notice:</strong> This is a demonstration tool. Do not enter real student names. Please use Codenames or IDs."
                },
                nav: { title: "FBA App", logout: "Logout" },
                dashboard: { title: "Case Dashboard", import_btn: "Import JSON", new_case_btn: "+ New Case", no_cases_title: "No cases", no_cases_text: "Get started by creating a new case or importing one." },
                case_detail: {
                    back_btn: "‚Üê Back to Dashboard", export_btn: "Export JSON",
                    step1_title: "Step 1: Problem Identification Interview", step1_desc: "Use this AI-guided interview to collect initial information from a parent or teacher.", chat_placeholder: "Type your response...", send_btn: "Send", interview_summary_title: "Interview Summary",
                    step2_title: "Step 2: Problem Analysis (ABC Data)", analyze_btn: "Analyze Data with AI", add_abc_btn: "+ Add Observation", step2_desc: "Record ABC observations. Once you have at least 3 entries, use the AI to analyze patterns and generate a hypothesis.", table_date: "Date & Time", table_ant: "Antecedent", table_beh: "Behavior", table_cons: "Consequence", table_actions: "Actions", no_data: "No ABC data has been recorded for this case yet.",
                    chart_title: "Behavior Frequency by Hour", chart_tooltip: "Hour {hour}:00 - {count} instances",
                    cat_ant_title: "Top Antecedents (Triggers)", cat_cons_title: "Top Consequences (Payoffs)",
                    step3_title: "Step 3: Record Review", analyze_records_btn: "Analyze Records with AI", step3_desc: "Paste relevant text from student records (e.g., IEPs, psychological evaluations, past FBA reports) below. The AI will summarize key points.", record_placeholder: "Paste record text here...",
                    step4_title: "Step 4: Visual Hypothesis Diagram", download_svg: "Download SVG", generate_visual_btn: "Generate Visual", step4_desc: "After completing Steps 1-3, generate a visual summary of the behavioral hypothesis.", visual_placeholder: "The visual diagram will appear here once generated.",
                    step5_title: "Step 5: The Critical Decision Point (AI-Assisted)", step5_desc: "This AI-driven checkpoint helps determine the next step by assessing confidence in the hypothesis and potential risks.", begin_assessment_btn: "Begin Confidence & Risk Assessment", assessment_prompt_ready: "You can now proceed with the confidence and risk assessment.", assessment_prompt_wait: "Complete Steps 1-4 to enable this assessment.",
                    q_severity: "1. Severity", q_severity_desc: "Describe the severity of the behavior. Does it pose a significant and immediate risk of physical harm to the student or others?", q_persistence: "2. Persistence & History", q_persistence_desc: "Describe how long the behavior has been a concern.", q_complexity: "3. Complexity & Confidence", q_complexity_desc: "Describe your confidence in the data.", get_rec_btn: "Get AI Recommendation",
                    step6_title: "Step 6: Behavior Intervention Plan (BIP) Development", foundational_info: "Foundational Information", hypothesis_label: "Hypothesis Statement (from FBA)", def_label: "Operational Definition of Target Behavior", def_desc: "Ensure this is observable and measurable. Refine the definition from Step 1 as needed.", save_foundation_btn: "Save & Begin BIP",
                    strategies_prevent: "A. Prevent Strategies", strategies_teach: "B. Teach Strategies", strategies_respond: "C. Respond Strategies",
                    goal_monitoring_title: "Goal Formation & Progress Monitoring", goal_inputs_desc: "Define a clear, measurable goal and outline your initial ideas.", goal_label: "Measurable Goal", goal_help: "What is the desired outcome? (e.g., \"Student will use a break card in 4 out of 5 opportunities.\")", monitor_label: "Monitoring Plan Ideas", monitor_help: "How often will you collect data? (e.g., \"Daily for 2 weeks.\")", generate_plan_btn: "Generate Plan with AI",
                    bip_complete_title: "BIP Complete", bip_complete_desc: "All sections of the BIP have been generated.", download_report_btn: "Download Full Report"
                },
                modals: { 
                    new_case_title: "Create a New Case", 
                    student_name: "Codename / Identifier", 
                    privacy_hint: "For privacy, please use a codename or ID (e.g., 'Student A'), not real names.",
                    grade: "Grade Level", cancel: "Cancel", create: "Create Case", abc_title_add: "Add ABC Observation", abc_title_edit: "Edit ABC Observation", date: "Date of Observation", time: "Time (Optional)", ant_label: "Antecedent", ant_help: "What happened immediately before the behavior?", beh_label: "Behavior", beh_help: "Describe the behavior exactly as it occurred.", cons_label: "Consequence", cons_help: "What happened immediately after the behavior?", save_obs: "Save Observation", 
                    delete_title: "Confirm Deletion", delete_msg: "Are you sure you want to delete this observation?", delete_btn: "Delete",
                    delete_case_title: "Delete Case", delete_case_msg: "Are you sure you want to delete this case? All associated data will be permanently removed."
                },
                messages: { firebase_missing: "Firebase configuration is missing.", case_created: "Case created successfully!", case_create_fail: "Failed to create case. Please try again.", obs_saved: "Observation saved successfully!", obs_updated: "Observation updated successfully!", obs_deleted: "Observation deleted successfully.", case_deleted: "Case deleted successfully.", obs_save_fail: "Failed to save. Please try again.", obs_delete_fail: "Failed to delete observation.", export_success: "Case exported successfully!", export_fail: "Failed to export case.", import_success: "Case imported successfully!", import_fail: "Failed to import case. Invalid file.", analyzing_data: "Analyzing data with AI...", analyzing_records: "AI is reviewing the records...", generating_visual: "AI is creating the visual diagram...", generating_rec: "Generating recommendation...", generating_plan: "Generating...", function_saved: "Function Saved", foundation_saved: "Foundation Saved", consulting_ai: "Consulting AI...", cat_saved: "{cat} section saved!", session_timeout: "Session timed out due to inactivity." },
                interview: { intro: "Hello! I am an AI assistant guiding you through the Functional Behavior Assessment (FBA) process. To start, could you please describe the behavior you are concerned about?", system_prompt: "You are an AI assistant for a Functional Behavior Assessment (FBA) interview. Ask questions ONE AT A TIME. After the user's final response, you MUST say 'Thank you, I believe I have enough information now.' and then, on a new line, provide a summary formatted in HTML. The summary MUST contain a '<h4>Interview Summary</h4>' and a '<h4><strong>Suggested Operational Definition</strong></h4>'." },
                decision: { proceed: "Proceed to BIP", consider_fa: "Consider FA", saved: "Save" },
                bip: { intro: "Let's discuss {cat} strategies.", edit_content: "Edit Content", save_content: "Save Changes" },
                steps: { step1_short: "1. Interview", step2_short: "2. ABC Data", step3_short: "3. Records", step4_short: "4. Visual", step5_short: "5. Decision", step6_short: "6. BIP" }
            },
            es: {
                app: { title: "Aplicaci√≥n FBA/BIP", loading: "Iniciando sesi√≥n segura..." },
                auth: { 
                    title: "Aplicaci√≥n FBA/BIP", 
                    subtitle: "Herramienta de Evaluaci√≥n e Intervenci√≥n Funcional de la Conducta", 
                    guest_access: "Acceso de Demostraci√≥n", 
                    login_btn: "Comenzar", 
                    login_error: "Fallo al iniciar sesi√≥n. Por favor refresque e intente de nuevo.", 
                    about_title: "Sobre FBA/BIP", 
                    about_text: "Esta herramienta gu√≠a a los profesionales a trav√©s del proceso de Evaluaci√≥n Funcional de la Conducta (FBA) y el desarrollo de Planes de Intervenci√≥n Conductual (BIP) utilizando pr√°cticas basadas en evidencia.",
                    privacy_warning: "<strong>Aviso de Privacidad:</strong> Esta es una herramienta de demostraci√≥n. No ingrese nombres reales. Use seud√≥nimos o IDs."
                },
                nav: { title: "App FBA", logout: "Cerrar Sesi√≥n" },
                dashboard: { title: "Tablero de Casos", import_btn: "Importar JSON", new_case_btn: "+ Nuevo Caso", no_cases_title: "No hay casos", no_cases_text: "Comience creando un nuevo caso o importando uno." },
                case_detail: {
                    back_btn: "‚Üê Volver al Tablero", export_btn: "Exportar JSON",
                    step1_title: "Paso 1: Entrevista de Identificaci√≥n del Problema", step1_desc: "Use esta entrevista guiada por IA para recopilar informaci√≥n inicial de un padre o maestro.", chat_placeholder: "Escriba su respuesta...", send_btn: "Enviar", interview_summary_title: "Resumen de la Entrevista",
                    step2_title: "Paso 2: An√°lisis del Problema (Datos ABC)", analyze_btn: "Analizar Datos con IA", add_abc_btn: "+ A√±adir Observaci√≥n", step2_desc: "Registre observaciones ABC. Una vez que tenga al menos 3 entradas, use la IA para analizar patrones.", table_date: "Fecha y Hora", table_ant: "Antecedente", table_beh: "Conducta", table_cons: "Consecuencia", table_actions: "Acciones", no_data: "No se han registrado datos ABC para este caso todav√≠a.",
                    chart_title: "Frecuencia de Conducta por Hora", chart_tooltip: "Hora {hour}:00 - {count} instancias",
                    cat_ant_title: "Principales Antecedentes (Disparadores)", cat_cons_title: "Principales Consecuencias (Refuerzos)",
                    step3_title: "Paso 3: Revisi√≥n de Registros", analyze_records_btn: "Analizar Registros con IA", step3_desc: "Pegue el texto relevante de los registros del estudiante abajo.", record_placeholder: "Pegue el texto del registro aqu√≠...",
                    step4_title: "Paso 4: Diagrama de Hip√≥tesis Visual", download_svg: "Descargar SVG", generate_visual_btn: "Generar Visual", step4_desc: "Despu√©s de completar los pasos 1-3, genere un resumen visual.", visual_placeholder: "El diagrama visual aparecer√° aqu√≠ una vez generado.",
                    step5_title: "Paso 5: Punto de Decisi√≥n Cr√≠tica", step5_desc: "Este punto de control ayuda a determinar el siguiente paso evaluando riesgos.", begin_assessment_btn: "Comenzar Evaluaci√≥n de Riesgo", assessment_prompt_ready: "Ahora puede proceder con la evaluaci√≥n.", assessment_prompt_wait: "Complete los Pasos 1-4 para habilitar esta evaluaci√≥n.",
                    q_severity: "1. Severidad", q_severity_desc: "Describa la severidad de la conducta. ¬øRepresenta un riesgo de da√±o f√≠sico?", q_persistence: "2. Persistencia e Historia", q_persistence_desc: "Describa cu√°nto tiempo ha sido una preocupaci√≥n la conducta.", q_complexity: "3. Complejidad y Confianza", q_complexity_desc: "Describa su confianza en los datos.", get_rec_btn: "Obtener Recomendaci√≥n de IA",
                    step6_title: "Paso 6: Plan de Intervenci√≥n (BIP)", foundational_info: "Informaci√≥n Fundamental", hypothesis_label: "Declaraci√≥n de Hip√≥tesis", def_label: "Definici√≥n Operacional", def_desc: "Aseg√∫rese de que esto sea observable y medible.", save_foundation_btn: "Guardar y Comenzar BIP",
                    strategies_prevent: "A. Estrategias de Prevenci√≥n", strategies_teach: "B. Estrategias de Ense√±anza", strategies_respond: "C. Estrategias de Respuesta",
                    goal_monitoring_title: "Meta y Monitoreo de Progreso", goal_inputs_desc: "Defina una meta clara y medible.", goal_label: "Meta Medible", goal_help: "¬øCu√°l es el resultado deseado?", monitor_label: "Ideas de Plan de Monitoreo", monitor_help: "¬øCon qu√© frecuencia recopilar√° datos?", generate_plan_btn: "Generar Plan con IA",
                    bip_complete_title: "BIP Completo", bip_complete_desc: "Todas las secciones del BIP han sido generadas.", download_report_btn: "Descargar Informe Completo"
                },
                modals: { 
                    new_case_title: "Crear Nuevo Caso", 
                    student_name: "Seud√≥nimo / ID del Estudiante", 
                    privacy_hint: "Use un seud√≥nimo (ej. 'Estudiante A') para proteger la privacidad.",
                    grade: "Grado Escolar", cancel: "Cancelar", create: "Crear Caso", abc_title_add: "A√±adir Observaci√≥n ABC", abc_title_edit: "Editar Observaci√≥n ABC", date: "Fecha de Observaci√≥n", time: "Hora (Opcional)", ant_label: "Antecedente", ant_help: "¬øQu√© sucedi√≥ inmediatamente antes?", beh_label: "Conducta", beh_help: "Describa la conducta exactamente.", cons_label: "Consecuencia", cons_help: "¬øQu√© sucedi√≥ inmediatamente despu√©s?", save_obs: "Guardar Observaci√≥n", 
                    delete_title: "Confirmar Eliminaci√≥n", delete_msg: "¬øEst√° seguro de que desea eliminar esta observaci√≥n?", delete_btn: "Eliminar",
                    delete_case_title: "Eliminar Caso", delete_case_msg: "¬øEst√° seguro de que desea eliminar este caso? Todos los datos asociados se eliminar√°n permanentemente."
                },
                messages: { firebase_missing: "Falta la configuraci√≥n de Firebase.", case_created: "¬°Caso creado exitosamente!", case_create_fail: "Fallo al crear caso.", obs_saved: "¬°Observaci√≥n guardada!", obs_updated: "¬°Observaci√≥n actualizada!", obs_deleted: "Observaci√≥n eliminada.", case_deleted: "Caso eliminado exitosamente.", obs_save_fail: "Fallo al guardar.", obs_delete_fail: "Fallo al eliminar.", export_success: "¬°Caso exportado!", export_fail: "Fallo al exportar.", import_success: "¬°Caso importado!", import_fail: "Fallo al importar.", analyzing_data: "Analizando datos con IA...", analyzing_records: "IA revisando registros...", generating_visual: "IA creando diagrama...", generating_rec: "Generando recomendaci√≥n...", generating_plan: "Generando...", function_saved: "Funci√≥n guardada", foundation_saved: "Fundamento guardado", consulting_ai: "Consultando IA...", cat_saved: "¬°Secci√≥n {cat} guardada!", session_timeout: "Sesi√≥n expirada por inactividad." },
                interview: { intro: "¬°Hola! Soy un asistente de IA que le guiar√° a trav√©s del proceso de Evaluaci√≥n Funcional de la Conducta (FBA). Para comenzar, ¬øpodr√≠a describir la conducta que le preocupa?", system_prompt: "Su es un asistente de IA para una entrevista de Evaluaci√≥n Funcional de la Conducta (FBA). Haz preguntas UNA A LA VEZ. Despu√©s de la respuesta final del usuario, DEBES decir 'Gracias, creo que tengo suficiente informaci√≥n ahora.' y luego, en una nueva l√≠nea, proporcionar un resumen formateado en HTML. El resumen DEBE contener un '<h4>Resumen de la Entrevista</h4>' y una '<h4><strong>Definici√≥n Operacional Sugerida</strong></h4>'." },
                decision: { proceed: "Proceder al BIP", consider_fa: "Considerar AF", saved: "Guardar" },
                bip: { intro: "Discutamos estrategias de {cat}.", edit_content: "Editar Contenido", save_content: "Guardar Cambios" },
                steps: { step1_short: "1. Entrevista", step2_short: "2. Datos ABC", step3_short: "3. Registros", step4_short: "4. Visual", step5_short: "5. Decisi√≥n", step6_short: "6. BIP" }
            }
        };

        /* =========================================
           SECTION 2: KERNEL (UTILITIES & I18N)
           ========================================= */
        class Utils {
            static formatDate(dateString) { if(!dateString) return 'N/A'; const date = new Date(dateString); return new Date(date.getTime() + date.getTimezoneOffset() * 60000).toLocaleDateString(); }
            static safeDate(input) {
                if (!input) return null;
                // If it's a Firestore Timestamp (has toDate method)
                if (typeof input.toDate === 'function') return input.toDate();
                // If it's a string or Date object
                return new Date(input);
            }
            static stripHtml(html) { if(!html) return ""; let doc = new DOMParser().parseFromString(html, 'text/html'); return doc.body.textContent || ""; }
            static capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }
            static generateId() { return crypto.randomUUID(); }
            static downloadAsJson(data, filename) { const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
            static readJsonFile(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = (e) => { try { resolve(JSON.parse(e.target.result)); } catch (error) { reject(error); } }; reader.onerror = reject; reader.readAsText(file); }); }
            static showNotification(messageKey, type = 'success', params = {}) { const notification = document.getElementById('notification'); const msgEl = document.getElementById('notification-message'); msgEl.textContent = messageKey.includes('.') ? I18nService.t(messageKey, params) : messageKey; notification.className = `fixed bottom-5 right-5 text-white py-3 px-5 rounded-lg shadow-xl transition-all ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`; notification.classList.remove('hidden'); setTimeout(() => { notification.style.opacity = '1'; }, 10); setTimeout(() => { notification.style.opacity = '0'; setTimeout(() => { notification.classList.add('hidden'); }, 300); }, 3000); }
            static showTypingIndicator(elementId, show) { const chatWindow = document.getElementById(elementId); if (!chatWindow) return; let indicator = chatWindow.querySelector('.typing-indicator'); if (show && !indicator) { indicator = document.createElement('div'); indicator.className = 'typing-indicator self-start'; indicator.innerHTML = `<span></span><span></span><span></span>`; chatWindow.appendChild(indicator); chatWindow.scrollTop = chatWindow.scrollHeight; } else if (!show && indicator) { indicator.remove(); } }
            static showErrorState(message) { document.body.innerHTML = `<div class="min-h-screen flex items-center justify-center bg-red-50"><div class="text-center p-8 bg-white rounded-lg shadow-xl"><h2 class="text-2xl font-bold text-red-700">Application Error</h2><p class="mt-4 text-gray-600">${message}</p></div></div>`; }
            static setLoading(btnId, isLoading) {
                const btn = document.getElementById(btnId);
                if(!btn) return;
                if(isLoading) {
                    btn.classList.add('btn-loading');
                    btn.disabled = true;
                } else {
                    btn.classList.remove('btn-loading');
                    btn.disabled = false;
                }
            }
            static injectTooltips() {
                document.querySelectorAll('[data-glossary-key]').forEach(el => {
                    // Prevent duplicate injection
                    if(el.querySelector('.glossary-icon')) return;
                    
                    const key = el.getAttribute('data-glossary-key');
                    const item = GLOSSARY[key];
                    if(item) {
                        const html = `
                            <div class="glossary-icon relative group inline-block ml-1 align-middle z-10">
                                <svg class="w-4 h-4 text-blue-400 cursor-help opacity-70 hover:opacity-100" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 hidden group-hover:block w-56 bg-gray-800 text-white text-xs rounded p-3 shadow-xl pointer-events-none">
                                    <strong class="block mb-1 text-blue-300 border-b border-gray-600 pb-1 font-bold">${item.title}</strong>
                                    <div class="leading-relaxed font-normal normal-case text-gray-200">${item.text}</div>
                                    <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800"></div>
                                </div>
                            </div>`;
                        el.insertAdjacentHTML('beforeend', html);
                    }
                });
            }
            static showDeleteModal(type, id) {
                const modal = document.getElementById('delete-confirm-modal');
                const title = document.getElementById('delete-modal-title');
                const msg = document.getElementById('delete-modal-msg');
                
                if (type === 'case') {
                    title.setAttribute('data-i18n', 'modals.delete_case_title');
                    msg.setAttribute('data-i18n', 'modals.delete_case_msg');
                } else {
                    title.setAttribute('data-i18n', 'modals.delete_title');
                    msg.setAttribute('data-i18n', 'modals.delete_msg');
                }
                // Refresh translation for the modal content
                I18nService.translatePage(modal);
                modal.classList.remove('hidden');
                return id;
            }
            static async getGeminiResponse(history) {
                const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const regularMessages = history.filter(msg => msg.role !== 'system'); const systemMessage = history.find(msg => msg.role === 'system');
                const payload = { contents: regularMessages }; if (systemMessage) { payload.systemInstruction = { parts: systemMessage.parts }; }
                
                // Exponential Backoff Implementation
                const delays = [1000, 2000, 4000, 8000, 16000];
                for (let i = 0; i <= delays.length; i++) {
                    try {
                        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        if (!response.ok) {
                            if ((response.status === 429 || response.status >= 500) && i < delays.length) {
                                console.warn(`API request failed (Status ${response.status}). Retrying in ${delays[i]}ms...`);
                                await new Promise(resolve => setTimeout(resolve, delays[i]));
                                continue;
                            }
                            throw new Error(`API call failed: ${response.status}`);
                        }
                        const result = await response.json();
                        return result.candidates?.[0]?.content?.parts?.[0]?.text || "Error: Empty response.";
                    } catch (error) {
                        if (i === delays.length) { console.error(error); return "Error: API Connection Failed after retries."; }
                        await new Promise(resolve => setTimeout(resolve, delays[i]));
                    }
                }
            }

            static async generateImage(prompt) {
                const apiKey = ""; 
                const url = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;
                
                // Safety: Ensure prompt is safe for classroom context
                const safePrompt = `cartoon style illustration for a children's school social story, soft colors, friendly, safe for work: ${prompt}`;

                const payload = {
                    instances: [{ prompt: safePrompt }],
                    parameters: { sampleCount: 1 }
                };

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`Image Gen Error: ${response.status}`);
                    
                    const result = await response.json();
                    // Imagen 4 returns base64 in bytesBase64Encoded
                    if (result.predictions?.[0]?.bytesBase64Encoded) {
                        return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    }
                    throw new Error("No image data returned");
                } catch (error) {
                    console.error("Image Gen Failed:", error);
                    return null; // Handle gracefully in UI
                }
            }
        }

        class I18nService {
            static currentLocale = 'en'; static resources = I18N_RESOURCES;
            static init() { this.translatePage(); }
            static setLocale(locale) { if (this.resources[locale]) { this.currentLocale = locale; this.translatePage(); } }
            static async addLanguage(langName) {
                const langKey = langName.toLowerCase().replace(/\s+/g, '_');
                if (this.resources[langKey]) { this.setLocale(langKey); return langKey; }
                const systemPrompt = `You are a professional software localization translator. Translate the provided JSON object values into ${langName}. Do not translate the keys. Return valid JSON only. Do not wrap in markdown blocks.`;
                const userPrompt = JSON.stringify(this.resources.en);
                try {
                    const responseText = await Utils.getGeminiResponse([{ role: 'system', parts: [{ text: systemPrompt }] }, { role: 'user', parts: [{ text: userPrompt }] }]);
                    const cleanJson = responseText.replace(/```json/g, '').replace(/```/g, '').trim();
                    this.resources[langKey] = JSON.parse(cleanJson); this.setLocale(langKey); return langKey;
                } catch (e) { console.error("Translation failed:", e); throw new Error("Failed to translate app."); }
            }
            static t(key, params = {}) { const keys = key.split('.'); let value = this.resources[this.currentLocale] || this.resources['en']; for (const k of keys) { if (value && value[k]) { value = value[k]; } else { return key; } } Object.keys(params).forEach(param => { value = value.replace(`{${param}}`, params[param]); }); return value; }
            static translatePage(rootElement = document) { rootElement.querySelectorAll('[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); const text = this.t(key); if (el.placeholder) { el.placeholder = text; } else { let html = text; if(key === 'auth.privacy_warning') { el.innerHTML = html; } else { el.textContent = html; } } }); }
        }

        /* =========================================
           SECTION 3: STATE & SERVICES
           ========================================= */
        class Store {
            constructor() { this.state = { user: null, currentCaseId: null, currentCaseData: null, observations: [] }; this.listeners = []; }
            subscribe(listener) { this.listeners.push(listener); return () => { this.listeners = this.listeners.filter(l => l !== listener); }; }
            setState(newState) { this.state = { ...this.state, ...newState }; this.listeners.forEach(listener => listener(this.state)); }
            getState() { return this.state; }
        }

        class Repository {
            constructor(store) { 
                this.store = store; 
                this.db = null; 
                this.casesUnsubscribe = null; 
                this.observationsUnsubscribe = null; 
                this.fidelityUnsubscribe = null; // NEW: Track fidelity listener
                
                // HYBRID STORAGE: Memory DB Structure
                this.memoryDb = {
                    cases: [],       // Array of case objects
                    observations: {}, // Map: caseId -> [Array of observation objects]
                    fidelityLogs: {}  // NEW: Map: caseId -> [Array of log objects]
                };
                // Listeners for memory mode (simulating onSnapshot)
                this.listeners = {
                    cases: [],
                    observations: {}, // Map: caseId -> [Array of callbacks]
                    fidelityLogs: {}  // NEW: Map: caseId -> [Array of callbacks]
                };
            }

            init(app) { 
                // Only use Firebase if app exists AND config is valid
                if (app && APP_CONFIG.firebaseConfig) {
                    this.db = getFirestore(app); 
                } else {
                    console.log("Repository initialized in Memory Mode (Offline)");
                }
            }

            // --- HELPER: Memory Notification ---
            _notifyCases() {
                const mockSnapshot = {
                    empty: this.memoryDb.cases.length === 0,
                    docs: this.memoryDb.cases.map(c => ({ id: c.id, data: () => c }))
                };
                this.listeners.cases.forEach(cb => cb(mockSnapshot));
            }

            _notifyObservations(caseId) {
                const obsList = this.memoryDb.observations[caseId] || [];
                const mockSnapshot = {
                    docs: obsList.map(o => ({ id: o.id, data: () => o }))
                };
                // Update store directly in memory mode too
                this.store.setState({ observations: [...obsList] });
            }

            // NEW: Memory Notification for Fidelity
            _notifyFidelity(caseId) {
                const logs = this.memoryDb.fidelityLogs[caseId] || [];
                const mockSnapshot = {
                    docs: logs.map(l => ({ id: l.id, data: () => l }))
                };
                const listeners = this.listeners.fidelityLogs[caseId] || [];
                listeners.forEach(cb => cb(mockSnapshot));
            }

            // --- HYBRID METHODS ---

            subscribeToCases(userId, callback) { 
                if (this.db) {
                    // Cloud Mode
                    if (this.casesUnsubscribe) this.casesUnsubscribe(); 
                    const q = collection(this.db, `/artifacts/${APP_CONFIG.appId}/users/${userId}/cases`); 
                    this.casesUnsubscribe = onSnapshot(q, callback); 
                } else {
                    // Memory Mode
                    this.listeners.cases.push(callback);
                    this._notifyCases(); // Immediate initial load
                }
            }

            subscribeToObservations(userId, caseId) { 
                if (this.db) {
                    // Cloud Mode
                    if (this.observationsUnsubscribe) this.observationsUnsubscribe(); 
                    const q = collection(this.db, `/artifacts/${APP_CONFIG.appId}/users/${userId}/cases/${caseId}/observations`); 
                    this.observationsUnsubscribe = onSnapshot(q, snapshot => { 
                        const obs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
                        this.store.setState({ observations: obs }); 
                    }); 
                } else {
                    // Memory Mode
                    // Just notify immediately for the requested case
                    this._notifyObservations(caseId);
                }
            }

            // NEW: Subscribe to Fidelity Logs
            subscribeToFidelityLogs(userId, caseId, callback) {
                if (this.db) {
                    if (this.fidelityUnsubscribe) this.fidelityUnsubscribe();
                    const q = collection(this.db, `/artifacts/${APP_CONFIG.appId}/users/${userId}/cases/${caseId}/fidelity_logs`);
                    this.fidelityUnsubscribe = onSnapshot(q, callback);
                } else {
                    if (!this.listeners.fidelityLogs[caseId]) this.listeners.fidelityLogs[caseId] = [];
                    this.listeners.fidelityLogs[caseId].push(callback);
                    this._notifyFidelity(caseId);
                }
            }

            async createCase(userId, data) { 
                if (this.db) {
                    const path = `/artifacts/${APP_CONFIG.appId}/users/${userId}/cases`; 
                    await addDoc(collection(this.db, path), { ...data, createdAt: serverTimestamp(), ownerId: userId }); 
                } else {
                    const newCase = { ...data, id: crypto.randomUUID(), createdAt: new Date(), ownerId: userId };
                    this.memoryDb.cases.push(newCase);
                    this._notifyCases();
                }
            }

            async updateCase(userId, caseId, data) { 
                if (this.db) {
                    const ref = doc(this.db, `/artifacts/${APP_CONFIG.appId}/users/${userId}/cases/${caseId}`); 
                    await updateDoc(ref, { ...data, updatedAt: serverTimestamp() }); 
                } else {
                    const index = this.memoryDb.cases.findIndex(c => c.id === caseId);
                    if (index !== -1) {
                        this.memoryDb.cases[index] = { ...this.memoryDb.cases[index], ...data, updatedAt: new Date() };
                        this._notifyCases();
                    }
                }
                // Update local store state for immediate UI reflection in current view
                const current = this.store.getState().currentCaseData; 
                this.store.setState({ currentCaseData: { ...current, ...data }}); 
            }

            async addObservation(userId, caseId, data) { 
                if (this.db) {
                    const path = `/artifacts/${APP_CONFIG.appId}/users/${userId}/cases/${caseId}/observations`; 
                    await addDoc(collection(this.db, path), { ...data, createdAt: serverTimestamp() }); 
                } else {
                    if (!this.memoryDb.observations[caseId]) this.memoryDb.observations[caseId] = [];
                    const newObs = { ...data, id: crypto.randomUUID(), createdAt: new Date() };
                    this.memoryDb.observations[caseId].push(newObs);
                    this._notifyObservations(caseId);
                }
            }

            // NEW: Add Fidelity Log
            async addFidelityLog(userId, caseId, logData) {
                if (this.db) {
                    const path = `/artifacts/${APP_CONFIG.appId}/users/${userId}/cases/${caseId}/fidelity_logs`;
                    await addDoc(collection(this.db, path), { ...logData, createdAt: serverTimestamp() });
                } else {
                    if (!this.memoryDb.fidelityLogs[caseId]) this.memoryDb.fidelityLogs[caseId] = [];
                    this.memoryDb.fidelityLogs[caseId].push({ ...logData, id: crypto.randomUUID(), createdAt: new Date() });
                    this._notifyFidelity(caseId);
                }
            }

            async updateObservation(userId, caseId, obsId, data) { 
                if (this.db) {
                    const ref = doc(this.db, `/artifacts/${APP_CONFIG.appId}/users/${userId}/cases/${caseId}/observations`, obsId); 
                    await updateDoc(ref, data); 
                } else {
                    const obsList = this.memoryDb.observations[caseId];
                    if (obsList) {
                        const index = obsList.findIndex(o => o.id === obsId);
                        if (index !== -1) {
                            obsList[index] = { ...obsList[index], ...data };
                            this._notifyObservations(caseId);
                        }
                    }
                }
            }

            async deleteObservation(userId, caseId, obsId) { 
                if (this.db) {
                    const ref = doc(this.db, `/artifacts/${APP_CONFIG.appId}/users/${userId}/cases/${caseId}/observations`, obsId); 
                    await deleteDoc(ref); 
                } else {
                    const obsList = this.memoryDb.observations[caseId];
                    if (obsList) {
                        this.memoryDb.observations[caseId] = obsList.filter(o => o.id !== obsId);
                        this._notifyObservations(caseId);
                    }
                }
            }
            
            async deleteCase(userId, caseId) {
                if (this.db) {
                    // Cloud Mode: Manual subcollection delete
                    const obsRef = collection(this.db, `/artifacts/${APP_CONFIG.appId}/users/${userId}/cases/${caseId}/observations`);
                    const snapshot = await getDocs(obsRef);
                    const batch = writeBatch(this.db);
                    snapshot.docs.forEach(doc => { batch.delete(doc.ref); });
                    
                    // NEW: Also delete fidelity logs
                    const fidRef = collection(this.db, `/artifacts/${APP_CONFIG.appId}/users/${userId}/cases/${caseId}/fidelity_logs`);
                    const fidSnap = await getDocs(fidRef);
                    fidSnap.docs.forEach(doc => { batch.delete(doc.ref); });

                    const caseRef = doc(this.db, `/artifacts/${APP_CONFIG.appId}/users/${userId}/cases/${caseId}`);
                    batch.delete(caseRef);
                    await batch.commit();
                } else {
                    // Memory Mode
                    this.memoryDb.cases = this.memoryDb.cases.filter(c => c.id !== caseId);
                    delete this.memoryDb.observations[caseId];
                    delete this.memoryDb.fidelityLogs[caseId];
                    this._notifyCases();
                }
            }

            async getCase(userId, caseId) { 
                if (this.db) {
                    const snap = await getDoc(doc(this.db, `/artifacts/${APP_CONFIG.appId}/users/${userId}/cases/${caseId}`)); 
                    return snap.exists() ? snap.data() : null; 
                } else {
                    return this.memoryDb.cases.find(c => c.id === caseId) || null;
                }
            }

            cleanup() { 
                if (this.casesUnsubscribe) this.casesUnsubscribe(); 
                if (this.observationsUnsubscribe) this.observationsUnsubscribe(); 
                if (this.fidelityUnsubscribe) this.fidelityUnsubscribe();
            }
        }

        class AuthService {
            constructor(store) { this.store = store; this.auth = null; }
            
            init(app) { 
                // Only initialize Auth if app exists AND config is valid
                if (app && APP_CONFIG.firebaseConfig) {
                    this.auth = getAuth(app); 
                    setPersistence(this.auth, inMemoryPersistence); 
                    onAuthStateChanged(this.auth, user => { 
                        this.store.setState({ user: user }); 
                        document.getElementById('loading-screen').classList.add('hidden'); 
                    }); 
                } else {
                    // OFFLINE MODE: Simulate Login
                    console.log("AuthService initialized in Memory Mode (Guest Access)");
                    const guestUser = { 
                        uid: 'guest-session-' + Math.floor(Math.random() * 10000), 
                        isAnonymous: true, 
                        displayName: 'Guest User' 
                    };
                    this.store.setState({ user: guestUser });
                    document.getElementById('loading-screen').classList.add('hidden');
                }
            }

            async login() { 
                if (this.auth) {
                    try { 
                        if (APP_CONFIG.initialAuthToken) { await signInWithCustomToken(this.auth, APP_CONFIG.initialAuthToken); } 
                        else { await signInAnonymously(this.auth); } 
                    } catch (e) { 
                        if (e.code === 'auth/invalid-custom-token') { await signInAnonymously(this.auth); } 
                    } 
                } else {
                    // Offline mode is auto-logged in, just go to dashboard
                    window.app.router.navigateTo('dashboard');
                }
            }

            async logout() { 
                if (this.auth) { await signOut(this.auth); } 
                else { window.location.reload(); } // Hard reset for memory mode
            }
        }

        /* =========================================
           SECTION 4: VIEW CONTROLLERS (UI LOGIC)
           ========================================= */
        class BaseController {
            constructor(store, repo) { this.store = store; this.repo = repo; this.mainContent = document.getElementById('view-container'); }
            mount() { /* Override */ }
            unmount() { this.mainContent.innerHTML = ''; }
        }

        class LoginController extends BaseController {
            mount() {
                const template = document.getElementById('login-screen-template');
                this.mainContent.appendChild(template.cloneNode(true));
                this.mainContent.firstElementChild.classList.remove('hidden'); 
                document.getElementById('anonymous-login-btn').addEventListener('click', () => window.app.authService.login());
                I18nService.translatePage(this.mainContent);
                // Hide guide on login
                document.getElementById('pigeon-guide-btn').classList.add('hidden');
            }
        }

        class DashboardController extends BaseController {
            mount() {
                // 1. Clear View
                this.mainContent.innerHTML = '';
                
                // 2. Programmatically Build the Dashboard UI
                // We avoid templates completely for the header to ensure button validity.
                const dashboardContainer = document.createElement('div');
                dashboardContainer.className = "max-w-7xl mx-auto px-4 sm:px-6 lg:px-8";
                
                dashboardContainer.innerHTML = `
                    <!-- Settings Mount Point -->
                    <div id="dash-settings-area"></div>

                    <!-- Header -->
                    <div class="flex justify-between items-center mb-8 mt-6">
                        <h1 class="text-3xl font-bold text-gray-900" data-i18n="dashboard.title">Case Dashboard</h1>
                        <div class="flex space-x-3">
                            <input type="file" id="manual-import-input" class="hidden" accept=".json">
                            <button id="manual-import-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                <span>Import JSON</span>
                            </button>
                            <button id="manual-add-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform active:scale-95">
                                + New Case
                            </button>
                        </div>
                    </div>

                    <!-- Grid -->
                    <div id="cases-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    
                    <!-- Empty State -->
                    <div id="no-cases-message" class="hidden text-center py-12 bg-white rounded-lg shadow">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9-1V7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2z" /></svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">No cases</h3>
                        <p class="mt-1 text-sm text-gray-500">Get started by creating a new case.</p>
                    </div>
                `;
                
                this.mainContent.appendChild(dashboardContainer);

                // 3. Attach Events - DYNAMIC MODAL INJECTION
                document.getElementById('manual-add-btn').onclick = (e) => {
                    e.preventDefault();
                    this.openDynamicModal(); // Call the new dynamic modal function
                };

                const impInput = document.getElementById('manual-import-input');
                document.getElementById('manual-import-btn').onclick = () => impInput.click();
                impInput.onchange = async (e) => {
                    if(e.target.files.length > 0) {
                        try {
                            const data = await Utils.readJsonFile(e.target.files[0]);
                            await this.importCaseHelper(data);
                            e.target.value = ''; 
                        } catch(err) { Utils.showNotification("messages.import_fail", "error"); }
                    }
                };

                // 4. Inject Settings (Clone the settings part of the template safely)
                const template = document.getElementById('dashboard-screen-template');
                if (template) {
                    const settingsBlock = template.querySelector('.bg-white.p-4.rounded-lg.shadow'); 
                    if (settingsBlock) {
                        const clone = settingsBlock.cloneNode(true);
                        document.getElementById('dash-settings-area').appendChild(clone);
                        this.setupSettings(clone);
                    }
                }

                // Initialize
                I18nService.translatePage(this.mainContent);
                this.fetchAndDisplayCases();
                document.getElementById('pigeon-guide-btn').classList.remove('hidden');
            }

            // --- NEW: DYNAMIC MODAL BUILDER ---
            // Creates the modal from scratch every time to ensure it works
            openDynamicModal() {
                // Remove any existing instances
                const existing = document.getElementById('dynamic-new-case-modal');
                if (existing) existing.remove();

                const modal = document.createElement('div');
                modal.id = 'dynamic-new-case-modal';
                modal.className = 'fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[9999]';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full m-4 relative animate-fade-in-down">
                        <button id="dyn-close-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">‚úï</button>
                        <h3 class="text-2xl font-bold mb-6 text-gray-900">Create a New Case</h3>
                        <form id="dyn-case-form">
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700">Codename / Identifier</label>
                                <input type="text" id="dyn-student-name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required placeholder="e.g. Student A">
                                <p class="text-xs text-gray-500 mt-1"><strong>Privacy Notice:</strong> Do not enter real names.</p>
                            </div>
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700">Grade Level</label>
                                <input type="text" id="dyn-student-grade" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required placeholder="e.g. 5th, K, 10">
                            </div>
                            <div class="flex justify-end space-x-3">
                                <button type="button" id="dyn-cancel-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors">Cancel</button>
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors">Create Case</button>
                            </div>
                        </form>
                    </div>
                `;

                document.body.appendChild(modal);

                // Bind Events
                const close = () => modal.remove();
                document.getElementById('dyn-close-btn').onclick = close;
                document.getElementById('dyn-cancel-btn').onclick = close;
                
                document.getElementById('dyn-case-form').onsubmit = async (e) => {
                    e.preventDefault();
                    const name = document.getElementById('dyn-student-name').value;
                    const grade = document.getElementById('dyn-student-grade').value;
                    if(name && grade) {
                        await this.repo.createCase(this.store.getState().user.uid, { studentName: name, gradeLevel: grade, status: 'Active' });
                        Utils.showNotification("Case created successfully!");
                        close();
                    }
                };
            }

            unmount() {
                const existingFab = document.getElementById('fab-new-case');
                if (existingFab) existingFab.remove();
                super.unmount();
            }

            setupSettings(container) {
                // Scope selectors to the passed container to avoid finding hidden template elements
                const scope = container || document;
                const schoolInput = scope.querySelector('#setting-school-name');
                const districtInput = scope.querySelector('#setting-district');
                const saveBtn = scope.querySelector('#save-settings-btn');
                const logoInput = scope.querySelector('#school-logo-upload');
                const logoPreview = scope.querySelector('#logo-preview');
                const clearLogoBtn = scope.querySelector('#clear-logo-btn');

                if (!saveBtn) return; // Guard clause

                // Load from localStorage
                schoolInput.value = localStorage.getItem('fba_school_name') || '';
                districtInput.value = localStorage.getItem('fba_district') || '';
                const savedLogo = localStorage.getItem('fba_school_logo');
                
                if (savedLogo) {
                    logoPreview.innerHTML = `<img src="${savedLogo}" class="w-full h-full object-contain">`;
                    clearLogoBtn.classList.remove('hidden');
                }

                // Logo Upload Logic
                logoInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if(file) {
                        if (file.size > 500000) { // 500KB limit
                            Utils.showNotification("Image too large (Max 500KB)", "error");
                            e.target.value = '';
                            return;
                        }
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            const base64 = reader.result;
                            try {
                                localStorage.setItem('fba_school_logo', base64);
                                logoPreview.innerHTML = `<img src="${base64}" class="w-full h-full object-contain">`;
                                clearLogoBtn.classList.remove('hidden');
                                Utils.showNotification("Logo saved!");
                            } catch (e) {
                                Utils.showNotification("Storage full. Remove old data.", "error");
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });

                // Clear Logo Logic
                clearLogoBtn.addEventListener('click', () => {
                    localStorage.removeItem('fba_school_logo');
                    logoPreview.innerHTML = 'No Logo';
                    logoInput.value = '';
                    clearLogoBtn.classList.add('hidden');
                    Utils.showNotification("Logo removed.");
                });

                saveBtn.addEventListener('click', () => {
                    localStorage.setItem('fba_school_name', schoolInput.value);
                    localStorage.setItem('fba_district', districtInput.value);
                    
                    // Visual Feedback
                    const originalText = saveBtn.innerText;
                    saveBtn.innerText = "Saved!";
                    saveBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    saveBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    
                    setTimeout(() => {
                        saveBtn.innerText = originalText;
                        saveBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                        saveBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    }, 2000);
                    
                    Utils.showNotification("Settings saved locally.");
                });
            }

            // Removed setupImport() as it is now handled inside mount()

            async importCaseHelper(jsonData) {
                if (jsonData.type !== 'FBA_CASE' && jsonData.type !== 'BAPS_CASE' || !jsonData.case) { throw new Error("Invalid file format."); }
                const userId = this.store.getState().user.uid;
                const newCaseData = { ...jsonData.case, status: 'Imported', createdAt: serverTimestamp(), importedAt: serverTimestamp() };
                delete newCaseData.id; 
                const batch = writeBatch(this.repo.db);
                const caseRef = doc(collection(this.repo.db, `/artifacts/${APP_CONFIG.appId}/users/${userId}/cases`));
                batch.set(caseRef, newCaseData);
                
                if (jsonData.observations) {
                    const obsPath = `/artifacts/${APP_CONFIG.appId}/users/${userId}/cases/${caseRef.id}/observations`;
                    jsonData.observations.forEach(obs => {
                        const obsRef = doc(collection(this.repo.db, obsPath));
                        const obsData = { ...obs }; delete obsData.id;
                        if (typeof obsData.observationTime === 'string') obsData.observationTime = new Date(obsData.observationTime);
                        batch.set(obsRef, obsData);
                    });
                }
                await batch.commit();
                Utils.showNotification("messages.import_success");
            }

            fetchAndDisplayCases() {
                const casesList = document.getElementById('cases-list');
                const noCasesMessage = document.getElementById('no-cases-message');
                const userId = this.store.getState().user.uid;
                
                this.repo.subscribeToCases(userId, (snapshot) => {
                    casesList.innerHTML = '';
                    if (snapshot.empty) { noCasesMessage.classList.remove('hidden'); } else {
                        noCasesMessage.classList.add('hidden');
                        snapshot.docs.forEach(doc => {
                            const caseCard = this.renderCaseCard(doc.data(), doc.id);
                            casesList.appendChild(caseCard);
                        });
                    }
                });
            }

            renderCaseCard(caseData, caseId) {
                const card = document.createElement('div');
                card.className = "bg-white rounded-lg shadow p-6 cursor-pointer hover:shadow-lg transition-shadow relative group";
                
                // Logic for Strategy/Status Snippet
                let strategySnippet = '';
                if (caseData.bipPreventContent) {
                    const text = Utils.stripHtml(caseData.bipPreventContent).substring(0, 60) + (caseData.bipPreventContent.length > 60 ? '...' : '');
                    strategySnippet = `
                        <div class="mt-3 pt-3 border-t border-gray-100">
                            <span class="text-[10px] uppercase font-bold text-gray-400">Primary Strategy</span>
                            <p class="text-xs text-blue-700 font-medium bg-blue-50 px-2 py-1 rounded mt-1 line-clamp-2">${text}</p>
                        </div>
                    `;
                } else if (caseData.analysisHypothesis) {
                     strategySnippet = `
                        <div class="mt-3 pt-3 border-t border-gray-100">
                            <span class="text-[10px] uppercase font-bold text-gray-400">Status</span>
                            <p class="text-xs text-purple-700 font-medium">Analysis in progress...</p>
                        </div>
                    `;
                }

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">${caseData.studentName}</h3>
                            <p class="text-sm text-gray-600 mt-1">Grade: ${caseData.gradeLevel || 'N/A'}</p>
                        </div>
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-bold ${caseData.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${caseData.status}
                        </span>
                    </div>
                    
                    ${strategySnippet}

                    <button class="delete-case-btn absolute top-4 right-4 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-2" data-id="${caseId}" title="Delete Case">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                `;
                
                // Add click event for card navigation
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('.delete-case-btn')) {
                        window.app.router.navigateTo('case', { id: caseId, data: caseData });
                    }
                });

                // Add click event for delete button
                card.querySelector('.delete-case-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    window.app.openDeleteCaseModal(caseId);
                });
                
                return card;
            }
        }

        // --- Step Managers for Case Detail ---
        class InterviewManager {
            constructor(controller) { this.c = controller; }
            init() {
                const data = this.c.store.getState().currentCaseData;
                if (data.interviewSummary) { this.renderSummary(data.interviewSummary); return; }
                this.c.bind('#send-btn', 'click', () => this.handleSendMessage());
                this.c.bind('#chat-input', 'keyup', (e) => { if(e.key==='Enter') this.handleSendMessage(); });
                // LOC: Use localized system prompt
                this.chatHistory = [{ role: 'system', parts: [{ text: `${I18nService.t('interview.system_prompt')} IMPORTANT: Reply in ${I18nService.currentLocale} language.` }] }];
                this.addMessage(I18nService.t('interview.intro'), 'model');
            }
            async handleSendMessage() {
                const input = document.getElementById('chat-input');
                const msg = input.value.trim(); if (!msg) return;
                this.addMessage(msg, 'user'); input.value = '';
                this.chatHistory.push({ role: 'user', parts: [{ text: msg }] });
                Utils.showTypingIndicator('chat-window', true);
                const response = await Utils.getGeminiResponse(this.chatHistory);
                Utils.showTypingIndicator('chat-window', false);
                if (response.includes('I believe I have enough information now.') || response.includes('suficiente informaci√≥n')) { this.endInterview(response); }
                else { this.addMessage(response, 'model'); this.chatHistory.push({ role: 'model', parts: [{ text: response }] }); }
            }
            addMessage(text, sender) {
                const win = document.getElementById('chat-window'); if(!win) return;
                const bub = document.createElement('div'); bub.className = `chat-bubble ${sender === 'user' ? 'chat-bubble-user' : 'chat-bubble-model'}`; bub.textContent = text;
                win.appendChild(bub); win.scrollTop = win.scrollHeight;
            }
            async endInterview(response) {
                const summaryRaw = response.split(/I believe I have enough information now\.|suficiente informaci√≥n/)[1]?.trim() || response;
                const temp = document.createElement('div'); temp.innerHTML = summaryRaw;
                const h4 = Array.from(temp.querySelectorAll('h4')).find(h => h.textContent.includes('Summary') || h.textContent.includes('Resumen'));
                if(h4) h4.remove();
                await this.c.repo.updateCase(this.c.userId, this.c.caseId, { interviewSummary: temp.innerHTML });
                this.renderSummary(temp.innerHTML);
                this.c.updateSteps();
            }
            renderSummary(html) {
                document.getElementById('chat-input-container').classList.add('hidden');
                document.getElementById('interview-summary-container').classList.remove('hidden');
                document.getElementById('summary-content').innerHTML = html;
            }
        }

        class AnalysisManager {
            constructor(controller) { this.c = controller; }
            init() {
                this.c.bind('#add-abc-btn', 'click', () => window.app.openAbcModal());
                this.c.bind('#analyze-data-btn', 'click', () => this.analyzeData());
                this.c.bind('#export-csv-btn', 'click', () => this.exportToCSV());
                this.c.bind('#print-data-btn', 'click', () => this.printDataLog()); // Bind Print Button
                this.c.bind('#analyze-records-btn', 'click', () => this.analyzeRecords());
                this.c.bind('#abc-data-body', 'click', (e) => this.handleTableActions(e));
                
                // NEW: Narrative Generator Binding
                this.c.bind('#generate-narrative-btn', 'click', () => this.generateNarrative());

                // NEW: Environment Audit Binding
                this.setupEnvAudit();

                // NEW: Annotation Tools Binding (Option 2)
                this.c.bind('#add-anno-btn', 'click', () => this.addAnnotation());

                // NEW: Paper Log Scan Bindings
                this.c.bind('#scan-paper-log-btn', 'click', () => document.getElementById('paper-log-upload').click());
                this.c.bind('#paper-log-upload', 'change', (e) => this.handlePaperLog(e.target.files[0]));

                // Filter bindings
                this.c.bind('#abc-filter-search', 'input', () => this.renderView());
                this.c.bind('#abc-filter-behavior', 'change', () => this.renderView());

                const data = this.c.store.getState().currentCaseData;
                if(data.recordReviewText) document.getElementById('record-review-text').value = data.recordReviewText;
                if(data.recordAnalysis) this.displayRecordAnalysis(data.recordAnalysis);
                if(data.analysisHypothesis) this.displayAnalysis(data.analysisHypothesis);
                
                // Load Env Audit Data
                if(data.envAuditData) {
                    const checkboxes = document.querySelectorAll('.env-chk');
                    data.envAuditData.forEach((checked, i) => {
                        if(checkboxes[i]) checkboxes[i].checked = checked;
                    });
                    // Trigger calculation to update UI without saving
                    document.getElementById('calc-env-score').click();
                }

                // Initialize Routine Matrix (Option 2)
                this.renderRoutineMatrix();

                this.c.repo.subscribeToObservations(this.c.userId, this.c.caseId);
                this.c.store.subscribe((state) => {
                    this.renderView();
                });
            }

            // NEW: Routine Matrix Logic (Option 2)
            renderRoutineMatrix() {
                const container = document.getElementById('routine-matrix-container');
                if (!container) return;

                const data = this.c.store.getState().currentCaseData.routineMatrix || {};
                const routines = ['Arrival', 'Morning Meeting', 'ELA/Reading', 'Math', 'Lunch/Recess', 'Science/SS', 'Specials', 'Dismissal'];
                const colors = ['#f0fdf4', '#dcfce7', '#fef9c3', '#fee2e2', '#fecaca']; // 1-5 (Green to Red)

                let html = `
                    <div class="bg-white p-4 rounded-lg border border-gray-200 mb-6 shadow-sm no-print">
                        <div class="flex justify-between items-center mb-3">
                            <h5 class="font-bold text-gray-700 flex items-center">
                                <span class="text-xl mr-2">üå°Ô∏è</span> Routine Hotspot Analysis
                            </h5>
                            <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">Rate Difficulty (1-5)</span>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">`;

                routines.forEach(r => {
                    // Simple key sanitization for storage
                    const key = r.replace(/[^a-zA-Z]/g, '');
                    const val = data[key] || 1;
                    const bg = colors[val - 1];
                    
                    html += `
                        <div class="p-3 border rounded transition-colors duration-300" style="background-color: ${bg}">
                            <label class="block text-xs font-bold text-gray-700 mb-2 truncate" title="${r}">${r}</label>
                            <input type="range" min="1" max="5" value="${val}" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer routine-slider accent-gray-600" data-key="${key}">
                            <div class="flex justify-between text-[10px] text-gray-500 mt-1 font-bold">
                                <span>Low</span>
                                <span class="val-display text-gray-900 text-sm">${val}</span>
                                <span>High</span>
                            </div>
                        </div>`;
                });

                html += `</div></div>`;
                container.innerHTML = html;

                // Bindings
                container.querySelectorAll('.routine-slider').forEach(input => {
                    input.addEventListener('input', (e) => {
                        const val = parseInt(e.target.value);
                        const parent = e.target.parentElement;
                        parent.style.backgroundColor = colors[val - 1];
                        parent.querySelector('.val-display').textContent = val;
                    });

                    input.addEventListener('change', async (e) => {
                        const key = e.target.dataset.key;
                        const val = parseInt(e.target.value);
                        
                        // Get fresh state
                        const currentMatrix = this.c.store.getState().currentCaseData.routineMatrix || {};
                        const updatedMatrix = { ...currentMatrix, [key]: val };
                        
                        await this.c.repo.updateCase(this.c.userId, this.c.caseId, { routineMatrix: updatedMatrix });
                    });
                });
            }

            async handlePaperLog(file) {
                if (!file) return;
                Utils.setLoading('scan-paper-log-btn', true);
                
                try {
                    const base64Data = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                    
                    const base64 = base64Data.split(',')[1];
                    const mimeType = file.type;

                    const prompt = `Analyze this image of a behavior log. Extract the data into a JSON ARRAY.
                    Each item must have: 
                    - "time": String (HH:MM format, e.g. "10:30"). If missing, estimate or use "09:00".
                    - "antecedent": String (Trigger).
                    - "behavior": String (Action).
                    - "consequence": String (Outcome).
                    
                    Return ONLY raw JSON. No markdown. No code fences.`;

                    const response = await Utils.getGeminiResponse([
                        { role: "user", parts: [
                            { text: prompt },
                            { inlineData: { mimeType: mimeType, data: base64 } }
                        ]}
                    ]);

                    // Sanitize response
                    const cleanJson = response.replace(/```json/g, '').replace(/```/g, '').trim();
                    const entries = JSON.parse(cleanJson);

                    if (!Array.isArray(entries)) throw new Error("Invalid format");

                    let count = 0;
                    const today = new Date().toISOString().split('T')[0];

                    for (const entry of entries) {
                        // Construct Date object
                        const timeStr = entry.time || "12:00";
                        const obsTime = new Date(`${today}T${timeStr}`);
                        
                        await this.c.repo.addObservation(this.c.userId, this.c.caseId, {
                            antecedent: entry.antecedent || "Unknown",
                            behavior: entry.behavior || "Unknown",
                            consequence: entry.consequence || "Unknown",
                            observationTime: obsTime,
                            setting: "Imported from Scan",
                            source: "Paper Scan"
                        });
                        count++;
                    }
                    
                    Utils.showNotification(`Successfully imported ${count} observations!`);
                    document.getElementById('paper-log-upload').value = ''; // Reset input

                } catch (e) {
                    console.error(e);
                    Utils.showNotification("Failed to scan log. Ensure image is clear.", "error");
                } finally {
                    Utils.setLoading('scan-paper-log-btn', false);
                }
            }

            setupEnvAudit() {
                this.c.bind('#calc-env-score', 'click', async () => {
                    const checks = document.querySelectorAll('.env-chk');
                    const checkedList = Array.from(checks).map(cb => cb.checked);
                    const checkedCount = checkedList.filter(Boolean).length;
                    const score = Math.round((checkedCount / checks.length) * 100);
                    
                    const display = document.getElementById('env-score-display');
                    const badge = document.getElementById('env-score-badge');
                    const rec = document.getElementById('env-recommendation');
                    
                    display.textContent = `${score}%`;
                    badge.textContent = `Score: ${score}%`;
                    badge.classList.remove('hidden');
                    
                    let recText = "";
                    let colorClass = "";

                    if(score < 80) {
                        colorClass = 'text-red-500';
                        recText = "‚ö†Ô∏è Recommendation: Improve environmental supports (aim for 80%+) before assuming behavior is solely student-based.";
                        badge.classList.add('bg-red-100', 'text-red-700');
                        badge.classList.remove('bg-green-100', 'text-green-700', 'bg-gray-100', 'text-gray-600');
                    } else {
                        colorClass = 'text-green-600';
                        recText = "‚úÖ Environment appears well-structured. Proceed with ABC data collection.";
                        badge.classList.add('bg-green-100', 'text-green-700');
                        badge.classList.remove('bg-red-100', 'text-red-700', 'bg-gray-100', 'text-gray-600');
                    }
                    
                    display.className = `font-bold text-2xl transition-colors ${colorClass}`;
                    rec.textContent = recText;
                    rec.className = `text-xs font-medium mt-2 text-right ${colorClass}`;

                    // Persist to Case
                    await this.c.repo.updateCase(this.c.userId, this.c.caseId, { 
                        envAuditScore: score,
                        envAuditData: checkedList 
                    });
                    
                    Utils.showNotification(`Audit Score Saved: ${score}%`);
                });
            }

            renderView() {
                const state = this.c.store.getState();
                const allObs = state.observations || [];
                const tbody = document.getElementById('abc-data-body');
                if(!tbody) return;

                // 1. Update Dropdown Options (preserve selection)
                this.updateDropdown(allObs);

                // 2. Apply Filters
                const searchTerm = document.getElementById('abc-filter-search')?.value.toLowerCase() || '';
                const filterBeh = document.getElementById('abc-filter-behavior')?.value || 'all';
                // Get current heatmap metric state if available, default to count
                const heatmapMetric = document.querySelector('input[name="heatmap-metric"]:checked')?.value || 'count';

                const filteredObs = allObs.filter(o => {
                    const matchSearch = (o.antecedent + o.behavior + o.consequence).toLowerCase().includes(searchTerm);
                    const matchBeh = filterBeh === 'all' || o.behavior.trim() === filterBeh;
                    return matchSearch && matchBeh;
                });

                // 3. Render Components with Filtered Data
                tbody.innerHTML = '';
                this.updateStats(filteredObs);
                
                // NEW: Render Automated Insights
                this.renderInsights(filteredObs);
                
                // NEW: Render Function Pie Chart
                this.renderFunctionPieChart(filteredObs);
                
                // Render Quick Clickers based on ALL data to find true top behaviors
                this.renderQuickClickers(allObs);

                // Render Function Sorter Matrix (Option 1)
                this.renderFunctionSorter(allObs);

                // Show Annotation Tools if data exists
                const annoTools = document.getElementById('annotation-tools');
                if (annoTools) {
                    if (allObs.length > 0) annoTools.classList.remove('hidden');
                    else annoTools.classList.add('hidden');
                }

                // Clear container before re-rendering charts
                document.getElementById('abc-chart-container').innerHTML = ''; 
                this.renderInteractiveScatterplot(); // NEW: Interactive Paint Grid
                this.renderTemporalChart(filteredObs); 
                this.renderScatterplot(filteredObs); 
                this.renderHeatmap(filteredObs, heatmapMetric); // Pass metric
                this.renderDailyTrendChart(filteredObs);
                this.renderMonthlyCalendar(filteredObs); // NEW: Add Monthly Calendar
                this.renderIntensityChart(filteredObs); // Added Intensity Chart
                this.renderDurationChart(filteredObs); // Added Duration Chart
                this.renderSettingChart(filteredObs); // Added Setting Chart
                this.renderCategoricalCharts(filteredObs); 
                this.renderKeywordCloud(filteredObs); // Added Trigger Word Cloud
                
                // Option 1: Pathway Analysis (Replaces old simple pattern logic)
                this.renderPathwayAnalysis(filteredObs);

                // NEW: Smart Schedule Calculator
                this.renderCalculator(filteredObs);

                if (filteredObs.length === 0) {
                     const msg = document.getElementById('no-abc-data-message');
                     msg.classList.remove('hidden');
                     if (allObs.length > 0) {
                        msg.innerHTML = '<p>No data matches your filters.</p>';
                     } else {
                        msg.innerHTML = '<p data-i18n="case_detail.no_data">No ABC data has been recorded for this case yet.</p>';
                        I18nService.translatePage(msg);
                     }
                } else {
                    document.getElementById('no-abc-data-message').classList.add('hidden');
                    filteredObs.sort((a,b) => Utils.safeDate(b.observationTime) - Utils.safeDate(a.observationTime))
                       .forEach(o => tbody.appendChild(this.renderRow(o)));
                }
                
                // Enable analysis button based on total data, not filtered
                const btn = document.getElementById('analyze-data-btn'); 
                if(btn) btn.disabled = allObs.length < 3;
            }

            renderInteractiveScatterplot() {
                const container = document.getElementById('abc-chart-container');
                if(!container) return;

                // UI Wrapper
                const wrapper = document.createElement('div');
                wrapper.className = "mt-4 p-4 bg-white border border-gray-100 rounded-lg shadow-sm overflow-x-auto no-print"; 
                wrapper.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h5 class="text-xs font-bold text-gray-500 uppercase tracking-widest">Interactive Scatterplot (Tap to Log)</h5>
                        <div class="flex space-x-2 text-[10px]">
                            <span class="flex items-center"><span class="w-3 h-3 bg-yellow-300 rounded mr-1"></span> Low</span>
                            <span class="flex items-center"><span class="w-3 h-3 bg-orange-400 rounded mr-1"></span> Med</span>
                            <span class="flex items-center"><span class="w-3 h-3 bg-red-500 rounded mr-1"></span> High</span>
                        </div>
                    </div>
                    <div id="scatterplot-grid" class="grid grid-cols-6 gap-1 min-w-[600px]"></div>
                    <p class="text-[10px] text-gray-400 mt-2 text-right italic">Logs data for the current week</p>
                `;

                // Grid Generation Logic
                const grid = wrapper.querySelector('#scatterplot-grid');
                const times = ["8:00", "9:00", "10:00", "11:00", "12:00", "1:00", "2:00", "3:00"];
                const days = ["Mon", "Tue", "Wed", "Thu", "Fri"];
                
                // Header Row
                grid.innerHTML += `<div class="text-[10px] text-gray-400"></div>`; // Corner
                days.forEach(d => grid.innerHTML += `<div class="text-center text-xs font-bold text-gray-600 bg-gray-50 p-1 rounded">${d}</div>`);

                // Helper to get date for current week's day index (0=Mon, 4=Fri for this grid context)
                const getDateForDay = (dayIndex) => {
                    const d = new Date();
                    const currentDay = d.getDay(); // 0=Sun, 1=Mon...
                    const distance = (dayIndex + 1) - currentDay; // +1 because dayIndex 0 is Monday (1)
                    d.setDate(d.getDate() + distance);
                    return d;
                };

                // Data Rows
                times.forEach(time => {
                    grid.innerHTML += `<div class="text-xs font-mono text-gray-500 self-center">${time}</div>`;
                    days.forEach((day, dayIdx) => {
                        const cellId = `scat-${day}-${time.replace(':','')}`;
                        
                        grid.innerHTML += `
                            <button id="${cellId}" class="h-10 w-full rounded border border-gray-200 hover:border-blue-300 transition-all focus:outline-none scatter-cell"
                                data-day="${dayIdx}" data-time="${time}" data-intensity="0">
                            </button>`;
                    });
                });

                // Add Click Listeners
                wrapper.querySelectorAll('.scatter-cell').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const el = e.currentTarget;
                        let intensity = parseInt(el.dataset.intensity);
                        
                        // Cycle: 0 (None) -> 1 (Low) -> 2 (Med) -> 3 (High) -> 0
                        intensity = (intensity + 1) % 4;
                        el.dataset.intensity = intensity;

                        // Visual Update
                        el.className = "h-10 w-full rounded border transition-all focus:outline-none scatter-cell " + 
                            (intensity === 0 ? "border-gray-200 bg-white" : 
                             intensity === 1 ? "bg-yellow-300 border-yellow-400" :
                             intensity === 2 ? "bg-orange-400 border-orange-500" : 
                             "bg-red-500 border-red-600");

                        if (intensity > 0) {
                            // Calculate specific date
                            const timeStr = el.dataset.time; // e.g. "9:00"
                            const dayIdx = parseInt(el.dataset.day); // 0=Mon
                            
                            const dateObj = getDateForDay(dayIdx);
                            // Set time
                            const [h, m] = timeStr.split(':');
                            let hour = parseInt(h);
                            // Adjust for PM if needed (simple heuristic: 8-11 is AM, 12-3 is PM)
                            // Actually 1:00 is 13:00. The array is "8:00"..."3:00".
                            // If hour < 7, add 12.
                            if (hour < 7) hour += 12;
                            
                            dateObj.setHours(hour, parseInt(m), 0, 0);

                            // Save
                            const obsData = {
                                antecedent: "Scatterplot Log",
                                behavior: "Target Behavior",
                                consequence: "Recorded via Scatterplot",
                                observationTime: dateObj,
                                intensity: intensity * 3, // Scale 1-3 to approx 1-10 scale (3, 6, 9)
                                setting: "Classroom",
                                source: 'scatterplot'
                            };

                            try {
                                await this.c.repo.addObservation(this.c.userId, this.c.caseId, obsData);
                                Utils.showNotification(`Logged: ${days[dayIdx]} ${timeStr}`);
                            } catch(err) {
                                console.error(err);
                                Utils.showNotification("Error saving", "error");
                            }
                        }
                    });
                });

                // Prepend to the chart container so it's at the top
                container.prepend(wrapper);
            }

            renderCalculator(filteredObs) {
                const container = document.getElementById('smart-schedule-container');
                if(!container) return;
                
                // Need at least 2 points to calculate an interval
                if (!filteredObs || filteredObs.length < 2) {
                    container.classList.add('hidden');
                    return;
                }

                // 1. Sort observations chronologically
                const sorted = [...filteredObs].sort((a,b) => Utils.safeDate(a.observationTime) - Utils.safeDate(b.observationTime));
                let diffs = [];
                
                // 2. Calculate time differences between consecutive incidents on the SAME day
                for(let i=1; i<sorted.length; i++) {
                    const t1 = Utils.safeDate(sorted[i-1].observationTime);
                    const t2 = Utils.safeDate(sorted[i].observationTime);
                    
                    // Only calculate if same day and gap is less than 3 hours (ignore long breaks like lunch/recess/next day)
                    if(t1 && t2 && t1.toDateString() === t2.toDateString()) {
                        const diffMin = (t2 - t1) / 1000 / 60; 
                        if(diffMin < 180 && diffMin > 0) diffs.push(diffMin);
                    }
                }
                
                if(diffs.length === 0) {
                    container.classList.add('hidden');
                    return;
                }
                
                // 3. Calculate Average IRT and Recommended Schedule (80% of IRT)
                const avgIRT = diffs.reduce((a,b)=>a+b,0) / diffs.length;
                const recommended = Math.floor(avgIRT * 0.8); // 80% rule for effectiveness
                const recVal = recommended || 1; // Minimum 1 min
                
                container.innerHTML = `
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-4 flex flex-col sm:flex-row justify-between items-center gap-4 shadow-sm">
                        <div class="flex-grow">
                            <div class="flex items-center mb-1">
                                <h5 class="font-bold text-green-800 text-sm flex items-center mr-2">
                                    <span class="text-xl mr-2">‚è±Ô∏è</span> Smart Schedule (DRO/NCR)
                                </h5>
                                <div class="relative group">
                                    <svg class="w-4 h-4 text-green-600 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 hidden group-hover:block w-64 bg-gray-800 text-white text-xs rounded p-2 shadow-lg z-20">
                                        <strong>DRO:</strong> Reward when behavior is ABSENT for this interval.<br>
                                        <strong>NCR:</strong> Give attention/item freely every interval to reduce drive.<br>
                                        Based on 80% of current Inter-Response Time.
                                    </div>
                                </div>
                            </div>
                            <p class="text-xs text-green-700">
        <div id="case-detail-screen-template" class="hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <!-- Header Actions -->
                <div class="flex justify-between items-center mb-6 no-print">
                    <button id="back-to-dashboard-btn" class="inline-flex items-center text-sm font-medium text-blue-600 hover:text-blue-800" data-i18n="case_detail.back_btn">&larr; Back to Dashboard</button>
                    <div class="flex space-x-2">
                        <!-- NEW: Handoff Button -->
                        <button id="handoff-btn" class="bg-indigo-100 hover:bg-indigo-200 text-indigo-800 text-sm font-semibold py-2 px-4 rounded border border-indigo-300 flex items-center shadow-sm transition-transform active:scale-95" title="Copy Shift Handoff Summary">
                            <span class="mr-2">üìã</span> Handoff
                        </button>
                        <!-- NEW: Home Note Button (Option 2) -->
                        <button id="home-note-btn" class="bg-pink-600 hover:bg-pink-700 text-white text-sm font-semibold py-2 px-4 rounded border border-pink-800 flex items-center shadow-sm transition-transform active:scale-95">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                            Home Note
                        </button>
                        </div>
                    </div>
                `;
                container.classList.remove('hidden');
            }

            renderInsights(obs) {
                const container = document.getElementById('automated-insights-grid');
                if (!container) return;

                if (!obs || obs.length < 3) {
                    container.classList.add('hidden');
                    return;
                }

                // Helper to find mode
                const getMode = (arr) => {
                    if (arr.length === 0) return "N/A";
                    const counts = {};
                    let maxVal = 0, maxKey = "";
                    arr.forEach(k => {
                        counts[k] = (counts[k] || 0) + 1;
                        if (counts[k] > maxVal) { maxVal = counts[k]; maxKey = k; }
                    });
                    return maxKey;
                };

                // 1. High Risk Day
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const dayNames = obs.map(o => {
                    const d = Utils.safeDate(o.observationTime);
                    return d ? days[d.getDay()] : null;
                }).filter(d => d);
                const topDay = getMode(dayNames);

                // 2. High Risk Time (Hour windows)
                const hours = obs.map(o => {
                    const d = Utils.safeDate(o.observationTime);
                    if (!d) return null;
                    const h = d.getHours();
                    const ampm = h >= 12 ? 'PM' : 'AM';
                    const h12 = h % 12 || 12;
                    return `${h12} ${ampm}`;
                }).filter(h => h);
                const topTime = getMode(hours);

                // 3. Top Trigger
                const ants = obs.map(o => o.antecedent ? o.antecedent.trim() : null).filter(a => a);
                const topAnt = getMode(ants);

                container.innerHTML = `
                    <div class="bg-gradient-to-br from-orange-50 to-white border-l-4 border-orange-500 p-4 rounded shadow-sm">
                        <div class="flex items-center justify-between mb-1">
                            <div class="text-xs font-bold text-orange-800 uppercase tracking-wide">High Risk Day</div>
                            <span class="text-xl">üìÖ</span>
                        </div>
                        <div class="text-xl font-bold text-gray-800">${topDay}</div>
                        <div class="text-xs text-gray-500">Most incidents occur on this day</div>
                    </div>
                    <div class="bg-gradient-to-br from-blue-50 to-white border-l-4 border-blue-500 p-4 rounded shadow-sm">
                        <div class="flex items-center justify-between mb-1">
                            <div class="text-xs font-bold text-blue-800 uppercase tracking-wide">High Risk Time</div>
                            <span class="text-xl">‚è∞</span>
                        </div>
                        <div class="text-xl font-bold text-gray-800">${topTime}</div>
                        <div class="text-xs text-gray-500">Peak hour for behavior</div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-50 to-white border-l-4 border-purple-500 p-4 rounded shadow-sm">
                        <div class="flex items-center justify-between mb-1">
                            <div class="text-xs font-bold text-purple-800 uppercase tracking-wide">Top Trigger</div>
                            <span class="text-xl">‚ö°</span>
                        </div>
                        <div class="text-md font-bold text-gray-800 line-clamp-2" title="${topAnt}">${topAnt}</div>
                        <div class="text-xs text-gray-500">Most common antecedent</div>
                    </div>
                `;
                container.classList.remove('hidden');
            }

            downloadScheduleICS(minutes) {
                const now = new Date();
                // Format date for ICS (YYYYMMDDTHHMMSSZ)
                const formatICSDate = (date) => date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                
                const start = formatICSDate(now);
                const end = formatICSDate(new Date(now.getTime() + (30 * 60 * 1000))); // 30 min block initial
                
                // ICS File Content
                const icsContent = [
                    'BEGIN:VCALENDAR',
                    'VERSION:2.0',
                    'PRODID:-//FBA App//NONSGML v1.0//EN',
                    'BEGIN:VEVENT',
                    `UID:${crypto.randomUUID()}@fbaapp`,
                    `DTSTAMP:${start}`,
                    `DTSTART:${start}`,
                    `DTEND:${end}`,
                    `RRULE:FREQ=DAILY;COUNT=10`, // Repeat for 10 occurrences (example)
                    `SUMMARY:Intervention Check-in`,
                    `DESCRIPTION:FBA App Recommendation: Check student every ${minutes} minutes. Deliver reinforcement if behavior is appropriate.`,
                    'BEGIN:VALARM',
                    'TRIGGER:-PT0M',
                    'ACTION:DISPLAY',
                    'DESCRIPTION:Reminder',
                    'END:VALARM',
                    'END:VEVENT',
                    'END:VCALENDAR'
                ].join('\r\n');

                // Trigger Download
                const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `Intervention_Schedule_${minutes}min.ics`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                Utils.showNotification("Schedule file downloaded. Open to add to calendar.");
            }

            renderPathwayAnalysis(obs) {
                const container = document.getElementById('pattern-highlight-card');
                if (!container) return;
                
                if (!obs || obs.length < 3) {
                    container.classList.add('hidden');
                    return;
                }

                // 1. Group by full chain
                const chains = {};
                obs.forEach(o => {
                    const a = (o.antecedent || "").trim() || "?";
                    const b = (o.behavior || "").trim() || "?";
                    const c = (o.consequence || "").trim() || "?";
                    const key = `${a}:::${b}:::${c}`; // Use delimiter to split later safely
                    chains[key] = (chains[key] || 0) + 1;
                });

                // 2. Sort by frequency
                const topChains = Object.entries(chains)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3); // Top 3

                if (topChains.length === 0) {
                     container.classList.add('hidden');
                     return;
                }

                // 3. Render Visual Pathway Diagram
                let html = `<h5 class="text-sm font-bold text-indigo-900 uppercase tracking-wide mb-4">üîó Top Behavior Pathways</h5>`;
                html += `<div class="space-y-4">`;
                
                topChains.forEach(([chainKey, count], index) => {
                    const [ant, beh, cons] = chainKey.split(':::');
                    const percent = Math.round((count / obs.length) * 100);
                    const isFirst = index === 0;
                    
                    // Style differently for the primary pattern
                    const containerClass = isFirst 
                        ? "bg-white border-2 border-indigo-200 shadow-md p-3 rounded-lg" 
                        : "bg-white/60 border border-indigo-100 p-2 rounded opacity-90";

                    html += `
                        <div class="${containerClass}">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs font-bold text-indigo-800 ${isFirst ? 'bg-indigo-100 px-2 py-0.5 rounded' : ''}">
                                    ${isFirst ? 'üî• Primary Pattern' : `#${index + 1} Pattern`}
                                </span>
                                <span class="text-xs font-bold text-gray-500">${count} incidents (${percent}%)</span>
                            </div>
                            
                            <div class="flex flex-col sm:flex-row items-center gap-2 text-center w-full">
                                <!-- Antecedent -->
                                <div class="flex-1 bg-blue-50 border border-blue-200 rounded p-2 w-full relative group">
                                    <div class="text-[10px] uppercase text-blue-400 font-bold mb-1">Trigger</div>
                                    <div class="text-xs font-medium text-blue-900 break-words">${ant}</div>
                                    <!-- Arrow for desktop -->
                                    <div class="hidden sm:block absolute -right-3 top-1/2 transform -translate-y-1/2 z-10 text-indigo-300">
                                        <svg class="w-5 h-5 fill-current" viewBox="0 0 20 20"><path d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z"/></svg>
                                    </div>
                                    <!-- Arrow for mobile -->
                                    <div class="sm:hidden absolute -bottom-3 left-1/2 transform -translate-x-1/2 z-10 text-indigo-300">
                                        <svg class="w-4 h-4 fill-current rotate-90" viewBox="0 0 20 20"><path d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z"/></svg>
                                    </div>
                                </div>

                                <!-- Behavior -->
                                <div class="flex-1 bg-yellow-50 border border-yellow-200 rounded p-2 w-full relative">
                                    <div class="text-[10px] uppercase text-yellow-500 font-bold mb-1">Behavior</div>
                                    <div class="text-xs font-medium text-yellow-900 break-words">${beh}</div>
                                     <!-- Arrow for desktop -->
                                    <div class="hidden sm:block absolute -right-3 top-1/2 transform -translate-y-1/2 z-10 text-indigo-300">
                                        <svg class="w-5 h-5 fill-current" viewBox="0 0 20 20"><path d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z"/></svg>
                                    </div>
                                    <!-- Arrow for mobile -->
                                    <div class="sm:hidden absolute -bottom-3 left-1/2 transform -translate-x-1/2 z-10 text-indigo-300">
                                        <svg class="w-4 h-4 fill-current rotate-90" viewBox="0 0 20 20"><path d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z"/></svg>
                                    </div>
                                </div>

                                <!-- Consequence -->
                                <div class="flex-1 bg-red-50 border border-red-200 rounded p-2 w-full">
                                    <div class="text-[10px] uppercase text-red-400 font-bold mb-1">Consequence</div>
                                    <div class="text-xs font-medium text-red-900 break-words">${cons}</div>
                                </div>
                            </div>
                        </div>`;
                });
                html += `</div>`;

                container.innerHTML = html;
                container.classList.remove('hidden');
            }

            renderFunctionPieChart(obs) {
                const container = document.getElementById('function-chart-container');
                if (!container) return; 

                // 1. Aggregate Data
                const counts = { 'Escape': 0, 'Attention': 0, 'Tangible': 0, 'Sensory': 0, 'Unknown': 0 };
                let total = 0;
                
                obs.forEach(o => {
                    let f = o.perceivedFunction || 'Unknown';
                    // Simple normalization
                    if (f.includes('Escape')) counts['Escape']++;
                    else if (f.includes('Attention')) counts['Attention']++;
                    else if (f.includes('Tangible') || f.includes('Activity')) counts['Tangible']++;
                    else if (f.includes('Sensory') || f.includes('Automatic')) counts['Sensory']++;
                    else counts['Unknown']++;
                    total++;
                });

                if (total === 0) {
                    container.innerHTML = `<h5 class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2 w-full text-left">Hypothesized Functions</h5><p class="text-xs text-gray-400 italic">No function data tagged</p>`;
                    return;
                }

                // 2. Define Colors & Calculate Slices
                const colors = { 'Escape': '#3b82f6', 'Attention': '#10b981', 'Tangible': '#f59e0b', 'Sensory': '#8b5cf6', 'Unknown': '#d1d5db' };
                let legendHtml = '<div class="grid grid-cols-2 gap-x-2 gap-y-1 mt-3 w-full">';

                // 3. Construct Gradient
                let gradientStr = '';
                let currentDeg = 0;
                
                for (const [key, val] of Object.entries(counts)) {
                    if (val > 0) {
                        const deg = (val / total) * 360;
                        gradientStr += `${colors[key]} ${currentDeg}deg ${currentDeg + deg}deg, `;
                        currentDeg += deg;
                        
                        // Add Legend Item
                        legendHtml += `
                            <div class="flex items-center text-[10px] text-gray-600">
                                <span class="w-2 h-2 rounded-full mr-1" style="background-color: ${colors[key]}"></span>
                                ${key} (${Math.round((val/total)*100)}%)
                            </div>`;
                    }
                }
                legendHtml += '</div>';
                gradientStr = gradientStr.slice(0, -2); // Remove trailing comma

                // 4. Render
                container.innerHTML = `
                    <h5 class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2 w-full text-left">Hypothesized Functions</h5>
                    <div class="relative w-24 h-24 rounded-full shadow-inner" style="background: conic-gradient(${gradientStr});"></div>
                    ${legendHtml}
                `;
            }

            renderFunctionSorter(obs) {
                const container = document.getElementById('function-matrix-container');
                const dragContainer = document.getElementById('draggable-behaviors');
                if (!container || !dragContainer) return;

                if (!obs || obs.length === 0) {
                    container.classList.add('hidden');
                    return;
                }
                container.classList.remove('hidden');

                // 1. Get unique behaviors
                const behaviors = [...new Set(obs.map(o => (o.behavior || '').trim()).filter(b => b))];
                
                // Only populate if dragContainer is empty to prevent resetting while dragging, 
                // OR if the list has changed significantly. For simplicity, we repopulate on view render
                // but we check if we already have these children to avoid flickering.
                // Simple version: clear and rebuild.
                dragContainer.innerHTML = behaviors.map(b => 
                    `<div draggable="true" class="cursor-grab bg-blue-50 text-blue-800 px-3 py-1 rounded shadow-sm text-xs border border-blue-100 hover:bg-blue-100 active:cursor-grabbing select-none transition-transform hover:scale-105 font-medium" data-beh="${b}">‚ãÆ ${b}</div>`
                ).join('');

                // 2. Setup Drag Events on Source Items
                dragContainer.querySelectorAll('[draggable="true"]').forEach(el => {
                    el.addEventListener('dragstart', e => {
                        e.dataTransfer.setData('text/plain', e.target.dataset.beh);
                        e.dataTransfer.effectAllowed = 'copy';
                        el.classList.add('opacity-50');
                    });
                    el.addEventListener('dragend', () => {
                        el.classList.remove('opacity-50');
                    });
                });

                // 3. Setup Drop Zones
                const boxes = container.querySelectorAll('.matrix-box');
                boxes.forEach(box => {
                    // Prevent stacking event listeners by clearing old ones via clone (optional) or just re-assigning
                    // Since renderView runs often, we re-assign standard 'on' handlers
                    
                    box.ondragover = (e) => {
                        e.preventDefault(); // Necessary to allow dropping
                        e.dataTransfer.dropEffect = 'copy';
                        box.classList.add('bg-white', 'ring-2', 'ring-offset-2', 'ring-blue-300');
                    };
                    
                    box.ondragleave = () => {
                        box.classList.remove('bg-white', 'ring-2', 'ring-offset-2', 'ring-blue-300');
                    };

                    box.ondrop = (e) => {
                        e.preventDefault();
                        box.classList.remove('bg-white', 'ring-2', 'ring-offset-2', 'ring-blue-300');
                        const beh = e.dataTransfer.getData('text/plain');
                        
                        if (beh) {
                            // Check for duplicates in this specific box
                            const existing = Array.from(box.querySelectorAll('.dropped-chip')).map(c => c.dataset.val);
                            if (!existing.includes(beh)) {
                                const chip = document.createElement('div');
                                chip.className = 'dropped-chip mt-1 bg-white border px-2 py-1 rounded text-xs shadow-sm flex items-center justify-between w-full animate-pulse';
                                chip.dataset.val = beh;
                                chip.innerHTML = `<span class="truncate mr-1">${beh}</span> <button class="text-red-400 hover:text-red-600 font-bold ml-1">√ó</button>`;
                                
                                // Remove functionality
                                chip.querySelector('button').onclick = () => chip.remove();
                                
                                box.querySelector('.dropped-container').appendChild(chip);
                                setTimeout(() => chip.classList.remove('animate-pulse'), 500);
                                
                                // Provide simple feedback
                                Utils.showNotification(`Linked '${beh}' to ${box.dataset.func}`);
                            }
                        }
                    };
                });
            }

            renderQuickClickers(allObs) {
                const container = document.getElementById('quick-click-container');
                const btnContainer = document.getElementById('quick-click-buttons');
                if(!container || !btnContainer) return;

                // 1. Find top 4 behaviors
                const counts = {};
                allObs.forEach(o => {
                    const b = o.behavior ? o.behavior.trim() : "";
                    if(b) counts[b] = (counts[b] || 0) + 1;
                });
                const topBehaviors = Object.entries(counts)
                    .sort((a,b) => b[1] - a[1])
                    .slice(0, 4)
                    .map(entry => entry[0]);

                if(topBehaviors.length === 0) {
                    container.classList.add('hidden');
                    return;
                }

                container.classList.remove('hidden');
                btnContainer.innerHTML = '';

                // 2. Create Buttons
                topBehaviors.forEach(beh => {
                    const btn = document.createElement('button');
                    btn.className = "bg-white hover:bg-yellow-100 text-yellow-900 border border-yellow-300 font-bold py-4 px-2 rounded shadow-sm transition-transform active:scale-95 flex flex-col items-center justify-center";
                    btn.innerHTML = `<span class="text-lg mb-1">‚ûï</span><span class="text-sm text-center truncate w-full" title="${beh}">${beh}</span>`;

                    btn.onclick = async (e) => {
                        e.preventDefault(); // Prevent accidental double taps or form submits
                        // Visual Feedback
                        const originalHTML = btn.innerHTML;
                        btn.innerHTML = `<span class="text-green-600 font-bold text-sm">‚úî Saved</span>`;
                        btn.disabled = true;

                        try {
                             // Save to Firestore
                            await this.c.repo.addObservation(this.c.userId, this.c.caseId, {
                                antecedent: "Quick Log",
                                behavior: beh,
                                consequence: "To be recorded",
                                observationTime: new Date(),
                                duration: null,
                                perceivedFunction: null
                            });
                            Utils.showNotification(`Logged: ${beh}`);
                        } catch(err) {
                            console.error(err);
                            Utils.showNotification("Failed to log", "error");
                        } finally {
                            setTimeout(() => {
                                btn.innerHTML = originalHTML;
                                btn.disabled = false;
                            }, 1000);
                        }
                    };
                    btnContainer.appendChild(btn);
                });
            }

            updateDropdown(allObs) {
                const select = document.getElementById('abc-filter-behavior');
                if(!select) return;
                const currentSelection = select.value;
                const behaviors = [...new Set(allObs.map(o => o.behavior.trim()))].sort();
                
                select.innerHTML = '<option value="all">All Behaviors</option>';
                behaviors.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b;
                    opt.textContent = b;
                    select.appendChild(opt);
                });
                select.value = currentSelection; // Restore selection
            }
            
            updateStats(obs) {
                const panel = document.getElementById('abc-stats-panel');
                if (!obs || obs.length === 0) { panel.classList.add('hidden'); return; }
                panel.classList.remove('hidden');
                
                // Existing Stats
                document.getElementById('stat-total-obs').textContent = obs.length;
                const countFreq = (arr) => {
                    const counts = {}; let max = 0; let res = '-';
                    arr.forEach(i => { counts[i] = (counts[i] || 0) + 1; });
                    for(const k in counts) { if(counts[k] > max) { max = counts[k]; res = k; } }
                    return res.length > 20 ? res.substring(0, 20) + '...' : res;
                };
                document.getElementById('stat-common-ant').textContent = countFreq(obs.map(o => o.antecedent));
                document.getElementById('stat-common-beh').textContent = countFreq(obs.map(o => o.behavior));

                // NEW: Health Score Logic
                let score = 0;
                // 1. Volume (up to 20 pts) - Cap at 5 obs
                if (obs.length >= 5) score += 20;
                else score += (obs.length * 4);
                
                // 2. Duration recorded? (20 pts)
                const hasDuration = obs.some(o => o.duration && o.duration > 0);
                if (hasDuration) score += 20;
                
                // 3. Setting recorded? (20 pts)
                const hasSetting = obs.some(o => o.setting && o.setting !== 'Unknown');
                if (hasSetting) score += 20;
                
                // 4. Antecedent Variance? (20 pts) - Prevents copy-paste data
                const uniqueAnt = new Set(obs.map(o => (o.antecedent || "").trim())).size;
                if (uniqueAnt > 1) score += 20;
                
                // 5. Function Hypothesis? (20 pts)
                const hasFunc = obs.some(o => o.perceivedFunction);
                if (hasFunc) score += 20;

                // Update UI
                const scoreEl = document.getElementById('stat-health-score');
                const titleEl = document.getElementById('stat-health-title');
                const cardEl = document.getElementById('stat-health-card');
                
                if(scoreEl && cardEl && titleEl) {
                    scoreEl.textContent = `${score}%`;
                    
                    let bg = 'bg-gray-50';
                    let border = 'border-gray-200';
                    let text = 'text-gray-500';

                    if (score >= 80) { bg='bg-green-50'; border='border-green-200'; text='text-green-600'; }
                    else if (score >= 50) { bg='bg-yellow-50'; border='border-yellow-200'; text='text-yellow-600'; }
                    else if (score > 0) { bg='bg-red-50'; border='border-red-200'; text='text-red-600'; }
                    
                    cardEl.className = `p-4 rounded-lg border transition-colors ${bg} ${border}`;
                    titleEl.className = `text-xs font-bold uppercase tracking-wide ${text}`;
                }
            }

            renderTemporalChart(obs) {
                const container = document.getElementById('abc-chart-container');
                if (!obs || obs.length === 0) { container.innerHTML = ''; return; }

                // Aggregate data by hour
                const hourlyCounts = new Array(24).fill(0);
                obs.forEach(o => {
                    const date = Utils.safeDate(o.observationTime);
                    if (date) hourlyCounts[date.getHours()]++;
                });

                const maxCount = Math.max(...hourlyCounts, 1);
                const chartHeight = 120;
                const barWidth = 100 / 24;

                // Generate SVG Bars
                const bars = hourlyCounts.map((count, hour) => {
                    const h = (count / maxCount) * chartHeight;
                    const x = hour * barWidth;
                    const y = chartHeight - h;
                    const tooltip = I18nService.t('case_detail.chart_tooltip', { hour: hour, count: count });
                    return `<rect x="${x}%" y="${y}" width="${barWidth - 0.5}%" height="${h}" 
                            fill="${count > 0 ? '#3b82f6' : '#f3f4f6'}" rx="1"
                            class="transition-opacity hover:opacity-75 cursor-pointer"
                            onclick="window.app.router.currentController.managers[1].showDrillDown('Hour: ${hour}:00', (o) => { const d = Utils.safeDate(o.observationTime); return d && d.getHours() === ${hour}; })">
                            <title>${tooltip} (Click for Details)</title>
                            </rect>`;
                }).join('');

                container.innerHTML = `
                    <div class="mt-4 p-4 bg-white border border-gray-100 rounded-lg shadow-sm">
                        <h5 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4">${I18nService.t('case_detail.chart_title')}</h5>
                        <svg width="100%" height="${chartHeight + 25}" class="overflow-visible">
                            <!-- X Axis -->
                            <line x1="0" y1="${chartHeight}" x2="100%" y2="${chartHeight}" stroke="#e5e7eb" stroke-width="1" />
                            
                            <!-- Vertical Grid (Optional/Subtle) -->
                            <line x1="50%" y1="0" x2="50%" y2="${chartHeight}" stroke="#f3f4f6" stroke-dasharray="2" />
                            
                            ${bars}
                            
                            <!-- Labels -->
                            <text x="0" y="${chartHeight + 15}" font-size="9" fill="#9ca3af" font-weight="500">12 AM</text>
                            <text x="25%" y="${chartHeight + 15}" font-size="9" fill="#9ca3af" font-weight="500" text-anchor="middle">6 AM</text>
                            <text x="50%" y="${chartHeight + 15}" font-size="9" fill="#9ca3af" font-weight="500" text-anchor="middle">12 PM</text>
                            <text x="75%" y="${chartHeight + 15}" font-size="9" fill="#9ca3af" font-weight="500" text-anchor="middle">6 PM</text>
                            <text x="100%" y="${chartHeight + 15}" font-size="9" fill="#9ca3af" font-weight="500" text-anchor="end">11 PM</text>
                        </svg>
                    </div>
                `;
            }

            filterByHour(hour) {
                const table = document.getElementById('abc-data-body');
                const allObs = this.c.store.getState().observations;
                
                // Filter observations matching the hour
                const filtered = allObs.filter(o => {
                    const date = Utils.safeDate(o.observationTime);
                    return date && date.getHours() === hour;
                });

                // Update UI to show filter is active
                Utils.showNotification(`Showing data for ${hour}:00 - ${hour + 1}:00`);
                
                // Re-render table
                table.innerHTML = '';
                if (filtered.length === 0) {
                    const msg = document.getElementById('no-abc-data-message');
                    msg.classList.remove('hidden');
                    msg.innerHTML = `<p>No data found for ${hour}:00.</p>`;
                } else {
                    document.getElementById('no-abc-data-message').classList.add('hidden');
                    filtered.sort((a,b) => Utils.safeDate(b.observationTime) - Utils.safeDate(a.observationTime))
                       .forEach(o => table.appendChild(this.renderRow(o)));
                }
            }

            // NEW: Drill-Down Modal Logic
            showDrillDown(title, filterFn) {
                const obs = this.c.store.getState().observations || [];
                const filtered = obs.filter(filterFn);
                const tbody = document.getElementById('drill-down-body');
                document.getElementById('drill-down-title').textContent = title;
                
                if (filtered.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-4 text-center">No matching records found.</td></tr>';
                } else {
                    tbody.innerHTML = filtered.map(o => `
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <td class="px-4 py-2 whitespace-nowrap">${Utils.safeDate(o.observationTime).toLocaleString()}</td>
                            <td class="px-4 py-2">${o.antecedent}</td>
                            <td class="px-4 py-2">${o.behavior}</td>
                            <td class="px-4 py-2">${o.consequence}</td>
                        </tr>
                    `).join('');
                }
                
                document.getElementById('drill-down-modal').classList.remove('hidden');
            }

            renderScatterplot(obs) {
                const container = document.getElementById('abc-chart-container');
                if (!obs || obs.length === 0) return;

                const scatterDiv = document.createElement('div');
                scatterDiv.className = "mt-4 p-4 bg-white border border-gray-100 rounded-lg shadow-sm";
                
                // Color Mapping for Context
                const colorMap = {
                    'Whole Group': '#3b82f6', // Blue
                    'Independent Work': '#f59e0b', // Orange
                    'Transition': '#ef4444', // Red
                    'Unstructured': '#10b981', // Green
                    'Small Group': '#8b5cf6', // Purple
                    'Other': '#9ca3af' // Gray
                };

                const points = obs.map(o => {
                    const date = Utils.safeDate(o.observationTime);
                    if(!date) return '';
                    
                    // Y-Axis: Time (0 - 24 hours). 0 (12 AM) at TOP.
                    const timeVal = date.getHours() + (date.getMinutes()/60);
                    const y = (timeVal / 24) * 100;
                    
                    // X-Axis: Day of Week (0-6)
                    const day = date.getDay(); // 0 is Sunday
                    const colWidth = 100/7;
                    const x = (day * colWidth) + (colWidth/2);
                    
                    // Determine Color based on Setting text
                    let fill = colorMap['Other'];
                    const s = (o.setting || '').toLowerCase();
                    if(s.includes('group') && !s.includes('small')) fill = colorMap['Whole Group'];
                    else if(s.includes('independent') || s.includes('work')) fill = colorMap['Independent Work'];
                    else if(s.includes('small')) fill = colorMap['Small Group'];
                    else if(s.includes('transition')) fill = colorMap['Transition'];
                    else if(s.includes('recess') || s.includes('unstructured') || s.includes('cafeteria')) fill = colorMap['Unstructured'];

                    return `<circle cx="${x}%" cy="${y}%" r="5" fill="${fill}" stroke="white" stroke-width="1"
                                class="cursor-pointer hover:stroke-black hover:stroke-2 transition-all opacity-90 hover:opacity-100 hover:r-6"
                                onclick="window.app.router.currentController.managers[1].viewObservation('${o.id}')">
                                <title>${date.toLocaleDateString()} ${date.toLocaleTimeString()} (${o.setting || 'Unknown'}) - Click to view</title>
                            </circle>`;
                }).join('');

                // Generate Legend HTML
                const legendHtml = Object.entries(colorMap).map(([label, color]) => `
                    <div class="flex items-center mr-3 mb-1">
                        <span class="w-3 h-3 rounded-full mr-1" style="background-color: ${color}"></span>
                        <span class="text-[10px] text-gray-600">${label}</span>
                    </div>
                `).join('');

                scatterDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <h5 class="text-xs font-bold text-gray-500 uppercase tracking-widest mt-1">Observation Context Map</h5>
                        <div class="flex flex-wrap justify-end max-w-[70%]">
                            ${legendHtml}
                        </div>
                    </div>
                    <div class="relative w-full h-64 border-l border-b border-gray-200 ml-2" style="width: calc(100% - 1rem);">
                        <svg width="100%" height="100%" class="overflow-visible">
                             <!-- Grid lines for days -->
                             ${[1,2,3,4,5,6].map(i => `<line x1="${(i*100/7)}%" y1="0" x2="${(i*100/7)}%" y2="100%" stroke="#f3f4f6" stroke-dasharray="2" />`).join('')}
                             
                             <!-- Grid lines for time -->
                             ${[0, 0.25, 0.5, 0.75, 1].map(i => `<line x1="0" y1="${i*100}%" x2="100%" y2="${i*100}%" stroke="#f3f4f6" stroke-dasharray="2" />`).join('')}

                             ${points}
                        </svg>
                        
                        <!-- Y-Axis Labels -->
                        <div class="absolute top-0 left-[-30px] w-[25px] h-full flex flex-col justify-between text-[9px] text-gray-400 text-right">
                            <span class="transform -translate-y-1/2">12a</span>
                            <span class="transform -translate-y-1/2">6a</span>
                            <span class="transform -translate-y-1/2">12p</span>
                            <span class="transform -translate-y-1/2">6p</span>
                            <span class="transform -translate-y-1/2">11p</span>
                        </div>

                        <!-- X-Axis Labels -->
                        <div class="absolute bottom-[-20px] left-0 w-full flex text-[10px] text-gray-400 text-center">
                            <div style="width: 14.28%">Sun</div>
                            <div style="width: 14.28%">Mon</div>
                            <div style="width: 14.28%">Tue</div>
                            <div style="width: 14.28%">Wed</div>
                            <div style="width: 14.28%">Thu</div>
                            <div style="width: 14.28%">Fri</div>
                            <div style="width: 14.28%">Sat</div>
                        </div>
                    </div>
                `;
                container.appendChild(scatterDiv);
            }

            viewObservation(id) {
                window.app.openAbcModal(id);
            }

            renderHeatmap(obs, metric = 'count') {
                const container = document.getElementById('abc-chart-container');
                if (!obs || obs.length === 0) return;

                // 1. Initialize Grid (0-6 Days, 0-23 Hours)
                // Stores { count: 0, totalIntensity: 0 }
                const grid = Array(7).fill().map(() => Array(24).fill().map(() => ({ count: 0, totalIntensity: 0 })));
                let maxVal = 0;

                obs.forEach(o => {
                    const date = Utils.safeDate(o.observationTime);
                    if (date) {
                        const day = date.getDay();
                        const hour = date.getHours();
                        const cell = grid[day][hour];
                        cell.count++;
                        cell.totalIntensity += (o.intensity || 0);
                        
                        // Calculate value based on metric
                        const val = metric === 'count' ? cell.count : (cell.count > 0 ? (cell.totalIntensity / cell.count) : 0);
                        if (val > maxVal) maxVal = val;
                    }
                });

                // 2. Build HTML (Focus: 7am - 6pm)
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const startHour = 7;
                const endHour = 18;
                
                // UI for Toggle
                let html = `
                <div class="mt-4 p-4 bg-white border border-gray-100 rounded-lg shadow-sm overflow-x-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h5 class="text-xs font-bold text-gray-500 uppercase tracking-widest">Weekly ${metric === 'count' ? 'Frequency' : 'Intensity'} Heatmap</h5>
                        <div class="flex bg-gray-100 rounded p-1">
                            <label class="flex items-center px-2 py-1 text-xs cursor-pointer ${metric === 'count' ? 'bg-white shadow text-blue-600 rounded font-medium' : 'text-gray-500'}">
                                <input type="radio" name="heatmap-metric" value="count" class="hidden" ${metric === 'count' ? 'checked' : ''} onchange="window.app.router.currentController.managers[1].renderView()">
                                Frequency
                            </label>
                            <label class="flex items-center px-2 py-1 text-xs cursor-pointer ${metric === 'intensity' ? 'bg-white shadow text-red-600 rounded font-medium' : 'text-gray-500'}">
                                <input type="radio" name="heatmap-metric" value="intensity" class="hidden" ${metric === 'intensity' ? 'checked' : ''} onchange="window.app.router.currentController.managers[1].renderView()">
                                Intensity
                            </label>
                        </div>
                    </div>
                    <div class="min-w-[600px]">
                        <div class="grid grid-cols-[40px_repeat(${endHour - startHour + 1},_1fr)] gap-1 mb-1">
                            <div class="h-6"></div>`;

                // Header
                for (let h = startHour; h <= endHour; h++) {
                    const t = h > 12 ? `${h-12}p` : h === 12 ? '12p' : `${h}a`;
                    html += `<div class="text-[10px] text-center text-gray-400 font-bold">${t}</div>`;
                }
                html += `</div>`;

                // Rows
                days.forEach((day, d) => {
                    html += `<div class="grid grid-cols-[40px_repeat(${endHour - startHour + 1},_1fr)] gap-1 mb-1">
                             <div class="text-[10px] font-bold text-gray-600 flex items-center h-8">${day}</div>`;
                    
                    for (let h = startHour; h <= endHour; h++) {
                        const cell = grid[d][h];
                        const count = cell.count;
                        
                        // Determine value based on metric
                        const val = metric === 'count' ? count : (count > 0 ? (cell.totalIntensity / count) : 0);
                        const intensityRatio = maxVal > 0 ? (val / maxVal) : 0;
                        
                        // Color Logic
                        let bg = 'bg-gray-50';
                        let txt = 'text-transparent';
                        
                        // Define palettes
                        const palettes = {
                            count: { t1: 'bg-blue-100', t2: 'bg-blue-300', t3: 'bg-blue-500', t4: 'bg-blue-700', text: 'text-blue-900' },
                            intensity: { t1: 'bg-red-100', t2: 'bg-red-300', t3: 'bg-red-500', t4: 'bg-red-700', text: 'text-red-900' }
                        };
                        const pal = metric === 'count' ? palettes.count : palettes.intensity;

                        if (count > 0) {
                            txt = pal.text;
                            if (intensityRatio < 0.25) bg = pal.t1;
                            else if (intensityRatio < 0.5) bg = pal.t2;
                            else if (intensityRatio < 0.75) { bg = pal.t3; txt = 'text-white'; }
                            else { bg = pal.t4; txt = 'text-white'; }
                        }
                        
                        // Format display value
                        const displayVal = metric === 'intensity' && val > 0 ? Math.round(val) : val;
                        const tooltipVal = metric === 'intensity' ? val.toFixed(1) : val;
                        
                        html += `<div class="${bg} ${txt} h-8 rounded flex items-center justify-center text-[10px] font-bold transition-all hover:scale-110 cursor-default" title="${day} ${h}:00 - ${metric === 'count' ? 'Freq' : 'Avg Int'}: ${tooltipVal}">${val > 0 ? displayVal : ''}</div>`;
                    }
                    html += `</div>`;
                });

                html += `</div></div>`;
                
                const wrapper = document.createElement('div');
                wrapper.innerHTML = html;
                container.appendChild(wrapper.firstElementChild);
            }

            calculateTrend(dataPoints) {
                // Linear Regression (Least Squares)
                const n = dataPoints.length;
                if (n < 2) return null;

                let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
                dataPoints.forEach(p => {
                    sumX += p.x;
                    sumY += p.y;
                    sumXY += (p.x * p.y);
                    sumXX += (p.x * p.x);
                });

                const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
                const intercept = (sumY - slope * sumX) / n;

                return { slope, intercept };
            }

            renderDailyTrendChart(obs) {
                const container = document.getElementById('abc-chart-container');
                if (!obs || obs.length === 0) return;

                // 1. Aggregate by Date
                const dailyCounts = {};
                obs.forEach(o => {
                    const date = Utils.safeDate(o.observationTime);
                    if(date) {
                        const dateStr = date.toISOString().split('T')[0]; // YYYY-MM-DD
                        dailyCounts[dateStr] = (dailyCounts[dateStr] || 0) + 1;
                    }
                });

                // 2. Sort Dates
                const sortedDates = Object.keys(dailyCounts).sort();
                if (sortedDates.length === 0) return;

                const maxCount = Math.max(...Object.values(dailyCounts), 1);
                const chartHeight = 150;
                const barWidth = 40; 
                const gap = 10;
                const totalWidth = sortedDates.length * (barWidth + gap);

                // --- Trend Calculation (Existing) ---
                const trendData = sortedDates.map((date, i) => ({ x: i, y: dailyCounts[date] }));
                const trend = this.calculateTrend(trendData);
                
                let trendLineSvg = '';
                let trendText = '';

                if (trend) {
                    // Start center of first bar (x = 0 index * width + half width)
                    const x1 = barWidth/2; 
                    const y1 = chartHeight - ((trend.slope * 0 + trend.intercept) / maxCount) * (chartHeight - 40) - 20;
                    
                    // End center of last bar
                    const lastIdx = sortedDates.length - 1;
                    const x2 = (lastIdx * (barWidth + gap)) + barWidth/2; 
                    const y2 = chartHeight - ((trend.slope * lastIdx + trend.intercept) / maxCount) * (chartHeight - 40) - 20;
                    
                    // Logic: Slope > 0 means increasing (Red/Bad), Slope < 0 means decreasing (Green/Good)
                    const isIncreasing = trend.slope > 0;
                    const lineColor = isIncreasing ? '#ef4444' : '#10b981'; 
                    const trendDesc = Math.abs(trend.slope) < 0.1 ? 'Stable ‚Üí' : (isIncreasing ? 'Increasing ‚Üó' : 'Decreasing ‚Üò');
                    const textColor = Math.abs(trend.slope) < 0.1 ? 'text-gray-500' : (isIncreasing ? 'text-red-600' : 'text-green-600');

                    trendLineSvg = `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" 
                                     stroke="${lineColor}" stroke-width="3" stroke-dasharray="5,5" opacity="0.8">
                                     <title>Trend: ${trendDesc} (${trend.slope.toFixed(2)} per day)</title>
                                    </line>`;
                                     
                    trendText = `<span class="ml-2 text-[10px] font-bold ${textColor} border border-gray-200 px-2 py-0.5 rounded bg-gray-50">Trend: ${trendDesc}</span>`;
                }

                // --- NEW: Phase Change Logic (Option 3) ---
                const caseData = this.c.store.getState().currentCaseData;
                let phaseLineSvg = '';
                let phaseStatsHtml = '';

                if (caseData && caseData.bipStartDate) {
                    const [by, bm, bd] = caseData.bipStartDate.split('-').map(Number);
                    // Use local date construction to match input[type="date"]
                    const bipStart = new Date(by, bm - 1, bd); 

                    let preSum = 0, preCount = 0;
                    let postSum = 0, postCount = 0;
                    let startIdx = -1;

                    sortedDates.forEach((dStr, i) => {
                        const [dy, dm, dd] = dStr.split('-').map(Number);
                        const d = new Date(dy, dm - 1, dd);
                        const val = dailyCounts[dStr];

                        if (d >= bipStart) {
                            if (startIdx === -1) startIdx = i;
                            postSum += val;
                            postCount++;
                        } else {
                            preSum += val;
                            preCount++;
                        }
                    });

                    // Only draw if we have a valid start index within the range
                    if (startIdx !== -1) {
                        const lineX = startIdx * (barWidth + gap) - (gap / 2);
                        phaseLineSvg = `
                            <line x1="${lineX}" y1="0" x2="${lineX}" y2="${chartHeight}" stroke="#2563eb" stroke-width="2" stroke-dasharray="4" />
                            <text x="${lineX + 5}" y="15" font-size="10" fill="#2563eb" font-weight="bold">BIP Start</text>
                        `;

                        // Calculate Stats
                        const avgPre = preCount ? preSum / preCount : 0;
                        const avgPost = postCount ? postSum / postCount : 0;
                        
                        if (preCount > 0 && postCount > 0) {
                            const diff = avgPost - avgPre;
                            const pct = (diff / avgPre) * 100;
                            const isGood = pct < 0; // Reduction is usually good for behaviors
                            const colorClass = isGood ? 'text-green-700 bg-green-50 border-green-200' : 'text-red-700 bg-red-50 border-red-200';
                            const arrow = isGood ? '‚Üì' : '‚Üë';
                            
                            phaseStatsHtml = `
                                <div class="ml-2 flex flex-col justify-center items-start text-[10px] border px-2 py-1 rounded ${colorClass} shadow-sm animate-pulse">
                                    <span class="font-bold whitespace-nowrap">${arrow} ${Math.abs(pct).toFixed(0)}% Change</span>
                                    <span class="opacity-75 whitespace-nowrap">Avg: ${avgPre.toFixed(1)} ‚ûù ${avgPost.toFixed(1)}</span>
                                </div>
                            `;

                            // --- NEW: PND Calculation (Option 2) ---
                            // 1. Find lowest baseline point (assuming reduction goal)
                            let minBaseline = Infinity;
                            sortedDates.forEach((dStr) => {
                                const [dy, dm, dd] = dStr.split('-').map(Number);
                                const d = new Date(dy, dm - 1, dd);
                                if (d < bipStart) {
                                    const val = dailyCounts[dStr];
                                    if (val < minBaseline) minBaseline = val;
                                }
                            });

                            // 2. Count intervention points below minBaseline
                            let nonOverlapping = 0;
                            sortedDates.forEach((dStr) => {
                                const [dy, dm, dd] = dStr.split('-').map(Number);
                                const d = new Date(dy, dm - 1, dd);
                                if (d >= bipStart) {
                                    if (dailyCounts[dStr] < minBaseline) nonOverlapping++;
                                }
                            });

                            const pndScore = Math.round((nonOverlapping / postCount) * 100);
                            let effectiveness = "Ineffective";
                            if (pndScore >= 90) effectiveness = "Very Effective";
                            else if (pndScore >= 70) effectiveness = "Effective";
                            else if (pndScore >= 50) effectiveness = "Questionable";

                            phaseStatsHtml += `
                                <div class="ml-2 flex flex-col justify-center items-start text-[10px] border px-2 py-1 rounded bg-purple-50 border-purple-200 text-purple-800 shadow-sm" title="Percentage of Non-overlapping Data: % of intervention points better than best baseline point.">
                                    <span class="font-bold">PND: ${pndScore}%</span>
                                    <span class="opacity-75">${effectiveness}</span>
                                </div>
                            `;
                            // ----------------------------------------
                        }
                    }
                }
                // ------------------------------------------

                // 3. Generate SVG
                const bars = sortedDates.map((date, index) => {
                    const count = dailyCounts[date];
                    const h = (count / maxCount) * (chartHeight - 40); // space for labels
                    const x = index * (barWidth + gap);
                    const y = chartHeight - h - 20; 
                    
                    // Format date as MM/DD
                    const parts = date.split('-');
                    const label = `${parts[1]}/${parts[2]}`;

                    // --- NEW: Annotation Rendering (Option 2) ---
                    const annotations = caseData.annotations || [];
                    const dateAnnos = annotations.filter(a => a.date === date);
                    let annoSvg = '';
                    
                    if (dateAnnos.length > 0) {
                        const annoLabel = dateAnnos.map(a => a.text).join(', ');
                        const textWidth = Math.min(100, annoLabel.length * 6 + 10); // Simple width calc
                        // Shift text left if near right edge
                        const textXOffset = (index > sortedDates.length - 2) ? -textWidth + 20 : -(textWidth/2) + (barWidth/2);
                        
                        annoSvg = `
                            <g class="annotation group">
                                <line x1="${x + barWidth/2}" y1="${y}" x2="${x + barWidth/2}" y2="${y - 25}" stroke="#4b5563" stroke-width="1" stroke-dasharray="2" />
                                <circle cx="${x + barWidth/2}" cy="${y - 25}" r="3" fill="#4b5563" />
                                <g class="opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                                    <rect x="${x + textXOffset}" y="${y - 45}" width="${textWidth}" height="16" rx="4" fill="rgba(255,255,255,0.95)" stroke="#9ca3af" stroke-width="1" />
                                    <text x="${x + textXOffset + textWidth/2}" y="${y - 34}" font-size="9" text-anchor="middle" fill="#1f2937" font-weight="bold">${annoLabel}</text>
                                </g>
                                <text x="${x + barWidth/2}" y="${y - 30}" font-size="10" text-anchor="middle" fill="#4b5563">üìå</text>
                            </g>
                        `;
                    }
                    // ------------------------------------------

                    return `
                        <g class="group">
                            <rect x="${x}" y="${y}" width="${barWidth}" height="${h}" fill="#10b981" rx="2">
                                <title>${date}: ${count} incidents</title>
                            </rect>
                            <text x="${x + barWidth/2}" y="${y - 5}" text-anchor="middle" font-size="10" fill="#374151" font-weight="bold">${count}</text>
                            <text x="${x + barWidth/2}" y="${chartHeight - 5}" text-anchor="middle" font-size="10" fill="#6b7280">${label}</text>
                            ${annoSvg}
                        </g>
                    `;
                }).join('');

                const chartHtml = `
                    <div class="mt-4 p-4 bg-white border border-gray-100 rounded-lg shadow-sm overflow-x-auto">
                        <div class="flex items-center mb-4 flex-wrap gap-2">
                            <h5 class="text-xs font-bold text-gray-500 uppercase tracking-widest">Daily Frequency Trend</h5>
                            ${trendText}
                            ${phaseStatsHtml}
                        </div>
                        <div style="min-width: ${totalWidth}px">
                            <svg width="${Math.max(totalWidth, 100)}%" height="${chartHeight}" class="overflow-visible">
                                ${bars}
                                ${trendLineSvg}
                                ${phaseLineSvg}
                                <line x1="0" y1="${chartHeight - 20}" x2="${totalWidth}" y2="${chartHeight - 20}" stroke="#e5e7eb" stroke-width="1" />
                            </svg>
                        </div>
                        <p class="text-[10px] text-gray-400 mt-2 text-right italic">Hover over üìå to see notes</p>
                    </div>
                `;
                
                const wrapper = document.createElement('div');
                wrapper.innerHTML = chartHtml;
                container.appendChild(wrapper.firstElementChild);
            }

            // NEW: Add Annotation Method (Option 2)
            async addAnnotation() {
                const dateVal = document.getElementById('anno-date').value;
                const text = document.getElementById('anno-text').value.trim();
                
                if (!dateVal || !text) {
                    Utils.showNotification("Date and Note required", "error");
                    return;
                }
                
                const currentData = this.c.store.getState().currentCaseData;
                const currentAnnos = currentData.annotations || [];
                const newAnno = { date: dateVal, text: text, id: Utils.generateId() };
                const updatedAnnos = [...currentAnnos, newAnno];
                
                // Save to Firestore/Repo
                await this.c.repo.updateCase(this.c.userId, this.c.caseId, { annotations: updatedAnnos });
                
                // Clear inputs
                document.getElementById('anno-text').value = '';
                Utils.showNotification("Marker added to graph");
                
                // UI will auto-refresh via store subscription calling renderView
            }

            renderMonthlyCalendar(obs) {
                const container = document.getElementById('abc-chart-container');
                if (!obs || obs.length === 0) return;

                // 1. Prepare Data
                const dailyData = {};
                obs.forEach(o => {
                    const d = Utils.safeDate(o.observationTime);
                    if (d) {
                        // Use local YYYY-MM-DD to avoid timezone shifts
                        const key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
                        if (!dailyData[key]) dailyData[key] = { total: 0, count: 0 };
                        dailyData[key].total += (o.intensity ? parseInt(o.intensity) : 5);
                        dailyData[key].count++;
                    }
                });

                // 2. Calendar Logic (Current Month)
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startDayOfWeek = firstDay.getDay(); // 0 (Sun) - 6 (Sat)

                // 3. Build Grid
                let daysHtml = '';
                // Empty slots for previous month
                for (let i = 0; i < startDayOfWeek; i++) {
                    daysHtml += `<div class="h-20 bg-gray-50 border border-gray-100"></div>`;
                }
                // Days
                for (let d = 1; d <= daysInMonth; d++) {
                    const dateKey = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
                    const data = dailyData[dateKey];
                    let colorClass = "bg-white";
                    let scoreHtml = "";

                    if (data) {
                        const avg = data.total / data.count;
                        scoreHtml = `<div class="mt-1 text-xs font-bold text-center">${avg.toFixed(1)} <br><span class="text-[9px] font-normal text-gray-500">(${data.count} events)</span></div>`;
                        if (avg >= 7) colorClass = "bg-red-100 border-red-200 text-red-800";
                        else if (avg >= 4) colorClass = "bg-yellow-50 border-yellow-200 text-yellow-800";
                        else colorClass = "bg-green-50 border-green-200 text-green-800";
                    }

                    daysHtml += `
                        <div class="h-20 border border-gray-100 p-1 ${colorClass} transition-colors hover:shadow-inner flex flex-col justify-between">
                            <div class="text-xs font-semibold text-gray-400">${d}</div>
                            ${scoreHtml}
                        </div>`;
                }

                // 4. Render Wrapper
                const wrapper = document.createElement('div');
                wrapper.className = "mt-4 p-4 bg-white border border-gray-100 rounded-lg shadow-sm";
                wrapper.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h5 class="text-xs font-bold text-gray-500 uppercase tracking-widest">Monthly Intensity Calendar (${now.toLocaleString('default', { month: 'long' })})</h5>
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-center mb-1">
                        <div class="text-xs text-gray-400 font-bold">Sun</div><div class="text-xs text-gray-400 font-bold">Mon</div><div class="text-xs text-gray-400 font-bold">Tue</div>
                        <div class="text-xs text-gray-400 font-bold">Wed</div><div class="text-xs text-gray-400 font-bold">Thu</div><div class="text-xs text-gray-400 font-bold">Fri</div><div class="text-xs text-gray-400 font-bold">Sat</div>
                    </div>
                    <div class="grid grid-cols-7 gap-1">
                        ${daysHtml}
                    </div>
                `;
                container.appendChild(wrapper);
            }

            renderIntensityChart(obs) {
                const container = document.getElementById('abc-chart-container');
                if (!obs || obs.length === 0) return;

                // 1. Aggregate Avg Intensity by Date
                const dailyInt = {};
                const dailyCount = {};
                
                obs.forEach(o => {
                    if (o.intensity) {
                        const date = Utils.safeDate(o.observationTime);
                        if(date) {
                            const dateStr = date.toISOString().split('T')[0];
                            dailyInt[dateStr] = (dailyInt[dateStr] || 0) + parseInt(o.intensity);
                            dailyCount[dateStr] = (dailyCount[dateStr] || 0) + 1;
                        }
                    }
                });

                const sortedDates = Object.keys(dailyInt).sort();
                if (sortedDates.length === 0) return;

                // 2. Prepare Data Points for Line Chart
                const points = sortedDates.map((date, i) => {
                    const avg = dailyInt[date] / dailyCount[date];
                    return { date, avg, i };
                });

                // 3. SVG Dimensions
                const height = 150;
                const maxVal = 10; // Intensity scale is 1-10
                const xStep = 100 / (points.length > 1 ? points.length - 1 : 1);

                // --- NEW: Phase Change Logic (Option 3) ---
                const caseData = this.c.store.getState().currentCaseData;
                let phaseLineSvg = '';
                
                if (caseData && caseData.bipStartDate) {
                    const [by, bm, bd] = caseData.bipStartDate.split('-').map(Number);
                    const bipStart = new Date(by, bm - 1, bd);
                    
                    const startIdx = points.findIndex(p => {
                        const [py, pm, pd] = p.date.split('-').map(Number);
                        return new Date(py, pm - 1, pd) >= bipStart;
                    });

                    if (startIdx !== -1) {
                        // Draw line slightly before the point
                        const lineX = Math.max(0, (startIdx * xStep) - (xStep / 2));
                        
                        phaseLineSvg = `
                            <line x1="${lineX}%" y1="0" x2="${lineX}%" y2="${height}" stroke="#2563eb" stroke-width="1.5" stroke-dasharray="4" />
                            <text x="${lineX}%" y="10" font-size="9" fill="#2563eb" dx="3" font-weight="bold">BIP Start</text>
                        `;
                    }
                }
                // ------------------------------

                // 4. Generate Polyline points
                const polylinePoints = points.map((p, idx) => {
                    // Start from very left if only 1 point, otherwise distribute
                    const x = points.length > 1 ? idx * xStep : 50; 
                    const y = height - (p.avg / maxVal) * (height - 30) - 20; // Scale to height
                    return `${x},${y}`;
                }).join(' ');

                // 5. Generate Dots & Tooltips
                const dots = points.map((p, idx) => {
                    const x = points.length > 1 ? idx * xStep : 50;
                    const y = height - (p.avg / maxVal) * (height - 30) - 20;
                    
                    // Color logic based on severity
                    let color = '#10b981'; // Green (low)
                    if (p.avg >= 7) color = '#ef4444'; // Red (high)
                    else if (p.avg >= 4) color = '#f59e0b'; // Yellow (med)

                    // Format date for tooltip
                    const parts = p.date.split('-');
                    const label = `${parts[1]}/${parts[2]}`;

                    return `
                        <g class="group">
                            <circle cx="${x}%" cy="${y}" r="4" fill="${color}" stroke="white" stroke-width="2" class="transition-all hover:r-6 cursor-pointer">
                                <title>${label}: Avg Intensity ${p.avg.toFixed(1)}</title>
                            </circle>
                            <!-- X Axis Label -->
                            <text x="${x}%" y="${height - 5}" text-anchor="middle" font-size="9" fill="#9ca3af" class="opacity-0 group-hover:opacity-100 transition-opacity">${label}</text>
                        </g>`;
                }).join('');

                const html = `
                    <div class="mt-4 p-4 bg-white border border-gray-100 rounded-lg shadow-sm overflow-hidden">
                        <h5 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4">Daily Average Intensity (1-10)</h5>
                        <svg width="100%" height="${height}" class="overflow-visible">
                            <!-- Background Lines -->
                            <line x1="0" y1="${height-20}" x2="100%" y2="${height-20}" stroke="#e5e7eb" stroke-width="1"/>
                            <line x1="0" y1="20" x2="100%" y2="20" stroke="#f3f4f6" stroke-dasharray="4"/>
                            
                            ${phaseLineSvg}

                            <!-- The Line -->
                            <polyline points="${polylinePoints.replace(/,/g, ' ').replace(/(\d+(\.\d+)?) (\d+(\.\d+)?)/g, '$1% $3')}" 
                                      fill="none" stroke="#6366f1" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                            ${dots}
                        </svg>
                    </div>
                `;
                
                // Append to container
                const wrapper = document.createElement('div');
                wrapper.innerHTML = html;
                container.appendChild(wrapper.firstElementChild);
            }

            renderDurationChart(obs) {
                const container = document.getElementById('abc-chart-container');
                if (!obs || obs.length === 0) return;

                // 1. Aggregate Duration by Date
                const dailyDuration = {};
                let hasDuration = false;
                
                obs.forEach(o => {
                    if (o.duration && o.duration > 0) {
                        hasDuration = true;
                        const date = Utils.safeDate(o.observationTime);
                        if(date) {
                            const dateStr = date.toISOString().split('T')[0]; // YYYY-MM-DD
                            dailyDuration[dateStr] = (dailyDuration[dateStr] || 0) + parseInt(o.duration);
                        }
                    }
                });

                if (!hasDuration) return;

                // 2. Sort Dates
                const sortedDates = Object.keys(dailyDuration).sort();
                if (sortedDates.length === 0) return;

                const maxDur = Math.max(...Object.values(dailyDuration), 1);
                const chartHeight = 150;
                const barWidth = 40; 
                const gap = 10;
                const totalWidth = sortedDates.length * (barWidth + gap);

                // 3. Generate SVG
                const bars = sortedDates.map((date, index) => {
                    const total = dailyDuration[date];
                    const h = (total / maxDur) * (chartHeight - 40); 
                    const x = index * (barWidth + gap);
                    const y = chartHeight - h - 20; 
                    
                    const parts = date.split('-');
                    const label = `${parts[1]}/${parts[2]}`;

                    return `
                        <g class="group">
                            <rect x="${x}" y="${y}" width="${barWidth}" height="${h}" fill="#f59e0b" rx="2">
                                <title>${date}: ${total} mins total</title>
                            </rect>
                            <text x="${x + barWidth/2}" y="${y - 5}" text-anchor="middle" font-size="10" fill="#78350f" font-weight="bold">${total}m</text>
                            <text x="${x + barWidth/2}" y="${chartHeight - 5}" text-anchor="middle" font-size="10" fill="#6b7280">${label}</text>
                        </g>
                    `;
                }).join('');

                const chartHtml = `
                    <div class="mt-4 p-4 bg-white border border-gray-100 rounded-lg shadow-sm overflow-x-auto">
                        <h5 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4">Daily Duration Intensity (Minutes)</h5>
                        <div style="min-width: ${totalWidth}px">
                            <svg width="${Math.max(totalWidth, 100)}%" height="${chartHeight}" class="overflow-visible">
                                ${bars}
                                <line x1="0" y1="${chartHeight - 20}" x2="${totalWidth}" y2="${chartHeight - 20}" stroke="#e5e7eb" stroke-width="1" />
                            </svg>
                        </div>
                    </div>
                `;
                
                const wrapper = document.createElement('div');
                wrapper.innerHTML = chartHtml;
                container.appendChild(wrapper.firstElementChild);
            }

            renderSettingChart(obs) {
                const container = document.getElementById('abc-chart-container');
                if (!obs || obs.length === 0) return;

                // Aggregate by Setting
                const counts = {};
                obs.forEach(o => {
                    const s = o.setting || "Unknown";
                    counts[s] = (counts[s] || 0) + 1;
                });

                const labels = Object.keys(counts).sort((a,b) => counts[b] - counts[a]);
                if (labels.length === 0) return;
                
                const max = Math.max(...Object.values(counts));

                const html = labels.map(label => {
                    const count = counts[label];
                    const pct = (count / max) * 100;
                    // Choose color based on keyword
                    let color = "bg-gray-400";
                    if(label.includes('Instruction')) color = "bg-blue-400";
                    else if(label.includes('Recess') || label.includes('Unstructured')) color = "bg-green-400";
                    else if(label.includes('Transition')) color = "bg-yellow-400";
                    else if(label.includes('Work')) color = "bg-orange-400";

                    const safeLabel = label.replace(/'/g, "\\'"); // Escape quotes for onclick

                    return `
                        <div class="mb-2 cursor-pointer hover:bg-blue-50 p-1 rounded transition-colors group"
                             onclick="window.app.router.currentController.managers[1].showDrillDown('Setting: ${safeLabel}', (o) => o.setting === '${safeLabel}')">
                            <div class="flex justify-between text-xs mb-1">
                                <span class="font-medium text-gray-600 truncate pr-2 group-hover:text-blue-700 group-hover:underline" title="${label}">${label}</span>
                                <span class="font-bold text-gray-700">${count}</span>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-2">
                                <div class="${color} h-2 rounded-full" style="width: ${pct}%"></div>
                            </div>
                        </div>`;
                }).join('');

                const wrapper = document.createElement('div');
                wrapper.className = "mt-4 p-4 bg-white border border-gray-100 rounded-lg shadow-sm";
                wrapper.innerHTML = `<h5 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-3">Risk by Context/Setting (Click for details)</h5>${html}`;
                container.appendChild(wrapper);
            }

            renderCategoricalCharts(obs) {
                const container = document.getElementById('categorical-charts-container');
                if (!obs || obs.length === 0) { container.innerHTML = ''; return; }

                const getTopItems = (field) => {
                    const counts = {};
                    obs.forEach(o => {
                        const val = o[field].trim();
                        if (val) counts[val] = (counts[val] || 0) + 1;
                    });
                    return Object.entries(counts)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 5); 
                };

                const renderBlock = (title, items, colorClass) => {
                    const max = Math.max(...items.map(i => i[1]), 1);
                    const bars = items.map(([label, count]) => {
                        const width = (count / max) * 100;
                        return `
                            <div class="mb-3">
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="truncate pr-4 font-medium text-gray-700" title="${label}">${label}</span>
                                    <span class="font-bold text-gray-500">${count}</span>
                                </div>
                                <div class="w-full bg-gray-100 rounded-full h-1.5">
                                    <div class="${colorClass} h-1.5 rounded-full transition-all duration-500" style="width: ${width}%"></div>
                                </div>
                            </div>`;
                    }).join('');

                    return `
                        <div class="bg-white border border-gray-100 rounded-lg p-5 shadow-sm">
                            <h5 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">${title}</h5>
                            <div>${bars || '<p class="text-xs text-gray-400 italic">No data yet</p>'}</div>
                        </div>`;
                };

                container.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        ${renderBlock(I18nService.t('case_detail.cat_ant_title'), getTopItems('antecedent'), 'bg-indigo-500')}
                        ${renderBlock(I18nService.t('case_detail.cat_cons_title'), getTopItems('consequence'), 'bg-rose-500')}
                    </div>
                `;
            }

            renderKeywordCloud(obs) {
                // Target the existing charts container
                const container = document.getElementById('categorical-charts-container');
                if (!obs || obs.length === 0 || !container) return;

                // 1. Tokenize Antecedents & Filter Stop Words
                const text = obs.map(o => o.antecedent).join(' ').toLowerCase();
                // Common stop words to ignore
                const stopWords = new Set(['the', 'a', 'an', 'and', 'or', 'but', 'is', 'was', 'were', 'to', 'in', 'on', 'at', 'of', 'for', 'with', 'he', 'she', 'it', 'they', 'student', 'teacher', 'asked', 'told', 'me', 'him', 'her', 'when', 'during', 'from', 'that', 'this']);
                
                // Extract words with 3+ letters using regex
                const words = text.match(/\b[a-z]{3,}\b/g) || [];
                
                // 2. Count Frequencies
                const counts = {};
                words.forEach(w => {
                    if(!stopWords.has(w)) counts[w] = (counts[w] || 0) + 1;
                });

                // 3. Sort Top 15 Keywords
                const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 15);
                if (sorted.length === 0) return;

                const maxVal = sorted[0][1]; // Count of the most frequent word

                // 4. Generate HTML Tags with Dynamic Sizing
                const tags = sorted.map(([word, count]) => {
                    // Calculate size relative to max frequency (min 0.75rem, max 2.0rem scaling)
                    const size = 0.75 + (count / maxVal) * 1.25; 
                    const opacity = 0.6 + (count / maxVal) * 0.4;
                    
                    return `<span class="inline-block mr-2 mb-2 px-3 py-1 rounded-full bg-indigo-100 text-indigo-900 font-bold border border-indigo-200 transition-all hover:scale-110 hover:bg-indigo-200 cursor-default" 
                                  style="font-size: ${size}rem; opacity: ${opacity}" title="${count} occurrences">
                                  ${word} <span class="text-xs opacity-50 align-top ml-1">${count}</span>
                            </span>`;
                }).join('');

                // 5. Append to View
                const wrapper = document.createElement('div');
                wrapper.className = "mt-4 p-5 bg-white border border-gray-100 rounded-lg shadow-sm";
                wrapper.innerHTML = `
                    <h5 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4">‚òÅÔ∏è Antecedent Keyword Cloud</h5>
                    <div class="flex flex-wrap items-baseline justify-center p-4 bg-gradient-to-br from-gray-50 to-white rounded-lg border border-gray-100 border-dashed min-h-[100px]">
                        ${tags}
                    </div>
                `;
                container.appendChild(wrapper);
            }
            
            renderRow(data) {
                const tr = document.createElement('tr');
                const dateObj = Utils.safeDate(data.observationTime);
                const dateStr = Utils.formatDate(dateObj);
                // Also display time if available
                const timeStr = dateObj ? dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                
                // Duration Badge Logic
                const durBadge = data.duration ? `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800 ml-2">‚è± ${data.duration}m</span>` : '';
                
                // Intensity Badge Logic
                let intBadge = '';
                if (data.intensity) {
                    let intColor = 'bg-blue-100 text-blue-800 border-blue-200';
                    let icon = '‚ö°';
                    if (data.intensity >= 8) { intColor = 'bg-red-100 text-red-800 border-red-200'; icon = 'üî•'; }
                    else if (data.intensity >= 5) { intColor = 'bg-yellow-100 text-yellow-800 border-yellow-200'; icon = '‚ö°'; }
                    
                    intBadge = `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-bold border ${intColor} ml-2" title="Intensity Score: ${data.intensity}">${icon} ${data.intensity}</span>`;
                }

                // Function Badge Logic
                const funcBadge = data.perceivedFunction ? `<span class="block text-xs text-indigo-600 mt-1 font-medium">üéØ ${data.perceivedFunction}</span>` : '';

                // Setting Icon Logic
                const settingVal = data.setting || '';
                let settingIcon = '‚ùì';
                if(settingVal.includes('Recess') || settingVal.includes('Unstructured')) settingIcon = '‚öΩ';
                else if(settingVal.includes('Work')) settingIcon = 'üìù';
                else if(settingVal.includes('Group') || settingVal.includes('Instruction')) settingIcon = 'üè´';
                else if(settingVal.includes('Transition')) settingIcon = 'üîÑ';
                else if(settingVal.includes('Cafeteria')) settingIcon = 'üçî';
                
                const settingDisplay = settingVal ? `<div class="text-xs text-gray-400 mt-1" title="${settingVal}">${settingIcon} ${settingVal}</div>` : '';

                // Setting Events Badge Logic
                const seBadge = data.settingEvents && data.settingEvents.length > 0 
                    ? `<div class="mt-1 flex flex-wrap gap-1">${data.settingEvents.map(se => `<span class="px-1.5 py-0.5 rounded text-[10px] bg-orange-100 text-orange-800 border border-orange-200">üê¢ ${se}</span>`).join('')}</div>` 
                    : '';

                // Print Button added to actions
                const printBtn = `<button data-id="${data.id}" class="print-obs-btn text-gray-500 hover:text-gray-800 mr-4" title="Print Incident Report">üñ®Ô∏è</button>`;

                tr.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${dateStr} ${timeStr} ${settingDisplay}</td><td class="px-6 py-4 whitespace-pre-wrap text-sm">${data.antecedent} ${seBadge}</td><td class="px-6 py-4 whitespace-pre-wrap text-sm">${data.behavior} ${durBadge} ${intBadge} ${funcBadge}</td><td class="px-6 py-4 whitespace-pre-wrap text-sm">${data.consequence}</td><td class="px-6 py-4 text-sm font-medium no-print">${printBtn}<button data-id="${data.id}" class="edit-btn text-blue-600 hover:text-blue-900 mr-4">Edit</button><button data-id="${data.id}" class="delete-btn text-red-600 hover:text-red-900">Delete</button></td>`;
                return tr;
            }
            
            handleTableActions(e) {
                const btn = e.target.closest('button'); if(!btn) return;
                const id = btn.dataset.id;
                if(btn.classList.contains('edit-btn')) window.app.openAbcModal(id);
                else if(btn.classList.contains('delete-btn')) window.app.openDeleteModal(id);
                else if(btn.classList.contains('print-obs-btn')) this.printObservation(id);
            }

            printObservation(id) {
                const obs = this.c.store.getState().observations.find(o => o.id === id);
                if(!obs) return;
                const student = this.c.store.getState().currentCaseData.studentName;
                
                const element = document.createElement('div');
                element.innerHTML = `
                    <div style="font-family: Arial; padding: 40px; max-width: 800px; margin: 0 auto; color: #333;">
                        <div style="border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; display:flex; justify-content:space-between; align-items:end;">
                            <div>
                                <h1 style="font-size: 24px; margin: 0; font-weight: bold;">Behavior Incident Report</h1>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 12px;">Confidential Record ‚Ä¢ Generated by FBA App</p>
                            </div>
                            <div style="text-align:right;">
                                <p style="margin:0;"><strong>Date:</strong> ${Utils.formatDate(Utils.safeDate(obs.observationTime))}</p>
                                <p style="margin:0;"><strong>Time:</strong> ${Utils.safeDate(obs.observationTime).toLocaleTimeString()}</p>
                            </div>
                        </div>
                        
                        <div style="background: #f9fafb; padding: 15px; border: 1px solid #e5e7eb; margin-bottom: 30px; border-radius: 4px;">
                            <table style="width: 100%; font-size: 14px;">
                                <tr>
                                    <td style="padding: 5px; width: 50%;"><strong>Student:</strong> ${student}</td>
                                    <td style="padding: 5px;"><strong>Setting/Activity:</strong> ${obs.setting || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 5px;"><strong>Intensity:</strong> ${obs.intensity || 5}/10</td>
                                    <td style="padding: 5px;"><strong>Duration:</strong> ${obs.duration || 0} minutes</td>
                                </tr>
                            </table>
                        </div>

                        <h3 style="font-size: 16px; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 15px; color: #111;">Incident Details</h3>
                        
                        <div style="margin-bottom: 20px;">
                            <strong style="color: #4b5563; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">Antecedent (Triggers)</strong>
                            <div style="margin-top: 5px; padding: 10px; background: #fff; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                ${obs.antecedent}
                                ${obs.settingEvents && obs.settingEvents.length > 0 ? `<div style="margin-top:5px; font-size:12px; color:#666;"><em>Setting Events: ${obs.settingEvents.join(', ')}</em></div>` : ''}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <strong style="color: #4b5563; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">Behavior (Observed)</strong>
                            <div style="margin-top: 5px; padding: 10px; background: #fff; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                ${obs.behavior}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 30px;">
                            <strong style="color: #4b5563; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">Consequence (Response)</strong>
                            <div style="margin-top: 5px; padding: 10px; background: #fff; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                ${obs.consequence}
                            </div>
                        </div>

                        ${obs.perceivedFunction ? `
                        <div style="margin-bottom: 40px; padding: 10px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 4px;">
                            <strong style="color: #166534; font-size: 12px;">Hypothesized Function:</strong> <span style="color: #14532d;">${obs.perceivedFunction}</span>
                        </div>` : ''}

                        <div style="margin-top: 60px; display: flex; justify-content: space-between; gap: 40px;">
                            <div style="flex: 1; border-top: 1px solid #000; padding-top: 10px; font-size: 12px;">Staff Signature</div>
                            <div style="flex: 1; border-top: 1px solid #000; padding-top: 10px; font-size: 12px;">Administrator / Parent Signature</div>
                        </div>
                    </div>
                `;

                const opt = {
                    margin:       0.5,
                    filename:     `Incident_${student.replace(/[^a-z0-9]/gi, '_')}_${Utils.formatDate(obs.observationTime)}.pdf`,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2 },
                    jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
                };

                html2pdf().set(opt).from(element).save().then(() => {
                    Utils.showNotification("Incident Report Downloaded");
                });
            }

            exportToCSV() {
                const obs = this.c.store.getState().observations;
                if (!obs || obs.length === 0) { 
                    Utils.showNotification("No data to export", "error"); 
                    return; 
                }
                
                const headers = ["Date", "Time", "Setting", "Antecedent", "Behavior", "Consequence", "Duration", "Perceived Function"];
                const rows = obs.map(o => {
                    const d = Utils.safeDate(o.observationTime);
                    const dateStr = d ? d.toLocaleDateString() : '';
                    const timeStr = d ? d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                    const clean = (text) => `"${(text || '').replace(/"/g, '""')}"`;
                    return [
                        dateStr, 
                        timeStr, 
                        clean(o.setting || 'Unknown'),
                        clean(o.antecedent), 
                        clean(o.behavior), 
                        clean(o.consequence),
                        o.duration || 0,
                        clean(o.perceivedFunction)
                    ].join(",");
                });
                
                const csvContent = [headers.join(","), ...rows].join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                const studentName = this.c.store.getState().currentCaseData.studentName.replace(/[^a-z0-9]/gi, '_');
                link.setAttribute("href", url);
                link.setAttribute("download", `ABC_Data_${studentName}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            printDataLog() {
                const obs = this.c.store.getState().observations;
                if (!obs || obs.length === 0) {
                     Utils.showNotification("No data to print", "error");
                     return;
                }

                // Sort chronological
                const sorted = [...obs].sort((a,b) => Utils.safeDate(a.observationTime) - Utils.safeDate(b.observationTime));

                // Build clean table string
                const rows = sorted.map(o => {
                     const dateObj = Utils.safeDate(o.observationTime);
                     const dateStr = Utils.formatDate(dateObj);
                     const timeStr = dateObj ? dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                     const durStr = o.duration ? `(${o.duration}m)` : '';
                     const funcStr = o.perceivedFunction ? `<br><span style="font-size:10px; color:#666;">Func: ${o.perceivedFunction}</span>` : '';
                     const setStr = o.setting ? `<br><span style="font-size:10px; color:#555;">${o.setting}</span>` : '';

                     return `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding:10px; vertical-align:top;">${dateStr}<br><small style="color:#666">${timeStr}</small>${setStr}</td>
                            <td style="padding:10px; vertical-align:top;">${o.antecedent}</td>
                            <td style="padding:10px; vertical-align:top;">${o.behavior} ${durStr}</td>
                            <td style="padding:10px; vertical-align:top;">${o.consequence} ${funcStr}</td>
                        </tr>
                    `;
                }).join('');

                const studentName = this.c.store.getState().currentCaseData.studentName;
                
                const element = document.createElement('div');
                element.innerHTML = `
                    <div style="font-family: 'Helvetica', sans-serif; padding: 20px; color: #333;">
                        <h2 style="text-align:center; color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 10px;">ABC Data Log</h2>
                        <p style="text-align:center; margin-bottom:20px;">Student: <strong>${studentName}</strong></p>
                        <table style="width:100%; border-collapse:collapse; font-size:12px">
                            <thead style="background:#f0f4f8; border-bottom: 2px solid #ddd;">
                                <tr>
                                    <th style="padding:10px; text-align:left; width: 15%;">Date/Time</th>
                                    <th style="padding:10px; text-align:left; width: 28%;">Antecedent</th>
                                    <th style="padding:10px; text-align:left; width: 28%;">Behavior</th>
                                    <th style="padding:10px; text-align:left; width: 29%;">Consequence</th>
                                </tr>
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                        <p style="text-align: center; font-size: 10px; color: #999; margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px;">
                            Generated via FBA/BIP App on ${new Date().toLocaleDateString()}
                        </p>
                    </div>
                `;

                const opt = {
                    margin:       0.5,
                    filename:     `ABC_Log_${studentName.replace(/[^a-z0-9]/gi, '_')}.pdf`,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2 },
                    jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
                };

                // UI Feedback
                const btn = document.getElementById('print-data-btn');
                const originalText = btn.innerHTML;
                btn.innerText = "Generating...";
                btn.disabled = true;

                html2pdf().set(opt).from(element).save().then(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    Utils.showNotification("Log PDF Downloaded!");
                }).catch(err => {
                    console.error(err);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    Utils.showNotification("Failed to generate PDF", "error");
                });
            }

            async analyzeData() {
                Utils.setLoading('analyze-data-btn', true);
                const obs = this.c.store.getState().observations;
                let txt = ""; 
                obs.forEach((o, i) => {
                    txt += `Obs ${i+1}: Setting: ${o.setting || 'Unknown'}, Setting Events: ${o.settingEvents ? o.settingEvents.join(', ') : 'None'}, Ant: ${o.antecedent}, Beh: ${o.behavior}, Cons: ${o.consequence}, Perceived Func: ${o.perceivedFunction || 'N/A'}\n`;
                });
                document.getElementById('analysis-container').innerHTML = `<p class="text-center p-4">${I18nService.t('messages.analyzing_data')}</p>`;
                const prompt = `Analyze ABC data. Use 'Setting' to find context patterns. Pay attention to 'Setting Events' (slow triggers) to explain variability. Consider 'Perceived Func' tags if present. Output HTML with <h4>Identified Patterns (incl. Settings & Setting Events)</h4>, <h4>Potential Function</h4>, <h4>Hypothesis Statement</h4>. Respond in ${I18nService.currentLocale}.`;
                const res = await Utils.getGeminiResponse([{role:'system', parts:[{text:prompt}]}, {role:'user', parts:[{text:txt}]}]);
                this.displayAnalysis(res);
                await this.c.repo.updateCase(this.c.userId, this.c.caseId, { analysisHypothesis: res });
                Utils.setLoading('analyze-data-btn', false);
                this.c.updateSteps();
            }

            generateNarrative() {
                const obs = this.c.store.getState().observations;
                if(!obs || obs.length === 0) {
                    Utils.showNotification("No data to summarize", "error");
                    return;
                }

                const mode = (arr) => {
                    if (arr.length === 0) return "N/A";
                    return arr.sort((a,b) =>
                          arr.filter(v => v===a).length - arr.filter(v => v===b).length
                    ).pop();
                };

                const cleanMap = (field) => obs.map(o => o[field]).filter(v => v && v.trim() !== '');

                const total = obs.length;
                const topBeh = mode(cleanMap('behavior')) || "observed behaviors";
                const topAnt = mode(cleanMap('antecedent')) || "various triggers";
                const topCons = mode(cleanMap('consequence')) || "various responses";
                const topSetting = mode(cleanMap('setting')) || "various settings";

                const text = `Data collection indicates that the student engaged in ${topBeh} on ${total} recorded occasions. This behavior occurred most frequently in the ${topSetting} setting. The most common antecedent triggering the behavior was ${topAnt}, and the behavior was typically followed by ${topCons}.`;

                const out = document.getElementById('narrative-output');
                if(out) {
                    out.textContent = text;
                    out.classList.remove('hidden');
                    Utils.showNotification("Narrative generated!");
                }
            }

            async analyzeRecords() {
                Utils.setLoading('analyze-records-btn', true);
                const text = document.getElementById('record-review-text').value; if(!text) return;
                document.getElementById('record-analysis-container').innerHTML = `<p class="text-center p-4">${I18nService.t('messages.analyzing_records')}</p>`;
                const prompt = `Analyze student records for FBA. Summarize key points in HTML with <h4> headings. Respond in ${I18nService.currentLocale}.`;
                const res = await Utils.getGeminiResponse([{role:'system', parts:[{text:prompt}]}, {role:'user', parts:[{text:text}]}]);
                this.displayRecordAnalysis(res);
                await this.c.repo.updateCase(this.c.userId, this.c.caseId, { recordReviewText: text, recordAnalysis: res });
                Utils.setLoading('analyze-records-btn', false);
                this.c.updateSteps();
            }
            
            displayAnalysis(html) { document.getElementById('analysis-container').innerHTML = `<div class="analysis-content mt-6 p-6 bg-purple-50 border border-purple-200 rounded-lg">${html}</div>`; }
            displayRecordAnalysis(html) { document.getElementById('record-analysis-container').innerHTML = `<div class="analysis-content mt-4 p-6 bg-indigo-50 border border-indigo-200 rounded-lg">${html}</div>`; }
        }

        class VisualManager {
            constructor(controller) { this.c = controller; }
            init() {
                const data = this.c.store.getState().currentCaseData;
                this.c.bind('#generate-visual-btn', 'click', () => this.generate());
                this.c.bind('#download-svg-btn', 'click', () => this.download());
                if(data.visualHypothesisSVG) this.render(data.visualHypothesisSVG);
            }
            async generate() {
                Utils.setLoading('generate-visual-btn', true);
                const data = this.c.store.getState().currentCaseData;
                document.getElementById('visual-hypothesis-container').innerHTML = `<p class="text-center p-4">${I18nService.t('messages.generating_visual')}</p>`;
                const prompt = `Create SVG diagram for FBA in ${I18nService.currentLocale} language. ViewBox '0 0 800 1150'. White bg. Rounded boxes. Wrapped text <tspan>. Sections: Personal, Context, Skills, MOs, SDs, Behavior, Consequence, Params, Hypothesis. Output ONLY raw SVG code.`;
                const context = `Summary: ${Utils.stripHtml(data.interviewSummary)}. ABC: ${Utils.stripHtml(data.analysisHypothesis)}. Records: ${Utils.stripHtml(data.recordAnalysis)}`;
                const res = await Utils.getGeminiResponse([{role:'system', parts:[{text:prompt}]}, {role:'user', parts:[{text:context}]}]);
                const svg = res.substring(res.indexOf('<svg'), res.lastIndexOf('</svg>')+6);
                if(svg.startsWith('<svg')) {
                    this.render(svg);
                    await this.c.repo.updateCase(this.c.userId, this.c.caseId, { visualHypothesisSVG: svg });
                    this.c.updateSteps();
                } else { document.getElementById('visual-hypothesis-container').innerHTML = "<p class='text-red-500'>Error generating SVG</p>"; }
                Utils.setLoading('generate-visual-btn', false);
            }
            render(svg) {
                document.getElementById('visual-hypothesis-container').innerHTML = svg;
                document.getElementById('download-svg-btn').classList.remove('hidden');
            }
            download() {
                const data = this.c.store.getState().currentCaseData;
                if(!data?.visualHypothesisSVG) return;
                const blob = new Blob([data.visualHypothesisSVG], {type:"image/svg+xml;charset=utf-8"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a"); a.href = url; a.download = `FBA_Visual.svg`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
            }
        }

        // --- NEW: Preference Assessment Manager ---
        class PreferenceManager {
            constructor(controller) {
                this.c = controller;
                this.items = [];
                this.pairs = [];
                this.currentPairIndex = 0;
                this.scores = {};
                this.finalResultsText = "";
            }

            init() {
                this.c.bind('#launch-pref-assess-btn', 'click', () => this.open());
                
                // Modal bindings
                document.getElementById('close-pref-btn').addEventListener('click', () => this.close());
                document.getElementById('add-pref-input-btn').addEventListener('click', () => this.addInput());
                document.getElementById('start-pref-btn').addEventListener('click', () => this.startAssessment());
                document.getElementById('pref-choice-a').addEventListener('click', () => this.recordChoice('a'));
                document.getElementById('pref-choice-b').addEventListener('click', () => this.recordChoice('b'));
                document.getElementById('save-pref-results-btn').addEventListener('click', () => this.saveResults());
            }

            addInput() {
                const container = document.getElementById('pref-inputs');
                if (container.children.length < 6) {
                    const input = document.createElement('input');
                    input.className = "pref-item-input w-full p-2 border rounded mt-2";
                    input.placeholder = `Item ${container.children.length + 1}`;
                    container.appendChild(input);
                }
            }

            startAssessment() {
                const inputs = document.querySelectorAll('.pref-item-input');
                this.items = Array.from(inputs).map(i => i.value.trim()).filter(v => v);
                
                if (this.items.length < 2) {
                    Utils.showNotification("Need at least 2 items", "error");
                    return;
                }

                // Generate Pairs (Round Robin)
                this.pairs = [];
                for (let i = 0; i < this.items.length; i++) {
                    for (let j = i + 1; j < this.items.length; j++) {
                        this.pairs.push([this.items[i], this.items[j]]);
                    }
                }
                
                // Shuffle Pairs
                this.pairs.sort(() => Math.random() - 0.5);

                // Reset Scores
                this.scores = {};
                this.items.forEach(i => this.scores[i] = 0);
                
                this.currentPairIndex = 0;
                this.showTrial();
                
                document.getElementById('pref-setup-view').classList.add('hidden');
                document.getElementById('pref-test-view').classList.remove('hidden');
            }

            showTrial() {
                const pair = this.pairs[this.currentPairIndex];
                document.getElementById('pref-trial-num').textContent = this.currentPairIndex + 1;
                document.getElementById('pref-total-trials').textContent = this.pairs.length;
                
                // Randomize Left/Right position to prevent side bias
                if (Math.random() > 0.5) {
                    document.getElementById('pref-choice-a').textContent = pair[0];
                    document.getElementById('pref-choice-b').textContent = pair[1];
                } else {
                    document.getElementById('pref-choice-a').textContent = pair[1];
                    document.getElementById('pref-choice-b').textContent = pair[0];
                }
            }

            recordChoice(side) {
                const choiceText = document.getElementById(`pref-choice-${side}`).textContent;
                this.scores[choiceText]++;
                
                this.currentPairIndex++;
                if (this.currentPairIndex < this.pairs.length) {
                    this.showTrial();
                } else {
                    this.showResults();
                }
            }

            showResults() {
                document.getElementById('pref-test-view').classList.add('hidden');
                document.getElementById('pref-results-view').classList.remove('hidden');
                
                const container = document.getElementById('pref-results-chart');
                container.innerHTML = '';
                
                // Calculate percentages
                // Each item appears against every other item exactly once. Total opportunities = n - 1.
                const totalOpportunities = Math.max(1, this.items.length - 1); 
                
                const results = Object.entries(this.scores)
                    .map(([item, count]) => ({ item, pct: Math.round((count / totalOpportunities) * 100) }))
                    .sort((a, b) => b.pct - a.pct); // Sort high to low

                results.forEach(res => {
                    let color = 'bg-gray-400';
                    if (res.pct >= 80) color = 'bg-green-500';
                    else if (res.pct >= 50) color = 'bg-yellow-400';
                    else color = 'bg-red-400';

                    const html = `
                        <div class="mb-2">
                            <div class="flex justify-between text-sm font-bold mb-1">
                                <span>${res.item}</span>
                                <span>${res.pct}%</span>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-4">
                                <div class="${color} h-4 rounded-full transition-all" style="width: ${res.pct}%"></div>
                            </div>
                        </div>`;
                    container.insertAdjacentHTML('beforeend', html);
                });
                
                this.finalResultsText = results.map(r => `${r.item} (${r.pct}%)`).join(', ');
            }

            async saveResults() {
                const area = document.getElementById('confirmed-reinforcers');
                if(area) area.value = this.finalResultsText;
                
                await this.c.repo.updateCase(this.c.userId, this.c.caseId, { bipReinforcers: this.finalResultsText });
                Utils.showNotification("Assessment saved!");
                this.close();
            }

            open() { 
                document.getElementById('pref-assess-modal').classList.remove('hidden'); 
                // Reset view
                document.getElementById('pref-setup-view').classList.remove('hidden');
                document.getElementById('pref-test-view').classList.add('hidden');
                document.getElementById('pref-results-view').classList.add('hidden');
            }
            close() { document.getElementById('pref-assess-modal').classList.add('hidden'); }
        }

        // --- NEW: Token Board Manager (Option 1) ---
        class TokenBoardManager {
            constructor(controller) {
                this.c = controller;
                this.tokens = 0;
                this.maxTokens = 5;
                this.init();
            }

            init() {
                this.c.bind('#open-token-board-btn', 'click', () => this.open());
                this.c.bind('#close-token-board', 'click', () => this.close());
                this.c.bind('#add-token-btn', 'click', () => this.addToken());
                this.c.bind('#remove-token-btn', 'click', () => this.removeToken());
                this.c.bind('#token-count-select', 'change', (e) => {
                    this.maxTokens = parseInt(e.target.value);
                    this.tokens = 0; // Reset on change
                    this.renderSlots();
                });
            }

            open() {
                document.getElementById('token-board-modal').classList.remove('hidden');
                this.renderSlots();
            }

            close() {
                document.getElementById('token-board-modal').classList.add('hidden');
            }

            renderSlots() {
                const container = document.getElementById('token-slots-container');
                container.innerHTML = '';
                
                for(let i=0; i<this.maxTokens; i++) {
                    const isEarned = i < this.tokens;
                    const slot = document.createElement('div');
                    // Responsive sizing based on count
                    const sizeClass = this.maxTokens > 5 ? 'w-16 h-16 md:w-20 md:h-20 text-3xl' : 'w-20 h-20 md:w-32 md:h-32 text-5xl';
                    
                    slot.className = `${sizeClass} rounded-full border-4 flex items-center justify-center transition-all duration-500 transform ${isEarned ? 'bg-yellow-400 border-yellow-500 shadow-[0_0_20px_rgba(250,204,21,0.6)] scale-110 rotate-12' : 'bg-blue-100 border-blue-200 shadow-inner'}`;
                    
                    slot.innerHTML = isEarned ? '‚≠ê' : '';
                    container.appendChild(slot);
                }
            }

            addToken() {
                if(this.tokens < this.maxTokens) {
                    this.tokens++;
                    this.renderSlots();
                    
                    if(this.tokens === this.maxTokens) {
                        this.celebrate();
                    }
                }
            }

            removeToken() {
                if(this.tokens > 0) {
                    this.tokens--;
                    this.renderSlots();
                }
            }

            celebrate() {
                const reward = document.getElementById('token-reward-input').value || "REWARD";
                
                // Create a massive overlay text
                const overlay = document.createElement('div');
                overlay.className = 'absolute inset-0 flex items-center justify-center z-50 pointer-events-none animate-bounce bg-white bg-opacity-30 backdrop-blur-sm';
                overlay.innerHTML = `
                    <div class="text-center transform scale-150 transition-all duration-1000">
                        <div class="text-9xl">üéâ</div>
                        <h1 class="text-6xl md:text-8xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-500 to-red-500 drop-shadow-lg mt-4 px-4">
                            ${reward} EARNED!
                        </h1>
                    </div>
                `;
                
                const modalBody = document.querySelector('#token-board-modal > div');
                modalBody.appendChild(overlay);
                
                // Remove after 4 seconds
                setTimeout(() => {
                    overlay.remove();
                }, 4000);
            }
        }

        // --- NEW: Contract Manager (Option 1) ---
        class ContractManager {
            constructor(controller) {
                this.c = controller;
                this.canvas = null;
                this.ctx = null;
                this.isDrawing = false;
                this.resizeTimeout = null;
            }

            init() {
                this.c.bind('#open-contract-btn', 'click', () => this.open());
                this.c.bind('#close-contract-btn', 'click', () => this.close());
                this.c.bind('#generate-contract-btn', 'click', () => this.generate());
                this.c.bind('#clear-sig-btn', 'click', () => this.clearSignature());
                this.c.bind('#download-contract-btn', 'click', () => this.download());
            }

            open() {
                document.getElementById('contract-modal').classList.remove('hidden');
                // Use setTimeout to ensure DOM is visible before initializing canvas
                setTimeout(() => this.setupCanvas(), 100);
            }

            close() {
                document.getElementById('contract-modal').classList.add('hidden');
            }

            setupCanvas() {
                this.canvas = document.getElementById('signature-pad');
                // Get the parent container dimensions
                const rect = this.canvas.parentElement.getBoundingClientRect();
                
                // Set canvas internal resolution to match display size for sharpness
                this.canvas.width = rect.width;
                this.canvas.height = rect.height;
                
                this.ctx = this.canvas.getContext('2d');
                this.ctx.lineWidth = 3;
                this.ctx.lineCap = 'round';
                this.ctx.strokeStyle = '#000000';

                // Event Listeners (support mouse and touch)
                const startDrawing = (e) => {
                    this.isDrawing = true;
                    this.ctx.beginPath();
                    const { x, y } = this.getPos(e);
                    this.ctx.moveTo(x, y);
                    e.preventDefault();
                };

                const draw = (e) => {
                    if (!this.isDrawing) return;
                    const { x, y } = this.getPos(e);
                    this.ctx.lineTo(x, y);
                    this.ctx.stroke();
                    e.preventDefault();
                };

                const stopDrawing = (e) => {
                    this.isDrawing = false;
                    e.preventDefault();
                };

                // Mouse
                this.canvas.onmousedown = startDrawing;
                this.canvas.onmousemove = draw;
                this.canvas.onmouseup = stopDrawing;
                this.canvas.onmouseleave = stopDrawing;

                // Touch
                this.canvas.ontouchstart = startDrawing;
                this.canvas.ontouchmove = draw;
                this.canvas.ontouchend = stopDrawing;
            }

            getPos(e) {
                const rect = this.canvas.getBoundingClientRect();
                let clientX, clientY;
                
                if (e.changedTouches) {
                    clientX = e.changedTouches[0].clientX;
                    clientY = e.changedTouches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                
                return {
                    x: clientX - rect.left,
                    y: clientY - rect.top
                };
            }

            clearSignature() {
                if (this.ctx && this.canvas) {
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                }
            }

            generate() {
                const studentName = this.c.store.getState().currentCaseData.studentName || "Student";
                const studentTask = document.getElementById('contract-student-task').value || "[Student Task]";
                const teacherTask = document.getElementById('contract-teacher-task').value || "[Teacher Task]";
                const reward = document.getElementById('contract-reward').value || "[Reward]";
                
                // Get Signature Image
                const sigData = this.canvas ? this.canvas.toDataURL() : null;
                
                // Show Download Button
                document.getElementById('download-contract-btn').classList.remove('hidden');

                const container = document.getElementById('contract-preview-container');
                container.innerHTML = `
                    <div style="padding: 40px; border: 8px double #1e3a8a; height: 100%; display: flex; flex-direction: column; background: white;">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h1 style="font-family: serif; font-size: 36px; color: #1e3a8a; margin-bottom: 10px; font-weight: bold;">Behavior Contract</h1>
                            <p style="color: #6b7280; font-size: 12px; text-transform: uppercase; letter-spacing: 2px;">Official Agreement</p>
                        </div>

                        <div style="flex-grow: 1;">
                            <p style="font-size: 16px; margin-bottom: 20px;">
                                I, <strong>${studentName}</strong>, agree to:
                            </p>
                            <div style="background-color: #eff6ff; padding: 15px; border-left: 4px solid #3b82f6; margin-bottom: 25px; font-size: 18px; color: #1e40af; font-weight: bold;">
                                ${studentTask}
                            </div>

                            <p style="font-size: 16px; margin-bottom: 20px;">
                                My teacher agrees to help me by:
                            </p>
                            <div style="background-color: #f9fafb; padding: 15px; border-left: 4px solid #9ca3af; margin-bottom: 25px; font-size: 16px; color: #374151;">
                                ${teacherTask}
                            </div>

                            <p style="font-size: 16px; margin-bottom: 20px;">
                                When I meet my goal, I will earn:
                            </p>
                            <div style="text-align: center; padding: 20px; border: 2px dashed #16a34a; border-radius: 10px; background-color: #f0fdf4; margin-bottom: 40px;">
                                <span style="font-size: 24px; font-weight: bold; color: #15803d;">‚òÖ ${reward} ‚òÖ</span>
                            </div>
                        </div>

                        <div style="display: flex; justify-content: space-between; margin-top: 20px; align-items: flex-end;">
                            <div style="text-align: center; width: 45%;">
                                <div style="height: 60px; border-bottom: 2px solid #000; display: flex; align-items: flex-end; justify-content: center;">
                                    ${sigData ? `<img src="${sigData}" style="max-height: 50px;">` : ''}
                                </div>
                                <p style="margin-top: 5px; font-size: 12px; font-weight: bold; color: #4b5563;">Student Signature</p>
                            </div>
                            <div style="text-align: center; width: 45%;">
                                <div style="height: 60px; border-bottom: 2px solid #000; display: flex; align-items: flex-end; justify-content: center; font-family: monospace; font-size: 16px;">
                                    ${new Date().toLocaleDateString()}
                                </div>
                                <p style="margin-top: 5px; font-size: 12px; font-weight: bold; color: #4b5563;">Date</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            download() {
                const element = document.getElementById('contract-preview-container');
                const studentName = this.c.store.getState().currentCaseData.studentName || "Student";
                
                const opt = {
                    margin:       0.5,
                    filename:     `Contract_${studentName.replace(/[^a-z0-9]/gi, '_')}.pdf`,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2 },
                    jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
                };

                // Visual feedback
                const btn = document.getElementById('download-contract-btn');
                const originalText = btn.innerHTML;
                btn.innerText = "Generating PDF...";
                btn.disabled = true;

                html2pdf().set(opt).from(element).save().then(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    Utils.showNotification("Contract PDF Downloaded!");
                });
            }
        }

        // --- NEW: Staff Fluency Manager (Option 3) ---
        class FluencyManager {
            constructor(controller) {
                this.c = controller;
                this.score = 0;
                this.questionIndex = 0;
                this.questions = [];
                this.timer = null;
            }

            init() {
                this.c.bind('#launch-fluency-btn', 'click', () => this.prepGame());
            }

            prepGame() {
                const data = this.c.store.getState().currentCaseData;
                const p = data.bipPreventContent;
                const t = data.bipTeachContent;
                const r = data.bipRespondContent;
                const beh = data.bipOperationalDefinition || "the target behavior";

                // Ensure BIP has enough content
                if (!p && !t && !r) {
                    Utils.showNotification("BIP incomplete. Add strategies first.", "error");
                    return;
                }

                // Generate Questions based on real BIP content
                this.questions = [];
                // Simple HTML stripper helper
                const extract = (html) => {
                    if (!html) return "";
                    // Try to grab first sentence or list item
                    const tmp = document.createElement("DIV");
                    tmp.innerHTML = html;
                    const txt = tmp.textContent || tmp.innerText || "";
                    return txt.split('.')[0].substring(0, 80) + (txt.length > 80 ? "..." : "");
                };
                
                // Prevent Questions
                if(p) this.questions.push({
                    type: "PREVENT",
                    color: "text-blue-600 bg-blue-100",
                    scenario: `You notice triggers for ${beh}. What is the correct antecedant strategy?`,
                    correct: extract(p),
                    distractors: ["Wait for behavior then react", "Send to office pre-emptively", "Raise your voice"]
                });

                // Teach Questions
                if(t) this.questions.push({
                    type: "TEACH",
                    color: "text-yellow-600 bg-yellow-100",
                    scenario: `The student is calm. What replacement skill should you practice now?`,
                    correct: extract(t),
                    distractors: ["Review classroom rules", "Do nothing", "Give them a timeout"]
                });

                // Respond Questions
                if(r) this.questions.push({
                    type: "RESPOND",
                    color: "text-red-600 bg-red-100",
                    scenario: `The student just engaged in ${beh}. What is the planned consequence?`,
                    correct: extract(r),
                    distractors: ["Lecture them on why it's wrong", "Immediate suspension", "Force an apology"]
                });

                // Add generic filler if not enough questions to make it feel like a game
                if (this.questions.length > 0) {
                    // Duplicate questions to make a 5-round game for now
                    while(this.questions.length < 5) {
                        this.questions.push(this.questions[this.questions.length % 3]); // Cycle existing
                    }
                }

                this.score = 0;
                this.questionIndex = 0;
                this.renderOverlay();
                this.showNextQuestion();
            }

            renderOverlay() {
                const overlay = document.createElement('div');
                overlay.id = 'fluency-overlay';
                overlay.className = "fixed inset-0 bg-indigo-900 z-[100] flex flex-col items-center justify-center text-white p-4";
                overlay.innerHTML = `
                    <button class="absolute top-4 right-4 text-gray-400 hover:text-white" onclick="document.getElementById('fluency-overlay').remove()">‚úï</button>
                    <div class="text-center w-full max-w-2xl">
                        <div class="flex justify-between items-end mb-6 border-b border-indigo-700 pb-2">
                            <h2 class="text-3xl font-bold text-yellow-400">‚ö° Staff Fluency Trainer</h2>
                            <div class="text-xl font-mono" id="fluency-score">Score: 0</div>
                        </div>
                        
                        <div id="fluency-card" class="bg-white text-indigo-900 p-8 rounded-2xl shadow-2xl mb-8 min-h-[200px] flex flex-col justify-center items-center relative overflow-hidden transition-all">
                            <div id="fluency-timer-bar" class="absolute top-0 left-0 h-2 bg-yellow-400 w-full transition-all duration-100 ease-linear"></div>
                            <div id="fluency-type" class="absolute top-4 left-4 text-xs font-bold uppercase tracking-widest px-2 py-1 rounded"></div>
                            <h3 id="fluency-scenario" class="text-2xl font-bold mb-4"></h3>
                        </div>

                        <div id="fluency-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Buttons injected here -->
                        </div>
                        <div id="fluency-feedback" class="mt-4 h-8 text-xl font-bold text-center"></div>
                    </div>
                `;
                document.body.appendChild(overlay);
            }

            showNextQuestion() {
                if (this.questionIndex >= this.questions.length) {
                    this.endGame();
                    return;
                }

                const q = this.questions[this.questionIndex];
                const typeEl = document.getElementById('fluency-type');
                const scenarioEl = document.getElementById('fluency-scenario');
                const optionsEl = document.getElementById('fluency-options');
                const timerBar = document.getElementById('fluency-timer-bar');
                const feedback = document.getElementById('fluency-feedback');

                feedback.textContent = "";
                
                typeEl.className = `absolute top-4 left-4 text-xs font-bold uppercase tracking-widest px-2 py-1 rounded ${q.color}`;
                typeEl.textContent = q.type + " STRATEGY";
                
                scenarioEl.textContent = q.scenario;
                
                // Mix answers (1 correct + 2 distractors)
                const answers = [
                    { text: q.correct, isCorrect: true },
                    { text: q.distractors[0], isCorrect: false },
                    { text: q.distractors[1], isCorrect: false }
                ].sort(() => Math.random() - 0.5);

                optionsEl.innerHTML = "";

                answers.forEach(ans => {
                    const btn = document.createElement('button');
                    btn.className = "bg-indigo-600 hover:bg-indigo-500 text-white p-4 rounded-xl font-bold text-lg shadow-lg border-b-4 border-indigo-800 active:scale-95 transition-all h-full";
                    btn.textContent = ans.text;
                    btn.onclick = () => this.handleAnswer(ans.isCorrect, q.correct, btn);
                    optionsEl.appendChild(btn);
                });

                // Timer Logic (10 seconds per question)
                timerBar.style.width = '100%';
                timerBar.classList.remove('bg-red-500');
                timerBar.classList.add('bg-yellow-400');
                
                let timeLeft = 100;
                if (this.timer) clearInterval(this.timer);
                
                this.timer = setInterval(() => {
                    timeLeft -= 1; // 1% every 100ms = 10 seconds total
                    timerBar.style.width = `${timeLeft}%`;
                    if(timeLeft < 30) {
                        timerBar.classList.remove('bg-yellow-400');
                        timerBar.classList.add('bg-red-500');
                    }
                    if (timeLeft <= 0) {
                        this.handleAnswer(false, q.correct, null);
                    }
                }, 100);
            }

            handleAnswer(isCorrect, fullCorrectText, clickedBtn) {
                clearInterval(this.timer);
                const feedback = document.getElementById('fluency-feedback');
                
                // Disable all buttons
                const btns = document.getElementById('fluency-options').querySelectorAll('button');
                btns.forEach(b => b.disabled = true);

                if (isCorrect) {
                    this.score += 100 + (parseInt(document.getElementById('fluency-timer-bar').style.width) || 0); // Bonus for speed
                    document.getElementById('fluency-score').textContent = `Score: ${this.score}`;
                    feedback.innerHTML = `<span class="text-green-400 drop-shadow-md">‚úî CORRECT!</span>`;
                    if(clickedBtn) {
                        clickedBtn.classList.remove('bg-indigo-600', 'border-indigo-800');
                        clickedBtn.classList.add('bg-green-500', 'border-green-700');
                    }
                } else {
                    feedback.innerHTML = `<span class="text-red-400 drop-shadow-md">‚úñ INCORRECT. <span class="text-sm text-gray-300 font-normal">Plan says: ${fullCorrectText.substring(0,30)}...</span></span>`;
                    if(clickedBtn) {
                        clickedBtn.classList.remove('bg-indigo-600', 'border-indigo-800');
                        clickedBtn.classList.add('bg-red-500', 'border-red-700');
                    }
                    // Highlight the correct one
                    btns.forEach(b => {
                        if(b.textContent === fullCorrectText) {
                            b.classList.remove('bg-indigo-600');
                            b.classList.add('bg-green-500', 'ring-4', 'ring-white');
                        }
                    });
                }

                this.questionIndex++;
                setTimeout(() => this.showNextQuestion(), 2000); // 2s Delay for feedback
            }

            endGame() {
                const container = document.getElementById('fluency-overlay');
                let message = "Good effort!";
                if(this.score > 400) message = "Expert Status! üåü";
                else if(this.score > 200) message = "Great job!";

                container.innerHTML = `
                    <div class="text-center bg-white text-indigo-900 p-10 rounded-2xl shadow-2xl animate-bounce-in max-w-lg">
                        <div class="text-6xl mb-4">üèÜ</div>
                        <h2 class="text-3xl font-bold mb-2">Training Complete!</h2>
                        <p class="text-xl mb-2">Final Score: <span class="font-bold text-indigo-600">${this.score}</span></p>
                        <p class="text-gray-500 mb-6 italic">${message}</p>
                        <button class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-bold shadow hover:bg-indigo-700 w-full" onclick="document.getElementById('fluency-overlay').remove()">Close Game</button>
                    </div>
                `;
            }
        }

        // --- NEW: Choice Board Manager ---
        class ChoiceBoardManager {
            constructor(controller) {
                this.c = controller;
            }

            init() {
                this.c.bind('#open-choice-board-btn', 'click', () => this.open());
                this.c.bind('#close-choice-board', 'click', () => this.close());
                this.c.bind('#cb-launch-btn', 'click', () => this.present());
                this.c.bind('#cb-reset-btn', 'click', () => this.reset());
            }

            open() {
                document.getElementById('choice-board-modal').classList.remove('hidden');
                // Pre-fill inputs with Reinforcers if available
                const data = this.c.store.getState().currentCaseData;
                if(data && data.bipReinforcers) {
                    const items = data.bipReinforcers.split(',').map(s => s.trim()).filter(s => s);
                    const inputs = document.querySelectorAll('.cb-input');
                    items.forEach((item, idx) => {
                        if(inputs[idx] && !inputs[idx].value) inputs[idx].value = item;
                    });
                }
                this.reset();
            }

            close() {
                document.getElementById('choice-board-modal').classList.add('hidden');
            }

            reset() {
                document.getElementById('cb-setup').classList.remove('hidden');
                document.getElementById('cb-present').classList.add('hidden');
                document.getElementById('cb-reset-btn').classList.add('hidden');
                document.getElementById('cb-present').innerHTML = '';
            }

            present() {
                const inputs = Array.from(document.querySelectorAll('.cb-input'))
                    .map(i => i.value.trim())
                    .filter(v => v);
                
                if(inputs.length < 1) {
                    Utils.showNotification("Enter at least 1 option", "error");
                    return;
                }
                
                const view = document.getElementById('cb-present');
                const setup = document.getElementById('cb-setup');
                
                setup.classList.add('hidden');
                view.classList.remove('hidden');
                document.getElementById('cb-reset-btn').classList.remove('hidden');
                
                // Responsive Grid Logic
                let gridClass = "grid-cols-1 md:grid-cols-2";
                if (inputs.length === 1) gridClass = "grid-cols-1";
                if (inputs.length === 3) gridClass = "grid-cols-1 md:grid-cols-3";
                if (inputs.length === 4) gridClass = "grid-cols-2";
                
                view.className = `flex-grow grid ${gridClass} gap-6 p-4`;

                view.innerHTML = inputs.map(item => `
                    <button class="choice-card bg-white border-8 border-blue-200 hover:border-blue-500 rounded-3xl flex flex-col items-center justify-center text-center p-4 shadow-xl transform transition-all active:scale-95 group h-full w-full relative overflow-hidden">
                        <div class="text-6xl md:text-8xl mb-4 group-hover:scale-110 transition-transform">üéÅ</div>
                        <div class="text-3xl md:text-5xl font-bold text-blue-900 break-words w-full leading-tight">${item}</div>
                    </button>
                `).join('');

                // Bind click events
                view.querySelectorAll('.choice-card').forEach((btn, idx) => {
                    btn.onclick = () => this.handleChoice(inputs[idx], btn);
                });
            }

            handleChoice(item, btnElement) {
                // Visual feedback: Fade out others
                const allBtns = document.querySelectorAll('.choice-card');
                allBtns.forEach(b => {
                    if(b !== btnElement) {
                        b.classList.add('opacity-0', 'pointer-events-none', 'scale-90');
                    }
                });
                
                // Highlight selected
                btnElement.classList.remove('border-blue-200', 'hover:border-blue-500', 'active:scale-95');
                btnElement.classList.add('border-green-500', 'bg-green-50', 'scale-110', 'z-50', 'shadow-2xl');
                
                // Celebration
                const originalContent = btnElement.innerHTML;
                btnElement.innerHTML = `
                    <div class="text-8xl animate-bounce">üéâ</div>
                    <div class="text-4xl font-bold text-green-700 mt-4">${item}</div>
                `;

                setTimeout(() => {
                    Utils.showNotification(`Student chose: ${item}`);
                    // Optionally update Token Board Reward
                    const tokenReward = document.getElementById('token-reward-input');
                    if(tokenReward) tokenReward.value = item;
                    
                    this.close();
                }, 2000);
            }
        }

        // --- NEW: Crisis Manager (Red Mode) ---
        class CrisisManager {
            constructor(controller) {
                this.c = controller;
                this.timerInterval = null;
                this.startTime = null;
                this.actions = [];
            }

            init() {
                this.c.bind('#crisis-mode-btn', 'click', () => this.startCrisisMode());
            }

            startCrisisMode() {
                const overlay = document.createElement('div');
                overlay.className = "fixed inset-0 bg-red-50 z-[100] flex flex-col p-4 overflow-hidden";
                overlay.id = "crisis-overlay";
                
                overlay.innerHTML = `
                    <div class="flex justify-between items-center mb-6 border-b border-red-200 pb-4">
                        <div>
                            <h1 class="text-3xl font-black text-red-700 uppercase tracking-widest animate-pulse">üö® Crisis Event</h1>
                            <div id="crisis-timer" class="text-5xl font-mono font-bold text-gray-900 mt-2">00:00</div>
                        </div>
                        <button id="end-crisis-btn" class="bg-gray-800 text-white px-6 py-4 rounded-lg font-bold shadow-lg hover:bg-gray-700 border-2 border-red-500 text-lg uppercase tracking-wide transition-transform active:scale-95">End Event & Save</button>
                    </div>
                    
                    <div class="flex-grow flex flex-col md:flex-row gap-4 h-full overflow-hidden">
                        <!-- Action Buttons -->
                        <div class="w-full md:w-2/3 grid grid-cols-2 md:grid-cols-3 gap-4 content-start overflow-y-auto pr-2">
                            <button class="crisis-action bg-white border-l-8 border-orange-500 shadow-md rounded-xl p-6 text-left font-bold text-xl hover:bg-orange-50 transition-all active:scale-95 group" data-action="Verbal De-escalation">
                                <div class="text-3xl mb-2 group-hover:scale-110 transition-transform origin-left">üó£Ô∏è</div>
                                Verbal Support
                            </button>
                            <button class="crisis-action bg-white border-l-8 border-blue-500 shadow-md rounded-xl p-6 text-left font-bold text-xl hover:bg-blue-50 transition-all active:scale-95 group" data-action="Room Clear">
                                <div class="text-3xl mb-2 group-hover:scale-110 transition-transform origin-left">üö™</div>
                                Room Clear
                            </button>
                            <button class="crisis-action bg-white border-l-8 border-purple-500 shadow-md rounded-xl p-6 text-left font-bold text-xl hover:bg-purple-50 transition-all active:scale-95 group" data-action="Called Support">
                                <div class="text-3xl mb-2 group-hover:scale-110 transition-transform origin-left">üìû</div>
                                Call Support
                            </button>
                            <button class="crisis-action bg-white border-l-8 border-red-600 shadow-md rounded-xl p-6 text-left font-bold text-xl hover:bg-red-50 transition-all active:scale-95 group" data-action="Physical Safety Hold">
                                <div class="text-3xl mb-2 group-hover:scale-110 transition-transform origin-left">‚úã</div>
                                Safety Hold
                            </button>
                            <button class="crisis-action bg-white border-l-8 border-yellow-500 shadow-md rounded-xl p-6 text-left font-bold text-xl hover:bg-yellow-50 transition-all active:scale-95 group" data-action="Student Safe">
                                <div class="text-3xl mb-2 group-hover:scale-110 transition-transform origin-left">‚úÖ</div>
                                Student Safe
                            </button>
                            <button class="crisis-action bg-white border-l-8 border-gray-500 shadow-md rounded-xl p-6 text-left font-bold text-xl hover:bg-gray-50 transition-all active:scale-95 group" data-action="Medical Check">
                                <div class="text-3xl mb-2 group-hover:scale-110 transition-transform origin-left">‚öïÔ∏è</div>
                                Medical Check
                            </button>
                            <button class="crisis-action bg-white border-l-8 border-indigo-500 shadow-md rounded-xl p-6 text-left font-bold text-xl hover:bg-indigo-50 transition-all active:scale-95 group" data-action="Parent Notified">
                                <div class="text-3xl mb-2 group-hover:scale-110 transition-transform origin-left">üì±</div>
                                Parent Contact
                            </button>
                            <button class="crisis-action bg-white border-l-8 border-teal-500 shadow-md rounded-xl p-6 text-left font-bold text-xl hover:bg-teal-50 transition-all active:scale-95 group" data-action="Re-entry / Calm">
                                <div class="text-3xl mb-2 group-hover:scale-110 transition-transform origin-left">üïäÔ∏è</div>
                                Re-entry / Calm
                            </button>
                        </div>
                        
                        <!-- Live Log -->
                        <div class="w-full md:w-1/3 bg-white rounded-lg shadow-inner border border-gray-200 p-4 flex flex-col h-full">
                            <h3 class="font-bold text-gray-500 uppercase tracking-widest mb-2 border-b pb-2 flex justify-between items-center">
                                Event Log <span class="text-xs font-normal text-red-400">Live</span>
                            </h3>
                            <div id="crisis-log" class="flex-grow overflow-y-auto space-y-2 pr-1">
                                <div class="text-gray-400 text-sm italic text-center mt-4">Log started at ${new Date().toLocaleTimeString()}...</div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(overlay);

                // Timer Logic
                this.startTime = Date.now();
                this.actions = [];
                this.timerInterval = setInterval(() => {
                    const diff = Math.floor((Date.now() - this.startTime) / 1000);
                    const m = Math.floor(diff / 60).toString().padStart(2, '0');
                    const s = (diff % 60).toString().padStart(2, '0');
                    document.getElementById('crisis-timer').textContent = `${m}:${s}`;
                }, 1000);

                // Bind Actions
                overlay.querySelectorAll('.crisis-action').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const action = btn.dataset.action;
                        const now = new Date();
                        const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
                        
                        // Add to UI
                        const logContainer = document.getElementById('crisis-log');
                        const logEntry = document.createElement('div');
                        logEntry.className = "flex justify-between items-center border-b border-gray-100 py-2 animate-fade-in-down px-2 hover:bg-gray-50 transition-colors rounded";
                        logEntry.innerHTML = `<span class="font-bold text-gray-800 text-sm">${action}</span><span class="text-xs text-gray-500 font-mono">${timeStr}</span>`;
                        
                        // Remove placeholder if exists
                        if (logContainer.firstElementChild && logContainer.firstElementChild.classList.contains('italic')) {
                            logContainer.innerHTML = '';
                        }
                        
                        logContainer.prepend(logEntry);
                        
                        // Add to State
                        this.actions.push({ action, time: now });
                    });
                });

                // Bind End Button
                document.getElementById('end-crisis-btn').addEventListener('click', () => this.endCrisis());
            }

            async endCrisis() {
                if(!confirm("End crisis event and save report?")) return;
                
                clearInterval(this.timerInterval);
                const overlay = document.getElementById('crisis-overlay');
                const durationSecs = Math.floor((Date.now() - this.startTime) / 1000);
                const durationMins = Math.ceil(durationSecs / 60);

                // Format Log for "Consequence" field
                const logText = this.actions.map(a => `[${a.time.toLocaleTimeString()}] ${a.action}`).join('\n');
                const fullNote = `CRISIS EVENT LOG:\n${logText}\n\nTotal Duration: ${Math.floor(durationSecs/60)}m ${durationSecs%60}s`;

                Utils.setLoading('end-crisis-btn', true);

                try {
                    await this.c.repo.addObservation(this.c.userId, this.c.caseId, {
                        antecedent: "Crisis Trigger (See Log)",
                        behavior: "Crisis / Safety Incident",
                        consequence: fullNote,
                        observationTime: new Date(this.startTime), // Start time of event
                        duration: durationMins,
                        intensity: 10, // Max intensity automatically
                        setting: "Crisis Event",
                        isCrisis: true,
                        crisisLog: this.actions
                    });
                    
                    Utils.showNotification("Crisis Report Saved Successfully");
                    overlay.remove();
                } catch(e) {
                    console.error(e);
                    Utils.showNotification("Failed to save crisis report", "error");
                    Utils.setLoading('end-crisis-btn', false);
                }
            }
        }

        // --- NEW: Acting-Out Cycle Manager (Option 1) ---
        class CycleManager {
            constructor(controller) {
                this.c = controller;
                this.phases = [
                    { name: 'Calm', x: 50, y: 220, color: '#10b981' },
                    { name: 'Trigger', x: 150, y: 210, color: '#f59e0b' },
                    { name: 'Agitation', x: 250, y: 160, color: '#f97316' },
                    { name: 'Acceleration', x: 340, y: 90, color: '#ef4444' },
                    { name: 'Peak', x: 420, y: 40, color: '#b91c1c' },
                    { name: 'De-escalation', x: 550, y: 130, color: '#3b82f6' },
                    { name: 'Recovery', x: 700, y: 220, color: '#6366f1' }
                ];
                this.data = {}; // Stores { PhaseName: { student: '', staff: '' } }
                this.currentPhase = null;
            }

            init() {
                // Load existing data if available
                const saved = this.c.store.getState().currentCaseData.actingOutCycle;
                if(saved) this.data = saved;
                this.renderSVG();
                this.c.bind('#cycle-save-btn', 'click', () => this.savePhase());
                this.c.bind('#cycle-ai-suggest-btn', 'click', () => this.aiSuggest());
            }

            renderSVG() {
                // Determine screen width for responsive SVG
                // Simple fixed viewBox allows scaling via CSS w-full
                const svgHTML = `
                    <svg viewBox="0 0 800 280" class="w-full h-full drop-shadow-sm">
                        <!-- Background Grid Lines -->
                        <line x1="0" y1="220" x2="800" y2="220" stroke="#e5e7eb" stroke-width="1" stroke-dasharray="4" />
                        
                        <!-- Curve Path: M(Start) Q(Control, End) ... -->
                        <path d="M 50,220 
                                 C 120,220 120,220 150,210 
                                 S 200,190 250,160 
                                 S 320,40 420,40 
                                 S 520,130 550,130 
                                 S 650,220 700,220 
                                 L 750,220" 
                              fill="none" stroke="#6366f1" stroke-width="4" stroke-linecap="round" />
                        
                        <!-- Interactive Nodes -->
                        ${this.phases.map((p, i) => {
                            const isSaved = this.data[p.name] && (this.data[p.name].student || this.data[p.name].staff);
                            const fill = isSaved ? p.color : 'white';
                            const stroke = p.color;
                            
                            return `
                                <g class="cursor-pointer hover:opacity-80 transition-opacity group" onclick="window.app.router.currentController.managers.find(m => m instanceof CycleManager).selectPhase('${p.name}')">
                                    <circle cx="${p.x}" cy="${p.y}" r="14" fill="${fill}" stroke="${stroke}" stroke-width="3" class="shadow-md" />
                                    ${isSaved ? '<text x="'+p.x+'" y="'+(p.y+4)+'" text-anchor="middle" fill="white" font-size="10" font-weight="bold">‚úì</text>' : ''}
                                    <text x="${p.x}" y="${p.y+30}" text-anchor="middle" font-size="11" font-weight="bold" fill="#4b5563" class="group-hover:fill-indigo-600">${p.name}</text>
                                </g>
                            `;
                        }).join('')}
                    </svg>
                `;
                document.getElementById('cycle-svg-container').innerHTML = svgHTML;
            }

            selectPhase(phase) {
                this.currentPhase = phase;
                const phaseObj = this.phases.find(p => p.name === phase);
                
                const editArea = document.getElementById('cycle-edit-area');
                editArea.classList.remove('hidden');
                
                // Colorize the header
                const title = document.getElementById('cycle-phase-title');
                title.textContent = `Phase: ${phase}`;
                title.style.color = phaseObj.color;
                editArea.style.borderColor = phaseObj.color;
                editArea.className = `bg-white p-4 rounded-lg border-l-4 shadow-md animate-fade-in-down`;
                editArea.style.borderLeftColor = phaseObj.color;

                document.getElementById('cycle-student-behavior').value = this.data[phase]?.student || '';
                document.getElementById('cycle-staff-response').value = this.data[phase]?.staff || '';
                
                // Smooth scroll to edit area if on mobile
                if(window.innerWidth < 768) editArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            async savePhase() {
                const student = document.getElementById('cycle-student-behavior').value;
                const staff = document.getElementById('cycle-staff-response').value;
                
                this.data[this.currentPhase] = { student, staff };
                
                // Persist
                await this.c.repo.updateCase(this.c.userId, this.c.caseId, { actingOutCycle: this.data });
                Utils.showNotification(`Saved ${this.currentPhase} phase!`);
                
                // Refresh SVG to show checkmark
                this.renderSVG();
            }

            async aiSuggest() {
                if(!this.currentPhase) return;
                
                Utils.setLoading('cycle-ai-suggest-btn', true);
                
                const data = this.c.store.getState().currentCaseData;
                const context = `
                    Student: ${data.studentName}.
                    Triggers: ${data.bipPreventContent || ''}.
                    Function: ${data.confirmedFunction || data.perceivedFunction || 'Unknown'}.
                `;
                
                const prompt = `
                    Based on the Colvin & Sugai Acting-Out Cycle, suggest behaviors and staff responses for the '${this.currentPhase}' phase.
                    Context: ${context}.
                    Return JSON: { "student": "string", "staff": "string" }.
                    Keep it brief (1-2 sentences).
                `;

                try {
                    const res = await Utils.getGeminiResponse([{role: 'user', parts: [{text: prompt}]}]);
                    const jsonStr = res.replace(/```json/g, '').replace(/```/g, '').trim();
                    const suggestion = JSON.parse(jsonStr);
                    
                    document.getElementById('cycle-student-behavior').value = suggestion.student;
                    document.getElementById('cycle-staff-response').value = suggestion.staff;
                    
                    Utils.showNotification("AI Suggestions applied!");
                } catch(e) {
                    console.error(e);
                    Utils.showNotification("Failed to get suggestion", "error");
                } finally {
                    Utils.setLoading('cycle-ai-suggest-btn', false);
                }
            }
        }

        // --- NEW: Sensory Profile Analyzer (Option 2) ---
        class SensoryManager {
            constructor(controller) { this.c = controller; }

            init() {
                this.render();
            }

            render() {
                // Check if already rendered
                if(document.getElementById('sensory-profile-container')) return;

                const wrapper = document.createElement('div');
                wrapper.id = "sensory-profile-container";
                wrapper.className = "mt-6 mb-6 bg-purple-50 p-4 rounded-lg border border-purple-200 no-print";
                
                wrapper.innerHTML = `
                    <div class="flex justify-between items-center mb-4 cursor-pointer select-none" onclick="document.getElementById('sensory-body').classList.toggle('hidden'); this.querySelector('.chevron-sensory').classList.toggle('rotate-180')">
                        <h5 class="font-bold text-purple-900 flex items-center">
                            <span class="text-xl mr-2">üß†</span> Sensory Profile Analyzer
                        </h5>
                        <div class="flex items-center space-x-2">
                            <span id="sensory-badge" class="hidden text-xs font-bold px-2 py-1 rounded bg-white text-purple-600 border border-purple-200">Result Ready</span>
                            <svg class="chevron-sensory w-5 h-5 text-purple-400 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                    <div id="sensory-body" class="hidden">
                        <p class="text-xs text-purple-800 mb-4">Check behaviors to identify sensory drivers (Seeking vs. Avoiding).</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="bg-white p-3 rounded border border-purple-100">
                                <h6 class="font-bold text-xs text-purple-700 mb-2 uppercase tracking-wide">Seeking (Hypo-sensitive)</h6>
                                <label class="flex items-center text-sm mb-1 hover:bg-purple-50 p-1 rounded cursor-pointer"><input type="checkbox" class="sensory-chk mr-2 text-purple-600 rounded" data-type="seek_prop"> Crashes/Bumps into things (Proprioceptive)</label>
                                <label class="flex items-center text-sm mb-1 hover:bg-purple-50 p-1 rounded cursor-pointer"><input type="checkbox" class="sensory-chk mr-2 text-purple-600 rounded" data-type="seek_vest"> Spins/Rocks body (Vestibular)</label>
                                <label class="flex items-center text-sm mb-1 hover:bg-purple-50 p-1 rounded cursor-pointer"><input type="checkbox" class="sensory-chk mr-2 text-purple-600 rounded" data-type="seek_tact"> Touches everything/Messy (Tactile)</label>
                                <label class="flex items-center text-sm mb-1 hover:bg-purple-50 p-1 rounded cursor-pointer"><input type="checkbox" class="sensory-chk mr-2 text-purple-600 rounded" data-type="seek_oral"> Chews on shirts/objects (Oral)</label>
                                <label class="flex items-center text-sm mb-1 hover:bg-purple-50 p-1 rounded cursor-pointer"><input type="checkbox" class="sensory-chk mr-2 text-purple-600 rounded" data-type="seek_vis"> Stares at lights/fans (Visual)</label>
                            </div>
                            <div class="bg-white p-3 rounded border border-purple-100">
                                <h6 class="font-bold text-xs text-purple-700 mb-2 uppercase tracking-wide">Avoiding (Hyper-sensitive)</h6>
                                <label class="flex items-center text-sm mb-1 hover:bg-purple-50 p-1 rounded cursor-pointer"><input type="checkbox" class="sensory-chk mr-2 text-purple-600 rounded" data-type="avoid_aud"> Covers ears/Hates noise (Auditory)</label>
                                <label class="flex items-center text-sm mb-1 hover:bg-purple-50 p-1 rounded cursor-pointer"><input type="checkbox" class="sensory-chk mr-2 text-purple-600 rounded" data-type="avoid_tact"> Dislikes textures/tags (Tactile)</label>
                                <label class="flex items-center text-sm mb-1 hover:bg-purple-50 p-1 rounded cursor-pointer"><input type="checkbox" class="sensory-chk mr-2 text-purple-600 rounded" data-type="avoid_vis"> Squints/Hides from light (Visual)</label>
                                <label class="flex items-center text-sm mb-1 hover:bg-purple-50 p-1 rounded cursor-pointer"><input type="checkbox" class="sensory-chk mr-2 text-purple-600 rounded" data-type="avoid_smell"> Gags at smells (Olfactory)</label>
                                <label class="flex items-center text-sm mb-1 hover:bg-purple-50 p-1 rounded cursor-pointer"><input type="checkbox" class="sensory-chk mr-2 text-purple-600 rounded" data-type="avoid_prox"> Avoids crowds/touch (Proprioceptive)</label>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <button id="calc-sensory-btn" class="bg-purple-600 text-white px-4 py-2 rounded text-xs font-bold shadow hover:bg-purple-700 transition-colors">Analyze Profile</button>
                        </div>
                        <div id="sensory-result" class="mt-3 hidden p-4 bg-white rounded border border-purple-200 text-sm shadow-sm animate-fade-in-down"></div>
                    </div>
                `;

                // Insert after stats panel
                const target = document.getElementById('abc-stats-panel');
                if(target && target.parentNode) target.parentNode.insertBefore(wrapper, target.nextSibling);

                // Load Data Logic
                const data = this.c.store.getState().currentCaseData;
                if (data.sensoryProfile && data.sensoryProfile.checked) {
                    const boxes = wrapper.querySelectorAll('.sensory-chk');
                    boxes.forEach((box, i) => {
                        if (data.sensoryProfile.checked[i]) box.checked = true;
                    });
                    // Automatically show result if data exists
                    this.calculateProfile(false); 
                }

                // Logic Binding
                setTimeout(() => {
                    const btn = document.getElementById('calc-sensory-btn');
                    if(btn) btn.addEventListener('click', () => this.calculateProfile(true));
                }, 0);
            }

            async calculateProfile(save = true) {
                const checkboxes = Array.from(document.querySelectorAll('.sensory-chk'));
                const checkedStates = checkboxes.map(c => c.checked);
                
                const seekingCount = checkboxes.filter(c => c.checked && c.dataset.type.startsWith('seek')).length;
                const avoidingCount = checkboxes.filter(c => c.checked && c.dataset.type.startsWith('avoid')).length;
                
                let resultHtml = "";
                let badgeText = "";

                if (seekingCount === 0 && avoidingCount === 0) {
                    resultHtml = `<p class="text-gray-500 italic">No significant sensory patterns detected yet. Select behaviors to analyze.</p>`;
                    badgeText = "";
                } else if (seekingCount > avoidingCount && seekingCount >= 2) {
                    resultHtml = `
                        <div class="flex items-start">
                            <span class="text-2xl mr-3">üöÄ</span>
                            <div>
                                <strong class="text-purple-900 block mb-1">Sensory Seeking (Hypo-sensitive)</strong>
                                <p class="text-purple-800">The student likely needs <strong>more</strong> sensory input to regulate.</p>
                                <div class="mt-2 text-xs bg-purple-50 p-2 rounded border border-purple-100">
                                    <strong>Strategies:</strong> Heavy work (carrying books), fidgets, wiggle seat, movement breaks, crunchy snacks.
                                </div>
                            </div>
                        </div>`;
                    badgeText = "Seeking Profile";
                } else if (avoidingCount > seekingCount && avoidingCount >= 2) {
                    resultHtml = `
                        <div class="flex items-start">
                            <span class="text-2xl mr-3">üõ°Ô∏è</span>
                            <div>
                                <strong class="text-purple-900 block mb-1">Sensory Avoiding (Hyper-sensitive)</strong>
                                <p class="text-purple-800">The student likely needs <strong>less</strong> sensory input to regulate.</p>
                                <div class="mt-2 text-xs bg-purple-50 p-2 rounded border border-purple-100">
                                    <strong>Strategies:</strong> Noise-canceling headphones, dim lighting, quiet corner, decluttered workspace, warnings before loud noises.
                                </div>
                            </div>
                        </div>`;
                    badgeText = "Avoiding Profile";
                } else {
                    resultHtml = `
                        <div class="flex items-start">
                            <span class="text-2xl mr-3">‚öñÔ∏è</span>
                            <div>
                                <strong class="text-purple-900 block mb-1">Mixed Sensory Profile</strong>
                                <p class="text-purple-800">The student shows signs of both seeking and avoiding depending on the sense.</p>
                                <div class="mt-2 text-xs bg-purple-50 p-2 rounded border border-purple-100">
                                    <strong>Recommendation:</strong> Consult an Occupational Therapist (OT) for a specific sensory diet.
                                </div>
                            </div>
                        </div>`;
                    badgeText = "Mixed Profile";
                }

                const resDiv = document.getElementById('sensory-result');
                const badge = document.getElementById('sensory-badge');
                
                if(resDiv) {
                    resDiv.innerHTML = resultHtml;
                    resDiv.classList.remove('hidden');
                }
                
                if(badge) {
                    if(badgeText) {
                        badge.textContent = badgeText;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }

                if(save) {
                    await this.c.repo.updateCase(this.c.userId, this.c.caseId, { 
                        sensoryProfile: { seeking: seekingCount, avoiding: avoidingCount, checked: checkedStates } 
                    });
                    Utils.showNotification("Sensory Profile Saved");
                }
            }
        }

        // --- NEW: Interval Recording Manager ---
        class IntervalManager {
            constructor(controller) {
                this.c = controller;
                this.timer = null;
                this.intervals = []; 
                this.config = { totalMins: 10, intervalSecs: 15, type: 'Partial', behavior: '' };
                this.currentIdx = 0;
                this.isObserved = false; // State for current interval
                this.timeLeft = 0;
            }

            init() {
                this.c.bind('#open-interval-btn', 'click', () => this.open());
                this.c.bind('#close-interval-btn', 'click', () => this.close());
                this.c.bind('#start-interval-session-btn', 'click', () => this.startSession());
                this.c.bind('#int-record-btn', 'click', () => this.toggleObservation());
                this.c.bind('#int-end-btn', 'click', () => this.endSession());
                this.c.bind('#int-discard-btn', 'click', () => this.close());
                this.c.bind('#int-save-btn', 'click', () => this.saveSession());

                // Type Selection Logic
                document.querySelectorAll('.int-type-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        // Reset styles
                        document.querySelectorAll('.int-type-btn').forEach(b => {
                            b.className = "int-type-btn p-3 border rounded-lg text-sm font-bold text-center hover:bg-teal-50 focus:ring-2 focus:ring-teal-500 transition-all text-gray-600";
                        });
                        // Highlight selected
                        const t = e.currentTarget;
                        t.className = "int-type-btn p-3 border rounded-lg text-sm font-bold text-center hover:bg-teal-50 focus:ring-2 focus:ring-teal-500 bg-teal-100 border-teal-500 text-teal-800 transition-all shadow-sm transform scale-105";
                        this.config.type = t.dataset.val;
                    });
                });
            }

            open() {
                document.getElementById('interval-modal').classList.remove('hidden');
                document.getElementById('int-setup-view').classList.remove('hidden');
                document.getElementById('int-active-view').classList.add('hidden');
                document.getElementById('int-summary-view').classList.add('hidden');
                
                // Pre-fill behavior from most frequent
                const obs = this.c.store.getState().observations || [];
                if(obs.length > 0) {
                    const counts = {};
                    obs.forEach(o => { if(o.behavior) counts[o.behavior] = (counts[o.behavior]||0)+1; });
                    const top = Object.keys(counts).sort((a,b)=>counts[b]-counts[a])[0];
                    if(top) document.getElementById('int-behavior-name').value = top;
                }
            }

            close() {
                clearInterval(this.timer);
                document.getElementById('interval-modal').classList.add('hidden');
            }

            startSession() {
                // Get Inputs
                const mins = parseInt(document.getElementById('int-total-mins').value);
                const secs = parseInt(document.getElementById('int-interval-secs').value);
                const beh = document.getElementById('int-behavior-name').value || "Target Behavior";

                if (!mins || mins < 1) { Utils.showNotification("Invalid duration", "error"); return; }

                this.config = { ...this.config, totalMins: mins, intervalSecs: secs, behavior: beh };
                
                // Initialize State
                this.intervals = [];
                const totalIntervals = Math.ceil((mins * 60) / secs);
                for(let i=0; i<totalIntervals; i++) this.intervals.push(null); // null = not yet recorded
                
                this.currentIdx = 0;
                this.timeLeft = secs;
                this.isObserved = false;

                // Setup UI
                document.getElementById('int-setup-view').classList.add('hidden');
                document.getElementById('int-active-view').classList.remove('hidden');
                
                document.getElementById('int-total-count').textContent = totalIntervals;
                document.getElementById('int-type-display').textContent = this.config.type;
                this.renderGrid();
                this.updateActiveUI();

                // Start Loop
                this.runTimer();
            }

            runTimer() {
                clearInterval(this.timer);
                // Initial tick
                this.tick();
                this.timer = setInterval(() => this.tick(), 100); // 100ms for smoother bar
            }

            tick() {
                this.timeLeft -= 0.1;
                
                // Update Progress Bar & Timer Text
                const pct = (this.timeLeft / this.config.intervalSecs) * 100;
                document.getElementById('int-progress-bar').style.width = `${pct}%`;
                document.getElementById('int-timer-display').textContent = Math.ceil(this.timeLeft).toString().padStart(2, '0');

                if (this.timeLeft <= 0) {
                    this.finishInterval();
                }
            }

            toggleObservation() {
                this.isObserved = !this.isObserved;
                this.updateActiveUI();
            }

            updateActiveUI() {
                const btn = document.getElementById('int-record-btn');
                const icon = document.getElementById('int-record-icon');
                const label = document.getElementById('int-record-label');
                const status = document.getElementById('int-status-text');

                if (this.isObserved) {
                    btn.className = "w-64 h-64 rounded-full border-8 border-teal-500 bg-teal-100 flex flex-col items-center justify-center shadow-[0_0_30px_rgba(20,184,166,0.4)] transition-all duration-200 active:scale-95 mb-6 animate-pulse";
                    icon.textContent = "‚úÖ";
                    label.textContent = "OBSERVED";
                    label.className = "text-xl font-bold text-teal-800 uppercase tracking-widest";
                    status.textContent = "Tap to undo";
                } else {
                    btn.className = "w-64 h-64 rounded-full border-8 border-gray-200 bg-white flex flex-col items-center justify-center shadow-lg transition-all duration-200 active:scale-95 mb-6 hover:border-gray-300";
                    icon.textContent = "üëÅÔ∏è";
                    label.textContent = "Observe";
                    label.className = "text-xl font-bold text-gray-400 uppercase tracking-widest";
                    status.textContent = "Tap if behavior occurs";
                }
                
                // Update Live Score
                const completed = this.intervals.slice(0, this.currentIdx).filter(v => v !== null);
                // Include current state in live calc? Usually strictly completed intervals. 
                // Let's count completed only to avoid jumping numbers.
                const count = completed.filter(Boolean).length;
                const total = completed.length;
                const pct = total > 0 ? Math.round((count/total)*100) : 0;
                document.getElementById('int-live-score').textContent = `${pct}%`;
            }

            finishInterval() {
                // Beep
                const audio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
                audio.play().catch(e=>{});

                // Record Data
                this.intervals[this.currentIdx] = this.isObserved;
                
                this.currentIdx++;
                
                // Check End
                if (this.currentIdx >= this.intervals.length) {
                    this.endSession();
                    return;
                }

                // Reset for next
                this.timeLeft = this.config.intervalSecs;
                this.isObserved = false;
                
                // Update Grid & UI
                this.renderGrid();
                this.updateActiveUI();
                document.getElementById('int-current-num').textContent = this.currentIdx + 1;
            }

            renderGrid() {
                const container = document.getElementById('int-grid');
                let html = '';
                this.intervals.forEach((val, i) => {
                    let color = 'bg-gray-200 border-gray-300';
                    if (val === true) color = 'bg-red-500 border-red-600';
                    else if (val === false) color = 'bg-green-500 border-green-600';
                    
                    // Current indicator
                    if (i === this.currentIdx) color = 'bg-yellow-300 border-yellow-500 ring-2 ring-yellow-400 animate-pulse';
                    else if (i > this.currentIdx) color = 'bg-white border-gray-100';

                    html += `<div class="w-4 h-4 rounded-sm border ${color}" title="Interval ${i+1}: ${val===true?'Yes':val===false?'No':'...'}"></div>`;
                });
                container.innerHTML = html;
                // Auto scroll to bottom
                container.scrollTop = container.scrollHeight;
            }

            endSession() {
                clearInterval(this.timer);
                
                // Calculate Final Score
                // Filter out nulls (in case ended early)
                const recorded = this.intervals.filter(v => v !== null);
                const count = recorded.filter(Boolean).length;
                const total = recorded.length;
                const pct = total > 0 ? Math.round((count/total)*100) : 0;

                // Show Summary
                document.getElementById('int-active-view').classList.add('hidden');
                document.getElementById('int-summary-view').classList.remove('hidden');
                
                document.getElementById('int-final-score').textContent = `${pct}%`;
                document.getElementById('int-summary-detail').innerHTML = `
                    <strong>${this.config.behavior}</strong> occurred in <strong>${count}</strong> out of <strong>${total}</strong> intervals.<br>
                    <span class="text-xs text-gray-500 mt-2 block">(${this.config.type} Interval Recording)</span>
                `;
            }

            async saveSession() {
                const recorded = this.intervals.filter(v => v !== null);
                const count = recorded.filter(Boolean).length;
                const total = recorded.length;
                const pct = total > 0 ? Math.round((count/total)*100) : 0;
                
                // Create Note Text
                const note = `${this.config.type} Interval Recording (${total} intervals of ${this.config.intervalSecs}s). Result: ${pct}% occurrence.`;

                Utils.setLoading('int-save-btn', true);
                
                try {
                    await this.c.repo.addObservation(this.c.userId, this.c.caseId, {
                        antecedent: "Structured Data Collection",
                        behavior: this.config.behavior,
                        consequence: note,
                        observationTime: new Date(),
                        setting: "Interval Session",
                        intensity: Math.ceil(pct / 10), // Map % to 1-10 intensity for graphs
                        duration: Math.ceil((total * this.config.intervalSecs) / 60),
                        type: 'interval_data',
                        intervalData: {
                            type: this.config.type,
                            totalIntervals: total,
                            intervalSecs: this.config.intervalSecs,
                            occurrences: count,
                            percentage: pct
                        }
                    });
                    Utils.showNotification("Session Saved!");
                    this.close();
                } catch(e) {
                    console.error(e);
                    Utils.showNotification("Error saving", "error");
                } finally {
                    Utils.setLoading('int-save-btn', false);
                }
            }
        }

        // --- NEW: Skill Deficit & Replacement Mapper (Option 1) ---
        class SkillMapperManager {
            constructor(controller) {
                this.c = controller;
                this.skills = {
                    "Communication (FCT)": [
                        { id: 'fct_break', label: "Cannot ask for break", text: "Student will hand a 'Break' card to staff immediately upon feeling frustrated." },
                        { id: 'fct_help', label: "Cannot ask for help", text: "Student will raise hand and ask 'Can you help me?' instead of shutting down." },
                        { id: 'fct_attn', label: "Cannot ask for attention", text: "Student will tap staff on shoulder and wait for eye contact." }
                    ],
                    "Tolerance & Regulation": [
                        { id: 'tol_no', label: "Cannot accept 'No'", text: "Student will say 'Okay' or take a deep breath when denied a preferred item." },
                        { id: 'tol_wait', label: "Cannot wait", text: "Student will wait calmly for up to 1 minute using a visual timer." },
                        { id: 'reg_calm', label: "Lacks calming strategy", text: "Student will go to the calm corner and squeeze a stress ball for 2 minutes." },
                        { id: 'tol_trans', label: "Struggles with transitions", text: "Student will carry a transition object to the next activity." }
                    ]
                };
            }

            init() {
                // Render immediately. Visibility is controlled by the parent section's hidden state.
                this.render();
            }

            render() {
                const container = document.getElementById('skill-mapper-container');
                if (!container) return;

                let html = `
                    <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200 mb-6 relative no-print">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-indigo-900 text-sm flex items-center">
                                <span class="text-xl mr-2">üß©</span> Skill Deficit & Replacement Mapper
                            </h4>
                            <button id="toggle-mapper-btn" class="text-xs text-indigo-600 hover:text-indigo-800 underline">Hide</button>
                        </div>
                        <p class="text-xs text-indigo-700 mb-4">Identify missing skills to automatically generate replacement behaviors.</p>
                        <div id="mapper-body">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">`;

                for (const [category, items] of Object.entries(this.skills)) {
                    html += `<div><h5 class="font-bold text-xs uppercase text-indigo-400 mb-2 tracking-wider border-b border-indigo-200 pb-1">${category}</h5><div class="space-y-1">`;
                    items.forEach(item => {
                        html += `
                            <label class="flex items-start space-x-2 cursor-pointer hover:bg-indigo-100 p-1 rounded transition-colors group">
                                <input type="checkbox" class="skill-check mt-0.5 rounded text-indigo-600 focus:ring-indigo-500" value="${item.id}" data-text="${item.text}">
                                <span class="text-xs text-indigo-800 group-hover:text-indigo-900 font-medium">${item.label}</span>
                            </label>`;
                    });
                    html += `</div></div>`;
                }

                html += `   </div>
                            <div id="replacement-preview" class="hidden bg-white p-3 rounded border border-indigo-100 mb-3 shadow-inner">
                                <strong class="text-[10px] text-indigo-500 uppercase block mb-1 font-bold">Replacement Behavior Preview:</strong>
                                <ul id="replacement-list" class="list-disc pl-4 text-xs text-gray-600 italic space-y-1"></ul>
                            </div>
                            <div class="text-right">
                                <button id="insert-skills-btn" class="bg-indigo-600 text-white px-4 py-2 rounded text-xs font-bold hover:bg-indigo-700 shadow-sm disabled:opacity-50 disabled:cursor-not-allowed transition-colors" disabled>
                                    Add to 'Teach' Plan
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                container.innerHTML = html;

                // Bindings
                const body = document.getElementById('mapper-body');
                const toggleBtn = document.getElementById('toggle-mapper-btn');
                
                toggleBtn.onclick = () => {
                    body.classList.toggle('hidden');
                    toggleBtn.textContent = body.classList.contains('hidden') ? "Show" : "Hide";
                };

                const checks = container.querySelectorAll('.skill-check');
                const preview = document.getElementById('replacement-preview');
                const list = document.getElementById('replacement-list');
                const insertBtn = document.getElementById('insert-skills-btn');

                checks.forEach(chk => {
                    chk.addEventListener('change', () => {
                        const selected = Array.from(checks).filter(c => c.checked);
                        
                        if (selected.length > 0) {
                            preview.classList.remove('hidden');
                            insertBtn.disabled = false;
                            list.innerHTML = selected.map(c => `<li>${c.dataset.text}</li>`).join('');
                        } else {
                            preview.classList.add('hidden');
                            insertBtn.disabled = true;
                            list.innerHTML = '';
                        }
                    });
                });

                insertBtn.onclick = () => this.insertStrategies();
            }

            async insertStrategies() {
                const checks = document.querySelectorAll('.skill-check:checked');
                if (checks.length === 0) return;

                const strategies = Array.from(checks).map(c => `<li>${c.dataset.text}</li>`).join('');
                // Wrap in a div to ensure block separation
                const htmlToAdd = `<div class="mt-2"><strong class="text-xs text-indigo-800 uppercase">Targeted Skills:</strong><ul class="list-disc pl-5 my-1 space-y-1 text-sm">${strategies}</ul></div>`;

                // Find the editable area managed by BipManager
                const area = document.getElementById('teach-editable-area');
                
                // If area is empty or "N/A", replace. Else append.
                if (!area || !area.innerText.trim() || area.innerText.trim() === 'N/A') {
                    if(area) area.innerHTML = htmlToAdd;
                } else {
                    area.innerHTML += htmlToAdd;
                }

                // Trigger Save via Repo
                if (this.c.userId && this.c.caseId) {
                    await this.c.repo.updateCase(this.c.userId, this.c.caseId, { bipTeachContent: area.innerHTML });
                    Utils.showNotification("Skills added to Teach Plan!");
                }
                
                // Reset UI
                checks.forEach(c => c.checked = false);
                document.getElementById('replacement-preview').classList.add('hidden');
                document.getElementById('insert-skills-btn').disabled = true;
                document.getElementById('mapper-body').classList.add('hidden'); // Auto-collapse after insert
                document.getElementById('toggle-mapper-btn').textContent = "Show";
            }
        }

        // --- NEW: Task Analysis Manager (Option 1) ---
        class TaskAnalysisManager {
            constructor(controller) {
                this.c = controller;
                this.steps = [];
            }

            init() {
                this.render();
            }

            render() {
                const container = document.getElementById('task-analysis-container');
                if (!container) return;

                container.innerHTML = `
                    <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200 mt-4 mb-4 no-print">
                        <div class="flex justify-between items-center mb-2">
                            <h5 class="font-bold text-indigo-900 text-sm flex items-center">
                                <span class="text-xl mr-2">‚õìÔ∏è</span> Skill Task Analysis (Chaining)
                            </h5>
                            <button id="toggle-task-btn" class="text-xs text-indigo-600 hover:text-indigo-800 underline">Hide</button>
                        </div>
                        <div id="task-analysis-body">
                            <p class="text-xs text-indigo-700 mb-3">Break complex skills down into small, teachable steps.</p>
                            <div class="flex gap-2 mb-2">
                                <input id="new-task-step" class="flex-grow p-2 text-sm border rounded focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Add a step (e.g., '1. Pick up break card')">
                                <button id="add-step-btn" class="bg-indigo-600 text-white px-3 py-1 rounded text-sm font-bold hover:bg-indigo-700 shadow-sm transition-colors">+</button>
                            </div>
                            <ul id="task-steps-list" class="space-y-1 mb-3 max-h-40 overflow-y-auto"></ul>
                            <div class="text-right">
                                <button id="save-task-analysis-btn" class="text-xs bg-white text-indigo-700 border border-indigo-200 px-3 py-1 rounded hover:bg-indigo-50 font-bold shadow-sm transition-colors disabled:opacity-50" disabled>Insert into Plan</button>
                            </div>
                        </div>
                    </div>
                `;

                // Bindings
                document.getElementById('toggle-task-btn').onclick = () => {
                    const body = document.getElementById('task-analysis-body');
                    body.classList.toggle('hidden');
                    document.getElementById('toggle-task-btn').textContent = body.classList.contains('hidden') ? "Show" : "Hide";
                };

                const input = document.getElementById('new-task-step');
                const addBtn = document.getElementById('add-step-btn');
                const saveBtn = document.getElementById('save-task-analysis-btn');

                const addHandler = () => {
                    const val = input.value.trim();
                    if(val) {
                        this.steps.push(val);
                        this.renderList();
                        input.value = '';
                        input.focus();
                        saveBtn.disabled = false;
                    }
                };

                addBtn.onclick = addHandler;
                input.addEventListener('keypress', (e) => { if(e.key === 'Enter') addHandler(); });

                saveBtn.onclick = () => this.saveToBIP();
            }

            renderList() {
                const list = document.getElementById('task-steps-list');
                if(!list) return;
                
                list.innerHTML = this.steps.map((step, i) => `
                    <li class="bg-white p-2 rounded border border-indigo-100 flex justify-between items-center text-sm shadow-sm">
                        <span><span class="font-bold text-indigo-400 mr-2">${i+1}.</span> ${step}</span>
                        <button class="text-red-400 hover:text-red-600 font-bold px-2 remove-step-btn" data-idx="${i}">√ó</button>
                    </li>
                `).join('');

                list.querySelectorAll('.remove-step-btn').forEach(btn => {
                    btn.onclick = (e) => {
                        const idx = parseInt(e.target.dataset.idx);
                        this.removeStep(idx);
                    };
                });
                
                // Update button state
                const saveBtn = document.getElementById('save-task-analysis-btn');
                if(saveBtn) saveBtn.disabled = this.steps.length === 0;
            }

            removeStep(index) {
                this.steps.splice(index, 1);
                this.renderList();
            }

            async saveToBIP() {
                if (this.steps.length === 0) return;

                // Formats the list as HTML and appends it to the 'Teach' editable area
                const html = `<div class="mt-3 p-3 bg-indigo-50 rounded border border-indigo-100"><strong class="text-indigo-900 text-sm block mb-1">‚õìÔ∏è Task Analysis:</strong><ol class="list-decimal pl-5 text-sm text-indigo-800 space-y-1">${this.steps.map(s => `<li>${s}</li>`).join('')}</ol></div>`;
                
                const area = document.getElementById('teach-editable-area');
                if (area.innerHTML.trim() === "N/A" || area.innerHTML.trim() === "") {
                    area.innerHTML = html;
                } else {
                    area.innerHTML += html;
                }

                // Trigger save
                await this.c.repo.updateCase(this.c.userId, this.c.caseId, { bipTeachContent: area.innerHTML });
                Utils.showNotification("Task Analysis added to Teach Plan!");
                
                // Reset
                this.steps = [];
                this.renderList();
                document.getElementById('new-task-step').value = '';
            }
        }

        // --- NEW: Communication Manager (Option 2) ---
        class CommunicationManager {
            constructor(controller) { 
                this.c = controller; 
            }

            init() {
                this.c.bind('#home-note-btn', 'click', () => this.generateHomeNote());
                this.c.bind('#handoff-btn', 'click', () => this.generateShiftHandoff());
            }

            generateShiftHandoff() {
                const data = this.c.store.getState().currentCaseData;
                const obs = this.c.store.getState().observations || [];
                
                // 1. Filter for Today
                const todayStr = new Date().toDateString();
                const todaysObs = obs.filter(o => Utils.safeDate(o.observationTime).toDateString() === todayStr);
                
                // 2. Determine Status
                const lastObs = todaysObs.sort((a,b) => Utils.safeDate(b.observationTime) - Utils.safeDate(a.observationTime))[0];
                let status = "üü¢ Stable";
                if (lastObs) {
                    const hoursSince = (new Date() - Utils.safeDate(lastObs.observationTime)) / (1000 * 60 * 60);
                    if (hoursSince < 1) status = "üî¥ Unsettled (Recent Incident)";
                    else if (hoursSince < 3) status = "üü° Recovering";
                }

                // 3. Draft Text
                const preventStrategy = data.bipPreventContent ? Utils.stripHtml(data.bipPreventContent).substring(0, 40) + "..." : "Review Plan";
                
                const text = `üìã HANDOFF: ${data.studentName}
-------------------------
Status: ${status}
Events Today: ${todaysObs.length}
Last Event: ${lastObs ? Utils.safeDate(lastObs.observationTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : 'None'}
Focus Strategy: ${preventStrategy}`;

                // 4. Copy to Clipboard (Robust Fallback)
                const tempInput = document.createElement("textarea");
                tempInput.value = text;
                document.body.appendChild(tempInput);
                tempInput.select();
                try {
                    document.execCommand("copy");
                    Utils.showNotification("Handoff summary copied!");
                } catch (e) {
                    Utils.showNotification("Failed to copy", "error");
                }
                document.body.removeChild(tempInput);
            }

            generateHomeNote() {
                const data = this.c.store.getState().currentCaseData;
                const obs = this.c.store.getState().observations || [];
                
                // 1. Filter for today's data
                const today = new Date();
                const todayStr = today.toDateString();
                const todaysObs = obs.filter(o => {
                    const d = Utils.safeDate(o.observationTime);
                    return d && d.toDateString() === todayStr;
                });
                
                // 2. Determine Tone
                const count = todaysObs.length;
                let highlight = "had a good day!";
                let emoji = "üåü";
                
                if (count > 5) {
                    highlight = "had a busy day with some challenges, but we worked through them.";
                    emoji = "üí™";
                } else if (count > 2) {
                    highlight = "had a few ups and downs, but finished strong.";
                    emoji = "üå§Ô∏è";
                } else if (count === 0) {
                    highlight = "had a wonderful, positive day!";
                    emoji = "üéâ";
                }

                // Get a skill focus from BIP or default
                const rawSkill = data.bipTeachContent || "positive coping skills";
                // Strip HTML and grab first meaningful chunk
                const skillClean = Utils.stripHtml(rawSkill).split(/[.,]/)[0].substring(0, 50) + "...";

                // 3. Draft Text
                const note = `Hi Parent/Guardian,

Just a quick update on ${data.studentName} for today (${today.toLocaleDateString()}).

${data.studentName} ${highlight} ${emoji}

Highlights:
- We focused on practicing: ${skillClean}
- Incidents recorded today: ${count}

We are continuing to use the support plan to help ${data.studentName} succeed.

Best,
The School Team`;

                // 4. Render in Preview Modal
                const content = document.getElementById('report-preview-content');
                content.innerHTML = `
                    <div class="p-6 max-w-2xl mx-auto">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="bg-pink-100 text-pink-600 p-2 rounded-full mr-2">‚úâÔ∏è</span> Home Note Draft
                        </h3>
                        <div class="bg-gray-50 p-4 rounded border border-gray-200 shadow-inner">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Editable Message</label>
                            <textarea id="home-note-text" class="w-full h-64 p-3 border border-gray-300 rounded text-sm font-mono text-gray-700 focus:ring-2 focus:ring-pink-500 outline-none" spellcheck="false">${note}</textarea>
                        </div>
                        <div class="mt-4 flex justify-end space-x-2">
                            <button id="copy-note-btn" class="bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-6 rounded shadow-md flex items-center transition-transform active:scale-95">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                Copy to Clipboard
                            </button>
                        </div>
                    </div>
                `;

                // Show Modal & Hide PDF Download Button (context switch)
                const modal = document.getElementById('report-preview-modal');
                const dlBtn = document.getElementById('preview-download-btn');
                if(dlBtn) dlBtn.classList.add('hidden');
                modal.classList.remove('hidden');

                // Bind Copy
                document.getElementById('copy-note-btn').onclick = () => {
                    const txt = document.getElementById('home-note-text');
                    txt.select();
                    document.execCommand('copy');
                    Utils.showNotification("Note copied to clipboard!");
                };
            }
        }

        // --- NEW: Presentation Mode Manager (Option 2) ---
        class PresentationManager {
            constructor(controller) { this.c = controller; }
            
            init() {
                this.c.bind('#present-mode-btn', 'click', () => this.toggle());
            }

            toggle() {
                document.body.classList.toggle('presentation-mode');
                const isPresenting = document.body.classList.contains('presentation-mode');
                
                if (isPresenting) {
                    // Expand all sections for visibility so data isn't hidden behind accordions
                    document.querySelectorAll('.section-collapsed').forEach(el => el.classList.remove('section-collapsed'));
                    
                    // Inject Exit Button (Fixed position, high z-index)
                    if (!document.getElementById('exit-present-btn')) {
                        const exitBtn = document.createElement('button');
                        exitBtn.id = 'exit-present-btn';
                        exitBtn.className = 'fixed bottom-6 right-6 bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-full shadow-2xl z-[100] font-bold text-lg animate-bounce flex items-center border-4 border-white';
                        exitBtn.innerHTML = `<span>Exit Presentation</span> <svg class="w-6 h-6 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`;
                        exitBtn.onclick = () => this.toggle();
                        document.body.appendChild(exitBtn);
                    }
                    
                    Utils.showNotification("Presentation Mode Active - Distractions Hidden");
                } else {
                    // Remove Exit Button
                    const btn = document.getElementById('exit-present-btn');
                    if(btn) btn.remove();
                    Utils.showNotification("Presentation Mode Exited");
                }
            }
        }

        // --- NEW CLASS: LiveModeManager ---
        class LiveModeManager {
            constructor(controller) {
                this.c = controller;
                this.timerInterval = null;
                this.startTime = null;
                this.elapsedPaused = 0;
                this.isRunning = false;
                this.sessionEvents = 0;
                this.isEditing = false; // Track edit mode state
            }

            init() {
                this.c.bind('#live-mode-btn', 'click', () => this.open());
                
                // FIX: Use global document selector because overlay is outside main view container
                const exitBtn = document.getElementById('exit-live-mode');
                if (exitBtn) {
                    exitBtn.addEventListener('click', () => this.close());
                }

                // Edit Button Binding
                const editBtn = document.getElementById('live-edit-btn');
                if (editBtn) {
                    editBtn.addEventListener('click', () => this.toggleEditMode());
                }

                this.c.bind('#live-timer-toggle', 'click', () => this.toggleTimer());
                this.c.bind('#live-timer-reset', 'click', () => this.resetTimer());
                
                // Changed from setupVITimer to setupAdvancedTimers
                this.setupAdvancedTimers();
                this.setupVoiceStream(); 
            }

            // ... (setupVoiceStream, addFeedItem, setupAdvancedTimers unchanged) ...
            setupVoiceStream() {
                const btn = document.getElementById('live-mic-btn');
                const btnText = document.getElementById('live-mic-text');
                const btnIcon = document.getElementById('live-mic-icon');
                
                if (!('webkitSpeechRecognition' in window)) {
                    btn.disabled = true;
                    btnText.textContent = "Mic Not Supported";
                    return;
                }

                btn.addEventListener('click', () => {
                    const recognition = new webkitSpeechRecognition();
                    recognition.lang = I18nService.currentLocale === 'es' ? 'es-ES' : 'en-US';
                    recognition.interimResults = false;
                    recognition.maxAlternatives = 1;

                    // UI State: Listening
                    btn.classList.replace('bg-gray-700', 'bg-red-600');
                    btn.classList.add('animate-pulse');
                    btnText.textContent = "Listening...";
                    btnIcon.textContent = "üî¥";

                    recognition.start();

                    recognition.onresult = async (event) => {
                        const text = event.results[0][0].transcript;
                        this.addFeedItem(text, 'note');
                        
                        // Save to Database
                        try {
                            await this.c.repo.addObservation(this.c.userId, this.c.caseId, {
                                antecedent: "Live Session Note",
                                behavior: "Qualitative Note", 
                                consequence: text, 
                                observationTime: new Date(),
                                setting: "Live Stream",
                                type: 'qualitative_note' 
                            });
                            Utils.showNotification("Note saved");
                        } catch(e) {
                            console.error(e);
                        }
                    };

                    recognition.onerror = (event) => {
                        console.error(event.error);
                        Utils.showNotification("Mic Error", "error");
                        resetBtn();
                    };

                    recognition.onend = () => {
                        resetBtn();
                    };

                    const resetBtn = () => {
                        btn.classList.replace('bg-red-600', 'bg-gray-700');
                        btn.classList.remove('animate-pulse');
                        btnText.textContent = "Dictate Note";
                        btnIcon.textContent = "üéôÔ∏è";
                    };
                });
            }

            addFeedItem(text, type = 'event') {
                const feed = document.getElementById('live-stream-feed');
                const item = document.createElement('div');
                const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
                
                if (type === 'note') {
                    item.className = "bg-gray-700 text-gray-200 p-3 rounded-lg text-xs border-l-4 border-blue-500 animate-fade-in-down";
                    item.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold text-blue-400">üé§ Voice Note</span>
                            <span class="text-gray-500 text-[10px]">${time}</span>
                        </div>
                        <div class="italic">"${text}"</div>
                    `;
                } else {
                    // Standard Event
                    item.className = "bg-gray-700 text-white p-2 rounded-lg text-xs border-l-4 border-yellow-500 animate-fade-in-down flex justify-between items-center";
                    item.innerHTML = `
                        <span class="font-bold">${text}</span>
                        <span class="text-gray-500 text-[10px]">${time}</span>
                    `;
                }
                
                feed.prepend(item);
            }

            setupAdvancedTimers() {
                // Target the Left Column (first bg-gray-800)
                const container = document.querySelector('#live-obs-overlay .bg-gray-800'); 
                if (!container || document.getElementById('adv-timer-controls')) return;

                // Inject UI for Multiple Timer Types
                const html = `
                    <div id="adv-timer-controls" class="mt-6 w-full border-t border-gray-700 pt-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-bold text-gray-400 uppercase tracking-widest">Alert Timer</span>
                            <select id="timer-type-select" class="bg-gray-700 text-white text-[10px] rounded border border-gray-600 outline-none p-1 focus:border-indigo-500">
                                <option value="VI">Variable (VI)</option>
                                <option value="FI">Fixed (FI)</option>
                                <option value="MTS">Momentary (MTS)</option>
                                <option value="PIR">Partial (PIR)</option>
                                <option value="WIR">Whole (WIR)</option>
                            </select>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="number" id="timer-interval-input" class="w-12 p-2 rounded bg-gray-700 text-white text-center font-mono focus:ring-2 focus:ring-indigo-500 outline-none border border-gray-600 text-sm" value="5" min="1">
                            <span class="text-gray-400 text-xs">min</span>
                            <button id="adv-timer-toggle-btn" class="flex-grow bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded text-xs font-bold transition-colors shadow-lg uppercase tracking-wide">Start</button>
                        </div>
                        <div id="adv-timer-status" class="mt-2 text-[10px] text-center text-gray-500 italic h-4 transition-colors"></div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);

                let timerId;
                let isRunning = false;
                const btn = document.getElementById('adv-timer-toggle-btn');
                const status = document.getElementById('adv-timer-status');
                const input = document.getElementById('timer-interval-input');
                const typeSelect = document.getElementById('timer-type-select');

                btn.addEventListener('click', () => {
                    if (isRunning) {
                        // Stop Logic
                        clearTimeout(timerId);
                        clearInterval(timerId);
                        isRunning = false;
                        
                        // Reset UI
                        btn.textContent = "Start";
                        btn.classList.replace('bg-red-600', 'bg-indigo-600');
                        btn.classList.replace('hover:bg-red-700', 'hover:bg-indigo-700');
                        status.textContent = "";
                        input.disabled = false;
                        typeSelect.disabled = false;
                        Utils.showNotification("Timer Stopped");
                    } else {
                        // Start Logic
                        const mins = parseInt(input.value);
                        if (!mins || mins < 1) {
                            Utils.showNotification("Invalid minutes", "error");
                            return;
                        }

                        isRunning = true;
                        input.disabled = true;
                        typeSelect.disabled = true;
                        btn.textContent = "Stop";
                        btn.classList.replace('bg-indigo-600', 'bg-red-600');
                        btn.classList.replace('hover:bg-indigo-700', 'hover:bg-red-700');

                        const type = typeSelect.value;
                        const triggerAlert = () => {
                            // Audio Alert
                            const audio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
                            audio.play().catch(() => {});
                            
                            // Visual Flash Overlay
                            const overlay = document.getElementById('live-obs-overlay');
                            const originalBg = "bg-gray-900";
                            overlay.classList.remove(originalBg);
                            overlay.classList.add('bg-green-900');
                            setTimeout(() => {
                                overlay.classList.remove('bg-green-900');
                                overlay.classList.add(originalBg);
                            }, 500);

                            let msg = "";
                            switch(type) {
                                case 'VI': msg = "üé≤ VI Check: Reinforce?"; break;
                                case 'FI': msg = "‚è∞ FI Check: Interval Complete"; break;
                                case 'MTS': msg = "üëÄ Momentary Check: Is behavior happening NOW?"; break;
                                case 'PIR': msg = "üìù Partial Interval: Did behavior occur at all?"; break;
                                case 'WIR': msg = "‚è±Ô∏è Whole Interval: Did behavior last the entire time?"; break;
                            }
                            Utils.showNotification(msg);
                        };

                        if (type !== 'VI') {
                            // Fixed Interval Types (FI, MTS, PIR, WIR)
                            const ms = mins * 60 * 1000;
                            status.textContent = `${type}: Alerting every ${mins} min`;
                            status.className = "mt-2 text-[10px] text-center text-green-400 font-bold h-4";
                            timerId = setInterval(triggerAlert, ms);
                            Utils.showNotification(`${type} Timer (${mins}m) Started`);
                        } else {
                            // Variable Interval
                            const runVI = () => {
                                const avg = parseInt(input.value);
                                // Variation +/- 40%
                                const min = avg * 0.6;
                                const max = avg * 1.4;
                                const nextMs = ((Math.random() * (max - min) + min) * 60 * 1000);
                                
                                status.textContent = `Next alert in ~${Math.round(nextMs/1000/60)} min`;
                                status.className = "mt-2 text-[10px] text-center text-blue-400 font-bold h-4";

                                timerId = setTimeout(() => {
                                    triggerAlert();
                                    if (isRunning) runVI(); // Recurse
                                }, nextMs);
                            };
                            runVI();
                            Utils.showNotification(`Variable Interval (~${mins}m) Started`);
                        }
                    }
                });
            }

            async open() {
                const data = this.c.store.getState().currentCaseData;
                document.getElementById('live-student-name').textContent = data.studentName;
                document.getElementById('live-obs-overlay').classList.remove('hidden');
                this.isEditing = false;
                document.getElementById('live-edit-btn').textContent = "Edit Buttons";
                
                // Reset session stats for display
                document.getElementById('live-session-count').textContent = '0';
                this.sessionEvents = 0;

                // NEW: Auto-Sync Logic
                // If we don't have custom behaviors saved, but we DO have a BIP definition...
                if ((!data.liveBehaviors || data.liveBehaviors.length === 0) && data.bipOperationalDefinition) {
                    const container = document.getElementById('live-buttons-container');
                    container.innerHTML = '<div class="col-span-2 sm:col-span-3 text-center text-gray-400 italic py-10 animate-pulse">ü§ñ Syncing target behaviors from BIP...</div>';
                    
                    try {
                        const prompt = `Extract specific target behaviors from this definition. Return a JSON array of strings (max 3 words each, e.g. ["Hitting", "Yelling"]). Definition: "${data.bipOperationalDefinition}". Return ONLY raw JSON.`;
                        const response = await Utils.getGeminiResponse([{role: 'user', parts: [{ text: prompt }]}]);
                        const json = response.replace(/```json/g, '').replace(/```/g, '').trim();
                        const behaviors = JSON.parse(json);
                        
                        if (Array.isArray(behaviors) && behaviors.length > 0) {
                            // Save to case data so we don't have to ask AI next time
                            await this.c.repo.updateCase(this.c.userId, this.c.caseId, { liveBehaviors: behaviors });
                            Utils.showNotification("Behaviors synced from BIP!");
                        }
                    } catch (e) {
                        console.error("Auto-sync failed", e);
                        // Defaults will load in renderButtons if this fails
                    }
                }

                this.renderButtons();
                
                // Attempt Fullscreen
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen().catch(e => console.log(e));
                }
            }

            close() {
                document.getElementById('live-obs-overlay').classList.add('hidden');
                if (document.exitFullscreen && document.fullscreenElement) {
                    document.exitFullscreen().catch(e => console.log(e));
                }
            }

            toggleEditMode() {
                this.isEditing = !this.isEditing;
                const btn = document.getElementById('live-edit-btn');
                btn.textContent = this.isEditing ? "Done Editing" : "Edit Buttons";
                btn.className = this.isEditing 
                    ? "text-xs text-green-400 hover:text-white font-bold underline decoration-wavy transition-colors"
                    : "text-xs text-gray-500 hover:text-white underline decoration-dotted transition-colors";
                
                this.renderButtons();
            }

            renderButtons() {
                const container = document.getElementById('live-buttons-container');
                const data = this.c.store.getState().currentCaseData;
                
                // Get Saved behaviors or Fallback to defaults
                let behaviors = data.liveBehaviors || [];
                
                // If empty, calculate defaults
                if (behaviors.length === 0) {
                    const allObs = this.c.store.getState().observations || [];
                    const counts = {};
                    allObs.forEach(o => { if(o.behavior) counts[o.behavior] = (counts[o.behavior]||0)+1; });
                    behaviors = Object.keys(counts).sort((a,b) => counts[b]-counts[a]).slice(0, 5);
                    
                    if(behaviors.length === 0) behaviors = ["Verbal Refusal", "Physical Aggression", "Elopement", "Disruption", "Off-Task"];
                    if(!behaviors.includes("Other")) behaviors.push("Other");
                }

                container.innerHTML = '';

                // Colors for cards
                const colors = [
                    'from-blue-600 to-blue-700 border-blue-800',
                    'from-red-600 to-red-700 border-red-800', 
                    'from-yellow-600 to-yellow-700 border-yellow-800',
                    'from-purple-600 to-purple-700 border-purple-800',
                    'from-green-600 to-green-700 border-green-800',
                    'from-gray-600 to-gray-700 border-gray-800'
                ];

                if (this.isEditing) {
                    // --- EDIT MODE ---
                    behaviors.forEach((b, i) => {
                        const card = document.createElement('div');
                        card.className = "relative bg-gray-700 text-gray-300 rounded-xl p-4 font-bold flex flex-col items-center justify-center border-2 border-dashed border-gray-500 min-h-[120px]";
                        
                        const label = document.createElement('span');
                        label.className = "text-lg text-center leading-tight mb-2";
                        label.textContent = b;
                        card.appendChild(label);

                        const removeBtn = document.createElement('button');
                        removeBtn.className = "text-red-400 hover:text-red-500 text-xs uppercase font-bold border border-red-400 px-2 py-1 rounded transition-colors hover:bg-red-900/20";
                        removeBtn.textContent = "Remove";
                        removeBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.removeCustomBehavior(b, behaviors);
                        });
                        card.appendChild(removeBtn);

                        container.appendChild(card);
                    });

                    // Add "Add New" Button
                    const addCard = document.createElement('button');
                    addCard.className = "bg-gray-800 text-green-400 rounded-xl p-4 font-bold flex flex-col items-center justify-center border-2 border-dashed border-green-500 hover:bg-gray-700 transition-colors min-h-[120px]";
                    addCard.innerHTML = `<span class="text-4xl">+</span><span class="text-xs uppercase">Add New</span>`;
                    addCard.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.addCustomBehavior(behaviors);
                    });
                    container.appendChild(addCard);

                } else {
                    // --- LOG MODE (Normal) ---
                    behaviors.forEach((b, i) => {
                        const colorClass = colors[i % colors.length];
                        const btn = document.createElement('button');
                        btn.className = `live-log-btn relative group overflow-hidden bg-gradient-to-br ${colorClass} text-white rounded-xl p-4 font-bold flex flex-col items-center justify-center transition-all transform active:scale-95 shadow-lg border-b-4 h-full min-h-[120px]`;
                        btn.innerHTML = `
                            <div class="absolute inset-0 bg-white opacity-0 group-hover:opacity-10 transition-opacity"></div>
                            <span class="text-3xl lg:text-4xl mb-2 drop-shadow-md">‚ö°</span>
                            <span class="text-lg lg:text-xl text-center leading-tight drop-shadow-sm">${b}</span>
                        `;
                        btn.onclick = () => this.quickLog(b, btn);
                        container.appendChild(btn);
                    });
                }
            }

            async addCustomBehavior(currentList) {
                // Simple prompt for now
                const newBeh = prompt("Enter new behavior name:");
                if (newBeh && newBeh.trim()) {
                    const updated = [...currentList, newBeh.trim()];
                    // Persist
                    await this.c.repo.updateCase(this.c.userId, this.c.caseId, { liveBehaviors: updated });
                    // Explicitly update store to reflect immediately without full reload if needed
                    this.c.store.getState().currentCaseData.liveBehaviors = updated;
                    this.renderButtons();
                }
            }

            async removeCustomBehavior(behToRemove, currentList) {
                if(confirm(`Remove "${behToRemove}"?`)) {
                    const updated = currentList.filter(b => b !== behToRemove);
                    // Persist
                    await this.c.repo.updateCase(this.c.userId, this.c.caseId, { liveBehaviors: updated });
                    // Explicitly update store
                    this.c.store.getState().currentCaseData.liveBehaviors = updated;
                    this.renderButtons();
                }
            }

            async quickLog(behavior, btnElement) {
                // Visual feedback
                btnElement.classList.add('ring-4', 'ring-white');
                setTimeout(() => btnElement.classList.remove('ring-4', 'ring-white'), 200);

                // Update local session stats
                this.sessionEvents++;
                document.getElementById('live-session-count').textContent = this.sessionEvents;
                document.getElementById('live-last-log').textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                // Add to Feed
                this.addFeedItem(behavior, 'event');

                Utils.showNotification(`Logged: ${behavior}`);
                
                try {
                    await this.c.repo.addObservation(this.c.userId, this.c.caseId, {
                        antecedent: "Live Focus Mode",
                        behavior: behavior,
                        consequence: "To be recorded",
                        observationTime: new Date(),
                        duration: null,
                        perceivedFunction: null,
                        setting: "Live Session"
                    });
                } catch(e) {
                    console.error(e);
                    Utils.showNotification("Error saving log", "error");
                }
            }

            toggleTimer() {
                const btn = document.getElementById('live-timer-toggle');
                if (this.isRunning) {
                    // Pause
                    clearInterval(this.timerInterval);
                    this.elapsedPaused += Date.now() - this.startTime;
                    this.isRunning = false;
                    btn.textContent = "RESUME";
                    btn.classList.replace('bg-red-600', 'bg-green-600');
                    btn.classList.replace('hover:bg-red-500', 'hover:bg-green-500');
                    btn.classList.replace('border-red-800', 'border-green-800');
                } else {
                    // Start
                    this.startTime = Date.now();
                    this.timerInterval = setInterval(() => this.updateTimerDisplay(), 100);
                    this.isRunning = true;
                    btn.textContent = "PAUSE";
                    btn.classList.replace('bg-green-600', 'bg-red-600');
                    btn.classList.replace('hover:bg-green-500', 'hover:bg-red-500');
                    btn.classList.replace('border-green-800', 'border-red-800');
                }
            }

            resetTimer() {
                clearInterval(this.timerInterval);
                this.isRunning = false;
                this.elapsedPaused = 0;
                this.startTime = null;
                document.getElementById('live-timer-display').textContent = "00:00";
                const btn = document.getElementById('live-timer-toggle');
                btn.textContent = "START";
                btn.classList.replace('bg-red-600', 'bg-green-600');
                btn.classList.replace('hover:bg-red-500', 'hover:bg-green-500');
                btn.classList.replace('border-red-800', 'border-green-800');
            }

            updateTimerDisplay() {
                const total = this.elapsedPaused + (Date.now() - this.startTime);
                const seconds = Math.floor(total / 1000);
                const m = Math.floor(seconds / 60).toString().padStart(2, '0');
                const s = (seconds % 60).toString().padStart(2, '0');
                document.getElementById('live-timer-display').textContent = `${m}:${s}`;
            }
        }

        class DecisionManager {
            constructor(controller) { this.c = controller; }
            init() {
                const data = this.c.store.getState().currentCaseData;
                this.c.bind('#begin-assessment-btn', 'click', () => {
                    document.getElementById('step-5-initial').classList.add('hidden');
                    document.getElementById('assessment-questions-container').classList.remove('hidden');
                });
                this.c.bind('#get-recommendation-btn', 'click', () => this.getRec());
                this.c.bind('#open-impact-calc-btn', 'click', () => this.calculateImpact()); // Bind Impact Calc
                
                // NEW: Triangulation Binding
                this.c.bind('#run-triangulation-btn', 'click', () => this.runTriangulation());

                if (data.criticalDecision) {
                    this.renderResult(data.criticalDecision);
                    if(data.criticalDecision.userAnswers) {
                        document.getElementById('severity-text').value = data.criticalDecision.userAnswers.severity || '';
                        document.getElementById('persistence-text').value = data.criticalDecision.userAnswers.persistence || '';
                        document.getElementById('complexity-text').value = data.criticalDecision.userAnswers.complexity || '';
                    }
                }
                // Restore Impact Stats if saved
                if (data.impactStats) {
                    this.renderImpactResults(data.impactStats.yearlyHours, data.impactStats.instructionalDays, data.impactStats.avgFreq, data.impactStats.avgDur);
                }
                // NEW: Restore Triangulation if saved
                if (data.triangulation) {
                    this.renderTriangulation(data.triangulation);
                }
            }
            
            // NEW: Run Triangulation
            async runTriangulation() {
                Utils.setLoading('run-triangulation-btn', true);
                const data = this.c.store.getState().currentCaseData;
                
                // Gather sources
                const interview = Utils.stripHtml(data.interviewSummary || "No interview data yet.");
                const records = Utils.stripHtml(data.recordAnalysis || "No record data yet.");
                const observation = Utils.stripHtml(data.analysisHypothesis || "No observation analysis yet.");

                const prompt = `Perform FBA Data Triangulation. Compare these 3 sources for consistency regarding the function of behavior.
                1. Interview: ${interview.substring(0, 1000)}
                2. Records: ${records.substring(0, 1000)}
                3. Observation: ${observation.substring(0, 1000)}
                
                Return a JSON OBJECT with keys:
                - "interview_func": inferred function (e.g. Escape, Attention) or "Not Found"
                - "records_func": inferred function or "Not Found"
                - "obs_func": inferred function or "Not Found"
                - "alignment": "Strong", "Partial", or "Weak"
                - "notes": One sentence explaining the alignment or discrepancy.
                Do not use markdown.`;

                try {
                    const response = await Utils.getGeminiResponse([{role: 'user', parts: [{ text: prompt }]}]);
                    const jsonStr = response.replace(/```json/g, '').replace(/```/g, '').trim();
                    const res = JSON.parse(jsonStr);

                    this.renderTriangulation(res);
                    
                    // Save to case
                    await this.c.repo.updateCase(this.c.userId, this.c.caseId, { triangulation: res });
                    Utils.showNotification("Validity Check Complete");

                } catch (e) {
                    console.error(e);
                    Utils.showNotification("Triangulation failed", "error");
                } finally {
                    Utils.setLoading('run-triangulation-btn', false);
                }
            }

            // NEW: Render Triangulation Results
            renderTriangulation(res) {
                const container = document.getElementById('triangulation-container');
                if (!container) return;
                
                let badgeColor = res.alignment === 'Strong' ? 'bg-green-100 text-green-800 border-green-200' : (res.alignment === 'Partial' ? 'bg-yellow-100 text-yellow-800 border-yellow-200' : 'bg-red-100 text-red-800 border-red-200');

                container.innerHTML = `
                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
                        <div class="p-3 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                            <span class="text-xs font-bold text-gray-500 uppercase">Analysis Results</span>
                            <span class="px-2 py-1 rounded text-xs font-bold border ${badgeColor}">${res.alignment} Alignment</span>
                        </div>
                        <table class="min-w-full text-xs">
                            <tr class="border-b border-gray-100"><td class="p-3 font-bold text-gray-600 w-1/3 bg-gray-50/50">Interview</td><td class="p-3 text-gray-800 font-medium">${res.interview_func}</td></tr>
                            <tr class="border-b border-gray-100"><td class="p-3 font-bold text-gray-600 bg-gray-50/50">Records</td><td class="p-3 text-gray-800 font-medium">${res.records_func}</td></tr>
                            <tr class="border-b border-gray-100"><td class="p-3 font-bold text-gray-600 bg-gray-50/50">Direct Obs</td><td class="p-3 text-gray-800 font-medium">${res.obs_func}</td></tr>
                        </table>
                        <div class="p-3 text-xs text-gray-600 bg-gray-50 italic border-t border-gray-200">
                            <strong>Note:</strong> ${res.notes}
                        </div>
                    </div>
                `;
                container.classList.remove('hidden');
            }

            async getRec() {
                Utils.setLoading('get-recommendation-btn', true);
                const sev = document.getElementById('severity-text').value;
                const per = document.getElementById('persistence-text').value;
                const com = document.getElementById('complexity-text').value;
                document.getElementById('assessment-result-container').innerHTML = `<p class="text-center p-4">${I18nService.t('messages.consulting_ai')}</p>`;
                const prompt = `Clinical decision tool. Recommend 'Path A: Proceed to BIP' or 'Path B: Functional Analysis'. Respond in ${I18nService.currentLocale}. Format: RECOMMENDATION_TYPE::[A/B] SUMMARY::... RATIONALE::...`;
                const data = this.c.store.getState().currentCaseData;
                const context = `Data: ${Utils.stripHtml(data.interviewSummary)} ${Utils.stripHtml(data.analysisHypothesis)}. User Input: ${sev} ${per} ${com}`;
                const res = await Utils.getGeminiResponse([{role:'system', parts:[{text:prompt}]}, {role:'user', parts:[{text:context}]}]);
                const decision = { userAnswers: {severity:sev, persistence:per, complexity:com}, aiResponse: res };
                await this.c.repo.updateCase(this.c.userId, this.c.caseId, { criticalDecision: decision });
                this.renderResult(decision);
                Utils.setLoading('get-recommendation-btn', false);
            }
            renderResult(decision) {
                const type = decision.aiResponse.match(/RECOMMENDATION_TYPE::(A|B)/)?.[1];
                const summary = decision.aiResponse.match(/SUMMARY::([\s\S]*?)RATIONALE::/)?.[1] || "";
                const rationale = decision.aiResponse.match(/RATIONALE::([\s\S]*)/)?.[1] || "";
                let html = type === 'A' ? `<div class="p-4 bg-green-100"><h4>${I18nService.t('decision.proceed')}</h4><p>${summary}</p><p>${rationale}</p></div>` : `<div class="p-4 bg-yellow-100"><h4>${I18nService.t('decision.consider_fa')}</h4><p>${summary}</p><p>${rationale}</p><div class="mt-4"><input id="confirmed-function-input" class="border p-2 w-full" placeholder="Enter confirmed function"><button id="save-confirmed-function-btn" class="bg-blue-600 text-white p-2 mt-2 rounded">${I18nService.t('decision.saved')}</button></div></div>`;
                document.getElementById('assessment-result-container').innerHTML = html;
                document.getElementById('step-5-initial').classList.add('hidden');
                document.getElementById('assessment-questions-container').classList.add('hidden');
                if (type === 'B') {
                    const btn = document.getElementById('save-confirmed-function-btn');
                    if(btn) btn.addEventListener('click', async () => {
                        const func = document.getElementById('confirmed-function-input').value;
                        if(func) {
                            await this.c.repo.updateCase(this.c.userId, this.c.caseId, { confirmedFunction: func });
                            Utils.showNotification("messages.function_saved");
                            this.c.updateSteps();
                        }
                    });
                }
                this.c.updateSteps();
            }

            calculateImpact() {
                const obs = this.c.store.getState().observations || [];
                let avgFreq = 0;
                let avgDur = 0;

                // Simple heuristic: Frequency per week
                if (obs.length > 0) {
                    const dates = obs.map(o => Utils.safeDate(o.observationTime)).sort((a,b) => a-b);
                    const first = dates[0];
                    const last = dates[dates.length-1];
                    // Avoid division by zero if all on same day
                    const daysDiff = Math.max(1, (last - first) / (1000 * 60 * 60 * 24));
                    const weeks = Math.max(1, daysDiff / 7);
                    
                    avgFreq = Math.ceil(obs.length / weeks);
                    
                    // Calculate average duration (default to 10 mins if not tracked, common for significant incidents)
                    const durations = obs.filter(o => o.duration).map(o => parseInt(o.duration));
                    avgDur = durations.length > 0 
                        ? Math.round(durations.reduce((a,b)=>a+b,0) / durations.length) 
                        : 10; 
                } else {
                    // No data fallback
                    Utils.showNotification("No data to calculate. Using estimates.", "warning");
                    avgFreq = 5; 
                    avgDur = 10;
                }

                // Calculations
                const weeklyMins = avgFreq * avgDur;
                const yearlyHours = Math.round((weeklyMins * 36) / 60); // 36 school weeks
                const instructionalDays = (yearlyHours / 6).toFixed(1); // 6 hour school day

                this.renderImpactResults(yearlyHours, instructionalDays, avgFreq, avgDur);
                
                // Save to case
                this.c.repo.updateCase(this.c.userId, this.c.caseId, { 
                    impactStats: { yearlyHours, instructionalDays, avgFreq, avgDur } 
                });
                
                Utils.showNotification("Impact Analysis Updated");
            }

            renderImpactResults(yearlyHours, instructionalDays, avgFreq, avgDur) {
                const container = document.getElementById('impact-results-container');
                container.innerHTML = `
                    <div class="bg-red-50 p-4 rounded border border-red-200 shadow-sm">
                        <h5 class="font-bold text-red-800 text-sm uppercase mb-2 flex items-center">
                            <span class="text-lg mr-2">üìâ</span> Time Lost (Student)
                        </h5>
                        <div class="text-3xl font-bold text-red-600">${yearlyHours} Hours</div>
                        <p class="text-xs text-red-700 mt-1 font-medium">Approx. <span class="font-bold bg-red-100 px-1 rounded">${instructionalDays} school days</span> lost per year.</p>
                        <p class="text-[10px] text-gray-500 mt-2 italic">Based on ~${avgFreq} incidents/week @ ${avgDur} mins avg.</p>
                    </div>
                    <div class="bg-orange-50 p-4 rounded border border-orange-200 shadow-sm">
                        <h5 class="font-bold text-orange-800 text-sm uppercase mb-2 flex items-center">
                            <span class="text-lg mr-2">üë•</span> Staff Impact
                        </h5>
                        <div class="text-3xl font-bold text-orange-600">${Math.round(yearlyHours * 1.5)} Hours</div>
                        <p class="text-xs text-orange-700 mt-1 font-medium">Estimated administrative/management time.</p>
                        <p class="text-[10px] text-gray-500 mt-2 italic">Assuming 1.5x multiplier for reporting & resetting.</p>
                    </div>
                `;
                container.classList.remove('hidden');
            }
        }

        class BipManager {
            constructor(controller) { 
                this.c = controller; 
                this.history = { prevent:[], teach:[], respond:[] }; 
                this.customStrategies = []; // Store custom strategies in memory
            }
            init() {
                const data = this.c.store.getState().currentCaseData;
                this.c.bind('#bip-save-foundation-btn', 'click', () => this.saveFoundation());
                this.c.bind('#prevent-send-btn', 'click', () => this.chat('prevent'));
                this.c.bind('#teach-send-btn', 'click', () => this.chat('teach'));
                this.c.bind('#respond-send-btn', 'click', () => this.chat('respond'));
                this.c.bind('#generate-monitoring-plan-btn', 'click', () => this.genPlan());
                this.c.bind('#download-report-btn', 'click', () => this.downloadReport());
                this.c.bind('#preview-report-btn', 'click', () => this.previewReport());
                this.c.bind('#download-word-btn', 'click', () => this.exportToWord());
                this.c.bind('#download-pocket-btn', 'click', () => this.downloadPocketBIP()); // NEW BINDING
                this.c.bind('#download-traffic-btn', 'click', () => this.downloadTrafficLight()); // NEW BINDING FOR OPTION 1
                this.c.bind('#create-rollout-btn', 'click', () => this.createRolloutPlan()); // NEW BINDING
                this.c.bind('#start-sim-btn', 'click', () => this.startRoleplay()); // NEW BINDING FOR OPTION 3
                this.c.bind('#audit-bip-btn', 'click', () => this.runQualityAudit());
                this.c.bind('#generate-snapshot-btn', 'click', () => this.generateSnapshot()); // NEW BINDING FOR OPTION 2
                
                // NEW: Goal Achievement Scaling (GAS) Binding
                this.c.bind('#gas-btn', 'click', () => this.generateGASRubric());

                // NEW: Data Sheet Generator Bindings
                this.c.mainContent.querySelectorAll('.gen-sheet-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => this.generateDataSheet(e.currentTarget.dataset.type));
                });

                // NEW: Goal Bank Binding (Dynamic injection later, but binding helper here if needed)
                // We will handle click via inline injection in generateGoalBank to keep it self-contained or bind dynamically

                // NEW: Roleplay UI Bindings
                this.c.bind('#close-roleplay-btn', 'click', () => document.getElementById('roleplay-modal').classList.add('hidden'));
                this.c.bind('#roleplay-send-btn', 'click', () => this.handleRoleplayChat());
                this.c.bind('#roleplay-input', 'keypress', (e) => { if(e.key === 'Enter') this.handleRoleplayChat(); });
                this.c.bind('#roleplay-restart-btn', 'click', () => this.startRoleplay());
                this.c.bind('#roleplay-hint-btn', 'click', () => {
                    const d = this.c.store.getState().currentCaseData;
                    Utils.showNotification(`Hint: Try strategies from Prevent: ${Utils.stripHtml(d.bipPreventContent).substring(0,50)}...`);
                });

                // NEW: Feasibility Check Binding (Option 1)
                this.c.bind('#calc-feasibility-btn', 'click', () => this.calculateFeasibility());

                // NEW: Restorative Debrief Binding
                this.c.bind('#generate-debrief-btn', 'click', () => this.generateRestorativeScript());
                
                // NEW: Crisis Plan Binding
                this.c.bind('#save-crisis-btn', 'click', () => this.saveCrisisPlan());
                this.c.bind('#visualize-crisis-btn', 'click', () => this.generateCrisisFlowchart()); // NEW
                
                // NEW: Fidelity Checklist Binding (Option 2)
                this.c.bind('#generate-fidelity-btn', 'click', () => this.generateFidelityChecklist());
                
                // NEW: Bind Date Input (Option 1)
                this.c.bind('#bip-start-date', 'change', (e) => this.saveStartDate(e.target.value));

                // NEW: SMART Goal Builder Bindings
                this.c.mainContent.querySelectorAll('.goal-builder-input').forEach(input => {
                    input.addEventListener('input', () => this.updateGoalPreview());
                });
                // Pre-fill student name if available in wizard
                if(data.studentName) {
                    const sInput = document.getElementById('goal-student');
                    if(sInput) {
                        sInput.value = data.studentName;
                        this.updateGoalPreview();
                    }
                }

                // Strategy Bank Modals
                const closeSb = () => document.getElementById('strategy-bank-modal').classList.add('hidden');
                document.getElementById('close-sb-modal').addEventListener('click', closeSb);
                document.getElementById('close-sb-btn-bottom').addEventListener('click', closeSb);

                // Preview Modal
                const closePreview = () => document.getElementById('report-preview-modal').classList.add('hidden');
                document.getElementById('close-preview-btn').addEventListener('click', closePreview);
                document.getElementById('preview-close-bottom-btn').addEventListener('click', closePreview);
                document.getElementById('preview-download-btn').addEventListener('click', () => {
                    this.downloadReport();
                    closePreview();
                });

                // Bind Focus Buttons for Chat Containers
                this.c.mainContent.querySelectorAll('.focus-toggle-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const targetId = e.currentTarget.closest('button').dataset.target; // ensure we get data from button
                        this.toggleFocusMode(targetId);
                    });
                });
                
                // NEW: Bindings for Reinforcer Tool
                this.c.bind('#generate-rewards-btn', 'click', () => this.generateRewards());
                this.c.bind('#save-reinforcers-btn', 'click', () => this.saveReinforcers());

                if(data.analysisHypothesis) document.getElementById('bip-hypothesis').innerHTML = data.analysisHypothesis;
                if(data.bipOperationalDefinition) {
                    document.getElementById('bip-definition').value = data.bipOperationalDefinition;
                    this.enableBuilder(data);
                } else if (data.interviewSummary) {
                    const div = document.createElement('div'); div.innerHTML = data.interviewSummary;
                    const h4 = Array.from(div.querySelectorAll('h4')).find(h => h.textContent.includes('Suggested Operational Definition') || h.textContent.includes('Definici√≥n'));
                    if(h4 && h4.parentElement.nextElementSibling) document.getElementById('bip-definition').value = h4.parentElement.nextElementSibling.textContent.trim();
                }
                
                // Load existing reinforcers
                if(data.bipReinforcers) {
                    const el = document.getElementById('confirmed-reinforcers');
                    if(el) el.value = data.bipReinforcers;
                }

                // NEW: Load existing crisis plan
                if(data.bipCrisisPlan) {
                    const el = document.getElementById('bip-crisis-text');
                    if(el) el.value = data.bipCrisisPlan;
                }

                // NEW: Load existing BIP start date
                if(data.bipStartDate) {
                    const el = document.getElementById('bip-start-date');
                    if(el) el.value = data.bipStartDate;
                }

                // NEW: Load existing restorative script
                if(data.restorativeScript) {
                    const el = document.getElementById('debrief-output');
                    if(el) {
                        el.innerHTML = data.restorativeScript;
                        el.classList.remove('hidden');
                    }
                }

                // NEW: Load existing Feasibility Score
                if(data.feasibilityScore) {
                    this.renderFeasibilityResult(data.feasibilityScore);
                }
            }
            
            // NEW: Save Start Date Function (Option 1)
            async saveStartDate(dateVal) {
                await this.c.repo.updateCase(this.c.userId, this.c.caseId, { bipStartDate: dateVal });
                Utils.showNotification("Intervention start date saved");
                // Update local store to refresh charts immediately if needed
                const currentData = this.c.store.getState().currentCaseData;
                this.c.store.setState({ currentCaseData: { ...currentData, bipStartDate: dateVal } });
            }

            // NEW: SMART Goal Logic (Updated for Option 3: IEP Format)
            updateGoalPreview() {
                const c = document.getElementById('goal-condition').value.trim();
                const s = document.getElementById('goal-student').value.trim();
                const b = document.getElementById('goal-behavior').value.trim();
                const cr = document.getElementById('goal-criteria').value.trim();
                
                // New fields for IEP Option
                const base = document.getElementById('goal-baseline').value.trim();
                const method = document.getElementById('goal-method').value;
                
                let fullGoal = "Complete the fields above...";
                
                if (s || b) {
                    // Smart formatting with punctuation handling
                    const conditionPart = c ? (c.endsWith(',') ? c : c + ',') : '';
                    const criteriaPart = cr ? (cr.startsWith('with') || cr.startsWith('by') || cr.startsWith('in') ? cr : 'with ' + cr) : '';
                    
                    // IEP Format
                    fullGoal = `<strong>Baseline:</strong> ${base || '[Insert Baseline]'}
                    <br><br>
                    <strong>Goal:</strong> By [Date], ${conditionPart} ${s || '[Student]'} ${b || '[will do behavior]'} ${criteriaPart} as measured by ${method}.`;
                }
                
                document.getElementById('goal-preview').innerHTML = fullGoal;
                // Sync with hidden textarea used by existing save logic (use textContent to strip HTML tags for the hidden saver)
                document.getElementById('bip-goal-text').value = document.getElementById('goal-preview').textContent; 
            }

            toggleFocusMode(elementId) {
                const el = document.getElementById(elementId);
                if (!el) return;
                
                const isFocused = el.classList.contains('fixed');
                const btn = el.querySelector('.focus-toggle-btn') || el.querySelector('.focus-content-btn');
                
                if (isFocused) {
                    // Exit Focus
                    el.classList.remove('fixed', 'inset-0', 'z-50', 'bg-white', 'p-10', 'h-screen', 'w-screen', 'overflow-y-auto');
                    
                    // Specific logic for chat containers
                    if (el.classList.contains('bip-chat-container')) {
                         el.classList.add('rounded-lg', 'border', 'p-4', 'bg-gray-50');
                         el.querySelector('.chat-window').classList.add('h-96');
                         el.querySelector('.chat-window').classList.remove('flex-grow');
                    }
                    // Specific logic for content display areas
                    if (el.classList.contains('bip-content-display')) {
                        el.classList.add('rounded-lg', 'border', 'p-6');
                        const area = el.querySelector('[id$="-editable-area"]');
                        if(area) area.classList.remove('min-h-[80vh]');
                    }

                    document.body.style.overflow = 'auto';
                    
                    // Reset Icon
                    if(btn) {
                        btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>`;
                        if(el.classList.contains('bip-content-display')) {
                            // Restore text for content button
                            btn.innerHTML = `<svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg> Focus`;
                        }
                    }
                    
                } else {
                    // Enter Focus
                    el.classList.add('fixed', 'inset-0', 'z-50', 'bg-white', 'p-10', 'h-screen', 'w-screen', 'overflow-y-auto');
                    
                    if (el.classList.contains('bip-chat-container')) {
                         el.classList.remove('rounded-lg', 'border', 'p-4', 'bg-gray-50');
                         // Make chat window grow to fill screen
                         el.querySelector('.chat-window').classList.remove('h-96');
                         el.querySelector('.chat-window').classList.add('flex-grow');
                    }
                    
                    if (el.classList.contains('bip-content-display')) {
                        el.classList.remove('rounded-lg', 'border', 'p-6');
                        const area = el.querySelector('[id$="-editable-area"]');
                        if(area) area.classList.add('min-h-[80vh]');
                    }
                    
                    document.body.style.overflow = 'hidden';
                    
                    // Set Exit Icon
                    if(btn) {
                        btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`;
                        if(el.classList.contains('bip-content-display')) {
                             btn.innerHTML = `<svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg> Exit Focus`;
                        }
                    }
                }
            }

            async saveFoundation() {
                const def = document.getElementById('bip-definition').value;
                await this.c.repo.updateCase(this.c.userId, this.c.caseId, { bipOperationalDefinition: def });
                Utils.showNotification("messages.foundation_saved");
                this.enableBuilder(this.c.store.getState().currentCaseData);
            }
            enableBuilder(data) {
                document.getElementById('bip-definition').disabled = true;
                document.getElementById('bip-save-foundation-btn').disabled = true;
                document.getElementById('bip-save-foundation-btn').textContent = "Saved";
                document.getElementById('bip-conversational-builder').classList.remove('hidden');
                
                // Show Preference Assessment
                document.getElementById('preference-assessment-section').classList.remove('hidden');
                
                ['prevent', 'teach', 'respond'].forEach(cat => {
                    const content = data[`bip${Utils.capitalize(cat)}Content`];
                    document.getElementById(`bip-${cat}-section`).classList.remove('hidden');
                    if(content) {
                        document.getElementById(`${cat}-chat-container`).classList.add('hidden');
                        this.renderEditableContent(cat, content);
                    }
                });
                
                if (!data.bipPreventContent) this.startChat('prevent');
                else if (!data.bipTeachContent) this.startChat('teach');
                else if (!data.bipRespondContent) this.startChat('respond');
                else {
                    document.getElementById('bip-goal-section').classList.remove('hidden');
                    
                    // NEW: Inject Goal Bank Button if not present
                    const goalContainer = document.getElementById('bip-goal-inputs');
                    if(goalContainer && !document.getElementById('goal-bank-btn')) {
                        const btn = document.createElement('button');
                        btn.id = "goal-bank-btn";
                        btn.className = "mb-4 bg-indigo-100 hover:bg-indigo-200 text-indigo-800 font-bold py-2 px-4 rounded border border-indigo-300 flex items-center w-full justify-center sm:w-auto";
                        btn.innerHTML = `<span class="mr-2">üè¶</span> Open IEP Goal Bank`;
                        btn.onclick = () => this.generateGoalBank();
                        goalContainer.insertBefore(btn, goalContainer.firstChild);
                    }

                    document.getElementById('bip-audit-section').classList.remove('hidden'); // Show Audit Button
                    document.getElementById('fidelity-section').classList.remove('hidden'); // Show Fidelity Section (Option 2)
                    document.getElementById('feasibility-check-section').classList.remove('hidden'); // Show Feasibility Section (Option 1)
                    document.getElementById('datasheet-section').classList.remove('hidden'); // Show Data Sheet Gen
                    
                    // Generate Checklist automatically when strategies are complete
                    this.generateMaterialChecklist();

                    // Restore Crisis Flowchart if present
                    if(data.crisisFlowchartSVG) {
                        const el = document.getElementById('crisis-visual-container');
                        if (el) {
                            el.innerHTML = data.crisisFlowchartSVG;
                            el.classList.remove('hidden');
                        }
                    }

                    // Restore GAS Rubric if present
                    if(data.gasRubric) {
                        this.renderGASRubric(data.gasRubric);
                    }

                    if(data.bipMonitoringPlan) {
                        document.getElementById('bip-goal-inputs').classList.add('hidden');
                        const disp = document.getElementById('monitoring-plan-display');
                        disp.innerHTML = data.bipMonitoringPlan; disp.classList.remove('hidden');
                        document.getElementById('report-download-container').classList.remove('hidden');
                    }
                }
            }

            // NEW: Generate Data Sheets
            async generateDataSheet(type) {
                const data = this.c.store.getState().currentCaseData;
                const student = data.studentName || "Student";
                // Strip HTML to get plain text definition
                const definition = Utils.stripHtml(data.bipOperationalDefinition || "Target Behavior");
                const date = new Date().toLocaleDateString();

                let contentHtml = '';

                if (type === 'frequency') {
                    contentHtml = `
                        <h3 style="margin-bottom:5px; color:#333;">Frequency Count Sheet</h3>
                        <p style="font-size:12px; margin-bottom:20px; color:#555;"><strong>Instructions:</strong> Place a tally mark for every occurrence of the target behavior.</p>
                        <table style="width:100%; border-collapse:collapse; border:1px solid #000;">
                            <thead>
                                <tr style="background:#eee;">
                                    <th style="border:1px solid #000; padding:10px; width:20%;">Date/Time</th>
                                    <th style="border:1px solid #000; padding:10px;">Tally Marks</th>
                                    <th style="border:1px solid #000; padding:10px; width:15%;">Total</th>
                                    <th style="border:1px solid #000; padding:10px; width:20%;">Staff Initials</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Array(10).fill('').map(() => `
                                <tr style="height:50px;">
                                    <td style="border:1px solid #000;"></td>
                                    <td style="border:1px solid #000;"></td>
                                    <td style="border:1px solid #000;"></td>
                                    <td style="border:1px solid #000;"></td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    `;
                } else if (type === 'duration') {
                    contentHtml = `
                        <h3 style="margin-bottom:5px; color:#333;">Duration Log</h3>
                        <p style="font-size:12px; margin-bottom:20px; color:#555;"><strong>Instructions:</strong> Record the start and end time of each incident.</p>
                        <table style="width:100%; border-collapse:collapse; border:1px solid #000;">
                            <thead>
                                <tr style="background:#eee;">
                                    <th style="border:1px solid #000; padding:10px;">Date</th>
                                    <th style="border:1px solid #000; padding:10px;">Start Time</th>
                                    <th style="border:1px solid #000; padding:10px;">End Time</th>
                                    <th style="border:1px solid #000; padding:10px;">Total Minutes</th>
                                    <th style="border:1px solid #000; padding:10px;">Activity/Setting</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Array(10).fill('').map(() => `
                                <tr style="height:50px;">
                                    <td style="border:1px solid #000;"></td>
                                    <td style="border:1px solid #000;"></td>
                                    <td style="border:1px solid #000;"></td>
                                    <td style="border:1px solid #000;"></td>
                                    <td style="border:1px solid #000;"></td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    `;
                } else if (type === 'abc') {
                    contentHtml = `
                        <h3 style="margin-bottom:5px; color:#333;">ABC Checklist</h3>
                        <p style="font-size:12px; margin-bottom:20px; color:#555;"><strong>Instructions:</strong> Check relevant boxes for each incident.</p>
                        <table style="width:100%; border-collapse:collapse; border:1px solid #000; font-size:11px;">
                            <thead>
                                <tr style="background:#eee;">
                                    <th style="border:1px solid #000; padding:5px; width:15%;">Time</th>
                                    <th style="border:1px solid #000; padding:5px;">Antecedent</th>
                                    <th style="border:1px solid #000; padding:5px;">Behavior</th>
                                    <th style="border:1px solid #000; padding:5px;">Consequence</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Array(8).fill('').map(() => `
                                <tr style="height:80px;">
                                    <td style="border:1px solid #000; vertical-align:top; padding:5px;"></td>
                                    <td style="border:1px solid #000; vertical-align:top; padding:5px;">
                                        ‚ñ° Demand/Task<br>‚ñ° Transition<br>‚ñ° Peer Issue<br>‚ñ° Denied Item<br>‚ñ° Alone/Down Time
                                    </td>
                                    <td style="border:1px solid #000; vertical-align:top; padding:5px;">
                                        ‚ñ° <strong>${definition.substring(0, 30)}...</strong><br>‚ñ° Aggression<br>‚ñ° Refusal<br>‚ñ° Elopement<br>‚ñ° Disruption
                                    </td>
                                    <td style="border:1px solid #000; vertical-align:top; padding:5px;">
                                        ‚ñ° Ignored<br>‚ñ° Redirected<br>‚ñ° Break Given<br>‚ñ° Consequence<br>‚ñ° Item Returned
                                    </td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    `;
                }

                const element = document.createElement('div');
                element.innerHTML = `
                    <div style="font-family:Arial, sans-serif; padding:40px; color:#333;">
                        <div style="border-bottom:2px solid #333; margin-bottom:20px; padding-bottom:10px;">
                            <h1 style="margin:0; font-size:24px; font-weight:bold;">Data Collection Sheet</h1>
                            <div style="display:flex; justify-content:space-between; margin-top:10px;">
                                <span><strong>Student:</strong> ${student}</span>
                                <span><strong>Generated:</strong> ${date}</span>
                            </div>
                        </div>
                        <div style="background:#f9f9f9; border:1px solid #ddd; padding:15px; margin-bottom:30px; font-size:12px; border-radius:4px;">
                            <strong>Target Behavior Definition:</strong><br>${definition}
                        </div>
                        ${contentHtml}
                    </div>
                `;

                const opt = {
                    margin: 0.5,
                    filename: `${student.replace(/[^a-z0-9]/gi, '_')}_${type}_datasheet.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                };

                // Visual Feedback
                const btn = document.querySelector(`.gen-sheet-btn[data-type="${type}"]`);
                const originalText = btn.innerHTML;
                btn.innerHTML = `‚è≥ Gen...`;
                btn.disabled = true;

                try {
                    await html2pdf().set(opt).from(element).save();
                    Utils.showNotification("Data sheet downloaded!");
                } catch(e) {
                    console.error(e);
                    Utils.showNotification("Error generating PDF", "error");
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }

            // NEW: Generate GAS Rubric (Option 2)
            async generateGASRubric() {
                const btnId = 'gas-btn';
                Utils.setLoading(btnId, true);
                
                const data = this.c.store.getState().currentCaseData;
                const baseline = data.bipOperationalDefinition || "Current behavior levels";
                // Try to get the goal text from the builder input first, fallback to saved plan
                const goal = document.getElementById('bip-goal-text').value || data.bipMonitoringPlan || "Reduction of behavior";

                const prompt = `Create a Goal Achievement Scaling (GAS) rubric based on:
                Baseline (-2): ${baseline}
                Goal (0): ${goal}
                
                Return a JSON OBJECT with keys: minus2, minus1, zero, plus1, plus2. 
                Values should be specific, observable descriptions of behavior frequency/intensity/duration.
                -2 is baseline (worst/current).
                0 is the expected goal.
                +2 is exceeding expectations significantly (best possible outcome).
                Do not use markdown.`;

                try {
                    const response = await Utils.getGeminiResponse([{role: 'user', parts: [{ text: prompt }]}]);
                    const jsonStr = response.replace(/```json/g, '').replace(/```/g, '').trim();
                    const rubric = JSON.parse(jsonStr);

                    this.renderGASRubric(rubric);
                    
                    // Save
                    await this.c.repo.updateCase(this.c.userId, this.c.caseId, { gasRubric: rubric });
                    Utils.showNotification("Rubric Generated!");

                } catch (e) {
                    console.error(e);
                    Utils.showNotification("Failed to generate rubric", "error");
                } finally {
                    Utils.setLoading(btnId, false);
                }
            }

            renderGASRubric(rubric) {
                const container = document.getElementById('gas-container');
                if(!container || !rubric) return;

                const html = `
                    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                        <div class="bg-indigo-50 p-3 border-b border-indigo-100 flex justify-between items-center">
                            <h5 class="font-bold text-indigo-900 text-sm flex items-center">
                                <span class="text-xl mr-2">üìä</span> Goal Achievement Scaling (GAS)
                            </h5>
                            <span class="text-xs text-indigo-600 bg-white px-2 py-1 rounded border border-indigo-200">Progress Rubric</span>
                        </div>
                        <table class="min-w-full divide-y divide-gray-200 text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase tracking-wider w-1/4">Score</th>
                                    <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Description</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <tr class="bg-green-50"><td class="px-4 py-3 font-bold text-green-800">+2 (Exceeds)</td><td class="px-4 py-3 text-gray-700">${rubric.plus2}</td></tr>
                                <tr class="bg-green-50/50"><td class="px-4 py-3 font-bold text-green-700">+1 (Above)</td><td class="px-4 py-3 text-gray-700">${rubric.plus1}</td></tr>
                                <tr class="bg-white border-l-4 border-l-blue-500"><td class="px-4 py-3 font-bold text-blue-800">0 (Expected Goal)</td><td class="px-4 py-3 font-medium text-gray-900">${rubric.zero}</td></tr>
                                <tr class="bg-yellow-50/50"><td class="px-4 py-3 font-bold text-yellow-700">-1 (Progress)</td><td class="px-4 py-3 text-gray-700">${rubric.minus1}</td></tr>
                                <tr class="bg-red-50"><td class="px-4 py-3 font-bold text-red-700">-2 (Baseline)</td><td class="px-4 py-3 text-gray-700">${rubric.minus2}</td></tr>
                            </tbody>
                        </table>
                    </div>
                `;
                container.innerHTML = html;
                container.classList.remove('hidden');
            }

            // NEW: IEP Goal Bank Logic
            generateGoalBank() {
                const data = this.c.store.getState().currentCaseData;
                const student = data.studentName || "The student";
                // Extract plain text from HTML content
                const behavior = Utils.stripHtml(data.bipOperationalDefinition || "target behavior").substring(0, 60);
                const replacement = Utils.stripHtml(data.bipTeachContent || "replacement skill").substring(0, 60);

                const goals = [
                    {
                        type: "üìâ Reduction",
                        text: `By the next annual review, ${student} will decrease the frequency of ${behavior} from [Current Baseline] to less than [Goal] incidents per week across 3 consecutive weeks, as measured by data collection.`
                    },
                    {
                        type: "üîÑ Replacement",
                        text: `By the next annual review, when frustrated/triggered, ${student} will use ${replacement} instead of ${behavior} in 4 out of 5 opportunities as measured by teacher observation.`
                    },
                    {
                        type: "‚è±Ô∏è Duration",
                        text: `By the next annual review, ${student} will reduce the duration of ${behavior} episodes to less than 5 minutes per incident in 90% of occurrences.`
                    }
                ];

                // Remove existing bank if present
                const existing = document.getElementById('goal-bank-container');
                if(existing) existing.remove();

                let html = `<div id="goal-bank-container" class="mb-6 bg-white border border-indigo-200 rounded-lg p-4 shadow-md animate-fade-in-down">
                    <div class="flex justify-between mb-3"><h4 class="font-bold text-indigo-900 flex items-center"><span class="text-xl mr-2">üè¶</span> Smart Goal Bank</h4><button class="text-gray-400 hover:text-gray-600" onclick="this.parentElement.parentElement.remove()">‚úï</button></div>
                    <p class="text-xs text-gray-500 mb-3">Click a goal to copy it to the clipboard.</p>`;
                
                goals.forEach(g => {
                    html += `
                        <div class="mb-2 p-3 bg-gray-50 rounded border border-gray-200 hover:bg-indigo-50 hover:border-indigo-300 cursor-pointer transition-colors group" onclick="navigator.clipboard.writeText(this.querySelector('p').innerText).then(() => Utils.showNotification('Goal copied!'));">
                            <span class="text-xs font-bold text-indigo-600 uppercase tracking-wider">${g.type}</span>
                            <p class="text-sm text-gray-800 mt-1 font-medium group-hover:text-indigo-900">${g.text}</p>
                        </div>`;
                });
                html += `</div>`;
                
                const container = document.getElementById('bip-goal-inputs');
                // Insert after the bank button
                const btn = document.getElementById('goal-bank-btn');
                if(btn) btn.insertAdjacentHTML('afterend', html);
                else container.insertAdjacentHTML('afterbegin', html);
            }
            
            // NEW: Feasibility Check Logic (Option 1)
            calculateFeasibility() {
                const scores = Array.from(document.querySelectorAll('.feasibility-score')).map(s => parseInt(s.value));
                const total = scores.reduce((a,b) => a+b, 0); // Max 15, Min 5
                
                this.renderFeasibilityResult(total);
                
                // Auto-save this score to the case
                this.c.repo.updateCase(this.c.userId, this.c.caseId, { feasibilityScore: total });
                Utils.showNotification(`Fit Score Saved: ${total}/15`);
            }

            renderFeasibilityResult(total) {
                const resultEl = document.getElementById('feasibility-result');
                if(!resultEl) return;

                let msg = "";
                let color = "";
                
                if (total >= 13) {
                    msg = "‚úÖ High Probability of Success: The context supports this plan.";
                    color = "bg-green-100 text-green-800 border-green-200";
                } else if (total >= 10) {
                    msg = "‚ö†Ô∏è Moderate Risk: Consider simplifying strategies or increasing support.";
                    color = "bg-yellow-100 text-yellow-800 border-yellow-200";
                } else {
                    msg = "üõë Low Probability of Success: The environment is not ready. Simplify the plan drastically.";
                    color = "bg-red-100 text-red-800 border-red-200";
                }
                
                resultEl.textContent = `Score: ${total}/15. ${msg}`;
                resultEl.className = `p-3 rounded border text-sm mt-2 font-medium ${color}`;
                resultEl.classList.remove('hidden');
            }

            generateMaterialChecklist() {
                const data = this.c.store.getState().currentCaseData;
                const p = data.bipPreventContent || '';
                const t = data.bipTeachContent || '';
                const r = data.bipRespondContent || '';
                const combinedText = (p + t + r).toLowerCase();
                
                const potentialMaterials = [
                    { key: 'schedule', label: 'Visual Schedule' },
                    { key: 'timer', label: 'Timer / Stopwatch' },
                    { key: 'token', label: 'Token Board & Tokens' },
                    { key: 'point', label: 'Points Sheet' },
                    { key: 'break', label: 'Break Cards' },
                    { key: 'story', label: 'Social Stories' },
                    { key: 'social', label: 'Social Skills Curriculum' },
                    { key: 'reinforce', label: 'Reinforcer Items' },
                    { key: 'reward', label: 'Reward Items' },
                    { key: 'choice', label: 'Choice Board' },
                    { key: 'visual', label: 'Visual Supports/Cues' },
                    { key: 'data', label: 'Data Collection Sheets' }
                ];

                const foundItems = potentialMaterials.filter(m => combinedText.includes(m.key));
                
                // Ensure Data Sheets are always included as a baseline
                if(!foundItems.find(i => i.key === 'data')) foundItems.push({ key: 'data', label: 'Data Collection Sheets' });

                // Remove existing checklist if present to avoid duplicates
                const existing = document.getElementById('bip-checklist-container');
                if(existing) existing.remove();

                // Unique items by label
                const uniqueItems = [...new Map(foundItems.map(item => [item.label, item])).values()];

                // Render
                let html = `<div id="bip-checklist-container" class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 mt-6 no-print">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-bold text-yellow-800">‚úÖ Implementation Prep List</h4>
                        <span class="text-xs text-yellow-600 bg-yellow-100 px-2 py-1 rounded border border-yellow-200">Auto-Generated</span>
                    </div>
                    <p class="text-xs text-yellow-700 mb-3">Based on your selected strategies, please prepare the following materials:</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">`;
                    
                uniqueItems.forEach(item => {
                    html += `<label class="flex items-center space-x-2 bg-white p-2 rounded border border-yellow-100 shadow-sm cursor-pointer hover:bg-yellow-50 transition-colors">
                                <input type="checkbox" class="form-checkbox h-4 w-4 text-yellow-600 rounded focus:ring-yellow-500">
                                <span class="text-sm text-gray-700 font-medium">${item.label}</span>
                             </label>`;
                });
                
                html += `</div></div>`;
                
                // Inject into DOM before the Audit section
                const target = document.getElementById('bip-audit-section');
                if(target) target.insertAdjacentHTML('beforebegin', html);
            }

            async generateSocialStory() {
                const btnId = 'gen-story-btn';
                Utils.setLoading(btnId, true);
                
                const data = this.c.store.getState().currentCaseData;
                if (!data.studentName) {
                    Utils.showNotification("Student name required", "error");
                    Utils.setLoading(btnId, false);
                    return;
                }

                // Step 1: Generate the Story Structure (Text + Image Prompts)
                const systemPrompt = `You are an expert in creating Social Stories for special education. 
                Create a 4-step social story for a student named ${data.studentName}.
                Target Behavior: ${data.bipOperationalDefinition || 'getting upset'}.
                Replacement: ${data.bipTeachContent || 'asking for help'}.
                
                Return a JSON ARRAY only. No markdown. Format:
                [
                  { "text": "Sentence 1 (Descriptive)", "visual": "Simple description of visual for sentence 1" },
                  { "text": "Sentence 2 (Perspective)", "visual": "Simple description of visual for sentence 2" },
                  { "text": "Sentence 3 (Directive)", "visual": "Simple description of visual for sentence 3" },
                  { "text": "Sentence 4 (Affirmative)", "visual": "Simple description of visual for sentence 4" }
                ]`;

                try {
                    Utils.showNotification("Drafting story...");
                    const textResponse = await Utils.getGeminiResponse([{role: 'user', parts: [{ text: systemPrompt }]}]);
                    
                    // Parse JSON safely
                    const cleanJson = textResponse.replace(/```json/g, '').replace(/```/g, '').trim();
                    const storyScenes = JSON.parse(cleanJson);

                    // Step 2: Generate Images for each scene
                    let storyHtml = `<div class="social-story-container space-y-4 p-4 bg-gray-50 rounded border border-gray-200">
                        <h4 class="font-bold text-center text-indigo-900">My Social Story</h4>`;

                    for (const scene of storyScenes) {
                        Utils.showNotification(`Illustrating: "${scene.text.substring(0, 15)}..."`);
                        
                        // Generate Image
                        const imageUrl = await Utils.generateImage(scene.visual);
                        
                        // Build Card HTML
                        const imgHtml = imageUrl 
                            ? `<img src="${imageUrl}" class="w-full h-32 object-cover rounded mb-2 border border-gray-200" alt="${scene.visual}">`
                            : `<div class="w-full h-32 bg-gray-200 flex items-center justify-center text-gray-400 text-xs italic mb-2">[Image Failed]</div>`;

                        storyHtml += `
                            <div class="bg-white p-3 rounded shadow-sm border border-gray-100">
                                ${imgHtml}
                                <p class="text-sm text-gray-800 font-medium text-center">${scene.text}</p>
                            </div>`;
                    }

                    storyHtml += `</div>`;

                    // Step 3: Insert into Editor
                    const area = document.getElementById('teach-editable-area');
                    if (area.innerText.trim() === 'N/A' || area.innerText.trim() === '') {
                         area.innerHTML = storyHtml;
                    } else {
                         area.innerHTML += `<br>${storyHtml}`;
                    }
                    
                    // Auto-save
                    await this.c.repo.updateCase(this.c.userId, this.c.caseId, { bipTeachContent: area.innerHTML });
                    Utils.showNotification("Social Story with Images Created!");

                } catch (e) {
                    console.error(e);
                    Utils.showNotification("Failed to generate story/images", "error");
                } finally {
                    Utils.setLoading(btnId, false);
                }
            }

            // NEW: Generate Priming Script Logic (Option 3)
            async generatePrimingScript() {
                Utils.setLoading('gen-script-btn', true);
                const data = this.c.store.getState().currentCaseData;
                const obs = this.c.store.getState().observations || [];
                
                // Find most common antecedent
                const counts = {}; 
                obs.forEach(o => { if(o.antecedent) counts[o.antecedent] = (counts[o.antecedent]||0)+1; });
                const topAnt = Object.keys(counts).sort((a,b)=>counts[b]-counts[a])[0] || "transitions or demands";

                const prompt = `Generate a brief "Priming / Pre-correction" script for a teacher to say to a student named ${data.studentName}.
                The common trigger is: "${topAnt}".
                The script should be supportive, clear, and remind the student of the expected behavior/reward.
                Format: HTML block <div class="bg-blue-50 p-3 border-l-4 border-blue-500 text-blue-900 italic my-2">"..."</div>`;

                try {
                    const response = await Utils.getGeminiResponse([{role: 'user', parts: [{ text: prompt }]}]);
                    const area = document.getElementById('prevent-editable-area');
                    area.innerHTML += `<br>${response}`;
                    await this.c.repo.updateCase(this.c.userId, this.c.caseId, { bipPreventContent: area.innerHTML });
                    Utils.showNotification("Priming Script generated!");
                } catch(e) {
                    console.error(e);
                    Utils.showNotification("Failed to generate script", "error");
                }
                Utils.setLoading('gen-script-btn', false);
            }

            // NEW: FBA-to-BIP Bridge Wizard (Option 2)
            async launchBridgeWizard() {
                const btnId = 'bridge-btn';
                Utils.setLoading(btnId, true);
                
                // 1. Get Top Trigger from Real Data
                const obs = this.c.store.getState().observations || [];
                const counts = {};
                obs.forEach(o => { if(o.antecedent) counts[o.antecedent] = (counts[o.antecedent]||0)+1; });
                const topAnt = Object.keys(counts).sort((a,b) => counts[b]-counts[a])[0];

                if (!topAnt) {
                    Utils.showNotification("No data found to bridge.", "error");
                    Utils.setLoading(btnId, false);
                    return;
                }

                // 2. AI Request
                const prompt = `The FBA data shows the most frequent trigger is: "${topAnt}". 
                Suggest 3 specific "Prevent/Antecedent" strategies to neutralize this specific trigger. 
                Format as HTML bullet points <ul><li><b>Strategy Name:</b> Description</li></ul>.`;

                try {
                    const response = await Utils.getGeminiResponse([{ role: 'user', parts: [{ text: prompt }] }]);
                    const area = document.getElementById('prevent-editable-area');
                    const html = `<div class="mb-3 bg-blue-50 p-3 rounded border-l-4 border-blue-500">
                        <strong class="text-blue-900 text-sm block mb-1">üåâ Data Bridge (Trigger: ${topAnt})</strong>
                        <div class="text-sm text-blue-800">${response}</div>
                    </div>`;
                    
                    if (area.innerHTML.trim() === "N/A" || area.innerHTML.trim() === "") {
                        area.innerHTML = html;
                    } else {
                        area.innerHTML += html;
                    }
                    
                    await this.c.repo.updateCase(this.c.userId, this.c.caseId, { bipPreventContent: area.innerHTML });
                    Utils.showNotification("Strategies linked to data!");
                } catch (e) {
                    console.error(e);
                    Utils.showNotification("Bridge failed", "error");
                }
                Utils.setLoading(btnId, false);
            }

            // NEW: Strategy Troubleshooter (Option 2)
            async troubleshootStrategy(cat) {
                const btnId = `troubleshoot-${cat}-btn`;
                Utils.setLoading(btnId, true);
                
                const area = document.getElementById(`${cat}-editable-area`);
                // Use textContent to get raw text for analysis, ignoring HTML tags
                const currentStrat = area.innerText.trim();
                
                if (!currentStrat || currentStrat.length < 5) {
                    Utils.showNotification("Please add a strategy first.", "error");
                    Utils.setLoading(btnId, false);
                    return;
                }

                // Get recent observations (last 5)
                const allObs = this.c.store.getState().observations || [];
                // Sort chronological descending (newest first)
                const sortedObs = [...allObs].sort((a,b) => Utils.safeDate(b.observationTime) - Utils.safeDate(a.observationTime)).slice(0, 5);
                
                if (sortedObs.length === 0) {
                    Utils.showNotification("No recent data available to analyze.", "error");
                    Utils.setLoading(btnId, false);
                    return;
                }

                const obsText = sortedObs.map(o => `[${Utils.formatDate(Utils.safeDate(o.observationTime))}] Trigger: ${o.antecedent}, Behavior: ${o.behavior}, Outcome: ${o.consequence}`).join(' | ');

                const prompt = `Act as a senior Board Certified Behavior Analyst (BCBA). 
                I am using this ${cat} strategy: "${currentStrat}". 
                
                However, here is the recent student behavior data (last 5 incidents): 
                "${obsText}". 
                
                Diagnose why this strategy might be failing or mismatched to the function shown in the data. 
                Is the reinforcement too weak? Is the function actually different?
                
                Provide 1 specific, actionable "Try This Instead" suggestion.
                Format: HTML. Use <div class="text-sm"> and <b> for emphasis. Keep it concise.`;

                try {
                    const advice = await Utils.getGeminiResponse([{role: 'user', parts: [{ text: prompt }]}]);
                    const container = document.getElementById(`${cat}-tools-area`);
                    
                    container.innerHTML = `
                        <div class="bg-red-50 border-l-4 border-red-500 p-4 mt-2 rounded shadow-sm animate-fade-in-down relative">
                            <button class="absolute top-2 right-2 text-red-400 hover:text-red-600 font-bold" onclick="this.parentElement.remove()">√ó</button>
                            <h5 class="font-bold text-red-800 text-sm flex items-center mb-2">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                üîß AI Troubleshooter Analysis
                            </h5>
                            <div class="text-sm text-red-900 leading-relaxed">${advice}</div>
                        </div>
                    `;
                    Utils.showNotification("Analysis complete");
                } catch (e) {
                    console.error(e);
                    Utils.showNotification("Analysis failed", "error");
                } finally {
                    Utils.setLoading(btnId, false);
                }
            }

            renderEditableContent(cat, content) {
                const container = document.getElementById(`${cat}-content-display`);
                
                // Add AI Story button specifically for Teach section
                const storyBtn = cat === 'teach' ? 
                    `<button id="gen-story-btn" class="text-xs bg-yellow-50 hover:bg-yellow-100 text-yellow-700 px-2 py-1 rounded border border-yellow-200 flex items-center shadow-sm">
                        <span class="mr-1">üìñ</span> AI Story
                    </button>` : '';

                // NEW: Add Shaping button for Teach section (Option 1)
                const shapingBtn = cat === 'teach' ?
                    `<button id="shaping-btn" class="text-xs bg-orange-50 hover:bg-orange-100 text-orange-700 px-2 py-1 rounded border border-orange-200 flex items-center shadow-sm">
                        <span class="mr-1">ü™ú</span> Shaping Tool
                    </button>` : '';

                // NEW: Add Response Effort button for Teach section
                const effortBtn = cat === 'teach' ?
                    `<button id="effort-btn" class="text-xs bg-pink-50 hover:bg-pink-100 text-pink-700 px-2 py-1 rounded border border-pink-200 flex items-center shadow-sm">
                        <span class="mr-1">‚öñÔ∏è</span> Effort Check
                    </button>` : '';

                // NEW: Add Script button for Prevent section
                const scriptBtn = cat === 'prevent' ? 
                    `<button id="gen-script-btn" class="text-xs bg-indigo-50 hover:bg-indigo-100 text-indigo-700 px-2 py-1 rounded border border-indigo-200 flex items-center shadow-sm">
                        <span class="mr-1">üí¨</span> Gen Script
                    </button>` : '';

                // NEW: Add Bridge button for Prevent section (Option 2)
                const bridgeBtn = cat === 'prevent' ? 
                    `<button id="bridge-btn" class="text-xs bg-blue-50 hover:bg-blue-100 text-blue-700 px-2 py-1 rounded border border-blue-200 flex items-center shadow-sm">
                        <span class="mr-1">üåâ</span> Data Bridge
                    </button>` : '';

                // NEW: Add High-P button for Prevent section (Option 3)
                const highpBtn = cat === 'prevent' ? 
                    `<button id="highp-btn" class="text-xs bg-purple-50 hover:bg-purple-100 text-purple-700 px-2 py-1 rounded border border-purple-200 flex items-center shadow-sm">
                        <span class="mr-1">üöÄ</span> High-P Tool
                    </button>` : '';

                // NEW: Add Thinning button for Respond section (Option 1)
                const thinningBtn = cat === 'respond' ? 
                    `<button id="thinning-btn" class="text-xs bg-yellow-50 hover:bg-yellow-100 text-yellow-700 px-2 py-1 rounded border border-yellow-200 flex items-center shadow-sm">
                        <span class="mr-1">üìâ</span> Thinning Tool
                    </button>` : '';

                container.innerHTML = `
                    <div class="flex justify-end mb-2 no-print space-x-2 flex-wrap gap-y-2">
                        ${storyBtn}
                        ${shapingBtn}
                        ${effortBtn}
                        ${scriptBtn}
                        ${bridgeBtn}
                        ${highpBtn}
                        ${thinningBtn}
                        <button class="troubleshoot-btn text-xs bg-red-50 hover:bg-red-100 text-red-600 px-2 py-1 rounded border border-red-200 flex items-center shadow-sm" data-cat="${cat}" id="troubleshoot-${cat}-btn">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            Debug
                        </button>
                        <button class="tts-btn text-xs bg-indigo-50 hover:bg-indigo-100 text-indigo-600 px-2 py-1 rounded border border-indigo-200 flex items-center" data-target="${cat}-editable-area">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                            Listen
                        </button>
                        <button class="strategy-bank-btn text-xs bg-green-50 hover:bg-green-100 text-green-600 px-2 py-1 rounded border border-green-200 flex items-center" data-cat="${cat}">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                            Bank
                        </button>
                        <button class="focus-content-btn text-xs bg-purple-50 hover:bg-purple-100 text-purple-600 px-2 py-1 rounded border border-purple-200 flex items-center" data-target="${cat}-content-display">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>
                            Focus
                        </button>
                        <button class="copy-btn text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 px-2 py-1 rounded border border-gray-300 flex items-center" data-target="${cat}-editable-area">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                            Copy
                        </button>
                        <button class="edit-bip-btn text-xs bg-blue-50 hover:bg-blue-100 text-blue-600 px-2 py-1 rounded border border-blue-200 flex items-center" data-cat="${cat}">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                            ${I18nService.t('bip.edit_content')}
                        </button>
                    </div>
                    <div id="${cat}-editable-area" class="p-2 rounded transition-colors border border-transparent outline-none">${content}</div>
                    <div id="${cat}-tools-area" class="mt-2"></div>
                `;
                container.classList.remove('hidden');
                
                // Bind new TTS button
                container.querySelector('.tts-btn').addEventListener('click', (e) => {
                    const targetId = e.currentTarget.dataset.target;
                    const text = document.getElementById(targetId).innerText;
                    
                    window.speechSynthesis.cancel();
                    
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = I18nService.currentLocale === 'es' ? 'es-ES' : 'en-US';
                    
                    window.speechSynthesis.speak(utterance);
                    Utils.showNotification("Playing audio...");
                });

                // Bind new Troubleshooter button
                container.querySelector('.troubleshoot-btn').addEventListener('click', (e) => this.troubleshootStrategy(cat));

                // Bind new AI Story button if present
                if (cat === 'teach') {
                    const btn = container.querySelector('#gen-story-btn');
                    if(btn) btn.addEventListener('click', () => this.generateSocialStory());
                    
                    // NEW: Bind Shaping Tool Button (Option 1)
                    const shpBtn = container.querySelector('#shaping-btn');
                    if(shpBtn) shpBtn.addEventListener('click', () => this.toggleShapingTool());

                    // NEW: Bind Response Effort Tool Button
                    const effBtn = container.querySelector('#effort-btn');
                    if(effBtn) effBtn.addEventListener('click', () => this.toggleResponseEffortTool());
                }

                // NEW: Bind Gen Script button if present
                if (cat === 'prevent') {
                    const btn = container.querySelector('#gen-script-btn');
                    if(btn) btn.addEventListener('click', () => this.generatePrimingScript());
                    
                    // NEW: Bind Bridge button (Option 2)
                    const bBtn = container.querySelector('#bridge-btn');
                    if(bBtn) bBtn.addEventListener('click', () => this.launchBridgeWizard());

                    // NEW: Bind High-P button (Option 3)
                    const hpBtn = container.querySelector('#highp-btn');
                    if(hpBtn) hpBtn.addEventListener('click', () => this.toggleHighPTool());
                }

                // NEW: Bind Thinning button (Option 1)
                if (cat === 'respond') {
                    const tBtn = container.querySelector('#thinning-btn');
                    if(tBtn) tBtn.addEventListener('click', () => this.toggleThinningTool());
                }

                container.querySelector('.edit-bip-btn').addEventListener('click', (e) => this.toggleEdit(cat, e.currentTarget));
                container.querySelector('.focus-content-btn').addEventListener('click', (e) => this.toggleFocusMode(e.currentTarget.dataset.target));
                container.querySelector('.strategy-bank-btn').addEventListener('click', (e) => this.openStrategyBank(cat));
                container.querySelector('.copy-btn').addEventListener('click', (e) => {
                    const text = document.getElementById(e.currentTarget.dataset.target).innerText;
                    navigator.clipboard.writeText(text).then(() => Utils.showNotification("Copied to clipboard!"));
                });
            }

            // NEW: Response Effort Calculator (Matching Law)
            toggleResponseEffortTool() {
                const container = document.getElementById('teach-tools-area');
                if (!container) return;
                
                // Toggle if already open
                if (container.innerHTML.trim() !== '') {
                    container.innerHTML = '';
                    return;
                }

                container.innerHTML = `
                    <div class="mt-4 bg-orange-50 p-4 rounded border border-orange-200 shadow-inner animate-fade-in-down">
                        <div class="flex justify-between items-center mb-2">
                            <h5 class="font-bold text-orange-900 text-sm">‚öñÔ∏è Response Effort Calculator (Matching Law)</h5>
                            <button class="text-gray-400 hover:text-gray-600 text-xs font-bold" onclick="document.getElementById('teach-tools-area').innerHTML=''">‚úñ</button>
                        </div>
                        <p class="text-xs text-orange-800 mb-3">Ensure the replacement behavior is "cheaper" (less effort) and "richer" (better payoff) than the problem behavior.</p>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <!-- Problem Behavior Column -->
                            <div class="bg-white p-3 rounded border border-red-200">
                                <h6 class="text-xs font-bold text-red-700 uppercase mb-2">Problem Behavior</h6>
                                <div class="mb-2">
                                    <label class="block text-[10px] font-bold text-gray-500">Effort (Physical/Cognitive)</label>
                                    <input type="range" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer effort-slider" min="1" max="10" value="3" id="prob-effort">
                                    <div class="flex justify-between text-[9px] text-gray-400"><span>Low (1)</span><span>High (10)</span></div>
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-500">Payoff (Reinforcement)</label>
                                    <input type="range" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer effort-slider" min="1" max="10" value="9" id="prob-payoff">
                                    <div class="flex justify-between text-[9px] text-gray-400"><span>Weak (1)</span><span>Strong (10)</span></div>
                                </div>
                            </div>

                            <!-- Replacement Behavior Column -->
                            <div class="bg-white p-3 rounded border border-green-200">
                                <h6 class="text-xs font-bold text-green-700 uppercase mb-2">Replacement Behavior</h6>
                                <div class="mb-2">
                                    <label class="block text-[10px] font-bold text-gray-500">Effort (Physical/Cognitive)</label>
                                    <input type="range" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer effort-slider" min="1" max="10" value="8" id="repl-effort">
                                    <div class="flex justify-between text-[9px] text-gray-400"><span>Low (1)</span><span>High (10)</span></div>
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-500">Payoff (Reinforcement)</label>
                                    <input type="range" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer effort-slider" min="1" max="10" value="5" id="repl-payoff">
                                    <div class="flex justify-between text-[9px] text-gray-400"><span>Weak (1)</span><span>Strong (10)</span></div>
                                </div>
                            </div>
                        </div>

                        <!-- Results -->
                        <div id="effort-result" class="p-3 rounded border text-sm font-medium text-center transition-colors bg-gray-100 border-gray-200 text-gray-600">
                            Adjust sliders to calculate viability...
                        </div>
                    </div>
                `;

                // Bind logic
                setTimeout(() => {
                    const sliders = container.querySelectorAll('.effort-slider');
                    sliders.forEach(s => s.addEventListener('input', () => this.calculateMatchingLaw()));
                    this.calculateMatchingLaw(); // Initial calc
                }, 0);
            }

            calculateMatchingLaw() {
                const probEffort = parseInt(document.getElementById('prob-effort').value);
                const probPayoff = parseInt(document.getElementById('prob-payoff').value);
                const replEffort = parseInt(document.getElementById('repl-effort').value);
                const replPayoff = parseInt(document.getElementById('repl-payoff').value);

                // Matching Law simplified ratio: Return/Cost
                const probScore = probPayoff / probEffort;
                const replScore = replPayoff / replEffort;

                const resultEl = document.getElementById('effort-result');
                
                if (replScore > probScore) {
                    resultEl.className = "p-3 rounded border text-sm font-medium text-center transition-colors bg-green-100 border-green-300 text-green-800";
                    resultEl.innerHTML = `‚úÖ <strong>Viable Plan!</strong> The Replacement Behavior is the "better deal" for the student.`;
                } else {
                    resultEl.className = "p-3 rounded border text-sm font-medium text-center transition-colors bg-red-100 border-red-300 text-red-800";
                    resultEl.innerHTML = `üõë <strong>Not Viable.</strong> The Problem Behavior is still more attractive.<br><span class="text-xs">Try reducing replacement effort or increasing its payoff.</span>`;
                }
            }

            openStrategyBank(cat) {
                const defaults = STRATEGY_BANK[cat] || [];
                // Filter custom strategies for this category
                const customs = this.customStrategies.filter(s => s.category === cat);
                
                // NEW: Function Matching Logic
                const data = this.c.store.getState().currentCaseData;
                let likelyFunction = data.confirmedFunction || "";

                // If no confirmed function, deduce from observations (frequency)
                if (!likelyFunction) {
                    const obs = this.c.store.getState().observations || [];
                    const counts = {};
                    obs.forEach(o => {
                        if(o.perceivedFunction) {
                            // Normalize slightly to match bank tags
                            let key = o.perceivedFunction;
                            if(key.includes('Tangible')) key = 'Tangible';
                            if(key.includes('Sensory')) key = 'Sensory';
                            counts[key] = (counts[key] || 0) + 1;
                        }
                    });
                    // Get top function
                    const top = Object.entries(counts).sort((a,b) => b[1] - a[1])[0];
                    if (top) likelyFunction = top[0];
                }

                // Merge and Sort strategies (Recommended first)
                const allStrategies = [...defaults, ...customs].map(s => {
                    // Check match
                    const isMatch = s.functions && s.functions.some(f => likelyFunction.includes(f));
                    return { ...s, isMatch };
                }).sort((a,b) => {
                    if (b.isMatch === a.isMatch) return 0;
                    return b.isMatch ? 1 : -1;
                });
                
                const list = document.getElementById('sb-list');
                document.getElementById('sb-modal-category').textContent = cat;
                
                // 1. Generate List Items HTML
                const itemsHtml = allStrategies.map(s => {
                    const matchBadge = s.isMatch ? `<span class="bg-indigo-100 text-indigo-700 text-[10px] px-2 py-0.5 rounded border border-indigo-200 font-bold ml-2">‚ú® Recommended</span>` : '';
                    
                    return `
                    <div class="border p-3 rounded hover:bg-gray-50 flex flex-col sm:flex-row justify-between items-start sm:items-center group mb-2 bg-white ${s.isMatch ? 'border-indigo-200 ring-1 ring-indigo-100' : ''}">
                        <div class="mr-2 mb-2 sm:mb-0">
                            <div class="font-bold text-sm text-gray-800 flex items-center">
                                ${s.title} 
                                ${matchBadge}
                                ${s.isCustom ? '<span class="text-[10px] bg-blue-100 text-blue-800 px-1.5 py-0.5 rounded ml-2 font-normal border border-blue-200">Custom</span>' : ''}
                            </div>
                            <div class="text-xs text-gray-600">${s.desc}</div>
                        </div>
                        <button class="bg-green-100 text-green-700 hover:bg-green-200 px-3 py-1 rounded text-xs font-bold insert-strategy-btn whitespace-nowrap shadow-sm border border-green-200 transition-colors" data-title="${s.title}" data-desc="${s.desc}">
                            + Insert
                        </button>
                    </div>
                `}).join('');

                // 2. Generate Controls HTML (Import/Export)
                const controlsHtml = `
                    <div class="flex justify-between items-center mb-4 bg-gray-50 p-2 rounded border border-gray-200">
                        <span class="text-xs text-gray-500 font-medium flex items-center">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                            My Library
                        </span>
                        <div class="flex space-x-2">
                            <input type="file" id="import-strat-input" class="hidden" accept=".json">
                            <button id="import-strat-btn" class="text-xs bg-white text-gray-700 border border-gray-300 px-2 py-1 rounded shadow-sm hover:bg-gray-100 flex items-center transition-colors">
                                <span class="mr-1">üìÇ</span> Import JSON
                            </button>
                            <button id="export-strat-btn" class="text-xs bg-white text-gray-700 border border-gray-300 px-2 py-1 rounded shadow-sm hover:bg-gray-100 flex items-center transition-colors">
                                <span class="mr-1">üíæ</span> Export JSON
                            </button>
                        </div>
                    </div>
                `;

                // 3. Generate Add New Form HTML
                const addFormHtml = `
                    <div class="mt-4 pt-4 border-t border-gray-200 bg-gray-50 p-4 rounded border border-gray-200">
                        <h5 class="font-bold text-sm text-gray-700 mb-3 flex items-center">
                            <span class="bg-blue-600 text-white rounded-full w-4 h-4 flex items-center justify-center text-[10px] mr-2">+</span> 
                            Add Custom Strategy to '${Utils.capitalize(cat)}'
                        </h5>
                        <input type="text" id="new-strat-title" placeholder="Strategy Name (e.g., 'Break Card')" class="w-full mb-2 p-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm">
                        <textarea id="new-strat-desc" placeholder="Description of how to use it..." class="w-full mb-3 p-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm" rows="2"></textarea>
                        <button id="save-custom-strat-btn" class="bg-blue-600 text-white px-3 py-2 rounded text-sm font-bold hover:bg-blue-700 w-full shadow-sm transition-colors flex justify-center items-center">
                            Save to My Library
                        </button>
                    </div>
                `;
                
                // 4. Assemble
                list.innerHTML = controlsHtml + itemsHtml + addFormHtml;
                
                // 5. Bind Insert Buttons (Existing logic)
                list.querySelectorAll('.insert-strategy-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const title = e.currentTarget.dataset.title;
                        const desc = e.currentTarget.dataset.desc;
                        const area = document.getElementById(`${cat}-editable-area`);
                        
                        const html = `<p class="mb-2 p-2 bg-blue-50 border-l-4 border-blue-400 rounded text-sm"><strong>${title}:</strong> ${desc}</p>`;
                        
                        if (area.innerHTML.trim() === "N/A" || area.innerHTML.trim() === "") {
                            area.innerHTML = html;
                        } else {
                            area.innerHTML += html;
                        }
                        
                        if (area.contentEditable !== "true") {
                            this.c.repo.updateCase(this.c.userId, this.c.caseId, { [`bip${Utils.capitalize(cat)}Content`]: area.innerHTML });
                        }
                        
                        Utils.showNotification("Strategy inserted!");
                        document.getElementById('strategy-bank-modal').classList.add('hidden');
                    });
                });

                // 6. Bind JSON Import/Export & Add Logic
                
                // Import
                document.getElementById('import-strat-btn').onclick = () => document.getElementById('import-strat-input').click();
                document.getElementById('import-strat-input').onchange = async (e) => {
                    if(e.target.files.length > 0) {
                        try {
                            const loaded = await Utils.readJsonFile(e.target.files[0]);
                            if(Array.isArray(loaded)) {
                                this.customStrategies = [...this.customStrategies, ...loaded];
                                Utils.showNotification(`Loaded ${loaded.length} strategies!`);
                                this.openStrategyBank(cat); // Re-render
                            } else {
                                throw new Error("Invalid format");
                            }
                        } catch(err) {
                            console.error(err);
                            Utils.showNotification("Failed to load JSON", "error");
                        }
                        e.target.value = '';
                    }
                };

                // Export
                document.getElementById('export-strat-btn').onclick = () => {
                    if(this.customStrategies.length === 0) {
                        Utils.showNotification("Library is empty. Add custom strategies first.", "error");
                        return;
                    }
                    Utils.downloadAsJson(this.customStrategies, 'My_FBA_Strategies.json');
                    Utils.showNotification("Library exported!");
                };

                // Save New
                document.getElementById('save-custom-strat-btn').onclick = () => {
                    const title = document.getElementById('new-strat-title').value.trim();
                    const desc = document.getElementById('new-strat-desc').value.trim();
                    
                    if(title && desc) {
                        this.customStrategies.push({ title, desc, category: cat, isCustom: true });
                        Utils.showNotification("Strategy saved to library!");
                        this.openStrategyBank(cat); // Re-render immediately
                    } else {
                        Utils.showNotification("Title and Description required", "error");
                    }
                };
                
                document.getElementById('strategy-bank-modal').classList.remove('hidden');
            }

            // NEW: Option 3 Methods (High-P Sequence)
            toggleHighPTool() {
                const container = document.getElementById('prevent-tools-area');
                if (!container) return;
                
                // Toggle if already open
                if (container.innerHTML.trim() !== '') {
                    container.innerHTML = '';
                    return;
                }

                container.innerHTML = `
                    <div class="mt-4 bg-blue-50 p-4 rounded border border-blue-200 animate-fade-in-down shadow-inner">
                        <div class="flex justify-between items-center mb-2">
                            <h5 class="font-bold text-blue-800 text-sm">üöÄ High-P Sequence Generator</h5>
                            <button class="text-gray-400 hover:text-gray-600 text-xs font-bold" onclick="document.getElementById('prevent-tools-area').innerHTML=''">‚úñ</button>
                        </div>
                        <p class="text-xs text-blue-600 mb-3">Ask for 3 easy behaviors (High Probability) before the hard one (Low Probability) to build behavioral momentum.</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-xs mb-3">
                            <div>
                                <label class="block font-semibold text-blue-700 mb-1">Easy Task 1</label>
                                <input id="highp-1" placeholder="e.g. Give me a high five" class="w-full border border-blue-200 p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block font-semibold text-blue-700 mb-1">Easy Task 2</label>
                                <input id="highp-2" placeholder="e.g. Touch your nose" class="w-full border border-blue-200 p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block font-semibold text-blue-700 mb-1">Easy Task 3</label>
                                <input id="highp-3" placeholder="e.g. Tell me your name" class="w-full border border-blue-200 p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block font-bold text-red-700 mb-1">HARD TASK (Target)</label>
                                <input id="lowp-target" placeholder="e.g. Start math sheet" class="w-full border border-red-300 bg-red-50 p-2 rounded focus:ring-2 focus:ring-red-500 outline-none placeholder-red-300 text-red-900 font-medium">
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button id="gen-highp-execute-btn" class="bg-blue-600 text-white text-xs px-4 py-2 rounded shadow hover:bg-blue-700 font-bold transition-colors">Generate & Insert Script</button>
                        </div>
                    </div>
                `;
                
                // Bind the execute button inside the injected HTML
                document.getElementById('gen-highp-execute-btn').addEventListener('click', () => this.generateHighP());
            }

            // NEW: Option 1 (Shaping Ladder) Methods
            toggleShapingTool() {
                const container = document.getElementById('teach-tools-area');
                if (!container) return;
                
                // Toggle off if already open
                if (container.innerHTML.trim() !== '') {
                    container.innerHTML = '';
                    return;
                }

                const data = this.c.store.getState().currentCaseData;
                const currentBeh = data.bipOperationalDefinition ? Utils.stripHtml(data.bipOperationalDefinition).substring(0, 50) : '';

                container.innerHTML = `
                    <div class="mt-4 bg-orange-50 p-4 rounded border border-orange-200 shadow-inner animate-fade-in-down">
                        <div class="flex justify-between items-center mb-3">
                            <h5 class="font-bold text-orange-900 text-sm flex items-center">
                                <span class="text-xl mr-2">ü™ú</span> Behavior Shaping Ladder
                            </h5>
                            <button class="text-gray-400 hover:text-gray-600 text-xs font-bold" onclick="document.getElementById('teach-tools-area').innerHTML=''">‚úñ</button>
                        </div>
                        <p class="text-xs text-orange-800 mb-3">Create intermediate steps to reach the goal behavior (Shaping).</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="block text-xs font-bold text-orange-900 mb-1">Current Behavior (Start)</label>
                                <input id="shape-start" value="${currentBeh}" class="w-full border border-orange-300 p-2 rounded text-sm bg-white focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="e.g. Screaming">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-orange-900 mb-1">Goal Behavior (Top)</label>
                                <input id="shape-goal" class="w-full border border-orange-300 p-2 rounded text-sm bg-white focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="e.g. Raising Hand">
                            </div>
                        </div>
                        
                        <div class="text-right">
                            <button id="gen-ladder-btn" class="bg-orange-600 hover:bg-orange-700 text-white text-xs px-4 py-2 rounded shadow font-bold transition-colors">
                                Generate Steps
                            </button>
                        </div>
                        <div id="ladder-results" class="mt-4 hidden space-y-2"></div>
                    </div>
                `;

                // Bind logic
                setTimeout(() => {
                    document.getElementById('gen-ladder-btn').addEventListener('click', () => this.generateShapingSteps());
                }, 0);
            }

            async generateShapingSteps() {
                const btnId = 'gen-ladder-btn';
                Utils.setLoading(btnId, true);

                const start = document.getElementById('shape-start').value;
                const goal = document.getElementById('shape-goal').value;

                const prompt = `Create a behavior shaping plan (Successive Approximations).
                Start Behavior: "${start}".
                Goal Behavior: "${goal}".
                Generate 3 intermediate steps that are progressively more difficult.
                Return JSON array of strings: ["Step 1 description", "Step 2 description", "Step 3 description"]`;

                try {
                    const response = await Utils.getGeminiResponse([{role: 'user', parts: [{ text: prompt }]}]);
                    const jsonStr = response.replace(/\`\`\`json/g, '').replace(/\`\`\`/g, '').trim();
                    const steps = JSON.parse(jsonStr);

                    const resultsDiv = document.getElementById('ladder-results');
                    let html = `<div class="relative pl-4 border-l-2 border-orange-300 space-y-4">`;
                    
                    // Render Ladder (Top down visually, but logic is steps)
                    html += `<div class="text-xs text-gray-400 font-bold">üèÅ Goal: ${goal}</div>`;
                    
                    [...steps].reverse().forEach((step, i) => {
                        html += `
                            <div class="bg-white p-2 rounded border border-orange-100 shadow-sm flex justify-between items-center group">
                                <span class="text-sm text-gray-800"><span class="font-bold text-orange-500">Step ${3-i}:</span> ${step}</span>
                                <button class="text-xs bg-green-50 text-green-700 border border-green-200 px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity insert-step-btn" data-text="${step}">Insert</button>
                            </div>
                        `;
                    });
                    
                    html += `<div class="text-xs text-gray-400 font-bold">üö¶ Start: ${start}</div></div>`;
                    
                    resultsDiv.innerHTML = html;
                    resultsDiv.classList.remove('hidden');

                    // Bind Insert Buttons
                    resultsDiv.querySelectorAll('.insert-step-btn').forEach(btn => {
                        btn.onclick = async () => {
                            const area = document.getElementById('teach-editable-area');
                            const snippet = `<div class="mt-2 p-2 bg-orange-50 border-l-4 border-orange-400 text-sm rounded"><strong>ü™ú Shaping Step:</strong> ${btn.dataset.text}</div>`;
                            
                            if (area.innerHTML.trim() === "N/A" || area.innerHTML.trim() === "") {
                                area.innerHTML = snippet;
                            } else {
                                area.innerHTML += snippet;
                            }
                            
                            await this.c.repo.updateCase(this.c.userId, this.c.caseId, { bipTeachContent: area.innerHTML });
                            Utils.showNotification("Step inserted!");
                        };
                    });

                } catch (e) {
                    console.error(e);
                    Utils.showNotification("Failed to generate ladder", "error");
                } finally {
                    Utils.setLoading(btnId, false);
                }
            }

            // NEW: Option 1 (Schedule Thinning Calculator) Logic
            toggleThinningTool() {
                const container = document.getElementById('respond-tools-area');
                if (!container) return;
                
                // Toggle off if already open
                if (container.innerHTML.trim() !== '') {
                    container.innerHTML = '';
                    return;
                }
                
                container.innerHTML = `
                    <div class="mt-4 bg-yellow-50 p-4 rounded border border-yellow-200 shadow-inner animate-fade-in-down">
                        <div class="flex justify-between items-center mb-2">
                            <h5 class="font-bold text-yellow-900 text-sm">üìâ Schedule Thinning Calculator</h5>
                            <button class="text-gray-400 hover:text-gray-600 text-xs font-bold" onclick="document.getElementById('respond-tools-area').innerHTML=''">‚úñ</button>
                        </div>
                        <p class="text-xs text-yellow-800 mb-3">Create a plan to fade reinforcement from dense to natural levels.</p>
                        <div class="grid grid-cols-2 gap-3 text-xs mb-3">
                            <div><label class="block font-bold text-yellow-900 mb-1">Current (mins)</label><input type="number" id="thin-current" value="5" class="w-full border border-yellow-300 p-2 rounded focus:ring-2 focus:ring-yellow-500 outline-none"></div>
                            <div><label class="block font-bold text-yellow-900 mb-1">Goal (mins)</label><input type="number" id="thin-goal" value="30" class="w-full border border-yellow-300 p-2 rounded focus:ring-2 focus:ring-yellow-500 outline-none"></div>
                            <div><label class="block font-bold text-yellow-900 mb-1">Steps</label><input type="number" id="thin-steps" value="5" class="w-full border border-yellow-300 p-2 rounded focus:ring-2 focus:ring-yellow-500 outline-none"></div>
                        </div>
                        <div class="flex justify-end">
                            <button id="calc-thinning-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white text-xs px-4 py-2 rounded shadow font-bold transition-colors">Generate Plan</button>
                        </div>
                        <div id="thinning-results" class="mt-3 hidden bg-white p-3 rounded border border-yellow-100 text-xs"></div>
                    </div>
                `;
                
                // Bind the calculate button
                setTimeout(() => {
                    document.getElementById('calc-thinning-btn').addEventListener('click', () => {
                        const current = parseInt(document.getElementById('thin-current').value);
                        const goal = parseInt(document.getElementById('thin-goal').value);
                        const steps = parseInt(document.getElementById('thin-steps').value);
                        
                        if(!current || !goal || !steps) {
                            Utils.showNotification("Please fill all fields", "error");
                            return;
                        }

                        const increment = (goal - current) / steps;
                        
                        let html = `<strong class="block mb-2 text-yellow-900">Fade Plan:</strong><ul class="list-disc pl-4 space-y-1 text-gray-700 mb-3">`;
                        for(let i=1; i<=steps; i++) {
                            const val = Math.round(current + (increment * i));
                            html += `<li><strong>Step ${i}:</strong> Every ${val} mins (Maintain for 3 successful days)</li>`;
                        }
                        html += `</ul>`;
                        
                        const res = document.getElementById('thinning-results');
                        res.innerHTML = html + `<div class="text-right"><button id="append-thinning-btn" class="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded border border-blue-200 font-medium hover:bg-blue-100">Append to BIP</button></div>`;
                        res.classList.remove('hidden');

                        document.getElementById('append-thinning-btn').addEventListener('click', async () => {
                            const area = document.getElementById('respond-editable-area');
                            const snippet = `<div class="mt-2 p-2 bg-yellow-50 border-l-4 border-yellow-400 rounded text-sm">${html}</div>`;
                            
                            if (area.innerHTML.trim() === "N/A" || area.innerHTML.trim() === "") {
                                area.innerHTML = snippet;
                            } else {
                                area.innerHTML += snippet;
                            }
                            
                            // Save
                            await this.c.repo.updateCase(this.c.userId, this.c.caseId, { bipRespondContent: area.innerHTML });
                            Utils.showNotification("Thinning plan added!");
                            container.innerHTML = ''; // Close tool
                        });
                    });
                }, 0);
            }

            generateHighP() {
                const t1 = document.getElementById('highp-1').value || "Easy Task 1";
                const t2 = document.getElementById('highp-2').value || "Easy Task 2";
                const t3 = document.getElementById('highp-3').value || "Easy Task 3";
                const target = document.getElementById('lowp-target').value || "Target Task";
                
                const html = `
                    <div class="my-3 bg-white border-l-4 border-blue-500 p-3 rounded shadow-sm">
                        <strong class="text-xs text-blue-500 uppercase tracking-wide block mb-2">üöÄ Behavioral Momentum Script</strong>
                        <div class="text-sm text-gray-700 space-y-1 font-medium">
                            <div>1. <strong>Teacher:</strong> "${t1}!" <span class="text-green-600 italic text-xs">‚Üí (Praise)</span></div>
                            <div>2. <strong>Teacher:</strong> "${t2}!" <span class="text-green-600 italic text-xs">‚Üí (Praise)</span></div>
                            <div>3. <strong>Teacher:</strong> "${t3}!" <span class="text-green-600 italic text-xs">‚Üí (Praise)</span></div>
                            <div class="mt-2 pt-2 border-t border-gray-100 font-bold text-blue-900 bg-blue-50 p-1 rounded">4. <strong>Teacher:</strong> "Great job! Now, ${target}."</div>
                        </div>
                    </div>
                `;
                
                const area = document.getElementById('prevent-editable-area');
                if (area.innerHTML.trim() === "N/A" || area.innerHTML.trim() === "") {
                    area.innerHTML = html;
                } else {
                    area.innerHTML += html;
                }
                
                // Save
                this.c.repo.updateCase(this.c.userId, this.c.caseId, { bipPreventContent: area.innerHTML });
                Utils.showNotification("High-P Script added!");
                
                // Clear tool
                document.getElementById('prevent-tools-area').innerHTML = '';
            }

            async toggleEdit(cat, btn) {
                const area = document.getElementById(`${cat}-editable-area`);
                const isEditing = area.isContentEditable;
                
                if (isEditing) {
                    // Save
                    area.contentEditable = "false";
                    area.classList.remove('bg-white', 'border-blue-300', 'shadow-inner');
                    area.classList.add('border-transparent');
                    btn.innerHTML = `<svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg> ${I18nService.t('bip.edit_content')}`;
                    const newContent = area.innerHTML;
                    await this.c.repo.updateCase(this.c.userId, this.c.caseId, { [`bip${Utils.capitalize(cat)}Content`]: newContent });
                    Utils.showNotification("messages.cat_saved", "success", {cat: cat});
                } else {
                    // Start Editing
                    area.contentEditable = "true";
                    area.classList.remove('border-transparent');
                    area.classList.add('bg-white', 'border-blue-300', 'shadow-inner');
                    area.focus();
                    btn.innerHTML = `<svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> ${I18nService.t('bip.save_content')}`;
                }
            }

            // NEW Methods for Preference Assessment
            async generateRewards() {
                Utils.setLoading('generate-rewards-btn', true);
                const interests = document.getElementById('student-interests').value;
                const grade = this.c.store.getState().currentCaseData.gradeLevel || 'student';
                
                const prompt = `Suggest 5 specific, low-cost classroom reinforcers for a student in grade ${grade} interested in: ${interests}. Return ONLY a JSON array of strings (e.g. ["item 1", "item 2"]). Do not use markdown formatting.`;
                
                try {
                    const res = await Utils.getGeminiResponse([{role:'user', parts:[{text:prompt}]}]);
                    const jsonStr = res.replace(/```json/g, '').replace(/```/g, '').trim();
                    const rewards = JSON.parse(jsonStr);
                    
                    const container = document.getElementById('reward-ideas-container');
                    container.innerHTML = '';
                    rewards.forEach(r => {
                        const chip = document.createElement('button');
                        chip.className = "bg-white text-pink-800 border border-pink-200 px-3 py-1 rounded-full text-xs font-medium hover:bg-pink-100 transition-colors shadow-sm";
                        chip.textContent = `+ ${r}`;
                        chip.onclick = (e) => {
                            e.preventDefault();
                            const area = document.getElementById('confirmed-reinforcers');
                            area.value = area.value ? `${area.value}, ${r}` : r;
                            chip.classList.add('opacity-50', 'cursor-not-allowed', 'bg-pink-100');
                            chip.disabled = true;
                        };
                        container.appendChild(chip);
                    });
                } catch(e) {
                    console.error(e);
                    Utils.showNotification("Failed to generate rewards. Try simpler keywords.", "error");
                }
                Utils.setLoading('generate-rewards-btn', false);
            }

            async saveReinforcers() {
                const text = document.getElementById('confirmed-reinforcers').value;
                Utils.setLoading('save-reinforcers-btn', true);
                await this.c.repo.updateCase(this.c.userId, this.c.caseId, { bipReinforcers: text });
                Utils.setLoading('save-reinforcers-btn', false);
                Utils.showNotification("Reinforcers saved!");
            }

            // NEW: Save Crisis Plan
            async saveCrisisPlan() {
                const text = document.getElementById('bip-crisis-text').value;
                Utils.setLoading('save-crisis-btn', true);
                await this.c.repo.updateCase(this.c.userId, this.c.caseId, { bipCrisisPlan: text });
                Utils.setLoading('save-crisis-btn', false);
                Utils.showNotification("Crisis plan saved!");
            }

            // NEW: Generate Crisis Flowchart
            async generateCrisisFlowchart() {
                const btnId = 'visualize-crisis-btn';
                Utils.setLoading(btnId, true);
                const text = document.getElementById('bip-crisis-text').value;
                
                if (!text || text.length < 10) {
                    Utils.showNotification("Please enter a crisis plan first.", "error");
                    Utils.setLoading(btnId, false);
                    return;
                }

                const prompt = `Convert this crisis plan into a flowchart structure. 
                Return a JSON ARRAY of objects. Each object represents a step: 
                { "label": "Short Title (e.g. Student Yells)", "action": "Staff Response (e.g. Clear room)" }. 
                Limit to 5 key steps. Text: "${text}"`;

                try {
                    const response = await Utils.getGeminiResponse([{role: 'user', parts: [{ text: prompt }]}]);
                    const jsonStr = response.replace(/```json/g, '').replace(/```/g, '').trim();
                    const steps = JSON.parse(jsonStr);

                    let svg = `<svg viewBox="0 0 400 ${steps.length * 140}" class="w-full h-auto font-sans" xmlns="http://www.w3.org/2000/svg">`;
                    // Defs for arrow
                    svg += `<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#9ca3af" /></marker></defs>`;

                    steps.forEach((step, i) => {
                        const y = i * 140 + 20;
                        // Draw Arrow (except for first item)
                        if (i > 0) {
                            const prevY = ((i - 1) * 140) + 20 + 80; // prevY + height
                            svg += `<line x1="200" y1="${prevY}" x2="200" y2="${y}" stroke="#9ca3af" stroke-width="2" marker-end="url(#arrowhead)" />`;
                        }
                        
                        // Color logic: Start (Yellow), Middle (Blue), End (Green)
                        let fill = '#eff6ff'; // Blue-50
                        let stroke = '#3b82f6'; // Blue-500
                        if (i === 0) { fill = '#fef3c7'; stroke = '#f59e0b'; } // Yellow
                        else if (i === steps.length - 1) { fill = '#f0fdf4'; stroke = '#22c55e'; } // Green

                        // Draw Box
                        svg += `
                            <rect x="50" y="${y}" width="300" height="80" rx="10" fill="${fill}" stroke="${stroke}" stroke-width="2"/>
                            <text x="200" y="${y+30}" text-anchor="middle" font-weight="bold" fill="#1f2937" font-size="14" font-family="sans-serif">${step.label}</text>
                            <text x="200" y="${y+55}" text-anchor="middle" fill="#4b5563" font-size="12" font-family="sans-serif">${step.action}</text>
                        `;
                    });
                    svg += `</svg>`;

                    const container = document.getElementById('crisis-visual-container');
                    container.innerHTML = svg;
                    container.classList.remove('hidden');
                    
                    await this.c.repo.updateCase(this.c.userId, this.c.caseId, { crisisFlowchartSVG: svg });
                    Utils.showNotification("Flowchart generated!");

                } catch (e) {
                    console.error(e);
                    Utils.showNotification("Could not create flowchart", "error");
                } finally {
                    Utils.setLoading(btnId, false);
                }
            }

            async generateRestorativeScript() {
                Utils.setLoading('generate-debrief-btn', true);
                const data = this.c.store.getState().currentCaseData;
                const ageGroup = document.getElementById('debrief-age-group').value;
                
                // Context for AI
                const behavior = data.bipOperationalDefinition || "the incident";
                const student = data.studentName || "the student";

                const prompt = `Generate a "Restorative Justice" debrief script for a teacher to use with a student named ${student} (${ageGroup} age group).
                The specific behavior to address is: "${behavior}".
                
                Include 4 specific questions/statements based on Restorative practices:
                1. What happened?
                2. What were you thinking/feeling?
                3. Who was affected?
                4. What can we do to make it right?
                
                Tone: Non-judgmental, curious, and supportive. 
                Format: Simple HTML with bold questions and suggested student-friendly phrasing.`;

                try {
                    const response = await Utils.getGeminiResponse([{role: 'user', parts: [{ text: prompt }]}]);
                    const container = document.getElementById('debrief-output');
                    container.innerHTML = response;
                    container.classList.remove('hidden');
                    
                    // Auto-save to case data so it persists
                    await this.c.repo.updateCase(this.c.userId, this.c.caseId, { restorativeScript: response });
                } catch (e) {
                    console.error(e);
                    Utils.showNotification("Failed to generate script", "error");
                }
                Utils.setLoading('generate-debrief-btn', false);
            }

            generateFidelityChecklist() {
                const data = this.c.store.getState().currentCaseData;
                
                // Helper to extract items from HTML content
                const extractItems = (html) => {
                    if (!html) return [];
                    const div = document.createElement('div');
                    div.innerHTML = html;
                    
                    // Priority 1: Extract <li> elements
                    let items = Array.from(div.querySelectorAll('li')).map(li => li.textContent.trim());
                    
                    // Priority 2: Extract <p> elements if no list
                    if (items.length === 0) {
                        items = Array.from(div.querySelectorAll('p'))
                            .map(p => p.textContent.trim())
                            .filter(t => t.length > 5); // Filter out empty lines
                    }
                    
                    // Priority 3: Fallback to splitting by newlines if mostly text
                    if (items.length === 0 && div.textContent.trim().length > 0) {
                         items = div.textContent.split('\n')
                            .map(t => t.trim())
                            .filter(t => t.length > 5);
                    }
                    
                    // Clean items (remove numbering like "1.", "a.")
                    return items.map(i => i.replace(/^[\d\w][\.)]\s*/, ''));
                };

                const preventItems = extractItems(data.bipPreventContent).map(i => `(Prevent) ${i}`);
                const teachItems = extractItems(data.bipTeachContent).map(i => `(Teach) ${i}`);
                const respondItems = extractItems(data.bipRespondContent).map(i => `(Respond) ${i}`);
                
                const allItems = [...preventItems, ...teachItems, ...respondItems];

                if (allItems.length === 0) {
                    Utils.showNotification("No strategies found to list. Complete the BIP first.", "error");
                    return;
                }

                // NEW: Fetch logs and render interactive UI
                this.c.repo.subscribeToFidelityLogs(this.c.userId, this.c.caseId, (snapshot) => {
                    // Handle both snapshot (Cloud) and array (Memory) structures
                    let logs = [];
                    if (snapshot.docs) {
                        logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    } else if (Array.isArray(snapshot)) { // Memory mode returns array directly
                        logs = snapshot;
                    }
                    this.renderFidelityTracker(allItems, logs);
                });
            }

            renderFidelityTracker(items, logs) {
                const preview = document.getElementById('fidelity-preview');
                const today = new Date().toLocaleDateString();
                
                // 1. Chart Generation (Simple HTML/CSS Bar Chart)
                const sortedLogs = logs.sort((a,b) => new Date(a.date) - new Date(b.date)).slice(-7); // Last 7 entries
                let chartHtml = '';
                
                if (sortedLogs.length > 0) {
                    const bars = sortedLogs.map(l => {
                        const height = l.score; // 0-100
                        let color = 'bg-red-400';
                        if(l.score >= 80) color = 'bg-green-500';
                        else if(l.score >= 50) color = 'bg-yellow-400';
                        
                        // Parse date slightly better for labels
                        const d = new Date(l.date);
                        const label = `${d.getMonth()+1}/${d.getDate()}`; // MM/DD

                        return `
                            <div class="flex flex-col items-center mx-1 group flex-1">
                                <div class="relative w-full max-w-[20px] bg-gray-100 rounded-t h-24 flex items-end overflow-hidden">
                                    <div class="${color} w-full transition-all duration-500" style="height: ${height}%"></div>
                                </div>
                                <span class="text-[9px] text-gray-500 mt-1 whitespace-nowrap overflow-hidden">${label}</span>
                                <!-- Tooltip -->
                                <div class="absolute bottom-full mb-1 hidden group-hover:block bg-black text-white text-xs px-2 py-1 rounded whitespace-nowrap z-10">
                                    ${l.date}: ${l.score}%
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    chartHtml = `
                        <div class="mb-6 bg-white p-3 rounded border border-gray-200">
                            <h5 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">Fidelity Trend (Last 7 Logs)</h5>
                            <div class="flex items-end justify-between h-28 border-b border-gray-300 pb-1">
                                ${bars}
                            </div>
                        </div>
                    `;
                } else {
                    chartHtml = `
                        <div class="mb-6 bg-white p-6 rounded border border-gray-200 text-center">
                            <p class="text-xs text-gray-400">No logs yet. Save today's checklist to see trends.</p>
                        </div>
                    `;
                }

                // 2. Checklist for Today
                let checklistHtml = items.map((item, idx) => `
                    <label class="flex items-start space-x-3 p-3 border rounded bg-white hover:bg-gray-50 transition-colors cursor-pointer mb-2">
                        <input type="checkbox" class="fidelity-checkbox w-5 h-5 text-blue-600 rounded focus:ring-blue-500 mt-0.5" data-idx="${idx}">
                        <span class="text-sm text-gray-700 font-medium select-none">${item}</span>
                    </label>
                `).join('');

                // 3. Assemble
                const html = `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h4 class="font-bold text-lg text-gray-800">‚úÖ Daily Fidelity Tracker</h4>
                                    <p class="text-xs text-gray-500">Date: ${today}</p>
                                </div>
                            </div>
                            <div class="mb-4 max-h-[400px] overflow-y-auto pr-2">
                                ${checklistHtml}
                            </div>
                            <div class="flex items-center space-x-4">
                                <button id="save-fidelity-log-btn" class="flex-grow sm:flex-grow-0 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md flex items-center justify-center transition-all">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    Save Today's Log
                                </button>
                                <span id="fidelity-score-preview" class="text-xl font-bold text-gray-400">0%</span>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            ${chartHtml}
                            <div class="text-sm text-blue-800 mb-4">
                                <strong class="block mb-1">Why Track Fidelity?</strong>
                                Consistent implementation is key. Aim for <span class="font-bold text-green-600">80%+ fidelity</span> to ensure the plan works as intended.
                            </div>
                            <hr class="border-gray-200 my-4">
                            <div class="text-right">
                                <button id="hide-fidelity-btn" class="text-xs text-gray-500 hover:text-gray-700 underline">Close Tracker</button>
                            </div>
                        </div>
                    </div>
                `;

                preview.innerHTML = html;
                preview.classList.remove('hidden');

                // Bindings
                document.getElementById('hide-fidelity-btn').onclick = () => preview.classList.add('hidden');
                
                // Live Score Update
                const updateScore = () => {
                    const checked = document.querySelectorAll('.fidelity-checkbox:checked').length;
                    const total = items.length;
                    const pct = Math.round((checked / total) * 100);
                    const scoreEl = document.getElementById('fidelity-score-preview');
                    scoreEl.textContent = `${pct}%`;
                    scoreEl.className = `text-xl font-bold ${pct >= 80 ? 'text-green-600' : pct >= 50 ? 'text-yellow-600' : 'text-red-500'}`;
                };
                
                document.querySelectorAll('.fidelity-checkbox').forEach(cb => cb.addEventListener('change', updateScore));

                // Save Handler
                document.getElementById('save-fidelity-log-btn').onclick = async () => {
                    const checkedCount = document.querySelectorAll('.fidelity-checkbox:checked').length;
                    const total = items.length;
                    const score = total > 0 ? Math.round((checkedCount / total) * 100) : 0;
                    
                    Utils.setLoading('save-fidelity-log-btn', true);
                    
                    try {
                        await this.c.repo.addFidelityLog(this.c.userId, this.c.caseId, {
                            date: new Date().toISOString().split('T')[0], // YYYY-MM-DD
                            score: score,
                            itemsChecked: checkedCount,
                            totalItems: total
                        });
                        Utils.showNotification(`Fidelity Log Saved: ${score}%`);
                    } catch (e) {
                        console.error(e);
                        Utils.showNotification("Failed to save log", "error");
                    }
                    
                    Utils.setLoading('save-fidelity-log-btn', false);
                };
            }

            startChat(cat) {
                if(this.history[cat].length === 0) {
                    const prompt = `BCBA Co-pilot for ${cat}. Conversational. Reply in ${I18nService.currentLocale}. Final output ONLY HTML block + [BIP_CATEGORY_COMPLETE].`;
                    this.history[cat].push({role:'system', parts:[{text:prompt}]});
                    const win = document.getElementById(`${cat}-chat-window`);
                    const bub = document.createElement('div'); bub.className = 'chat-bubble chat-bubble-model'; 
                    bub.textContent = I18nService.t('bip.intro', {cat: cat});
                    win.appendChild(bub);
                }
            }
            async chat(cat) {
                const input = document.getElementById(`${cat}-chat-input`);
                const msg = input.value; if(!msg) return;
                const win = document.getElementById(`${cat}-chat-window`);
                const userBub = document.createElement('div'); userBub.className = 'chat-bubble chat-bubble-user'; userBub.textContent = msg;
                win.appendChild(userBub); input.value = '';
                
                this.history[cat].push({role:'user', parts:[{text:msg}]});
                Utils.showTypingIndicator(`${cat}-chat-window`, true);
                const res = await Utils.getGeminiResponse(this.history[cat]);
                Utils.showTypingIndicator(`${cat}-chat-window`, false);
                
                if(res.includes('[BIP_CATEGORY_COMPLETE]')) {
                    const html = res.replace('[BIP_CATEGORY_COMPLETE]', '').trim();
                    await this.c.repo.updateCase(this.c.userId, this.c.caseId, { [`bip${Utils.capitalize(cat)}Content`]: html });
                    Utils.showNotification("messages.cat_saved", "success", {cat: cat});
                    this.enableBuilder(this.c.store.getState().currentCaseData);
                } else {
                    const botBub = document.createElement('div'); botBub.className = 'chat-bubble chat-bubble-model'; botBub.textContent = res;
                    win.appendChild(botBub); win.scrollTop = win.scrollHeight;
                    this.history[cat].push({role:'model', parts:[{text:res}]});
                }
            }
            async genPlan() {
                Utils.setLoading('generate-monitoring-plan-btn', true);
                const goal = document.getElementById('bip-goal-text').value;
                const mon = document.getElementById('bip-monitoring-text').value;
                const res = await Utils.getGeminiResponse([{role:'user', parts:[{text: `Create monitoring plan HTML in ${I18nService.currentLocale}. Goal: ${goal}. Idea: ${mon}`}]}]);
                await this.c.repo.updateCase(this.c.userId, this.c.caseId, { bipMonitoringPlan: res });
                Utils.setLoading('generate-monitoring-plan-btn', false);
                this.enableBuilder(this.c.store.getState().currentCaseData);
            }

            async runQualityAudit() {
                Utils.setLoading('audit-bip-btn', true);
                
                const data = this.c.store.getState().currentCaseData;
                const bipContext = `
                    Definition: ${data.bipOperationalDefinition || 'N/A'}
                    Prevent: ${data.bipPreventContent || 'N/A'}
                    Teach: ${data.bipTeachContent || 'N/A'}
                    Respond: ${data.bipRespondContent || 'N/A'}
                    Goal: ${data.bipMonitoringPlan || 'N/A'}
                `;

                const prompt = `Act as a clinical supervisor. Audit this Behavior Intervention Plan. 
                Rate 1-5 on: 
                1. Operational Definition Clarity
                2. Function-Based Strategies
                3. Measurability of Goal.
                Provide a brief 1-sentence critique for each. Return HTML. Reply in ${I18nService.currentLocale}.`;

                try {
                    const response = await Utils.getGeminiResponse([
                        { role: 'system', parts: [{ text: prompt }] },
                        { role: 'user', parts: [{ text: bipContext }] }
                    ]);

                    const container = document.getElementById('bip-audit-result');
                    container.innerHTML = response;
                    container.classList.remove('hidden');
                } catch(e) {
                    console.error(e);
                    Utils.showNotification("Audit failed", "error");
                }
                
                Utils.setLoading('audit-bip-btn', false);
            }

            // NEW: Role-Based Snapshot Generator (Option 2)
            async generateSnapshot() {
                const role = document.getElementById('snapshot-role').value;
                const data = this.c.store.getState().currentCaseData;
                const btnId = 'generate-snapshot-btn';
                
                Utils.setLoading(btnId, true);

                const prompt = `
                    Act as a Board Certified Behavior Analyst. Create a concise, 1-page summary (Snapshot) of this Behavior Intervention Plan specifically for a ${role}.
                    
                    CONTEXT:
                    Student: ${data.studentName}
                    Target Behavior: ${data.bipOperationalDefinition || 'N/A'}
                    Prevent Strategies (Full): ${Utils.stripHtml(data.bipPreventContent || 'N/A')}
                    Respond Strategies (Full): ${Utils.stripHtml(data.bipRespondContent || 'N/A')}
                    
                    REQUIREMENTS:
                    1. Only include information relevant to a ${role} in their specific setting. 
                       (e.g., If Bus Driver, focus on seating/transit/safety. If Substitute, focus on immediate management. If Art, focus on materials).
                    2. Structure the HTML output with these headers:
                       - <h3>Snapshot for ${role}</h3>
                       - <h4>‚ö†Ô∏è Watch For (Triggers & Behaviors)</h4>
                       - <h4>‚úÖ Do This (Prevent Strategies) - Max 3 bullets</h4>
                       - <h4>üõë If Behavior Happens (Response) - Max 3 bullets</h4>
                    3. Tone: Helpful, direct, simple English. No jargon.
                    4. Output format: Clean HTML suitable for printing.
                `;

                try {
                    const response = await Utils.getGeminiResponse([{role: 'user', parts: [{text: prompt}]}]);
                    
                    // Generate PDF container
                    const element = document.createElement('div');
                    element.innerHTML = `
                        <div style="font-family: sans-serif; padding: 40px; color: #333;">
                            <div style="border-bottom: 4px solid #2563eb; padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h1 style="color: #1e3a8a; margin: 0; font-size: 24px; font-weight: bold;">BIP Snapshot</h1>
                                    <p style="margin: 5px 0 0; color: #666; font-size: 14px;">Role: <strong>${role}</strong></p>
                                </div>
                                <div style="text-align: right; font-size: 12px; color: #666;">
                                    Student: <strong>${data.studentName}</strong><br>
                                    Date: ${new Date().toLocaleDateString()}
                                </div>
                            </div>
                            <div style="font-size: 14px; line-height: 1.6; background: #fff;">
                                ${response}
                            </div>
                            <div style="margin-top: 40px; font-size: 10px; color: #999; text-align: center; border-top: 1px solid #eee; padding-top: 10px;">
                                Confidential Student Information ‚Ä¢ Generated by FBA/BIP App
                            </div>
                        </div>
                    `;

                    const opt = {
                        margin: 0.5,
                        filename: `${role.replace(/\s+/g, '_')}_Snapshot_${data.studentName.replace(/[^a-z0-9]/gi, '_')}.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2 },
                        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                    };

                    await html2pdf().set(opt).from(element).save();
                    Utils.showNotification(`${role} Snapshot Downloaded!`);

                } catch (e) {
                    console.error(e);
                    Utils.showNotification("Failed to generate snapshot", "error");
                } finally {
                    Utils.setLoading(btnId, false);
                }
            }
            
            exportToWord() {
                const data = this.c.store.getState().currentCaseData;
                
                // Get Checkbox States
                const showFba = document.getElementById('chk-fba')?.checked ?? true;
                const showVisual = document.getElementById('chk-visual')?.checked ?? true;
                const showDecision = document.getElementById('chk-decision')?.checked ?? true;
                const showBip = document.getElementById('chk-bip')?.checked ?? true;

                // 1. Construct Office-compatible HTML wrapper
                const preHtml = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>FBA/BIP Report</title></head><body>`;
                const postHtml = "</body></html>";
                
                // 2. Build Content
                let content = `
                    <h1 style="font-family: Arial, sans-serif; font-size: 24px; color: #2c3e50;">Confidential FBA/BIP Report</h1>
                    <p style="font-family: Arial, sans-serif;"><strong>Student:</strong> ${data.studentName}</p>
                    <p style="font-family: Arial, sans-serif;"><strong>Grade:</strong> ${data.gradeLevel || 'N/A'}</p>
                    <p style="font-family: Arial, sans-serif;"><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                    <hr/>`;
                
                if (showFba) {
                    content += `
                    <h2 style="font-family: Arial, sans-serif; font-size: 18px; color: #2c3e50; background-color: #f0f4f8; padding: 5px;">I. Functional Behavior Assessment</h2>
                    
                    <h3 style="font-family: Arial, sans-serif; font-size: 14px; color: #16a085;">1. Problem Identification</h3>
                    ${data.interviewSummary || '<p>No data recorded.</p>'}
                    
                    <h3 style="font-family: Arial, sans-serif; font-size: 14px; color: #16a085;">2. Record Review</h3>
                    ${data.recordAnalysis || '<p>No data recorded.</p>'}
                    
                    <h3 style="font-family: Arial, sans-serif; font-size: 14px; color: #16a085;">3. ABC Data Summary</h3>
                    ${data.analysisHypothesis || '<p>No analysis generated.</p>'}`;
                }
                
                if (showBip) {
                    content += `
                    <h2 style="font-family: Arial, sans-serif; font-size: 18px; color: #2c3e50; background-color: #f0f4f8; padding: 5px; margin-top: 20px;">II. Behavior Intervention Plan</h2>
                    
                    <h3 style="font-family: Arial, sans-serif; font-size: 14px; color: #16a085;">1. Operational Definition</h3>
                    <p style="font-family: Arial, sans-serif;">${data.bipOperationalDefinition || 'N/A'}</p>
                    
                    <h3 style="font-family: Arial, sans-serif; font-size: 14px; color: #16a085;">2. Intervention Strategies</h3>
                    
                    <h4 style="font-family: Arial, sans-serif; font-size: 12px; color: #555;">A. Prevent Strategies</h4>
                    ${data.bipPreventContent || '<p>N/A</p>'}
                    
                    <h4 style="font-family: Arial, sans-serif; font-size: 12px; color: #555;">B. Teach Strategies</h4>
                    ${data.bipTeachContent || '<p>N/A</p>'}
                    
                    <h4 style="font-family: Arial, sans-serif; font-size: 12px; color: #555;">C. Respond Strategies</h4>
                    ${data.bipRespondContent || '<p>N/A</p>'}

                    <h3 style="font-family: Arial, sans-serif; font-size: 14px; color: #c0392b;">3. Crisis Intervention Plan</h3>
                    <p style="font-family: Arial, sans-serif;">${data.bipCrisisPlan ? data.bipCrisisPlan.replace(/\n/g, '<br>') : 'N/A'}</p>
                    
                    <h3 style="font-family: Arial, sans-serif; font-size: 14px; color: #16a085;">4. Progress Monitoring</h3>
                    ${data.bipMonitoringPlan || '<p>N/A</p>'}`;
                }
                
                content += `
                    <div style="margin-top: 40px; font-family: Arial, sans-serif; font-size: 10px; color: #999; border-top: 1px solid #eee; padding-top: 10px;">
                        Generated via FBA/BIP App. Contains confidential information.
                    </div>
                `;

                // 3. Create Blob and Download
                const html = preHtml + content + postHtml;
                const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `FBA_Report_${data.studentName.replace(/[^a-z0-9]/gi, '_')}.doc`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                Utils.showNotification("Word Document Downloaded!");
            }

            generateReportHTML() {
                const data = this.c.store.getState().currentCaseData;
                const obs = this.c.store.getState().observations || [];
                const obsCount = obs.length;

                // Get Checkbox States
                const showFba = document.getElementById('chk-fba')?.checked ?? true;
                const showVisual = document.getElementById('chk-visual')?.checked ?? true;
                const showDecision = document.getElementById('chk-decision')?.checked ?? true;
                const showBip = document.getElementById('chk-bip')?.checked ?? true;

                // Retrieve settings for header
                const school = localStorage.getItem('fba_school_name') || '';
                const district = localStorage.getItem('fba_district') || '';
                const logo = localStorage.getItem('fba_school_logo');

                let headerHtml = '';
                if (school || district || logo) {
                    const logoImg = logo ? `<img src="${logo}" style="max-height:60px; max-width:150px; display:block; margin: 0 auto 10px auto;">` : '';
                    headerHtml = `
                        <div style="text-align:center; margin-bottom:20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                            ${logoImg}
                            <h2 style="margin:0; color:#2c3e50; font-size: 18px; font-weight: bold;">${district}</h2>
                            <h3 style="margin:5px 0; color:#7f8c8d; font-size: 14px; font-weight: normal;">${school}</h3>
                        </div>
                    `;
                }

                let html = `
                <div style="font-family: 'Helvetica', sans-serif; padding: 20px; color: #333; line-height: 1.5; background-color: white;">
                    ${headerHtml}
                    <h1 style="color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 10px; margin-bottom: 20px;">Confidential FBA/BIP Report</h1>
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 30px; background: #f9f9f9; padding: 15px; border-radius: 5px; border: 1px solid #eee;">
                        <div>
                            <strong>Student:</strong> ${data.studentName}<br>
                            <strong>Grade:</strong> ${data.gradeLevel || 'N/A'}
                        </div>
                        <div>
                            <strong>Date:</strong> ${new Date().toLocaleDateString()}<br>
                            <strong>Case ID:</strong> ${data.id ? data.id.substring(0,8) : 'N/A'}
                        </div>
                    </div>`;

                if (showFba) {
                    html += `
                    <h2 style="color: #34495e; background: #f0f4f8; padding: 8px; border-left: 5px solid #3498db; margin-top: 25px; font-size: 16px;">I. Functional Behavior Assessment</h2>
                    
                    <h3 style="color: #16a085; margin-top: 15px; font-size: 14px;">1. Problem Identification</h3>
                    <div style="font-size: 12px;">${data.interviewSummary || '<p>No interview data.</p>'}</div>

                    <h3 style="color: #16a085; margin-top: 15px; font-size: 14px;">2. Record Review</h3>
                    <div style="font-size: 12px;">${data.recordAnalysis || '<p>No record analysis.</p>'}</div>

                    <h3 style="color: #16a085; margin-top: 15px; font-size: 14px;">3. ABC Data Summary</h3>
                    <p style="font-size: 12px;"><strong>Total Observations:</strong> ${obsCount}</p>
                    <div style="font-size: 12px;">${data.analysisHypothesis || '<p>No analysis generated.</p>'}</div>`;
                }

                if (showVisual) {
                    if (showFba) html += `<div class="html2pdf__page-break"></div>`;
                    html += `
                    <h2 style="color: #34495e; background: #f0f4f8; padding: 8px; border-left: 5px solid #3498db; margin-top: 25px; font-size: 16px;">II. Visual Hypothesis</h2>
                    <div style="text-align: center; margin: 20px 0;">${data.visualHypothesisSVG || '<p>No visual generated.</p>'}</div>`;
                }

                if (showDecision) {
                    html += `
                    <h2 style="color: #34495e; background: #f0f4f8; padding: 8px; border-left: 5px solid #3498db; margin-top: 25px; font-size: 16px;">III. Critical Decision</h2>
                    <div style="font-size: 12px;">
                        ${data.criticalDecision ? `
                            <p><strong>Recommendation:</strong> ${data.criticalDecision.aiResponse.match(/RECOMMENDATION_TYPE::(.*?)\n/)?.[1] || 'N/A'}</p>
                            <p><strong>Confirmed Function:</strong> ${data.confirmedFunction || 'N/A'}</p>
                        ` : '<p>No decision recorded.</p>'}
                    </div>`;
                }

                if (showBip) {
                    if (showFba || showVisual || showDecision) html += `<div class="html2pdf__page-break"></div>`;
                    html += `
                    <h2 style="color: #34495e; background: #f0f4f8; padding: 8px; border-left: 5px solid #3498db; margin-top: 25px; font-size: 16px;">IV. Behavior Intervention Plan</h2>
                    
                    <h3 style="color: #16a085; margin-top: 15px; font-size: 14px;">1. Operational Definition</h3>
                    <p style="font-size: 12px;">${data.bipOperationalDefinition || 'N/A'}</p>

                    <h3 style="color: #16a085; margin-top: 15px; font-size: 14px;">2. Intervention Strategies</h3>
                    
                    <h4 style="font-size: 13px; color: #555; margin-bottom: 5px;">A. Prevent (Antecedent)</h4>
                    <div style="font-size: 12px; margin-bottom: 10px;">${data.bipPreventContent || 'N/A'}</div>

                    <h4 style="font-size: 13px; color: #555; margin-bottom: 5px;">B. Teach (Replacement)</h4>
                    <div style="font-size: 12px; margin-bottom: 10px;">${data.bipTeachContent || 'N/A'}</div>

                    <h4 style="font-size: 13px; color: #555; margin-bottom: 5px;">C. Respond (Consequence)</h4>
                    <div style="font-size: 12px; margin-bottom: 10px;">${data.bipRespondContent || 'N/A'}</div>

                    <h3 style="color: #c0392b; margin-top: 15px; font-size: 14px;">3. Crisis Intervention Plan</h3>
                    <div style="font-size: 12px; margin-bottom: 10px; white-space: pre-wrap;">${data.bipCrisisPlan || 'N/A'}</div>

                    <h3 style="color: #16a085; margin-top: 15px; font-size: 14px;">4. Progress Monitoring</h3>
                    <div style="font-size: 12px;">${data.bipMonitoringPlan || 'N/A'}</div>`;
                }

                html += `
                    <div style="margin-top: 60px; display: flex; justify-content: space-between;">
                        <div style="width: 45%; border-top: 1px solid #333; padding-top: 5px; text-align: center; font-size: 12px;">Case Manager / BCBA</div>
                        <div style="width: 45%; border-top: 1px solid #333; padding-top: 5px; text-align: center; font-size: 12px;">Administrator / Parent</div>
                    </div>

                    <p style="text-align: center; font-size: 10px; color: #999; margin-top: 40px; border-top: 1px solid #eee; padding-top: 10px;">
                        CONFIDENTIAL: Contains protected student information. Handle per FERPA/HIPAA.
                    </p>
                </div>`;
                
                return html;
            }

            previewReport() {
                const html = this.generateReportHTML();
                document.getElementById('report-preview-content').innerHTML = html;
                
                // Ensure Download button is visible (it might be hidden by Home Note)
                document.getElementById('preview-download-btn').classList.remove('hidden');
                
                document.getElementById('report-preview-modal').classList.remove('hidden');
            }

            downloadReport() {
                const data = this.c.store.getState().currentCaseData;
                
                // Construct PDF content container
                const element = document.createElement('div');
                element.innerHTML = this.generateReportHTML();

                const opt = {
                    margin:       0.5,
                    filename:     `FBA_Report_${data.studentName.replace(/[^a-z0-9]/gi, '_')}.pdf`,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2, useCORS: true },
                    jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
                };

                // UI Feedback
                const btn = document.getElementById('download-report-btn');
                const originalText = btn.innerText;
                btn.innerText = "Generating PDF...";
                btn.disabled = true;

                // Generate
                html2pdf().set(opt).from(element).save().then(() => {
                    btn.innerText = originalText;
                    btn.disabled = false;
                    Utils.showNotification("PDF Report Downloaded!");
                }).catch(err => {
                    console.error("PDF Generation Error:", err);
                    btn.innerText = "Error";
                    setTimeout(() => { 
                        btn.innerText = originalText; 
                        btn.disabled = false; 
                    }, 2000);
                    Utils.showNotification("Failed to generate PDF.", "error");
                });
            }

            downloadPocketBIP() {
                const data = this.c.store.getState().currentCaseData;
                
                // Helper to strip HTML and truncate for the card
                const getPlain = (html, length=150) => {
                    const tmp = document.createElement("DIV");
                    tmp.innerHTML = html || 'N/A';
                    let text = tmp.textContent || tmp.innerText || "";
                    text = text.replace(/\s+/g, ' ').trim();
                    return text.length > length ? text.substring(0, length) + '...' : text;
                };

                // Generate Card HTML
                const element = document.createElement('div');
                element.innerHTML = `
                    <div style="width: 4in; height: 6in; border: 2px solid #333; font-family: 'Arial', sans-serif; font-size: 11px; display: flex; flex-direction: column; background: white; color: black; box-sizing: border-box;">
                        <div style="background: #333; color: white; padding: 8px; text-align: center; font-weight: bold; font-size: 14px;">
                            BIP: ${data.studentName}
                        </div>
                        <div style="padding: 10px; flex-grow: 1; display: flex; flex-direction: column; gap: 8px;">
                            <div style="background: #f3f4f6; padding: 5px; border-left: 4px solid #6b7280; border-radius: 2px;">
                                <strong style="display:block; color:#374151; font-size:10px; text-transform:uppercase;">üéØ Target Behavior</strong>
                                <span style="font-style:italic;">${getPlain(data.bipOperationalDefinition, 120)}</span>
                            </div>
                            
                            <div style="border: 1px solid #bbf7d0; background: #f0fdf4; padding: 5px; border-radius: 4px;">
                                <strong style="color: #166534; display:block;">üü¢ PREVENT (Antecedent)</strong>
                                ${getPlain(data.bipPreventContent, 200)}
                            </div>
                            
                            <div style="border: 1px solid #fef08a; background: #fefce8; padding: 5px; border-radius: 4px;">
                                <strong style="color: #854d0e; display:block;">üü° TEACH (Replacement)</strong>
                                ${getPlain(data.bipTeachContent, 200)}
                            </div>
                            
                            <div style="border: 1px solid #fecaca; background: #fef2f2; padding: 5px; border-radius: 4px;">
                                <strong style="color: #991b1b; display:block;">üî¥ RESPOND (Consequence)</strong>
                                ${getPlain(data.bipRespondContent, 200)}
                            </div>
                        </div>
                        <div style="background: #f9fafb; padding: 5px; text-align: center; font-size: 9px; color: #9ca3af; border-top: 1px solid #e5e7eb;">
                            Confidential ‚Ä¢ Pocket BIP ‚Ä¢ ${new Date().toLocaleDateString()}
                        </div>
                    </div>
                `;

                const opt = {
                    margin:       0,
                    filename:     `Pocket_BIP_${data.studentName.replace(/[^a-z0-9]/gi, '_')}.pdf`,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2, scrollY: 0 },
                    jsPDF:        { unit: 'in', format: [4, 6], orientation: 'portrait' } // 4x6 inch index card
                };

                // UI Feedback
                const btn = document.getElementById('download-pocket-btn');
                const originalText = btn.innerHTML;
                btn.innerText = "Generating...";
                btn.disabled = true;

                html2pdf().set(opt).from(element).save().then(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    Utils.showNotification("Pocket BIP Downloaded!");
                }).catch(err => {
                    console.error(err);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    Utils.showNotification("Failed to generate PDF", "error");
                });
            }

            // NEW: Option 1 (Traffic Light Report)
            downloadTrafficLight() {
                // ... existing traffic light code ...
                const opt = {
                    margin: 0.5,
                    filename: `Traffic_Light_BIP_${data.studentName.replace(/[^a-z0-9]/gi, '_')}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                };

                // UI Feedback
                const btn = document.getElementById('download-traffic-btn');
                const originalText = btn.innerHTML;
                btn.innerText = "Generating...";
                btn.disabled = true;

                html2pdf().set(opt).from(element).save().then(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    Utils.showNotification("Traffic Light Report Downloaded");
                }).catch(err => {
                    console.error(err);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    Utils.showNotification("Failed to generate PDF", "error");
                });
            }

            // NEW: Option 3 (Staff Roleplay Simulator) Logic
            async startRoleplay() {
                const data = this.c.store.getState().currentCaseData;
                const modal = document.getElementById('roleplay-modal');
                const chatWin = document.getElementById('roleplay-chat-window');
                
                modal.classList.remove('hidden');
                chatWin.innerHTML = ''; // Clear previous chat
                
                // 1. Build System Prompt
                const systemPrompt = `
                    You are a highly realistic roleplay simulator for teacher training.
                    
                    **CASE CONTEXT:**
                    Student Name: ${data.studentName || 'Student'}
                    Target Behavior: ${data.bipOperationalDefinition || 'Disruptive behavior'}
                    
                    **THE PLAN (BIP) THE USER SHOULD FOLLOW:**
                    1. Prevent Strategies: ${Utils.stripHtml(data.bipPreventContent || 'N/A')}
                    2. Teach Strategies: ${Utils.stripHtml(data.bipTeachContent || 'N/A')}
                    3. Respond Strategies: ${Utils.stripHtml(data.bipRespondContent || 'N/A')}
                    
                    **YOUR ROLE:**
                    - Act as the student. 
                    - Start by setting a scene where the behavior is about to happen or is happening.
                    - Wait for the User (Teacher) to respond.
                    - If the User follows the BIP strategies correctly, react positively (de-escalate).
                    - If the User fails to follow the plan (e.g. argues, punishes, ignores protocol), escalate the behavior OR break character briefly in [brackets] to give feedback.
                    - Keep responses short, immersive, and reactive.
                `;

                this.roleplayHistory = [{ role: 'system', parts: [{ text: systemPrompt }] }];
                
                // 2. Initial AI Turn
                this.addRoleplayMessage("Initializing Scenario...", "system");
                Utils.showTypingIndicator('roleplay-chat-window', true);
                
                try {
                    // Trigger the AI to start the scenario
                    this.roleplayHistory.push({ role: 'user', parts: [{ text: "Start the scenario now." }] });
                    const response = await Utils.getGeminiResponse(this.roleplayHistory);
                    
                    // Remove the user trigger from history to keep chat clean? Actually Gemini API handles history, so we keep it or just render response.
                    // We won't render "Start scenario now" to the user.
                    Utils.showTypingIndicator('roleplay-chat-window', false);
                    this.addRoleplayMessage(response, 'ai');
                    this.roleplayHistory.push({ role: 'model', parts: [{ text: response }] });
                } catch (e) {
                    console.error(e);
                    Utils.showNotification("Simulation failed to start.", "error");
                }
            }

            async handleRoleplayChat() {
                const input = document.getElementById('roleplay-input');
                const text = input.value.trim();
                if(!text) return;
                
                this.addRoleplayMessage(text, 'user');
                input.value = '';
                
                this.roleplayHistory.push({ role: 'user', parts: [{ text: text }] });
                
                Utils.showTypingIndicator('roleplay-chat-window', true);
                const response = await Utils.getGeminiResponse(this.roleplayHistory);
                Utils.showTypingIndicator('roleplay-chat-window', false);
                
                this.addRoleplayMessage(response, 'ai');
                this.roleplayHistory.push({ role: 'model', parts: [{ text: response }] });
            }

            addRoleplayMessage(text, type) {
                const win = document.getElementById('roleplay-chat-window');
                const div = document.createElement('div');
                
                if (type === 'system') {
                    div.className = "text-center text-xs text-gray-500 italic my-2";
                    div.textContent = text;
                } else if (type === 'user') {
                    div.className = "flex justify-end mb-4";
                    div.innerHTML = `<div class="bg-indigo-600 text-white px-4 py-3 rounded-2xl rounded-tr-none max-w-[80%] shadow-md text-sm">${text}</div>`;
                } else { // AI
                    // Check for bracketed feedback to style differently
                    const formattedText = text.replace(/\[(.*?)\]/g, '<span class="block mt-2 mb-2 p-2 bg-yellow-100 text-yellow-800 text-xs font-bold border-l-4 border-yellow-500 rounded">üí° FEEDBACK: $1</span>');
                    div.className = "flex justify-start mb-4";
                    div.innerHTML = `<div class="bg-white text-gray-800 border border-gray-200 px-4 py-3 rounded-2xl rounded-tl-none max-w-[80%] shadow-md text-sm">${formattedText}</div>`;
                }
                
                win.appendChild(div);
                win.scrollTop = win.scrollHeight;
            }

            createRolloutPlan() {
                const data = this.c.store.getState().currentCaseData;
                
                // Helper to grab first bullet point or sentence
                const getTopStrategy = (html) => {
                    if (!html) return "Review strategy with team";
                    const temp = document.createElement('div');
                    temp.innerHTML = html;
                    // Try to find list items first
                    const li = temp.querySelector('li');
                    if (li) return li.textContent.trim();
                    // Try paragraphs
                    const p = temp.querySelector('p');
                    if (p) return p.textContent.trim();
                    // Fallback to text content
                    return temp.textContent.trim().substring(0, 100) + "...";
                };

                const preventTop = getTopStrategy(data.bipPreventContent);
                const teachTop = getTopStrategy(data.bipTeachContent);
                const respondTop = getTopStrategy(data.bipRespondContent);

                const planHTML = `
                    <div class="p-8 bg-white max-w-3xl mx-auto font-sans text-gray-800">
                        <div class="text-center mb-8 border-b pb-4">
                            <h1 class="text-3xl font-extrabold text-gray-900 mb-2">üöÄ BIP Launch Plan</h1>
                            <p class="text-lg text-gray-600">Student: <strong>${data.studentName}</strong></p>
                        </div>
                        
                        <div class="space-y-8 relative before:absolute before:inset-0 before:ml-5 before:-translate-x-px md:before:mx-auto md:before:translate-x-0 before:h-full before:w-0.5 before:bg-gradient-to-b before:from-transparent before:via-slate-300 before:to-transparent">
                            
                            <!-- Day 1 -->
                            <div class="relative flex items-center justify-between md:justify-normal md:odd:flex-row-reverse group is-active">
                                <div class="flex items-center justify-center w-10 h-10 rounded-full border border-white bg-blue-500 shadow shrink-0 md:order-1 md:group-odd:-translate-x-1/2 md:group-even:translate-x-1/2 z-10 text-white font-bold">1</div>
                                <div class="w-[calc(100%-4rem)] md:w-[calc(50%-2.5rem)] bg-white p-4 rounded border border-gray-200 shadow-sm">
                                    <div class="flex items-center justify-between space-x-2 mb-1">
                                        <div class="font-bold text-blue-900">Day 1: Foundation</div>
                                        <span class="text-xs font-medium text-blue-600 bg-blue-50 px-2 py-1 rounded">Prevent</span>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-3">Focus only on setting the stage. Do not worry about new consequences yet.</p>
                                    <div class="bg-blue-50 p-3 rounded border border-blue-100 text-sm text-blue-800 italic">
                                        "Strategy: ${preventTop}"
                                    </div>
                                </div>
                            </div>

                            <!-- Day 2 -->
                            <div class="relative flex items-center justify-between md:justify-normal md:odd:flex-row-reverse group is-active">
                                <div class="flex items-center justify-center w-10 h-10 rounded-full border border-white bg-yellow-500 shadow shrink-0 md:order-1 md:group-odd:-translate-x-1/2 md:group-even:translate-x-1/2 z-10 text-white font-bold">2</div>
                                <div class="w-[calc(100%-4rem)] md:w-[calc(50%-2.5rem)] bg-white p-4 rounded border border-gray-200 shadow-sm">
                                    <div class="flex items-center justify-between space-x-2 mb-1">
                                        <div class="font-bold text-yellow-900">Day 2: Teaching</div>
                                        <span class="text-xs font-medium text-yellow-600 bg-yellow-50 px-2 py-1 rounded">Replace</span>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-3">Continue Day 1. Add the teaching component (practice when calm).</p>
                                    <div class="bg-yellow-50 p-3 rounded border border-yellow-100 text-sm text-yellow-800 italic">
                                        "Teach: ${teachTop}"
                                    </div>
                                </div>
                            </div>

                            <!-- Day 3 -->
                            <div class="relative flex items-center justify-between md:justify-normal md:odd:flex-row-reverse group is-active">
                                <div class="flex items-center justify-center w-10 h-10 rounded-full border border-white bg-red-500 shadow shrink-0 md:order-1 md:group-odd:-translate-x-1/2 md:group-even:translate-x-1/2 z-10 text-white font-bold">3</div>
                                <div class="w-[calc(100%-4rem)] md:w-[calc(50%-2.5rem)] bg-white p-4 rounded border border-gray-200 shadow-sm">
                                    <div class="flex items-center justify-between space-x-2 mb-1">
                                        <div class="font-bold text-red-900">Day 3: Full Launch</div>
                                        <span class="text-xs font-medium text-red-600 bg-red-50 px-2 py-1 rounded">Respond</span>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-3">Add the response strategies. The plan is now fully live.</p>
                                    <div class="bg-red-50 p-3 rounded border border-red-100 text-sm text-red-800 italic">
                                        "If behavior occurs: ${respondTop}"
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-8 text-center text-xs text-gray-400">
                            Generated by FBA/BIP App
                        </div>
                    </div>
                `;

                // Open in Modal
                document.getElementById('report-preview-content').innerHTML = planHTML;
                document.getElementById('report-preview-modal').classList.remove('hidden');
            }
        }

        class CaseDetailController extends BaseController {
            mount(caseId, caseData) {
                this.caseId = caseId;
                this.userId = this.store.getState().user.uid;
                
                const template = document.getElementById('case-detail-screen-template');
                this.mainContent.appendChild(template.cloneNode(true));
                this.mainContent.firstElementChild.classList.remove('hidden');
                
                document.getElementById('case-detail-student-name').textContent = caseData.studentName;
                document.getElementById('case-detail-student-dob').textContent = `Grade: ${caseData.gradeLevel || 'N/A'}`;
                
                this.bind('#back-to-dashboard-btn', 'click', () => window.app.router.navigateTo('dashboard'));
                this.bind('#export-case-btn', 'click', () => this.exportCase());
                this.bind('#global-quick-log-btn', 'click', () => window.app.openAbcModal());

                this.managers = [
                    new InterviewManager(this),
                    new AnalysisManager(this),
                    new VisualManager(this),
                    new LiveModeManager(this), // NEW MANAGER ADDED
                    new DecisionManager(this),
                    new BipManager(this),
                    new TokenBoardManager(this), // NEW MANAGER ADDED (Option 1)
                    new ChoiceBoardManager(this), // NEW: Added Choice Board Manager
                    new ContractManager(this), // NEW: Added Contract Manager
                    new FluencyManager(this), // NEW: Added Fluency Manager (Option 3)
                    new PreferenceManager(this), // NEW: Added Preference Manager
                    new SkillMapperManager(this), // NEW: Skill Mapper Manager (Option 1 Request)
                    new TaskAnalysisManager(this), // NEW: Task Analysis Manager (Requested)
                    new CommunicationManager(this), // NEW: Communication Manager (Option 2)
                    new IntervalManager(this), // NEW: Interval Recording Manager (Requested Option 1)
                    new CycleManager(this), // NEW: Acting-Out Cycle Manager (Option 1)
                    new SensoryManager(this), // NEW: Sensory Profile Analyzer (Option 2)
                    new CrisisManager(this), // NEW: Crisis Manager (Red Mode - Option 2)
                    new PresentationManager(this) // NEW: Presentation Mode Manager (Option 2 Request)
                ];
                this.managers.forEach(m => m.init());
                
                this.setupUI(); // Initialize collapsibles and scroll spy
                this.updateSteps(); 
                I18nService.translatePage(this.mainContent);
                // Ensure guide is visible and reset on detail view load
                document.getElementById('pigeon-guide-btn').classList.remove('hidden');
            }

            bind(selector, event, handler) {
                const el = this.mainContent.querySelector(selector);
                if (el) el.addEventListener(event, handler);
            }

            setupUI() {
                // Collapsible Logic
                this.mainContent.querySelectorAll('.section-header').forEach(header => {
                    header.addEventListener('click', () => {
                        header.parentElement.classList.toggle('section-collapsed');
                    });
                });

                // Scroll Spy Logic
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            // Remove active from all
                            document.querySelectorAll('#side-nav a').forEach(a => a.classList.remove('active'));
                            // Add active to current
                            const id = entry.target.id;
                            const link = document.querySelector(`#side-nav a[href="#${id}"]`);
                            if (link) link.classList.add('active');
                        }
                    });
                }, { threshold: 0.3 }); // Trigger when 30% visible

                this.mainContent.querySelectorAll('.step-section').forEach(section => observer.observe(section));
            }

            exportCase() {
                const data = this.store.getState().currentCaseData;
                const obs = this.store.getState().observations;
                const exportData = { version: '1.0', type: 'FBA_CASE', exportedAt: new Date().toISOString(), case: data, observations: obs };
                Utils.downloadAsJson(exportData, `FBA_Case_${data.studentName}.json`);
            }

            updateSteps() {
                const data = this.store.getState().currentCaseData;
                const recBtn = document.getElementById('analyze-records-btn');
                const recTxt = document.getElementById('record-review-text');
                if(recBtn && recTxt) {
                    recBtn.disabled = (recTxt.value.length < 50) || !!data.recordAnalysis;
                    recTxt.addEventListener('input', () => { recBtn.disabled = recTxt.value.length < 50; });
                }
                const visBtn = document.getElementById('generate-visual-btn');
                if(visBtn) visBtn.disabled = !(data.interviewSummary && data.analysisHypothesis && data.recordAnalysis);
                const assBtn = document.getElementById('begin-assessment-btn');
                if(assBtn) assBtn.disabled = !data.visualHypothesisSVG;
                const dec = data.criticalDecision;
                const proceed = dec && (dec.aiResponse.includes('TYPE::A') || (dec.aiResponse.includes('TYPE::B') && data.confirmedFunction));
                if(proceed) document.getElementById('step-6-section').classList.remove('hidden');
                
                this.updateProgressUI();
            }

            updateProgressUI() {
                const data = this.store.getState().currentCaseData;
                const obs = this.store.getState().observations || [];
                
                // Define completion criteria
                const checks = [
                    !!data.interviewSummary,                      // Step 1
                    obs.length >= 3 && !!data.analysisHypothesis, // Step 2 (min 3 obs + analysis)
                    !!data.recordReviewText,                      // Step 3
                    !!data.visualHypothesisSVG,                   // Step 4
                    !!data.criticalDecision,                      // Step 5
                    !!data.bipMonitoringPlan                      // Step 6
                ];
                
                const completed = checks.filter(Boolean).length;
                const total = checks.length;
                const pct = Math.round((completed / total) * 100);
                
                // Update Bar
                const bar = document.getElementById('progress-bar-fill');
                const pctText = document.getElementById('progress-percentage');
                if(bar) bar.style.width = `${pct}%`;
                if(pctText) pctText.textContent = `${pct}%`;
                
                // Update Text Colors
                checks.forEach((isDone, idx) => {
                    const el = document.getElementById(`prog-step-${idx + 1}`);
                    if(el) {
                        el.className = isDone ? "text-blue-600 font-bold transition-colors" : "text-gray-400 transition-colors";
                        // Checkmark logic
                        if(isDone && !el.textContent.includes('‚úì')) el.innerHTML += ' ‚úì'; 
                        if(!isDone && el.textContent.includes('‚úì')) el.innerHTML = el.innerHTML.replace(' ‚úì', '');
                    }
                });
            }
        }

        // --- NEW: Guide Manager (Percy) ---
        class GuideManager {
            constructor(app) {
                this.app = app;
                this.btn = document.getElementById('pigeon-guide-btn');
                this.popover = document.getElementById('guide-chat-popover');
                this.chatWindow = document.getElementById('guide-messages');
                this.history = [];
                
                // Drag State
                this.isDragging = false;
                this.dragStartTime = 0;
                this.dragOffset = { x: 0, y: 0 };

                this.init();
            }

            init() {
                // Mouse Events
                this.btn.addEventListener('mousedown', (e) => this.startDrag(e));
                document.addEventListener('mousemove', (e) => this.drag(e));
                document.addEventListener('mouseup', (e) => this.endDrag(e));
                
                // Touch Events
                this.btn.addEventListener('touchstart', (e) => this.startDrag(e), { passive: false });
                document.addEventListener('touchmove', (e) => this.drag(e), { passive: false });
                document.addEventListener('touchend', (e) => this.endDrag(e));

                document.getElementById('close-guide-btn').addEventListener('click', () => this.close());
                document.getElementById('guide-send-btn').addEventListener('click', () => this.sendMessage());
                document.getElementById('guide-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') this.sendMessage(); });
            }

            startDrag(e) {
                if (e.type === 'touchstart') e.preventDefault();
                
                // If this is the first interaction, convert CSS positioning to explicit pixels
                if (!this.btn.style.left) {
                   const rect = this.btn.getBoundingClientRect();
                   this.btn.style.left = rect.left + 'px';
                   this.btn.style.top = rect.top + 'px';
                   this.btn.style.bottom = 'auto';
                   this.btn.style.right = 'auto';
                }

                this.isDragging = true;
                this.dragStartTime = Date.now();
                
                const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
                
                const rect = this.btn.getBoundingClientRect();
                this.dragOffset.x = clientX - rect.left;
                this.dragOffset.y = clientY - rect.top;
                
                // Disable transition for immediate response
                this.btn.style.transition = 'none'; 
            }

            drag(e) {
                if (!this.isDragging) return;
                if (e.type === 'touchmove') e.preventDefault();

                const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
                
                let newX = clientX - this.dragOffset.x;
                let newY = clientY - this.dragOffset.y;
                
                // Boundary Checks
                const winWidth = window.innerWidth;
                const winHeight = window.innerHeight;
                const btnWidth = this.btn.offsetWidth;
                const btnHeight = this.btn.offsetHeight;
                
                if (newX < 10) newX = 10;
                if (newX + btnWidth > winWidth - 10) newX = winWidth - btnWidth - 10;
                if (newY < 10) newY = 10;
                if (newY + btnHeight > winHeight - 10) newY = winHeight - btnHeight - 10;
                
                this.btn.style.left = newX + 'px';
                this.btn.style.top = newY + 'px';

                // Move popover with button if open
                if (!this.popover.classList.contains('hidden-popover')) {
                    this.updatePopoverPosition();
                }
            }

            endDrag(e) {
                if (!this.isDragging) return;
                this.isDragging = false;
                this.btn.style.transition = 'transform 0.3s ease'; // Restore hover effect
                
                // Determine if click or drag
                const duration = Date.now() - this.dragStartTime;
                if (duration < 200) {
                    this.toggle();
                } else {
                    this.updatePopoverPosition();
                }
            }

            updatePopoverPosition() {
                const btnRect = this.btn.getBoundingClientRect();
                const popRect = this.popover.getBoundingClientRect(); // Might be 0 if hidden/scale(0)
                // Use default size if hidden
                const popWidth = popRect.width || 350;
                const popHeight = popRect.height || 500;
                const winWidth = window.innerWidth;
                const winHeight = window.innerHeight;

                // Default: Top-Left relative to button (so it looks like it's coming from bottom-right of screen typically)
                // Actually, let's try to keep it "Above" the button, aligned Right edge.
                let popLeft = btnRect.right - popWidth; 
                let popTop = btnRect.top - popHeight - 10;

                // Logic: If too close to top, put below.
                if (popTop < 10) {
                    popTop = btnRect.bottom + 10;
                }
                
                // Logic: If too close to left, align left edge
                if (popLeft < 10) {
                    popLeft = btnRect.left;
                }

                // Apply
                this.popover.style.right = 'auto';
                this.popover.style.bottom = 'auto';
                this.popover.style.left = popLeft + 'px';
                this.popover.style.top = popTop + 'px';
            }

            toggle() {
                if (this.popover.classList.contains('hidden-popover')) this.open();
                else this.close();
            }

            open() {
                // Temporarily show off-screen to get dimensions if needed, or just remove hidden
                this.popover.classList.remove('hidden-popover');
                this.updatePopoverPosition();
                
                if (this.history.length === 0) {
                    const context = this.getContext();
                    this.addMessage(`Hi there! I'm Percy. I see you're on the ${context.location}. How can I help you with this behavior analysis?`, 'ai');
                }
            }

            close() {
                this.popover.classList.add('hidden-popover');
            }

            getContext() {
                const route = this.app.router.currentController?.constructor.name;
                let location = "Dashboard";
                let details = "";

                if (route === 'DashboardController') {
                    location = "Dashboard";
                } else if (route === 'CaseDetailController') {
                    location = "Case View";
                    // Attempt to find active step
                    const activeLink = document.querySelector('#side-nav a.active');
                    const stepName = activeLink ? activeLink.textContent.trim() : "Overview";
                    const data = this.app.store.getState().currentCaseData;
                    details = `Student: ${data?.studentName || 'Unknown'}. Working on: ${stepName}.`;
                }
                return { location, details };
            }

            async sendMessage() {
                const input = document.getElementById('guide-input');
                const text = input.value.trim();
                if (!text) return;

                this.addMessage(text, 'user');
                input.value = '';

                // Build context-aware prompt
                const ctx = this.getContext();
                const systemPrompt = `You are Percy the Pigeon, a friendly and expert Board Certified Behavior Analyst (BCBA) guide. 
                User Context: Currently viewing ${ctx.location}. ${ctx.details}
                Goal: Help the user navigate the app or understand FBA/BIP concepts. Keep answers concise and helpful. 
                Tone: Cheerful, encouraging, professional but accessible.`;

                const messages = [
                    { role: 'system', parts: [{ text: systemPrompt }] },
                    ...this.history.map(h => ({ role: h.role === 'ai' ? 'model' : 'user', parts: [{ text: h.text }] })),
                    { role: 'user', parts: [{ text }] }
                ];

                Utils.showTypingIndicator('guide-messages', true);
                const response = await Utils.getGeminiResponse(messages);
                Utils.showTypingIndicator('guide-messages', false);

                this.addMessage(response, 'ai');
            }

            addMessage(text, role) {
                const bubble = document.createElement('div');
                bubble.className = `chat-bubble ${role === 'ai' ? 'guide-bubble-ai' : 'guide-bubble-user'}`;
                bubble.innerHTML = text; // Allow simple HTML
                this.chatWindow.appendChild(bubble);
                this.chatWindow.scrollTop = this.chatWindow.scrollHeight;
                this.history.push({ role, text });
            }
        }

        /* =========================================
           SECTION 5: ROUTER & APP BOOTSTRAP
           ========================================= */
        class Router {
            constructor(app) {
                this.app = app;
                this.currentController = null;
            }

            navigateTo(route, params = {}) {
                if (this.currentController) {
                    this.currentController.unmount();
                }

                switch (route) {
                    case 'login':
                        this.currentController = new LoginController(this.app.store, this.app.repo);
                        document.getElementById('app-navbar').classList.add('hidden');
                        break;
                    case 'dashboard':
                        this.currentController = new DashboardController(this.app.store, this.app.repo);
                        document.getElementById('app-navbar').classList.remove('hidden');
                        break;
                    case 'case':
                        this.app.store.setState({ currentCaseId: params.id, currentCaseData: params.data });
                        this.currentController = new CaseDetailController(this.app.store, this.app.repo);
                        this.currentController.mount(params.id, params.data);
                        return; // CaseDetail mounts itself differently
                }

                if (this.currentController && route !== 'case') {
                    this.currentController.mount();
                }
            }
        }

        class App {
            constructor() {
                this.store = new Store();
                this.repo = new Repository(this.store);
                this.authService = new AuthService(this.store);
                this.router = new Router(this);
                this.guide = new GuideManager(this); // Init Guide
                this.editingAbcId = null;
                this.deletingAbcId = null;
                this.deletingCaseId = null;
            }

            init() {
                const firebaseApp = initializeApp(APP_CONFIG.firebaseConfig);
                this.repo.init(firebaseApp);
                this.store.subscribe((state) => {
                    const currentRoute = this.router.currentController?.constructor.name;
                    if (state.user && currentRoute === 'LoginController') {
                        document.getElementById('user-id-display').textContent = state.user.uid;
                        this.router.navigateTo('dashboard');
                    } else if (!state.user && currentRoute !== 'LoginController') {
                        this.router.navigateTo('login');
                    }
                });
                this.authService.init(firebaseApp);
                this.setupSessionTimeout();
                this.router.navigateTo('login');
                this.setupGlobalModals();
                this.setupGlobalTimer();
                this.setupVoiceDictation();
                Utils.injectTooltips(); // Init Tooltips
            }

            setupGlobalTimer() {
                const widget = document.getElementById('global-timer-widget');
                const toggleBtn = document.getElementById('global-timer-toggle');
                const display = document.getElementById('global-timer-display');
                const playIcon = document.getElementById('play-icon');
                const stopIcon = document.getElementById('stop-icon');
                
                let interval;
                let seconds = 0;
                let isRunning = false;

                // Show widget only on case detail screen
                this.store.subscribe((state) => {
                    const route = this.router.currentController?.constructor.name;
                    if (route === 'CaseDetailController') widget.classList.remove('hidden');
                    else widget.classList.add('hidden');
                });

                toggleBtn.addEventListener('click', () => {
                    if (!isRunning) {
                        // Start
                        isRunning = true;
                        toggleBtn.classList.replace('bg-green-600', 'bg-red-600');
                        toggleBtn.classList.replace('hover:bg-green-700', 'hover:bg-red-700');
                        playIcon.classList.add('hidden');
                        stopIcon.classList.remove('hidden');
                        
                        interval = setInterval(() => {
                            seconds++;
                            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
                            const s = (seconds % 60).toString().padStart(2, '0');
                            display.textContent = `${m}:${s}`;
                        }, 1000);
                    } else {
                        // Stop & Log
                        clearInterval(interval);
                        const durationMins = Math.ceil(seconds / 60);
                        
                        // Reset UI
                        isRunning = false;
                        seconds = 0;
                        display.textContent = "00:00";
                        toggleBtn.classList.replace('bg-red-600', 'bg-green-600');
                        toggleBtn.classList.replace('hover:bg-red-700', 'hover:bg-green-700');
                        playIcon.classList.remove('hidden');
                        stopIcon.classList.add('hidden');

                        // Open Modal with data
                        this.openAbcModal(null, { duration: durationMins, time: new Date() });
                    }
                });
            }

            setupVoiceDictation() {
                if (!('webkitSpeechRecognition' in window)) return;

                document.querySelectorAll('.mic-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const targetId = e.currentTarget.closest('button').dataset.target;
                        const targetEl = document.getElementById(targetId);
                        
                        // Stop any existing recognition instances if user clicks rapidly
                        if (window.currentRecognition) {
                            window.currentRecognition.stop();
                        }

                        const recognition = new webkitSpeechRecognition();
                        window.currentRecognition = recognition;
                        
                        recognition.lang = I18nService.currentLocale === 'es' ? 'es-ES' : 'en-US';
                        recognition.continuous = false;
                        recognition.interimResults = false;

                        const btnIcon = e.currentTarget.closest('button');
                        btnIcon.classList.add('text-red-600', 'animate-pulse');

                        recognition.onresult = (event) => {
                            const text = event.results[0][0].transcript;
                            targetEl.value = targetEl.value ? `${targetEl.value} ${text}` : text;
                        };

                        recognition.onerror = (event) => {
                            console.error("Speech recognition error", event.error);
                            btnIcon.classList.remove('text-red-600', 'animate-pulse');
                        };

                        recognition.onend = () => {
                            btnIcon.classList.remove('text-red-600', 'animate-pulse');
                            window.currentRecognition = null;
                        };

                        recognition.start();
                    });
                });
            }

            setupSessionTimeout() {
                let timeout;
                const reset = () => {
                    clearTimeout(timeout);
                    if (!this.store.getState().user) return;
                    timeout = setTimeout(() => {
                        this.authService.logout();
                        Utils.showNotification("messages.session_timeout", "error");
                    }, 30 * 60 * 1000); // 30 minutes
                };
                ['click', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(evt => document.addEventListener(evt, reset));
                reset();
            }
            
            setupGlobalModals() {
                document.getElementById('logout-btn').addEventListener('click', () => this.authService.logout());
                document.getElementById('new-case-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const name = document.getElementById('student-name').value;
                    const grade = document.getElementById('student-grade').value;
                    if(name && grade) {
                        await this.repo.createCase(this.store.getState().user.uid, { studentName: name, gradeLevel: grade, status: 'Active' });
                        document.getElementById('new-case-modal').classList.add('hidden');
                        Utils.showNotification("messages.case_created");
                    }
                });
                document.getElementById('cancel-modal-btn').addEventListener('click', () => document.getElementById('new-case-modal').classList.add('hidden'));
                document.getElementById('cancel-abc-modal-btn').addEventListener('click', () => document.getElementById('abc-modal').classList.add('hidden'));
                
                // --- Chip Logic Implementation ---
                document.querySelectorAll('.preset-chip').forEach(chip => {
                    chip.addEventListener('click', (e) => {
                        const targetId = e.currentTarget.dataset.target;
                        const val = e.currentTarget.dataset.value;
                        const el = document.getElementById(targetId);
                        if (el) {
                            const currentVal = el.value.trim();
                            el.value = currentVal ? `${currentVal}, ${val}` : val;
                        }
                    });
                });

                // --- Slider Logic ---
                const intensityInput = document.getElementById('intensity-range');
                const intensityDisplay = document.getElementById('intensity-display');
                if(intensityInput && intensityDisplay) {
                    intensityInput.addEventListener('input', (e) => {
                        const val = e.target.value;
                        intensityDisplay.textContent = val;
                        
                        let classes = 'font-bold px-2 py-0.5 rounded text-xs border ';
                        if (val >= 8) classes += 'text-red-600 bg-red-100 border-red-200';
                        else if (val >= 5) classes += 'text-yellow-600 bg-yellow-100 border-yellow-200';
                        else classes += 'text-blue-600 bg-blue-100 border-blue-200';
                        
                        intensityDisplay.className = classes;
                    });
                }

                // --- NEW: Perceived Function Chip Logic ---
                document.querySelectorAll('.func-chip').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        // Deselect others
                        document.querySelectorAll('.func-chip').forEach(b => {
                            b.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
                            b.classList.add('bg-gray-50', 'text-gray-600', 'border-gray-200');
                        });
                        
                        // Select clicked
                        e.currentTarget.classList.remove('bg-gray-50', 'text-gray-600', 'border-gray-200');
                        e.currentTarget.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                        
                        // Update input
                        document.getElementById('perceived-function').value = e.currentTarget.dataset.value;
                    });
                });

                // --- Quick Scenario Logic ---
                document.querySelectorAll('.scenario-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const ant = e.currentTarget.dataset.ant;
                        const beh = e.currentTarget.dataset.beh;
                        const cons = e.currentTarget.dataset.cons;
                        
                        document.getElementById('antecedent').value = ant;
                        document.getElementById('behavior').value = beh;
                        document.getElementById('consequence').value = cons;
                        
                        Utils.showNotification("Scenario applied! You can now edit the details.");
                    });
                });

                // --- AI Magic Fill Logic ---
                document.getElementById('magic-fill-btn').addEventListener('click', async () => {
                    const input = document.getElementById('magic-fill-input');
                    const text = input.value.trim();
                    if (!text) return;

                    Utils.setLoading('magic-fill-btn', true);
                    
                    const prompt = `Extract ABC data from: "${text}". 
                    Return ONLY valid JSON with keys: antecedent, behavior, consequence, time (HH:MM format). 
                    If info is missing, infer or leave empty string. Do not include markdown formatting.`;

                    try {
                        const response = await Utils.getGeminiResponse([{role: 'user', parts: [{ text: prompt }]}]);
                        const cleanJson = response.replace(/```json/g, '').replace(/```/g, '').trim();
                        const data = JSON.parse(cleanJson);

                        if (data.antecedent) document.getElementById('antecedent').value = data.antecedent;
                        if (data.behavior) document.getElementById('behavior').value = data.behavior;
                        if (data.consequence) document.getElementById('consequence').value = data.consequence;
                        if (data.time) document.getElementById('observation-time').value = data.time;
                        
                        Utils.showNotification("Form filled by AI!");
                    } catch (e) {
                        console.error(e);
                        Utils.showNotification("Could not parse text", "error");
                    } finally {
                        Utils.setLoading('magic-fill-btn', false);
                    }
                });
                
                // --- NEW: Stopwatch Logic ---
                let timerInterval;
                let startTime;
                const timerDisplay = document.getElementById('stopwatch-display');
                const startBtn = document.getElementById('start-timer-btn');
                const stopBtn = document.getElementById('stop-timer-btn');
                const resetBtn = document.getElementById('reset-timer-btn');

                if (startBtn && stopBtn && resetBtn && timerDisplay) {
                    startBtn.addEventListener('click', () => {
                        startTime = Date.now();
                        startBtn.disabled = true;
                        startBtn.classList.add('opacity-50', 'cursor-not-allowed');
                        stopBtn.disabled = false;
                        stopBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        
                        timerInterval = setInterval(() => {
                            const elapsed = Date.now() - startTime;
                            const mins = Math.floor(elapsed / 60000);
                            const secs = Math.floor((elapsed % 60000) / 1000);
                            timerDisplay.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                        }, 1000);
                    });

                    stopBtn.addEventListener('click', () => {
                        clearInterval(timerInterval);
                        const elapsed = Date.now() - startTime;
                        let durationVal = Math.ceil(elapsed / 60000);
                        if(durationVal === 0 && elapsed > 0) durationVal = 1; // Minimum 1 min
                        
                        document.getElementById('duration').value = durationVal;
                        
                        startBtn.disabled = false;
                        startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        stopBtn.disabled = true;
                        stopBtn.classList.add('opacity-50', 'cursor-not-allowed');
                        Utils.showNotification(`Duration set to ${durationVal} min(s)`);
                    });

                    resetBtn.addEventListener('click', () => {
                        clearInterval(timerInterval);
                        timerDisplay.textContent = "00:00";
                        startBtn.disabled = false;
                        startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        stopBtn.disabled = true;
                        stopBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    });
                }
                // ---------------------------------

                document.getElementById('abc-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const ant = document.getElementById('antecedent').value;
                    const beh = document.getElementById('behavior').value;
                    const cons = document.getElementById('consequence').value;
                    const date = document.getElementById('observation-date').value;
                    const time = document.getElementById('observation-time').value;
                    const duration = document.getElementById('duration').value;
                    const intensity = document.getElementById('intensity-range').value;
                    const func = document.getElementById('perceived-function').value;
                    const setting = document.getElementById('setting-context').value;
                    const settingEvents = Array.from(document.querySelectorAll('input[name="setting_event"]:checked')).map(cb => cb.value);

                    if(ant && beh && cons && date) {
                        const obsData = { 
                            antecedent: ant, 
                            behavior: beh, 
                            consequence: cons, 
                            duration: duration ? parseInt(duration) : null,
                            intensity: intensity ? parseInt(intensity) : 5,
                            perceivedFunction: func || null,
                            setting: setting || 'Unknown',
                            settingEvents: settingEvents,
                            observationTime: new Date(`${date}T${time||'00:00'}`) 
                        };
                        if(this.editingAbcId) await this.repo.updateObservation(this.store.getState().user.uid, this.store.getState().currentCaseId, this.editingAbcId, obsData);
                        else await this.repo.addObservation(this.store.getState().user.uid, this.store.getState().currentCaseId, obsData);
                        document.getElementById('abc-modal').classList.add('hidden');
                        Utils.showNotification(this.editingAbcId ? "messages.obs_updated" : "messages.obs_saved");
                    }
                });
                document.getElementById('cancel-delete-btn').addEventListener('click', () => document.getElementById('delete-confirm-modal').classList.add('hidden'));
                
                // Unified delete handler
                document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
                    if (this.deletingCaseId) {
                         await this.repo.deleteCase(this.store.getState().user.uid, this.deletingCaseId);
                         this.deletingCaseId = null;
                         document.getElementById('delete-confirm-modal').classList.add('hidden');
                         Utils.showNotification("messages.case_deleted");
                    } else if (this.deletingAbcId) {
                        await this.repo.deleteObservation(this.store.getState().user.uid, this.store.getState().currentCaseId, this.deletingAbcId);
                        this.deletingAbcId = null;
                        document.getElementById('delete-confirm-modal').classList.add('hidden');
                        Utils.showNotification("messages.obs_deleted");
                    }
                });

                // Language Modal
                document.getElementById('language-switcher').addEventListener('change', async (e) => {
                    if (e.target.value === 'add_new_lang') {
                        document.getElementById('language-modal').classList.remove('hidden');
                        e.target.value = I18nService.currentLocale;
                    } else { I18nService.setLocale(e.target.value); }
                });
                document.getElementById('cancel-lang-btn').addEventListener('click', () => document.getElementById('language-modal').classList.add('hidden'));
                document.getElementById('confirm-lang-btn').addEventListener('click', async () => {
                    const input = document.getElementById('new-language-input'); const langName = input.value.trim(); if (!langName) return;
                    document.getElementById('language-modal').classList.add('hidden');
                    const loadingScreen = document.getElementById('loading-screen'); document.getElementById('loading-text').textContent = `Translating to ${langName}...`; loadingScreen.classList.remove('hidden');
                    try {
                        const newKey = await I18nService.addLanguage(langName);
                        const select = document.getElementById('language-switcher');
                        const option = document.createElement('option'); option.value = newKey; option.textContent = langName;
                        select.insertBefore(option, select.lastElementChild); select.value = newKey;
                        Utils.showNotification("Language added!");
                    } catch (err) { Utils.showNotification("Translation failed.", "error"); } 
                    finally { loadingScreen.classList.add('hidden'); input.value = ''; }
                });
            }
            
            openAbcModal(id = null, prefillData = null) {
                this.editingAbcId = id;
                document.getElementById('abc-form').reset();
                
                // Clear Setting Event Checkboxes
                document.querySelectorAll('input[name="setting_event"]').forEach(cb => cb.checked = false);

                // --- SMART AUTOCOMPLETE LOGIC ---
                const obs = this.store.getState().observations || [];
                const populateList = (listId, field) => {
                    const list = document.getElementById(listId);
                    if (!list) return;
                    // Get unique, trimmed, non-empty values from history
                    const items = [...new Set(obs.map(o => (o[field] || '').trim()))]
                        .filter(i => i.length > 0)
                        .sort();
                    list.innerHTML = items.map(i => `<option value="${i}">`).join('');
                };
                
                populateList('ant-options', 'antecedent');
                populateList('beh-options', 'behavior');
                populateList('cons-options', 'consequence');
                // --------------------------------

                // Reset Function Chips
                document.getElementById('perceived-function').value = '';
                document.querySelectorAll('.func-chip').forEach(b => {
                    b.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
                    b.classList.add('bg-gray-50', 'text-gray-600', 'border-gray-200');
                });
                
                // Reset Stopwatch
                document.getElementById('stopwatch-display').textContent = "00:00";
                const startBtn = document.getElementById('start-timer-btn');
                const stopBtn = document.getElementById('stop-timer-btn');
                if(startBtn) {
                    startBtn.disabled = false;
                    startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                if(stopBtn) {
                    stopBtn.disabled = true;
                    stopBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }

                // Reset Intensity
                const intInput = document.getElementById('intensity-range');
                const intDisp = document.getElementById('intensity-display');
                if(intInput && intDisp) {
                    intInput.value = 5;
                    intDisp.textContent = "5";
                    intDisp.className = "font-bold text-yellow-600 bg-yellow-100 px-2 py-0.5 rounded text-xs border border-yellow-200";
                }

                // --- NEW: Option 1 Dynamic History Implementation ---
                const historyContainer = document.getElementById('history-chips-container');
                if (historyContainer) {
                    historyContainer.innerHTML = '';
                    historyContainer.classList.add('hidden');
                    
                    const allObs = this.store.getState().observations || [];
                    if (allObs.length > 0) {
                        const getTopItems = (field) => {
                            const counts = {};
                            allObs.forEach(o => {
                                const val = o[field] ? o[field].trim() : '';
                                if (val) counts[val] = (counts[val] || 0) + 1;
                            });
                            return Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 3).map(x => x[0]);
                        };

                        const topAnts = getTopItems('antecedent');
                        const topBehs = getTopItems('behavior');

                        if (topAnts.length > 0 || topBehs.length > 0) {
                            historyContainer.classList.remove('hidden');
                            const label = document.createElement('div');
                            label.className = "text-xs font-bold text-gray-500 uppercase mb-2";
                            label.textContent = "üïí Frequent History (Tap to Add)";
                            historyContainer.appendChild(label);
                            
                            const wrapper = document.createElement('div');
                            wrapper.className = "flex flex-wrap gap-2";
                            
                            // Helper to create chips
                            const addChip = (text, field, colorClass, prefix) => {
                                const btn = document.createElement('button');
                                btn.type = 'button';
                                btn.className = `text-xs ${colorClass} border border-opacity-20 rounded px-2 py-1 transition-colors flex items-center shadow-sm`;
                                btn.innerHTML = `<span class="opacity-50 mr-1 text-[10px] uppercase font-bold">${prefix}:</span> ${text}`;
                                btn.addEventListener('click', () => {
                                    const el = document.getElementById(field);
                                    // Append if not empty, otherwise set
                                    el.value = el.value ? `${el.value}, ${text}` : text;
                                    // Visual feedback
                                    btn.classList.add('ring-2', 'ring-offset-1', 'ring-blue-400');
                                    setTimeout(() => btn.classList.remove('ring-2', 'ring-offset-1', 'ring-blue-400'), 200);
                                });
                                wrapper.appendChild(btn);
                            };

                            topAnts.forEach(t => addChip(t, 'antecedent', 'bg-blue-50 hover:bg-blue-100 text-blue-800 border-blue-300', 'Ant'));
                            topBehs.forEach(t => addChip(t, 'behavior', 'bg-red-50 hover:bg-red-100 text-red-800 border-red-300', 'Beh'));
                            
                            historyContainer.appendChild(wrapper);
                        }
                    }
                }
                // --- END Option 1 ---

                if (prefillData) {
                    if(prefillData.duration) document.getElementById('duration').value = prefillData.duration;
                    if(prefillData.time) {
                        const now = prefillData.time;
                        document.getElementById('observation-time').value = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
                    }
                }

                if(id) {
                    const obs = this.store.getState().observations.find(o => o.id === id);
                    if(obs) {
                        document.getElementById('antecedent').value = obs.antecedent;
                        document.getElementById('behavior').value = obs.behavior;
                        document.getElementById('consequence').value = obs.consequence;
                        document.getElementById('duration').value = obs.duration || '';
                        document.getElementById('setting-context').value = obs.setting || '';
                        
                        // Load Setting Events
                        if (obs.settingEvents) {
                            obs.settingEvents.forEach(val => {
                                const cb = document.querySelector(`input[name="setting_event"][value="${val}"]`);
                                if(cb) cb.checked = true;
                            });
                        }

                        // Load Intensity
                        if (obs.intensity) {
                            const input = document.getElementById('intensity-range');
                            if(input) {
                                input.value = obs.intensity;
                                input.dispatchEvent(new Event('input')); // Trigger update for visual display
                            }
                        }

                        const dateObj = Utils.safeDate(obs.observationTime);
                        if (dateObj) {
                            document.getElementById('observation-date').value = dateObj.toISOString().split('T')[0];
                            const hours = String(dateObj.getHours()).padStart(2, '0');
                            const minutes = String(dateObj.getMinutes()).padStart(2, '0');
                            document.getElementById('observation-time').value = `${hours}:${minutes}`;
                        }
                        
                        // Populate Function Chip
                        if(obs.perceivedFunction) {
                            document.getElementById('perceived-function').value = obs.perceivedFunction;
                            const chip = document.querySelector(`.func-chip[data-value="${obs.perceivedFunction}"]`);
                            if(chip) {
                                chip.classList.remove('bg-gray-50', 'text-gray-600', 'border-gray-200');
                                chip.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                            }
                        }
                    }
                } else {
                    document.getElementById('observation-date').value = new Date().toISOString().split('T')[0];
                }
                document.getElementById('abc-modal').classList.remove('hidden');
            }
            
            openDeleteModal(id) {
                this.deletingAbcId = id;
                this.deletingCaseId = null;
                Utils.showDeleteModal('observation', id);
            }
            
            openDeleteCaseModal(id) {
                this.deletingCaseId = id;
                this.deletingAbcId = null;
                Utils.showDeleteModal('case', id);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.app = new App();
            window.app.init();
        });
    </script>
</body>
</html>