"""
Inject IEP Progress Monitoring Report Export into App.jsx.
Three changes:
  1. handleExportIEPReport function (after handleExportCSV)
  2. IEP Export button (next to CSV button in student detail)
  3. Help tip localization key
"""
import re

FILE = r"C:\Users\cabba\OneDrive\Desktop\UDL-Tool-Updated\prismflow-deploy\src\App.jsx"

with open(FILE, "r", encoding="utf-8-sig") as f:
    content = f.read()

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CHANGE 1: Add handleExportIEPReport function after handleExportCSV
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

IEP_FUNCTION = '''
    const handleExportIEPReport = (student) => {
        if (!student) return;
        const rtiResult = classifyRTITier(student.stats);
        const goal = rtiGoals?.[student.name];
        const assessments = student.data?.fluencyAssessments || [];
        const logs = interventionLogs?.[student.name] || [];
        const aimline = goal ? calculateAimline(goal, assessments.map(a => ({ date: a.date, value: a.wcpm || 0 }))) : null;
        const tierColors = { 1: '#10b981', 2: '#f59e0b', 3: '#ef4444' };
        const tierLabels = { 1: 'Tier 1 â€” Universal', 2: 'Tier 2 â€” Targeted', 3: 'Tier 3 â€” Intensive' };
        const alertLabels = { ok: 'âœ… On Track', warning: 'âš ï¸ Approaching Concern (4+ below aimline)', critical: 'ğŸ”´ Critical â€” Consider Tier Change (6+ below aimline)' };

        const html = `<!DOCTYPE html><html><head><meta charset="utf-8">
        <title>IEP Progress Report â€” ${student.name}</title>
        <style>
            @media print { body { margin: 0.5in; } .no-print { display: none !important; } }
            * { box-sizing: border-box; margin: 0; padding: 0; }
            body { font-family: 'Segoe UI', Arial, sans-serif; color: #1e293b; line-height: 1.5; max-width: 800px; margin: 0 auto; padding: 24px; }
            .header { border-bottom: 3px solid #0e7490; padding-bottom: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: flex-end; }
            .header h1 { font-size: 20px; color: #0e7490; }
            .header .meta { font-size: 11px; color: #64748b; text-align: right; }
            .section { margin-bottom: 20px; }
            .section h2 { font-size: 14px; font-weight: 700; color: #0e7490; border-bottom: 1px solid #e2e8f0; padding-bottom: 4px; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em; }
            .tier-badge { display: inline-block; padding: 4px 14px; border-radius: 6px; font-weight: 700; font-size: 13px; color: white; }
            .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
            .stat-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px 14px; }
            .stat-card .label { font-size: 10px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.08em; }
            .stat-card .value { font-size: 18px; font-weight: 700; color: #1e293b; }
            table { width: 100%; border-collapse: collapse; font-size: 12px; }
            th { background: #f1f5f9; font-weight: 700; text-align: left; padding: 6px 10px; border: 1px solid #e2e8f0; }
            td { padding: 6px 10px; border: 1px solid #e2e8f0; }
            tr:nth-child(even) { background: #f8fafc; }
            .reason { background: #fef3c7; border-left: 3px solid #f59e0b; padding: 6px 10px; font-size: 12px; margin-bottom: 4px; border-radius: 0 6px 6px 0; }
            .rec { background: #ecfdf5; border-left: 3px solid #10b981; padding: 6px 10px; font-size: 12px; margin-bottom: 4px; border-radius: 0 6px 6px 0; }
            .alert-box { padding: 10px 14px; border-radius: 8px; font-weight: 600; font-size: 13px; }
            .footer { margin-top: 30px; border-top: 1px solid #e2e8f0; padding-top: 12px; font-size: 10px; color: #94a3b8; text-align: center; }
            .print-btn { position: fixed; top: 16px; right: 16px; background: #0e7490; color: white; border: none; padding: 10px 24px; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        </style></head><body>
        <button class="print-btn no-print" onclick="window.print()">ğŸ–¨ï¸ Print / Save PDF</button>

        <div class="header">
            <div>
                <h1>ğŸ“Š Progress Monitoring Report</h1>
                <div style="font-size:12px;color:#475569;margin-top:4px;">IEP / RTI Documentation</div>
            </div>
            <div class="meta">
                <div><strong>Student:</strong> ${student.name}</div>
                <div><strong>Date:</strong> ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
                <div><strong>Generated by:</strong> AlloFlow UDL Platform</div>
            </div>
        </div>

        <div class="section">
            <h2>Current Classification</h2>
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
                <span class="tier-badge" style="background:${tierColors[rtiResult.tier]}">${tierLabels[rtiResult.tier]}</span>
                ${aimline ? '<span class="alert-box" style="background:' + (aimline.alert === 'critical' ? '#fef2f2;color:#991b1b' : aimline.alert === 'warning' ? '#fffbeb;color:#92400e' : '#ecfdf5;color:#065f46') + '">' + alertLabels[aimline.alert] + '</span>' : ''}
            </div>
            ${rtiResult.reasons.length > 0 ? '<div style="margin-top:8px"><strong style="font-size:11px;color:#64748b;">Classification Factors:</strong>' + rtiResult.reasons.map(r => '<div class="reason">' + r + '</div>').join('') + '</div>' : '<div class="reason" style="background:#ecfdf5;border-left-color:#10b981;">All metrics within expected range</div>'}
        </div>

        <div class="section">
            <h2>Performance Summary</h2>
            <div class="grid2">
                <div class="stat-card"><div class="label">Quiz Average</div><div class="value">${student.stats.quizAvg || 0}%</div></div>
                <div class="stat-card"><div class="label">Fluency (WCPM)</div><div class="value">${student.stats.fluencyWCPM || 'N/A'}</div></div>
                <div class="stat-card"><div class="label">Word Sounds Accuracy</div><div class="value">${student.stats.wsAccuracy ? student.stats.wsAccuracy + '%' : 'N/A'}</div></div>
                <div class="stat-card"><div class="label">Total Activities</div><div class="value">${student.stats.totalActivities || 0}</div></div>
            </div>
        </div>

        ${goal ? '<div class="section"><h2>Goal &amp; Aimline</h2><div class="grid2"><div class="stat-card"><div class="label">Baseline</div><div class="value">' + goal.baseline + '</div></div><div class="stat-card"><div class="label">Target</div><div class="value">' + goal.target + '</div></div><div class="stat-card"><div class="label">Target Date</div><div class="value">' + new Date(goal.targetDate).toLocaleDateString() + '</div></div><div class="stat-card"><div class="label">Aimline Slope</div><div class="value">' + (aimline ? '+' + aimline.slope.toFixed(1) + '/week' : 'N/A') + '</div></div></div></div>' : ''}

        ${assessments.length > 0 ? '<div class="section"><h2>Assessment History</h2><table><thead><tr><th>Date</th><th>WCPM</th><th>Accuracy</th><th>Level</th></tr></thead><tbody>' + assessments.slice(-10).map(a => '<tr><td>' + new Date(a.date || a.timestamp).toLocaleDateString() + '</td><td>' + (a.wcpm || 'N/A') + '</td><td>' + (a.accuracy ? a.accuracy + '%' : 'N/A') + '</td><td>' + (a.readingLevel || '-') + '</td></tr>').join('') + '</tbody></table></div>' : ''}

        ${logs.length > 0 ? '<div class="section"><h2>Intervention Log</h2><table><thead><tr><th>Program</th><th>Frequency</th><th>Duration</th><th>Group Size</th><th>Start Date</th><th>Notes</th></tr></thead><tbody>' + logs.map(l => '<tr><td><strong>' + (l.program || '') + '</strong></td><td>' + (l.frequency || '') + '</td><td>' + (l.minutes || '30') + ' min</td><td>' + (l.groupSize || '1') + '</td><td>' + (l.startDate || '') + '</td><td>' + (l.notes || '-') + '</td></tr>').join('') + '</tbody></table></div>' : '<div class="section"><h2>Intervention Log</h2><div style="font-size:12px;color:#94a3b8;font-style:italic;">No interventions logged. Use the Teacher Dashboard to log interventions.</div></div>'}

        ${rtiResult.recs.length > 0 ? '<div class="section"><h2>Recommendations</h2>' + rtiResult.recs.map(r => '<div class="rec">ğŸ’¡ ' + r + '</div>').join('') + '</div>' : ''}

        <div class="section">
            <h2>Safety Flags</h2>
            ${student.safetyFlags.length > 0 ? '<table><thead><tr><th>Category</th><th>Details</th></tr></thead><tbody>' + student.safetyFlags.map(f => '<tr><td>' + (f.category || 'Unspecified') + '</td><td>' + (f.message || f.text || '-') + '</td></tr>').join('') + '</tbody></table>' : '<div style="font-size:12px;color:#10b981;">âœ… No safety flags on record.</div>'}
        </div>

        <div class="footer">
            <div>Generated by AlloFlow UDL Platform â€¢ ${new Date().toLocaleString()} â€¢ Confidential Student Record</div>
            <div style="margin-top:4px;">This report contains data collected during platform-based instruction and assessment. Verify all data points against official district records before use in legal or compliance documents.</div>
        </div>
        </body></html>`;

        const printWin = window.open('', '_blank', 'width=900,height=700');
        if (printWin) { printWin.document.write(html); printWin.document.close(); }
        addToast('IEP Progress Report generated', 'success');
    };
'''

# Find the end of handleExportCSV to insert after it
anchor1 = "    };\n    // Class summary stats"
if anchor1 in content:
    content = content.replace(anchor1, "    };\n" + IEP_FUNCTION + "\n    // Class summary stats", 1)
    print("âœ… CHANGE 1: handleExportIEPReport function inserted after handleExportCSV")
else:
    print("âŒ CHANGE 1: Could not find anchor for function insertion")

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CHANGE 2: Add IEP Export button next to Log Intervention button
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

IEP_BUTTON = '''
                                            <button
                                                onClick={() => handleExportIEPReport(selectedStudent)}
                                                aria-label="Export IEP Progress Report"
                                                style={{ fontSize: '11px', fontWeight: 700, color: 'white', background: '#7c3aed', border: 'none', borderRadius: '6px', padding: '5px 12px', cursor: 'pointer', marginLeft: '6px' }}
                                            >
                                                ğŸ“„ IEP Report
                                            </button>
'''

anchor2 = "                                                Log Intervention\n                                            </button>"
if anchor2 in content:
    content = content.replace(anchor2, "                                                Log Intervention\n                                            </button>\n" + IEP_BUTTON, 1)
    print("âœ… CHANGE 2: IEP Export button inserted after Log Intervention button")
else:
    print("âŒ CHANGE 2: Could not find anchor for button insertion")

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CHANGE 3: Add help tip for the IEP button
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

HELP_TIP = """    'dashboard_export_iep': "Generate a formatted IEP Progress Monitoring Report for the selected student. Report includes: current tier classification with supporting data, performance summary (quiz average, fluency WCPM, word sounds accuracy), RTI goal and aimline status, assessment history table, intervention log summary, auto-generated recommendations, and safety flags. Opens in a new window with a Print button for saving as PDF. Use for: IEP meetings, parent conferences, RTI team reviews, and compliance documentation. Data is pulled from the student's logged sessions and assessments. Verify against official district records before use in legal documents.","""

anchor3 = "    'dashboard_export_csv':"
if anchor3 in content:
    idx = content.index(anchor3)
    # Find the end of this line
    end_of_line = content.index('\n', idx)
    content = content[:end_of_line+1] + HELP_TIP + '\n' + content[end_of_line+1:]
    print("âœ… CHANGE 3: Help tip added after dashboard_export_csv")
else:
    print("âŒ CHANGE 3: Could not find anchor for help tip insertion")

# Write the modified file
with open(FILE, "w", encoding="utf-8-sig") as f:
    f.write(content)

print("\nâœ… All changes written to App.jsx")
